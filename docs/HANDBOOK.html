<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Christophe de Dinechin">
<title>XL: An extensible programming language</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>XL: An extensible programming language</h1>
<div class="details">
<span id="author" class="author">Christophe de Dinechin</span><br>
<span id="email" class="email"><a href="mailto:christophe@dinechin.org">christophe@dinechin.org</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#introduction-to-xl">1. Introduction to XL</a>
<ul class="sectlevel2">
<li><a href="#two-basic-examples">1.1. Two basic examples</a>
<ul class="sectlevel3">
<li><a href="#hello-world">1.1.1. Hello World</a></li>
<li><a href="#factorial">1.1.2. Factorial</a></li>
</ul>
</li>
<li><a href="#one-operator-to-rule-them-all">1.2. One operator to rule them all</a></li>
<li><a href="#the-standard-library">1.3. The standard library</a>
<ul class="sectlevel3">
<li><a href="#usual-programming-features">1.3.1. Usual programming features</a></li>
<li><a href="#the-next-natural-evolutionary-step">1.3.2. The next natural evolutionary step</a></li>
<li><a href="#benefits-of-moving-features-to-a-library">1.3.3. Benefits of moving features to a library</a></li>
<li><a href="#the-case-of-text-input-output-operations">1.3.4. The case of text input / output operations</a></li>
</ul>
</li>
<li><a href="#efficient-translation">1.4. Efficient translation</a></li>
<li><a href="#adding-complex-features">1.5. Adding complex features</a>
<ul class="sectlevel3">
<li><a href="#reactive-programming-in-tao3d">1.5.1. Reactive programming in Tao3D</a></li>
<li><a href="#declarative-programming-in-tao3d">1.5.2. Declarative programming in Tao3D</a></li>
<li><a href="#distributed-programming-with-elfe">1.5.3. Distributed programming with ELFE</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#xl-syntax">2. XL syntax</a>
<ul class="sectlevel2">
<li><a href="#homoiconic-representation-of-programs">2.1. Homoiconic representation of programs</a>
<ul class="sectlevel3">
<li><a href="#why-lisp-remains-so-strong-to-this-day">2.1.1. Why Lisp remains so strong to this day</a></li>
<li><a href="#the-xl-parse-tree">2.1.2. The XL parse tree</a></li>
</ul>
</li>
<li><a href="#leaf-nodes">2.2. Leaf nodes</a>
<ul class="sectlevel3">
<li><a href="#numbers">2.2.1. Numbers</a></li>
<li><a href="#symbols-2">2.2.2. Symbols</a></li>
<li><a href="#text-2">2.2.3. Text</a></li>
</ul>
</li>
<li><a href="#inner-nodes">2.3. Inner nodes</a>
<ul class="sectlevel3">
<li><a href="#indentation-and-off-side-rule">2.3.1. Indentation and off-side rule</a></li>
<li><a href="#operator-precedence-and-associativity">2.3.2. Operator precedence and associativity</a></li>
<li><a href="#delimiters">2.3.3. Delimiters</a></li>
<li><a href="#child-syntax">2.3.4. Child syntax</a></li>
<li><a href="#extending-the-syntax">2.3.5. Extending the syntax</a></li>
</ul>
</li>
<li><a href="#making-the-syntax-easy-for-humans">2.4. Making the syntax easy for humans</a>
<ul class="sectlevel3">
<li><a href="#expression-vs-statement">2.4.1. Expression vs. statement</a></li>
<li><a href="#infix-vs-prefix">2.4.2. infix vs. prefix</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#xl-program-evaluation">3. XL program evaluation</a>
<ul class="sectlevel2">
<li><a href="#execution-phases">3.1. Execution phases</a>
<ul class="sectlevel3">
<li><a href="#execution-context">3.1.1. Execution context</a></li>
<li><a href="#parsing-phase">3.1.2. Parsing phase</a></li>
<li><a href="#sequences">3.1.3. Sequences</a></li>
<li><a href="#declaration-phase">3.1.4. Declaration phase</a></li>
<li><a href="#evaluation-phase">3.1.5. Evaluation phase</a></li>
</ul>
</li>
<li><a href="#expression-evaluation">3.2. Expression evaluation</a></li>
<li><a href="#syntactic-sugar">3.3. Syntactic sugar</a>
<ul class="sectlevel3">
<li><a href="#types-sugar">3.3.1. Types sugar</a></li>
<li><a href="#modules-sugar">3.3.2. Modules sugar</a></li>
<li><a href="#parameter-sugar">3.3.3. Parameter sugar</a></li>
<li><a href="#sugar-for-code-and-data">3.3.4. Sugar for code and data</a></li>
<li><a href="#implementations-hints">3.3.5. Implementations hints</a></li>
<li><a href="#storage-hints">3.3.6. Storage hints</a></li>
<li><a href="#alternate-notations">3.3.7. Alternate notations</a></li>
</ul>
</li>
<li><a href="#pattern-matching">3.4. Pattern matching</a>
<ul class="sectlevel3">
<li><a href="#name-definitions">3.4.1. Name definitions</a></li>
<li><a href="#wildcards">3.4.2. Wildcards</a></li>
<li><a href="#type-annotations">3.4.3. Type annotations</a></li>
<li><a href="#function-prefix-definitions">3.4.4. Function (prefix) definitions</a></li>
<li><a href="#postfix-definitions">3.4.5. Postfix definitions</a></li>
<li><a href="#infix-definitions">3.4.6. Infix definitions</a></li>
<li><a href="#argument-splitting">3.4.7. Argument splitting</a></li>
<li><a href="#conditional-patterns">3.4.8. Conditional patterns</a></li>
<li><a href="#validated-patterns">3.4.9. Validated patterns</a></li>
<li><a href="#literal-constants">3.4.10. Literal constants</a></li>
<li><a href="#metabox-values">3.4.11. Metabox values</a></li>
<li><a href="#blocks">3.4.12. Blocks</a></li>
<li><a href="#scope-pattern-matching">3.4.13. Scope pattern matching</a></li>
<li><a href="#pattern-matching-scope">3.4.14. Pattern-matching scope</a></li>
</ul>
</li>
<li><a href="#declaration-selection">3.5. Declaration selection</a>
<ul class="sectlevel3">
<li><a href="#overloading">3.5.1. Overloading</a></li>
<li><a href="#dynamic-dispatch">3.5.2. Dynamic dispatch</a></li>
<li><a href="#immediate-evaluation">3.5.3. Immediate evaluation</a></li>
<li><a href="#lazy-evaluation">3.5.4. Lazy evaluation</a></li>
</ul>
</li>
<li><a href="#functional-evaluation">3.6. Functional evaluation</a>
<ul class="sectlevel3">
<li><a href="#closures">3.6.1. Closures</a></li>
<li><a href="#memoization">3.6.2. Memoization</a></li>
<li><a href="#functions-as-values">3.6.3. Functions as values</a></li>
</ul>
</li>
<li><a href="#special-evaluation-rules">3.7. Special evaluation rules</a>
<ul class="sectlevel3">
<li><a href="#sequence-evaluation">3.7.1. Sequence evaluation</a></li>
<li><a href="#self">3.7.2. Self</a></li>
<li><a href="#implicit-result-variable">3.7.3. Implicit result variable</a></li>
<li><a href="#returned-value">3.7.4. Returned value</a></li>
</ul>
</li>
<li><a href="#scoping">3.8. Scoping</a>
<ul class="sectlevel3">
<li><a href="#nested-declarations">3.8.1. Nested declarations</a></li>
<li><a href="#scopes-and-maps">3.8.2. Scopes and maps</a></li>
<li><a href="#current-context">3.8.3. Current context</a></li>
<li><a href="#enclosing-context">3.8.4. Enclosing context</a></li>
<li><a href="#static-context">3.8.5. Static context</a></li>
<li><a href="#global-context">3.8.6. Global context</a></li>
<li><a href="#thread-context">3.8.7. Thread context</a></li>
</ul>
</li>
<li><a href="#error-handling">3.9. Error handling</a>
<ul class="sectlevel3">
<li><a href="#taking-error-parameters">3.9.1. Taking error parameters</a></li>
<li><a href="#fallible-types">3.9.2. Fallible types</a></li>
<li><a href="#try-catch">3.9.3. Try-Catch</a></li>
<li><a href="#error-statements">3.9.4. Error statements</a></li>
</ul>
</li>
<li><a href="#interface-and-implementation">3.10. Interface and implementation</a></li>
</ul>
</li>
<li><a href="#types">4. Types</a>
<ul class="sectlevel2">
<li><a href="#type-annotations-2">4.1. Type annotations</a></li>
<li><a href="#type-conversions">4.2. Type conversions</a>
<ul class="sectlevel3">
<li><a href="#conversion-using-constructors">4.2.1. Conversion using constructors</a></li>
<li><a href="#explicit-conversion">4.2.2. Explicit conversion</a></li>
<li><a href="#implicit-conversion">4.2.3. Implicit conversion</a></li>
<li><a href="#ignorable-type">4.2.4. Ignorable type</a></li>
</ul>
</li>
<li><a href="#type-definitions">4.3. Type definitions</a></li>
<li><a href="#type-expressions">4.4. Type expressions</a></li>
<li><a href="#variable-sized-types">4.5. Variable sized types</a></li>
<li><a href="#shared-type-annotations">4.6. Shared type annotations</a></li>
<li><a href="#standard-types">4.7. Standard types</a>
<ul class="sectlevel3">
<li><a href="#basic-types">4.7.1. Basic types</a></li>
<li><a href="#sized-data-types">4.7.2. Sized data types</a></li>
<li><a href="#category-types">4.7.3. Category types</a></li>
<li><a href="#generic-containers">4.7.4. Generic containers</a></li>
<li><a href="#true-generic-types">4.7.5. True generic types</a></li>
<li><a href="#constrained-generic-types">4.7.6. Constrained generic types</a></li>
<li><a href="#other-generic-types">4.7.7. Other generic types</a></li>
<li><a href="#mathematical-types">4.7.8. Mathematical types</a></li>
<li><a href="#parse-tree-types">4.7.9. Parse tree types</a></li>
<li><a href="#program-related-types">4.7.10. Program-related types</a></li>
<li><a href="#other-common-types">4.7.11. Other common types</a></li>
</ul>
</li>
<li><a href="#type-related-concepts">4.8. Type-related concepts</a>
<ul class="sectlevel3">
<li><a href="#lifetime">4.8.1. Lifetime</a></li>
<li><a href="#creation">4.8.2. Creation</a></li>
<li><a href="#destruction">4.8.3. Destruction</a></li>
<li><a href="#errors">4.8.4. Errors</a></li>
<li><a href="#mutability">4.8.5. Mutability</a></li>
<li><a href="#compactness">4.8.6. Compactness</a></li>
<li><a href="#ownership">4.8.7. Ownership</a></li>
<li><a href="#access-types">4.8.8. Access types</a></li>
<li><a href="#inheritance">4.8.9. Inheritance</a></li>
</ul>
</li>
<li><a href="#subtypes">4.9. Subtypes</a>
<ul class="sectlevel3">
<li><a href="#range-subtypes">4.9.1. Range subtypes</a></li>
<li><a href="#size-subtypes">4.9.2. Size subtypes</a></li>
<li><a href="#real-subtypes">4.9.3. Real subtypes</a></li>
<li><a href="#saturating-subtypes">4.9.4. Saturating subtypes</a></li>
<li><a href="#character-subtypes">4.9.5. Character subtypes</a></li>
<li><a href="#text-subtypes">4.9.6. Text subtypes</a></li>
<li><a href="#memory-access-subtypes">4.9.7. Memory access subtypes</a></li>
</ul>
</li>
<li><a href="#type-interface">4.10. Type interface</a>
<ul class="sectlevel3">
<li><a href="#information-hiding">4.10.1. Information hiding</a></li>
<li><a href="#direct-implementation">4.10.2. Direct implementation</a></li>
<li><a href="#data-inheritance">4.10.3. Data inheritance</a></li>
<li><a href="#indirect-implementation">4.10.4. Indirect implementation</a></li>
<li><a href="#delegation">4.10.5. Delegation</a></li>
<li><a href="#attributes-implementation">4.10.6. Attributes implementation</a></li>
<li><a href="#generic-implementations">4.10.7. Generic implementations</a></li>
<li><a href="#attribute-error-checking">4.10.8. Attribute error checking</a></li>
<li><a href="#exposed-details">4.10.9. Exposed details</a></li>
</ul>
</li>
<li><a href="#transfers">4.11. Transfers</a>
<ul class="sectlevel3">
<li><a href="#assignment">4.11.1. Assignment</a></li>
<li><a href="#copy">4.11.2. Copy</a></li>
<li><a href="#move">4.11.3. Move</a></li>
<li><a href="#computing-assignment">4.11.4. Computing assignment</a></li>
<li><a href="#binding">4.11.5. Binding</a></li>
<li><a href="#name-parameters">4.11.6. Name parameters</a></li>
<li><a href="#attributes">4.11.7. Attributes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#programming-paradigms">5. Programming paradigms</a>
<ul class="sectlevel2">
<li><a href="#object-oriented-programming">5.1. Object-oriented programming</a>
<ul class="sectlevel3">
<li><a href="#type-interface-2">5.1.1. Type interface</a></li>
<li><a href="#class-interface">5.1.2. Class interface</a></li>
<li><a href="#class-implementation">5.1.3. Class implementation</a></li>
<li><a href="#direct-derivation">5.1.4. Direct derivation</a></li>
<li><a href="#indirect-derivation">5.1.5. Indirect derivation</a></li>
<li><a href="#dynamic-dispatch-2">5.1.6. Dynamic dispatch</a></li>
<li><a href="#multiple-dispatch">5.1.7. Multiple dispatch</a></li>
</ul>
</li>
<li><a href="#functional-programming">5.2. Functional programming</a></li>
<li><a href="#generic-programming">5.3. Generic programming</a></li>
<li><a href="#design-by-contract">5.4. Design by contract</a></li>
<li><a href="#distributed-programming">5.5. Distributed programming</a></li>
<li><a href="#aspect-oriented-programming">5.6. Aspect-oriented programming</a></li>
<li><a href="#logic-programming">5.7. Logic programming</a></li>
<li><a href="#declarative-programming">5.8. Declarative programming</a></li>
<li><a href="#reactive-programming">5.9. Reactive programming</a></li>
<li><a href="#synchronous-programming">5.10. Synchronous programming</a></li>
</ul>
</li>
<li><a href="#compiling-xl">6. Compiling XL</a>
<ul class="sectlevel2">
<li><a href="#normal-representation">6.1. Normal representation</a></li>
<li><a href="#machine-representation">6.2. Machine representation</a></li>
<li><a href="#closures-representation">6.3. Closures representation</a></li>
<li><a href="#type-representation">6.4. Type representation</a></li>
<li><a href="#discriminated-types">6.5. Discriminated types</a></li>
<li><a href="#compiling-variable-sized-types">6.6. Compiling variable-sized types</a></li>
<li><a href="#constrained-types">6.7. Constrained types</a></li>
<li><a href="#dynamic-dispatch-3">6.8. Dynamic dispatch</a></li>
</ul>
</li>
<li><a href="#basic-operations">7. Basic operations</a></li>
<li><a href="#modules">8. Modules</a></li>
<li><a href="#standard-library">9. Standard Library</a>
<ul class="sectlevel2">
<li><a href="#garbage-collection">9.1. Garbage collection</a></li>
</ul>
</li>
<li><a href="#history-of-xl">10. History of XL</a>
<ul class="sectlevel2">
<li><a href="#it-started-as-an-experimental-language">10.1. It started as an experimental language</a></li>
<li><a href="#lx-an-extensible-language">10.2. LX, an extensible language</a></li>
<li><a href="#lx-meet-xroma">10.3. LX, meet Xroma</a></li>
<li><a href="#xl-moves-to-the-off-side-rule">10.4. XL moves to the off-side rule</a></li>
<li><a href="#concept-programming">10.5. Concept programming</a></li>
<li><a href="#mozart-and-moka-adding-java-support-to-xl">10.6. Mozart and Moka: Adding Java support to XL</a></li>
<li><a href="#innovations-in-2000-vintage-xl">10.7. Innovations in 2000-vintage XL</a></li>
<li><a href="#xl0-and-xl2-reinventing-the-parse-tree">10.8. XL0 and XL2: Reinventing the parse tree</a></li>
<li><a href="#bootstrapping-xl">10.9. Bootstrapping XL</a></li>
<li><a href="#xl2-compiler-plugins">10.10. XL2 compiler plugins</a></li>
<li><a href="#xl2-internal-use-of-plugins-the-translation-extension">10.11. XL2 internal use of plugins: the <code>translation</code> extension</a></li>
<li><a href="#switching-to-dynamic-code-generation">10.12. Switching to dynamic code generation</a></li>
<li><a href="#translating-using-only-tree-rewrites">10.13. Translating using only tree rewrites</a></li>
<li><a href="#tao3d-interactive-3d-graphics-with-xl">10.14. Tao3D, interactive 3D graphics with XL</a></li>
<li><a href="#elfe-distributed-programming-with-xl">10.15. ELFE, distributed programming with XL</a></li>
<li><a href="#xl-gets-a-type-system">10.16. XL gets a type system</a></li>
<li><a href="#the-llvm-catastrophy">10.17. The LLVM catastrophy</a></li>
<li><a href="#repairing-and-reconverging">10.18. Repairing and reconverging</a></li>
<li><a href="#language-redefinition">10.19. Language redefinition</a></li>
<li><a href="#future-work">10.20. Future work</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>XL is an extensible programming language, designed to accomodate a
variety of programming needs with ease.</p>
</div>
<div class="paragraph">
<p>Being <em>extensible</em> means that the language is designed to make it very
easy for programmers to adapt the language to suit their needs, for
example by adding new programming constructs. In XL, extending the
language is a routine and safe operation, much like adding a function or
creating a class in more traditional programming languages.
This extensibility is demonstrated by the fact that operations that
are built-in in other programming languages, such as integer
arithmetic, basic types or loops, are part of the
<a href="#standard-library">standard library</a> in XL.</p>
</div>
<div class="paragraph">
<p>As a consequence of this extensibility, XL is intended to be suitable
for programming tasks ranging from the simplest to the most complex,
from documents and application scripting, as illustrated by
<a href="https://tao3d.sf.net">Tao3D</a>, to compilers, as illustrated by the XL2
<a href="http://github.com/c3d/xl/blob/master/xl2/native">self-compiling compiler</a> to distributed
programming, as illustrated by <a href="https://github.com/c3d/elfe">ELFE</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
XL is a work in progress. Even if there are some bits and
pieces that happen to already work, and even if there were fully
functioning releases like the XL version used in
<a href="https://tao3d.sf.net">Tao3D</a> in the past, XL is presently in a long process of
being totally reworked and overhauled. As a result, the compiler in
this repository is presently not suitable for any serious
programming. Examples given below may sometimes simply not work. Take
it as a painful reminder that the work is far from finished, and, who
knows, as an idea for a contribution. See <a href="#history-of-xl">HISTORY</a>
for how we came to the present mess. The <a href="http://github.com/c3d/xl/blob/master/README.md">README</a>
gives a quick overview of the language.
</td>
</tr>
</table>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect1">
<h2 id="introduction-to-xl"><a class="anchor" href="#introduction-to-xl"></a><a class="link" href="#introduction-to-xl">1. Introduction to XL</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Extensible? What does that mean for a programming language? For XL, it
really means three things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>XL offers a standard way to extend the
language with many kinds of features, not just
functions or data types, but also programming constructs,
optimizations, domain-specific notations, and
more. Actually, all this is done with a
<a href="#one-operator-to-rule-them-all">single operator</a>, <code>is</code>, called
the <em>definition operator</em>.</p>
</li>
<li>
<p>As a validation of the concept, most features that are built-in in
other programming languages, like the <code>while</code> loop, or integer arithmetic, are <em>constructed</em> in XL. Specifically, they are provided by
the <a href="#the-standard-library">standard library</a>, using techniques that
any programmer can use in their program. This proves by example that
programmers can add their own program constructs, their own
machine-level data types, from scratch or by extending existing ones.</p>
</li>
<li>
<p>XL provides <a href="#efficient-translation">complete control</a> over the
program translation process. This means that libraries
exist or can be written to make XL at least as good as C for
low-level bit-twiddling, at least as good as C&#43;&#43; for generic algorithms, at least as good as Ada for tasking, at least as
good as Fortran for numerical algorithms, at least as good as
Java for distributed programming, and so on.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This may all seem too good to be true. This document explains how the
magic happens. But first of all, one thing that really matters: XL is
supposed to be <em>simple</em>. Let’s start with a few well-known examples to
prove this.</p>
</div>
<div class="sect2">
<h3 id="two-basic-examples"><a class="anchor" href="#two-basic-examples"></a><a class="link" href="#two-basic-examples">1.1. Two basic examples</a></h3>
<div class="paragraph">
<p>It is practically compulsory to begin the presentation of any
programming language with a
<a href="https://en.wikipedia.org/wiki/%22Hello,_World!%22_program">"Hello
World"</a> example, immediately followed by a a
recursive definition of the
<a href="https://en.wikipedia.org/wiki/Factorial">factorial function</a>. Let’s
follow this long honored tradition.</p>
</div>
<div class="sect3">
<h4 id="hello-world"><a class="anchor" href="#hello-world"></a><a class="link" href="#hello-world">1.1.1. Hello World</a></h4>
<div class="paragraph">
<p>In XL, a program that prints <code>Hello World</code> on the terminal console
output will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">use XL.CONSOLE.TEXT_IO
print "Hello World"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line <em>imports</em> the <code>XL.CONSOLE.TEXT_IO</code>
<a href="#modules">module</a>.  The program can then use the <code>print</code>
function from that module to write the text on the terminal console.</p>
</div>
<div class="paragraph">
<p>Why do we need the <code>use</code> statement? There is a general rule in XL
that you only pay for things that you use. Not all programs will use a
terminal console, so the corresponding functions must be explicitly
imported into a program. It is possible that some systems, like
embedded systems, don’t even have a terminal console. On such a
system, the corresponding module would not be available, and the
program would properly fail to compile.</p>
</div>
<div class="paragraph">
<p>What is more interesting, though, is the definition of <code>print</code>. That
definition is <a href="#the-case-of-text-input-output-operations">discussed
below</a>, and you will see that it is quite simple, in particular when
compared with similar input/output operations in languages such
as C&#43;&#43;.</p>
</div>
<div class="paragraph">
<p>Another interesting, if slightly more complicated version of "Hello
World" is one written in the <a href="https://tao3d.sf.net">Tao3D</a> dialect
of XL that produces this result:</p>
</div>
<div class="videoblock">
<div class="title">Hello World in Tao3D</div>
<div class="content">
<iframe width="800" height="600" src="https://www.youtube.com/embed/6WIMWlUZJvs?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<details>
<summary class="title">Source code for the Tao3D "Hello World"</summary>
<div class="content">
<div class="paragraph">
<p>The source code for this example can be found below. The Tao3D dialect
of XL still uses <code>-&gt;</code> instead of <code>is</code> as the definition
operator. Apart from that change, the following code is valid XL for
the language described in this document.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">color "white"
milkyway 10000
rotatez -23
earth 400
hello_world 440

milkyway R -&gt;
// ----------------------------------------------------------------------------
//    Draw the Milky Way
// ----------------------------------------------------------------------------
    locally
        texture_wrap true, true
        texture_transform {scale 5, 5, 5}
        texture "milkyway.jpg"
        rotatey 0.02 * page_time + 100
        scale 1, -1, 1
        sphere R


earth R -&gt;
// ----------------------------------------------------------------------------
//    Draw Earth
// ----------------------------------------------------------------------------
    locally
        texture "earth.bmp"
        texture_wrap true, true
        rotatey 5 * page_time + 250
        sphere 0, 0, 0, R


hello_world R -&gt;
// ----------------------------------------------------------------------------
//    Draw "hello world" text
// ----------------------------------------------------------------------------
    locally
        frame_texture 1900, 600,
            color 1, 1, 1, 1
            reset_transform
            // If font Arial Unicode installed, it will be used.
            // Otherwise, unifont will be used (unifont is packaged
            // with Tao presentations).
            font "Arial Unicode MS", "unifont", 72
            move_to -800, -9, 0
            text "Hello World! or Καλημέρα κόσμε; or こんにちは 世界"
        rotatey -11 * page_time + 180
        color 20% , 20% , 20% , 70%
        sphere 0, 0, 0, R - 30
        color 100% , 90% , 20% , 90%
        sphere 0, 0, 0, R</code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="factorial"><a class="anchor" href="#factorial"></a><a class="link" href="#factorial">1.1.2. Factorial</a></h4>
<div class="paragraph">
<p>A program computing the <a href="https://en.wikipedia.org/wiki/Factorial">factorial</a>
of numbers between 1 and 5, and then showing them on the console, can
be written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">use IO = XL.CONSOLE.TEXT_IO

0! is 1
N! is N * (N-1)!

for I in 1..5 loop
    IO.print "The factorial of ", I, " is ", I!</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have used an alternative form of the <code>use</code> statement, where the
imported module is given a local nick-name, <code>IO</code>. This form is useful
when it’s important to avoid the risk of name collisions between
modules. In that case, the programmer need to refer to the <code>print</code>
function of the module as <code>IO.print</code>.</p>
</div>
<div class="paragraph">
<p>The definition of the factorial function shows how expressive XL is,
making it possible to use the well-known notation for the factorial
function. The definition consists in two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the special case of the factorial of <code>0</code> is defined as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">0! is 1</code></pre>
</div>
</div>
</li>
<li>
<p>the general case is defined as follows, and involves a recursion in
the form of the <code>(N-1)!</code> expression:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">N! is N * (N-1)!</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>That definition would not detect a problem with something like <code>-3!</code>. The
second form would match, and presumably enter an infinite recursion that would
exhaust available stack space. It is possible to fix that problem by
indicating that the definition only works for positive numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">0!              is 1
N!  when N &gt; 0  is N * (N-1)!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Writing the code that way will ensure that there is a compile-time error
for code like <code>-3!</code>, because there is no definition that matches.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="one-operator-to-rule-them-all"><a class="anchor" href="#one-operator-to-rule-them-all"></a><a class="link" href="#one-operator-to-rule-them-all">1.2. One operator to rule them all</a></h3>
<div id="definition" class="paragraph">
<p>XL has a single fundamental operator, <code>is</code>, called the <em>definition operator</em>. It is an <a href="#infix">infix operator</a> with a
<a href="#pattern">pattern</a> on the left and an
<a href="#implementation">implementation</a> on the right. In other words,
the pattern for the infix <code>is</code> is <code>Pattern is Implementation</code>, where
<code>Pattern</code> is a program pattern, like <code>X+Y</code>, and <code>Implementation</code> is an
implementation for that pattern, for example <code>Add X, Y</code>. This operator
can also be read as <em>transforms into</em>, i.e. it transforms the code
that is on the left into the code that is on the right.</p>
</div>
<div class="paragraph">
<p>This single operator can be used to define all kinds of entities.</p>
</div>
<details>
<summary class="title">Simple variables or constants</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Define pi as a numerical constant
pi              is      3.1415926</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Lists  or data structures</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Define a constant list and a constant array
funny_words     is      "xylophage", "zygomatic", "barfitude"
identity_matrix is
    [ [1, 0, 0],
      [0, 1, 0],
      [0, 0, 1] ]</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Functions </summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Define the 'abs' function in a generic way for all numbered ordered types
abs X           is      if X &lt; 0 then -X else X</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Operators </summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Define a not-equal operator using unicode sign
X ≠ Y           is      not (X = Y)</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Specializations for particular inputs </summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Factorial definition requires a specialization for case 0!
0!              is      1
N!  when N &gt; 0  is      N * (N-1)!</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Notations using arbitrary combinations of operators </summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Check if value A is in interval B..C
A in B..C       is      A &gt;= B and A &lt;= C</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Optimizations using specializations </summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Optimize various common cases for arithmetic
X * 1           is      X
X + 0           is      X
X - X           is      0
X / X when X≠0  is      1</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Program structures </summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Define an infinite loop using recursion
loop Body       is      { Body; loop Body }</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Types</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Define a 'complex' type with either polar or cartesian representation
type complex    is polar or cartesian
type cartesian  matches cartesian(re:number, im:number)
type polar      matches polar(mod:number, arg:number)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="#types">types</a> in XL indicate the shape of parse trees. In
other words, the <code>cartesian</code> type above will match any parse tree that
takes the shape of the word <code>cartesian</code> followed by two numbers, like
for example <code>cartesian(1,5)</code>.
</td>
</tr>
</table>
</div>
</div>
</details>
<details>
<summary class="title">Higher-order functions, i.e. functions that return functions </summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// A function that returns a function
adder N         is      { lambda X is N + X }
add3            is      ( adder 3 )

 // This will compute 8
 add3 5</code></pre>
</div>
</div>
<div class="paragraph">
<p>The notation <code>lambda X</code>, which can also be written <code>\X</code>, is inspired by
<a href="https://en.wikipedia.org/wiki/Lambda_calculus">lambda calculus</a>. It makes
it possible to create <a href="#pattern">patterns</a> that match entire
expressions. In other words, <code>X is 0</code> defines a name, and only the
expression <code>X</code> matches that definition, whereas <code>\X is 0</code> defines a
"catch-all" pattern that will match <code>35</code> or <code>"ABC"</code>. This <em>lambda
notation</em> can be used to build something that behaves almost exactly
like an <em>anonymous function</em> in functional languages, although the way
it actually works internally is <a href="#scoping">still based on pattern
matching</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The current implementations of XL special-case single-defintion
contexts, and <code>lambda</code> can be omitted in that case. In a normal context,
<code>X is Y</code> defines a name <code>X</code>, but it did not seem very useful to have
single-definition contexts defining only a name. The above example could
have been written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">adder N is (X is N + X)</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, this is not consistent with the rest of the language, and
<code>lambda</code> will be required in future implementations.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</details>
<details>
<summary class="title">Maps that associate a key to a value </summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Spelling numbers in English
number_spelling is
    0           is "zero"
    1           is "one"
    2           is "two"
    3           is "three"
    4           is "four"
    5           is "five"
    6           is "six"
    7           is "seven"
    8           is "eight"
    9           is "nine"
    10          is "ten"
    11          is "eleven"
    12          is "twelve"
    13          is "thirteen"
    14          is "fourteen"
    15          is "fifteen"
    16          is "sixteen"
    17          is "seventeen"
    18          is "eighteen"
    19          is "nineteen"
    20          is "twenty"
    30          is "thirty"
    40          is "forty"
    50          is "fifty"
    60          is "sixty"
    70          is "seventy"
    80          is "eighty"
    90          is "ninety"
    lambda N when N mod 100 = 0 and N &lt; 2000 is
        number_spelling[N/100] &amp; "hundred"
    lambda N when N mod 1000 = 0 is
        number_spelling[N/1000] &amp; "thousand"
    lambda N when N &lt; 100 is
        number_spelling[N/10] &amp; " " &amp; number_spelling[N mod 10]
    lambda N when N &lt; 1000 is
        number_spelling[N/100] &amp; "hundred and " &amp; number_spelling[N mod 100]
    lamdba N when N &lt; 1e6 is
        number_spelling[N/1000] &amp; "thousand " &amp; number_spelling[N mod 1000]
    lambda N when N mod 1e6 = 0 is
        number_spelling[N/1e6] &amp; "million"
    lambda N when N &lt; 1e9 is
        number_spelling[N/1e6] &amp; "million " &amp; number_spelling[N mod 1e6]
    lambda N when N mod 1e9 = 0 is
        number_spelling[N/1e9] &amp; "billion"
    lambda N when N &lt; 1e9 is
        number_spelling[N/1e9] &amp; "billion " &amp; number_spelling[N mod 1e9]

// This will return "twelve thousand one hundred and seventy three"
number_spelling[12173]</code></pre>
</div>
</div>
<div class="paragraph">
<p>With simple value, XL maps provide a functionality roughly equivalent
to <code>std::map</code> in C.  However, it’s really nothing more than a
regular function with a number of special cases, and it is a much more
general kind of mapping that C, as the <code>lambda N</code> example above
demonstrates. Like for all functions, the compiler can optimize
special kinds of mapping to provide an efficient implementation, for
example if all the indexes are contiguous integers.</p>
</div>
</div>
</details>
<details>
<summary class="title">Templates (C++ terminology) or generic code (Ada terminology)</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// An (inefficient) implementation of a generic 1-based array type

// array[1] of T, start of the recurrence
array[1] of T is
    // Implementation stores one variable value of type T
    Tail : T
    1 is Value

// array[N] of T: defined based on array[N-1] of T
array[N] of T when N &gt; 1 is
    // Implemenation is a two-parter for Head and Tail
    Head  : array[N-1] of T
    Tail  : T
    lambda I when I&lt;N is Head[I]
    lambda I when I=N is Tail

// Usage looks exactly like a regular array in another language
A : array[5] of integer
for I in 1..5 loop
    A[I] := I * I</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Variadic functions</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// A general implementation of minimum
min X, Y    is { mX is min X; mY is min Y; if mX &lt; mY then mX else mY }
min X       is X

// Computes 4
min 7, 42, 20, 8, 4, 5, 30</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>In short, the single <code>is</code> operator covers all the kinds of declarations
that are found in other languages, using a single, easy to read syntax.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-standard-library"><a class="anchor" href="#the-standard-library"></a><a class="link" href="#the-standard-library">1.3. The standard library</a></h3>
<div class="paragraph">
<p>Each programming language offers a specific set of features, which
are characteristic of that language. Most languages offer integer
arithmetic, floating-point arithmetic, comparisons, boolean logic,
text manipulation (often called "<em>strings</em>"), but also programming
constructs such as loops, tests, and so on.</p>
</div>
<div class="paragraph">
<p>XL provides most features programmers are used to, but they are
defined in the XL <em>standard library</em>, not by the compiler. The
standard library is guaranteed to be present in all implementations
and behave identically. However, it is written using only tools that
are available to a regular developer, not just to compiler writers.</p>
</div>
<div class="sect3">
<h4 id="usual-programming-features"><a class="anchor" href="#usual-programming-features"></a><a class="link" href="#usual-programming-features">1.3.1. Usual programming features</a></h4>
<div class="paragraph">
<p>Definitions in the standard library include common fixtures of
programming that are built-in in other languages, in particular
well-known programming constructs such as loops, tests,
and so on.</p>
</div>
<div class="paragraph">
<p>For example, the <em>if statement</em> in XL is defined in the standard
library as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">if [[true]]  then TrueClause else FalseClause   is TrueClause   <i class="conum" data-value="1"></i><b>(1)</b>
if [[false]] then TrueClause else FalseClause   is FalseClause
if [[true]]  then TrueClause                    is TrueClause
if [[false]] then TrueClause                    is false</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A value between two square brackets, as in <code>[[true]]</code> and
<code>[[false]]</code>, is called a <a href="#metabox">metabox</a>.
It indicates that the pattern must match the actual values in the
metabox. In other words, <code>foo true is ...</code> defines a pattern with a
formal parameter named <code>true</code>, whereas <code>foo [[true]] is ...</code> defines a
pattern which only matches when the argument is equal to constant
<code>true</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similarly, the <code>while</code> loop is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">while Condition loop Body is
    if Condition then
        Body
        while Condition loop Body</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the definitions above, programmers can then use <code>if</code> and <code>while</code>
in their programs much like they would in any other programming
language, as in the following code that verifies the
<a href="https://en.wikipedia.org/wiki/Collatz_conjecture">Syracuse conjecture</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">while N &lt;&gt; 1 loop
    if N mod 2 = 0 then
        N /= 2
    else
        N := N * 3 + 1
    print N</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the-next-natural-evolutionary-step"><a class="anchor" href="#the-next-natural-evolutionary-step"></a><a class="link" href="#the-next-natural-evolutionary-step">1.3.2. The next natural evolutionary step</a></h4>
<div class="paragraph">
<p>Moving features to a library is a natural evolution for
programming languages. Consider for example the case of text I/O
operations. They used to be built-in for early languages such
as BASIC’s <code>PRINT</code> or Pascal’s <code>WriteLn</code>, but they moved to the
library in later languages such as C with <code>printf</code>. As a result, C has
a much wider variety of I/O functions. The same observation can be
made on text manipulation and math functions, which were all built-in
in BASIC, but all implemented as library functions in C. For tasking,
Ada has built-in construct, C has the <code>pthread</code> library. And so on.</p>
</div>
<div class="paragraph">
<p>Yet, while C moved a very large number of things to libraries, it still
did not go all the way. The meaning of <code>x+1</code> in C is defined strictly by
the compiler. So is the meaning of <code>x/3</code>, even if some implementations
that lack a hardware implementation of division have to make a call to
a library function to actually implement that code.</p>
</div>
<div class="paragraph">
<p>C&#43;&#43; went one step further than C, allowing programmers to
<em>overload</em> operators, i.e. redefine the meaning of an operation
like <code>X+1</code>, but only for custom data types, and only for already
existing operators. In C&#43;&#43;, a programmer cannot <em>create</em> the
<em>spaceship operator</em> <code>&lt;=&gt;</code> using the standard language mechanisms.
It has to be implemented in the compiler. The spaceship operator has to be
<a href="http://open-std.org/JTC1/SC22/WG21/docs/papers/2017/p0515r0.pdf">added
to the language by compiler writers</a>, and it takes a 35-pages article
to discuss the implications. This takes time and a large effort, since
all compiler writers must implement the same thing.</p>
</div>
<div class="paragraph">
<p>By contrast, all it takes in XL to implement <code>&lt;=&gt;</code> in a variant that
always returns <code>-1</code>, <code>0</code> or <code>1</code> is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X &lt;=&gt; Y     when X &lt; Y  is -1
X &lt;=&gt; Y     when X = Y  is  0
X &lt;=&gt; Y     when X &gt; Y  is  1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this also requires a syntax file defining the precedence of the operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">INFIX 290 &lt;=&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, C&#43;&#43; makes it extremely difficult to optimize
away an expression like <code>X*0</code>, <code>X*1</code> or <code>X+0</code> using only standard
programming techniques, whereas XL makes it extremely easy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X*0     is 0
X*1     is X
X+0     is X</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, C&#43;&#43; also makes it very difficult to deal with expressions
containing multiple operators. For example, many modern CPUs feature a
form of
<a href="https://en.wikipedia.org/wiki/Multiply–accumulate_operation#Fused_multiply–add">fused multiply-add</a>, which has benefits that include performance and
precision. Yet C&#43;&#43; will not allow you to overload <code>X*Y+Z</code> to
use this kind of operations. In XL, this is not a problem at all:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X*Y+Z   is FusedMultiplyAdd(X,Y,Z)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In other words, the XL approach represents the next logical
evolutionary step for programming languages along a line
already followed by highly-successful ancestors.</p>
</div>
</div>
<div class="sect3">
<h4 id="benefits-of-moving-features-to-a-library"><a class="anchor" href="#benefits-of-moving-features-to-a-library"></a><a class="link" href="#benefits-of-moving-features-to-a-library">1.3.3. Benefits of moving features to a library</a></h4>
<div class="paragraph">
<p>Putting basic features in the standard library, as opposed to keeping
them in the compiler, has several benefits:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Flexibility: It is much easier to offer a
large number of behaviors and to address special cases.</p>
</li>
<li>
<p>Clarity: The definition given in the library gives a very clear and
machine-verifiable description of the operation.</p>
</li>
<li>
<p>Extensibility: If the library definition is
not sufficient, it is possible to add what you need. It will behave
exactly as what is in the library. If it proves useful enough, it
may even make it to the standard library in a later iteration of the
language.</p>
</li>
<li>
<p>Fixability: Built-in mechanisms, such as
library versioning, make it possible to
address bugs without breaking existing code, which can still use
an earlier version of the library.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The XL standard library consists of a <a href="http://github.com/c3d/xl/blob/master/native/lib">wide variety of
modules</a>. The top-level module is called <code>XL</code>, and sub-modules are
categorized in a hierarchy. For example, if you
need to perform computations on complex numbers, you would <code>use
XL.MATH.COMPLEX</code> to load the
<a href="http://github.com/c3d/xl/blob/master/native/lib/xl/math/complex.xs">complex numbers module</a></p>
</div>
<div class="paragraph">
<p>The <a href="http://github.com/c3d/xl/blob/master/src/builtins.xl">library builtins</a> is a list of definitions
that are accessible to any XL program without any explicit <code>use</code>
statement. This includes most features that you find in languages such
as C, for example integer arithmetic or loops. Compiler options make it
possible to load another file instead, or even to load no file at all,
in which case you need to build everything from scratch.</p>
</div>
</div>
<div class="sect3">
<h4 id="the-case-of-text-input-output-operations"><a class="anchor" href="#the-case-of-text-input-output-operations"></a><a class="link" href="#the-case-of-text-input-output-operations">1.3.4. The case of text input / output operations</a></h4>
<div class="paragraph">
<p>Input/output operations (often abbreviated as I/O) are a fundamental
brick in most programming languages. In general, I/O operations are
somewhat complex. If you are curious, the source code for the venerable
<code>printf</code> function in C is
<a href="https://github.com/lattera/glibc/blob/master/stdio-common/vfprintf.c">available
online</a>.</p>
</div>
<div id="print" class="paragraph">
<p>The implementation of text I/O in XL is comparatively very simple. The
definition of <code>print</code> looks something like, where irrelevant
implementation details were elided as <code>&#8230;&#8203;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">to write X:text         is ... <i class="conum" data-value="1"></i><b>(1)</b>
to write X:integer      is ...
to write X:real         is ...
to write X:character    is ...
to write [[true]]       is { write "true"  } <i class="conum" data-value="2"></i><b>(2)</b>
to write [[false]]      is { write "false" }
to write Head, Rest     is { write Head; write Rest }

to print                is { write SOME_NEWLINE_CHARACTER }
to print Items          is { write Items; print }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>to</code> that precedes <code>write</code> is <a href="#syntactic-sugar">syntactic sugar</a> for
procedures named after an English verb. It implicitly marks the procedure as
having the <code>ok</code> <a href="#fallible-types">fallible type</a>. In other words, it
indicates that <code>write</code> can return <code>nil</code> or an <code>error</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>[[true]]</code> notation is called a <a href="#metabox">metabox</a>,
and indicates that we must match the value of the expression
in the metabox, in that case, <code>true</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is an example of <em>variadic function definition</em> in XL. In
other words, <code>print</code> can take a variable number of arguments, much
like <code>printf</code> in C. You can write multiple comma-separated items in a
<code>print</code>. For example, consider the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">print "The value of X is ", X, " and the value of Y is ", Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>That would first call the last definition of <code>print</code> with the following
<a href="#binding">binding</a> for the variable <code>Items</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Items   is "The value of X is ", X, " and the value of Y is ", Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>This in turn is passed to <code>write</code>, and the definition that matches is
<code>write Head, Rest</code> with the following bindings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Head    is "The value of X is "
Rest    is X, " and the value of Y is ", Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that case, <code>write Head</code> will directly match <code>write X:text</code> and write
some text on the console. On the other hand, <code>write Rest</code> will need to
iterate once more through the <code>write Head, Rest</code> definition, this time
with the following bindings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Head    is X
Rest    is " and the value of Y is ", Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>The call to <code>write Head</code> will then match one of the implementations of
<code>write</code>, depending on the actual type of <code>X</code>. For example, if <code>X</code> is an
integer, then it will match with <code>write X:integer</code>. Then the last split
occurs for <code>write Rest</code> with the following bindings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Head    is " and the value of Y is "
Rest    is Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>For that last iteration, <code>write Head</code> will use the <code>write X:text</code>
definition, and <code>write Rest</code> will use whatever definition of <code>write</code>
matches the type of <code>Y</code>.</p>
</div>
<div class="paragraph">
<p>All this can be done at compile-time. The generated code can then be
reused whenever the combination of argument types is the same. For
example, if <code>X</code> and <code>Y</code> are <code>integer</code> values, the generated code could
be used for the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">print "The sum is ", X+Y, " and the difference is ", X-Y</code></pre>
</div>
</div>
<div id="print_instances" class="paragraph">
<p>This is because the sequence of types is the same. Everything happens as
if the above mechanism had created a series of additional definition
that looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">to print A:text, B:integer, C:text, D:integer is
    write A, B, C, D
    print

to write A:text, B:integer, C:text, D:integer is
    write A
    write B, C, D

to write B:integer, C:text, D:integer is
    write B
    write C, D

to write C:text, D:integer is
    write C
    write D</code></pre>
</div>
</div>
<div class="paragraph">
<p>All these definitions are then available as shortcuts whenever the
compiler evaluates future function calls.</p>
</div>
<div class="paragraph">
<p>The <code>print</code> function as defined above is both type-safe
 and extensible, unlike similar facilities found for
example in the C programming language.</p>
</div>
<div class="paragraph">
<p>It is type-safe because the compiler knows the type of each argument at
every step, and can check that there is a matching <code>write</code> function.</p>
</div>
<div class="paragraph">
<p>It is extensible, because additional definitions of <code>write</code> will be
considered when evaluating <code>write Items</code>. For example, if you add a
<code>complex</code> type similar to the one defined by the standard library, all
you need for that type to become "writable" is to add a definition of
<code>write</code> that looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">to write Z:complex      is write "(", Z.Re, ";", Z.Im, ")"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unlike the C&#43;&#43; <code>iostream</code> facility, the XL compiler will naturally emit
less code. In particular, it will need only one function call for every
call to <code>print</code>, calling the generated function for the given
combination of arguments. That function will in turn call other
generated functions, but the code sequence corresponding to a
particular sequence of arguments will be factored out between all the
call sites, minimizing code bloat.</p>
</div>
<div class="paragraph">
<p>Additionally, the approach used in XL makes it possible to offer
specific features for output lines, for example to ensure that a
single line is always printed contiguously even in a multi-threaded
scenario.  Assuming a <code>single_thread</code> facility
ensuring that the code is executed by at most one thread, creating a
<code>print</code> that executes only in one thread at a time is nothing more than:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">to print_in_single_thread Items is
    single_thread
         print Items</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is extremely difficult, if not impossible, to achieve a similar effect with
C&#43;&#43; <code>iostream</code> or, more generally, with I/O facilities that perform one call
per I/O item. That’s because there is no efficient way for the compiler to
identify where the "line breaks" are in your code.</p>
</div>
<div class="paragraph">
<p>Similarly, the C semantics enforce that a line is represented by a
terminating "new-line" character. This is not the only way to represent
lines. For example, each line could be a distinct block of memory, or a
different record on disk. The semantics of XL does not preclude such
implementations, which can sometimes perform much better.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="efficient-translation"><a class="anchor" href="#efficient-translation"></a><a class="link" href="#efficient-translation">1.4. Efficient translation</a></h3>
<div class="paragraph">
<p>Despite being very high-level, XL was designed so that efficient translation to machine code was possible, if sometimes
challenging. In other words, XL is designed to be able to work as a
<em>system language</em>, in the same vein as C, Ada or Rust, i.e. a
language that can be used to program operating systems, system
libraries, compilers or other low-level
applications.</p>
</div>
<div class="paragraph">
<p>For that reason, nothing in the semantics of XL mandates complex
behind-the-scene activites, like garbage collection, thread safety, or even memory management. As for other aspects of the
language, any such activity has to be provided by the library. You
only pay for it if you actually use it. In other words, the only
reason you’d ever get garbage collection in an XL program is if you
explicitly need it for your own application.</p>
</div>
<div class="paragraph">
<p>This philosophy sometimes requires the XL compiler to work extra hard
in order to be more than minimally efficient. Consider for example the
definition of the <code>while</code> loop
given above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">while Condition loop Body is
    if Condition then
        Body
        while Condition loop Body</code></pre>
</div>
</div>
<div class="paragraph">
<p>That definition can be used in your own code as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">while N &lt;&gt; 1 loop
    if N mod 2 = 0 then N /= 2 else N := N * 3 + 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>What happens is that the compiler looks at the code, and matches against
the definitions at its disposal. The <code>while</code> loop in the code matches
the form <code>while Condition loop Body</code>, provided you do the following
<a href="#binding">bindings</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Conditions is N &lt;&gt; 1
Body is
   if N mod 2 = 0 then N /= 2 else N := N * 3 + 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The definition for the <code>while Condition loop Body</code> form is then
evaluated with the above bindings, in other words, the code below then
needs to be evaluated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">    if Condition then
        Body
        while Condition loop Body</code></pre>
</div>
</div>
<div class="paragraph">
<p>Conceptually, that is extremely simple. Getting this to work well is
of course a little bit complicated. In particular, the definition ends
with another reference to <code>while</code>. If the compiler naively generates a
<em>function call</em> to implement a form like that, executing that code
would likely run out of stack space for loops with a large number
of iterations. A special optimization
called <em>tail call elimination</em> is required to ensure the expected
behavior, namely the generation of a machine branch instruction
instead of a machine call instruction.</p>
</div>
<div class="paragraph">
<p>Furthermore, the reference implementation is just that, a
reference. The compiler is perfectly allowed, even encouraged, to
"cheat", i.e. to recognize common idioms, and efficiently translate
them. One name, <code>builtin</code>, is reserved for that purpose. For example,
the definition of integer addition may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X:integer + Y:integer as integer    is builtin "Add"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The left part of <code>is</code> here is perfectly standard XL. It tells the
compiler that an expression like <code>X+Y</code> where both <code>X</code> and <code>Y</code> have the
<code>integer</code> type will result in an <code>integer</code> value (that is the meaning of
<code>as integer</code>). The implementation, however, is not given. Instead, the
<code>builtin "Add"</code> tells the compiler that it has a cheat sheet for that
operations, called <code>Add</code>. How this cheat sheet is actually implemented
is not specified, and depends on the compiler. The name of builtins is machine
dependent, and is represented as text so as to allow for arbitrary syntax.</p>
</div>
</div>
<div class="sect2">
<h3 id="adding-complex-features"><a class="anchor" href="#adding-complex-features"></a><a class="link" href="#adding-complex-features">1.5. Adding complex features</a></h3>
<div class="paragraph">
<p>Features can be added to the language that go beyond a simple notation.
This can also be done in XL, although this may require a little bit of
additional work. This topic cannot be covered extensively here. Instead,
examples from existing implementations will provide hints of how this
can happen.</p>
</div>
<div class="sect3">
<h4 id="reactive-programming-in-tao3d"><a class="anchor" href="#reactive-programming-in-tao3d"></a><a class="link" href="#reactive-programming-in-tao3d">1.5.1. Reactive programming in Tao3D</a></h4>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Reactive_programming">Reactive programming</a>
is a form of programming designed to facilitate the propagation of
changes in a program. It is particularly useful to react to changes in a
user interface.</p>
</div>
<div class="paragraph">
<p><a href="https://tao3d.sf.net">Tao3D</a> added reactive programming to XL to deal
with user-interface events, like mouse movements or keyboard input.
This is achieved in Tao3D using a combination of <em>partial re-evaluation</em>
of programs in response to <em>events</em> sent by functions that depend
on user-interface state.</p>
</div>
<div class="paragraph">
<p>For example, consider the following Tao3D program to draw the hands of a
clock (see complete <a href="https://youtu.be/apy5csu0DkE">YouTube tutorial</a> for
more details):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">locally
    rotate_z -6 * minutes
    rectangle 0, 100, 15, 250

locally
    rotate_z -30 * hours
    rectangle 0, 50, 15, 150

locally
    color "red"
    rotate_z -6 * seconds
    rectangle 0, 80, 10, 200</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>locally</code> function controls the scope of partial
re-evaluation.  Time-based functions like <code>minutes</code>, <code>hours</code>
or <code>seconds</code> return the minutes, hours and seconds of the current
time, respectively, but also trigger a time event each time they
change. For example, the <code>hours</code> function will trigger a time event
every hour.</p>
</div>
<div class="paragraph">
<p>The <code>locally</code> function controls partial re-evaluation of the code within
it, and caches all drawing-related information within it in a structure
called a <em>layout</em>. There is also a top-level layout for anything created
outside of a <code>locally</code>.</p>
</div>
<div class="paragraph">
<p>The first time the program is evaluated, three layouts are created by
the three <code>locally</code> calls, and populated with three rectangles (one of
them colored in red), which were rotated along the Z axis (perpendicular
to the screen) by an amount depending on time. When, say, the <code>seconds</code>
value changes, a time event is sent by <code>seconds</code>, which is intercepted
by the enclosing <code>locally</code>, which then re-evaluated its contents, and
then sends a redraw event to the enclosing layout. The two other layouts
will use the cached graphics, without re-evaluating the code under
<code>locally</code>.</p>
</div>
<div class="paragraph">
<p>All this can be implemented entirely within the constraints of the
normal XL evaluation rules. In other words, the language did not have to
be changed in order to implement Tao3D.</p>
</div>
</div>
<div class="sect3">
<h4 id="declarative-programming-in-tao3d"><a class="anchor" href="#declarative-programming-in-tao3d"></a><a class="link" href="#declarative-programming-in-tao3d">1.5.2. Declarative programming in Tao3D</a></h4>
<div class="paragraph">
<p>Tao3D also demonstrates how a single language can be used to define
documents in a way that feels declarative like a declarative language,
i.e. similar to HTML, but still offers the power of imperative programming
like JavaScript, as well as style sheets reminiscent of CSS. In other
words, Tao3D does with a single language, XL, what HTML5 does with
three.</p>
</div>
<div class="paragraph">
<p>For example, an interactive slide in Tao3D would be written
using code like this (note that Tao3D uses <code>import</code> instead of <code>use</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">import Slides

slide "The XL programming language",
    * "Extensible"
    * "Powerful"
    * "Simple"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can easily be mis-interpreted as being a mere markup language,
something similar to <a href="https://en.wikipedia.org/wiki/Markdown">markdown</a>,
which is one reason why I sometimes refer to XL as an <em>XML without the
M</em>.</p>
</div>
<div class="paragraph">
<p>However, the true power of XL can more easily be shown by adding the
clock defined previously, naming it <code>clock</code>, and then using it in the
slide. This introduces the dynamic aspect that Javascript brings to
HTML5.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">import Slides

clock is
    locally
        line_color "blue"
        color "lightgray"
        circle 0, 0, 300

    locally
        rotate_z -6 * minutes
        rectangle 0, 100, 15, 250

    locally
        rotate_z -30 * hours
        rectangle 0, 50, 15, 150

    locally
        color "red"
        rotate_z -6 * seconds
        rectangle 0, 80, 10, 200

slide "The XL programming language",
    * "Extensible"
    * "Powerful"
    * "Simple"
    anchor
        translate_x 600
        clock</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to illustrate how <a href="#pattern-matching">pattern matching</a>
provides a powerful method to define styles, one can add the following
definition to the program in order to change the font for the titles
(more specifically, to change the font for the "title" layouts of all
themes and all slide masters):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">theme_font Theme, Master, "title" is font "Palatino", 80, italic</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of this program is an animated slide that looks like the
following:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/Tao3D-clock.png" alt="Animated clock"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="distributed-programming-with-elfe"><a class="anchor" href="#distributed-programming-with-elfe"></a><a class="link" href="#distributed-programming-with-elfe">1.5.3. Distributed programming with ELFE</a></h4>
<div class="paragraph">
<p><a href="https://github.com/c3d/elfe">ELFE</a> is another XL-based experiment
targeting distributed programming, notably for the Internet of things.
The idea was to use the <a href="#homoiconic">homoiconic</a> aspect of XL
to evaluate parts of the program on different machines, by sending the
relevant program fragments and the associated data over the wire for
remote evaluation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
ELFE is now integrated as part of XL, and the ELFE demos are
stored in the <a href="http://github.com/c3d/xl/blob/master/demo">demo</a> directory of XL.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This was achieved by adding only four relatively simple XL functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tell</code> sends a program to another node in a "fire and forget" way,
not expecting any response.</p>
</li>
<li>
<p><code>ask</code> evaluates a remote program that returns a value, and returns
that value to the calling program.</p>
</li>
<li>
<p><code>invoke</code> evaluates a remote program, establishing a two-way
communication with the remote that the remote can use with <code>reply</code>.</p>
</li>
<li>
<p><code>reply</code> allows remote code within an <code>invoke</code> to evaluate code in its
original caller’s context, but with access to all the local variables
declared by the remote.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider the <a href="http://github.com/c3d/xl/blob/master/demo/7-two-hops.xl">following program</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">WORKER_1 is "pi2.local"
WORKER_2 is "pi.local"

invoke WORKER_1,
   every 1.1s,
        rasp1_temp is
            ask WORKER_2,
                temperature
        send_temps rasp1_temp, temperature

   send_temps T1:real, T2:real is
       if abs(T1-T2) &gt; 2.0 then
           reply
               show_temps T1, T2

show_temps T1:real, T2:real is
    print "Temperature on pi is ", T1, " and on pi2 ", T2, ". "
    if T1&gt;T2 then
        print "Pi is hotter by ", T1-T2, " degrees"
    else
        print "Pi2 is hotter by ", T2-T1, " degrees"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This small program looks like a relatively simple control script.
However, the way it runs is extremely interesting.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>This single program actually runs on three different machines, the
original controller, as well as two machines called <code>WORKER_1</code> and
<code>WORKER_2</code>.</p>
</li>
<li>
<p>It still looks and feels like a single program. In particular,
variables, values and function calls are passed around machines almost
transparently. For example</p>
<div class="ulist">
<ul>
<li>
<p>the computation <code>T1-T2</code> in <code>send_temps</code> is performed on <code>WORKER_1</code>…</p>
</li>
<li>
<p>… using a value of <code>T1</code> that actually came from <code>WORKER_2</code> through the
<code>ask</code> statement in <code>rasp1_temp</code>.</p>
</li>
<li>
<p>Whenever the <code>reply</code> code is executed, variable <code>T1</code> and <code>T2</code> live on
<code>WORKER_1</code>…</p>
</li>
<li>
<p>… but within the <code>reply</code>, they are passed transparently as arguments
in order to call <code>show_temps</code> on the controller.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Communication occurs primarily between <code>WORKER_1</code> and <code>WORKER_2</code>,
which exchange a message every 1.1s. Communication with the controller
only occurs if and when necessary. If the controller resides in Canada
and the workers in Australia, this can save substantial networking
costs.</p>
</li>
<li>
<p>A single <code>temperature</code> function, with an extremely simple
implementation, provides an remarkably rich set of remotely-accessible
features that might require a very complex API in other languages.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This last point is worth insisting on. The following program uses the
same function to compute the minimum, maximum and average temperature on
the remote node. Nothing was changed to the temperature API. The
computations are performed efficiently by the remote node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">invoke "pi.local",
    min   is 100.0
    max   is 0.0
    sum   is 0.0
    count is 0

    compute_stats T:real is
        min   := min(T, min)
        max   := max(T, max)
        sum   := sum + T
        count := count + 1
        reply
            report_stats count, T, min, max, sum/count

    every 2.5s,
        compute_stats temperature

report_stats Count, T, Min, Max, Avg is
    print "Sample ", Count, " T=", T, " ",
          "Min=", Min, " Max=", Max, " Avg=", Avg</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The definitions of <code>min</code>, <code>max</code>, <code>sum</code> and <code>count</code> would not be
acceptable in the version of XL described in this document. You would
need to write for example <code>min : real := 100</code> instead of <code>min is 100.0</code>,
since <code>min is 100.0</code> would declare a constant.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To run the ELFE demos, you need to start an XL server on the machines
called <code>pi.local</code> and <code>pi2.local</code>, using the <code>-remote</code> command-line
option of XL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">% xl -remote</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then run the program on a third machine with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">% xl 7-two-hops.xl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Like for Tao3D, the implementation of these functions is not very
complicated, and more importantly, it did not require any kind of change
to the basic XL evaluation rules. In other words, adding something as
sophisticated as transparently distributed programming to XL can be done
by practically any programmer, without changing the compiler.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="xl-syntax"><a class="anchor" href="#xl-syntax"></a><a class="link" href="#xl-syntax">2. <a id="syntax"></a>XL syntax</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>For programmers familiar with other programming languages, the
syntax of XL may not seem very innovative at first, and that is
intentional. Most programmers should be able to read and write correct
XL code in a matter of minutes.</p>
</div>
<div class="paragraph">
<p>The first noticable thing is a disturbing lack of all these nice
semi-random punctuation characters that have decorated programs since
the dawn of computing and make most source code look like an ornate form
of line noise to the uninitiated. Where are all the parentheses gone?
Why this horrible lack of curly braces? How can you make sense of a
program without a semi-colon to
<a href="https://en.wikipedia.org/wiki/Comparison_of_programming_languages_(syntax)#Statements">terminate
or separate</a> statements?</p>
</div>
<div class="paragraph">
<p>In reality, the difference between XL syntax and earlier programming
languages is much more than skin deep. The syntax of XL is actually one
of its most unique characteristics. The design of the XL syntax is
essential to understand both the philosophy and implementation of the
whole language.</p>
</div>
<div class="sect2">
<h3 id="homoiconic-representation-of-programs"><a class="anchor" href="#homoiconic-representation-of-programs"></a><a class="link" href="#homoiconic-representation-of-programs">2.1. <a id="homoiconic"></a>Homoiconic representation of programs</a></h3>
<div class="paragraph">
<p>XL is a <a href="https://en.wikipedia.org/wiki/Homoiconicity">homoiconic
language</a>, meaning that all XL programs are data and
conversely. This makes it particularly easy for programs to manipulate
programs, an approach sometimes referred to as
<em>metaprogramming</em>. Metaprogramming is the foundation upon which the
touted extensibility of XL is built.</p>
</div>
<div class="sect3">
<h4 id="why-lisp-remains-so-strong-to-this-day"><a class="anchor" href="#why-lisp-remains-so-strong-to-this-day"></a><a class="link" href="#why-lisp-remains-so-strong-to-this-day">2.1.1. Why Lisp remains so strong to this day</a></h4>
<div class="paragraph">
<p>In that respect, XL is very much inspired by one of the earliest and
most enduring high-level programming languages,
<a href="https://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a>. The
earliest implementations of Lisp date back to 1958, yet that language
remains surprisingly modern and flourishing today, unlike languages of
that same era like <a href="https://en.wikipedia.org/wiki/COBOL">Cobol</a> or
<a href="https://en.wikipedia.org/wiki/Fortran">Fortran</a>.</p>
</div>
<div class="paragraph">
<p>One reason for Lisp’s endurance is the metaprogramming capabilities
deriving from homoiconicity. If you want to add a feature to Lisp, all
you need is to write a program that translates Lisp programs with the
new feature into previous-generation Lisp programs. This kind of
capability made it much easier to add
object-oriented programming
<a href="https://en.wikipedia.org/wiki/Common_Lisp_Object_System">to Lisp</a> than
to languages like C: neither <a href="https://en.wikipedia.org/wiki/C%2B%2B">C++</a>
nor <a href="https://en.wikipedia.org/wiki/Objective-C">Objective C</a> were
implemented as just another C library, and there was a reason for
that. Unlike Lisp, C is not extensible.</p>
</div>
<div class="paragraph">
<p>Despite its strengths, Lisp remains confined to specific markets, in
large part because to most programmers, the language remains
surprisingly alien to this day, even garnering such infamous nicknames
as "<em>Lots of Insipid and Stupid Parentheses</em>". As seen from a
<a href="#concept-programming">concept programming</a> point of view, the
underlying problem is that the Lisp syntax departs from the usual
notations as used by human beings. For example, adding 1 and 2 is
written <code>1+2</code> in XL, like in most programming languages, but <code>(+ 1 2)</code>
in Lisp. In concept programming, this notational problem is called
<em>syntactic noise</em>.</p>
</div>
<div class="paragraph">
<p>XL addresses this problem by putting human usability first. In that
sense, it can be seen as an effort to make the power of Lisp more
accessible. That being said, XL is quite a bit more than just Lisp
with a new fancy and programmer-friendly syntax.</p>
</div>
</div>
<div class="sect3">
<h4 id="the-xl-parse-tree"><a class="anchor" href="#the-xl-parse-tree"></a><a class="link" href="#the-xl-parse-tree">2.1.2. <a id="parse-tree"></a>The XL parse tree</a></h4>
<div class="paragraph">
<p>The XL syntax is much <em>simpler</em> than that of languages such as C, and
arguably not really more complicated than the syntax of Lisp. The
<a href="http://github.com/c3d/xl/blob/master/src/parser.cpp">parser</a> for XL is less than 800 lines of
straightforward C&#43;&#43; code, and the <a href="http://github.com/c3d/xl/blob/master/src/scanner.cpp">scanner</a>
barely adds another 900 lines. By contrast, the
<a href="https://github.com/gcc-mirror/gcc/blob/master/gcc/c/c-parser.c">C parser</a>
in GCC needs more than 20000 lines of code, which is about the size of a
complete XL interpreter, and the
<a href="https://github.com/gcc-mirror/gcc/blob/master/gcc/cp/parser.c">C++ parser</a>
is over twice as much!</p>
</div>
<div class="paragraph">
<p>A key to keeping things really simple is that the XL syntax is
<em>dynamic</em>. Available operators and their precedence are <em>configured</em>
primarily through a <a href="http://github.com/c3d/xl/blob/master/src/xl.syntax">syntax file</a>. As a result,
there are no hard-coded keywords or special operators in the XL
compiler.</p>
</div>
<div class="paragraph">
<p>All XL programs can be represented with a very simple tree structure,
called a <em>parse tree</em>. The XL parse tree contains <em>leaf nodes</em>
that don&#8217;t have any children, such as integer, real, text
or symbol nodes, and <em>inner nodes</em> that have at least
one child node, such as infix, prefix, postfix and
block nodes. In general, when a node can have children, these
children can be of any kind.</p>
</div>
<div class="paragraph">
<p>Leaf nodes contain values that are atomic as far as XL is concerned:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a id="integer"></a><code>integer</code> nodes represent non-negative whole numbers
like <code>1234</code>, <code>2#1001</code> or <code>16#FFFE_FFFF</code>.</p>
</li>
<li>
<p><a id="real"></a><code>real</code> nodes represent a floating-point approximation of
real numbers like <code>1.234</code>, <code>1.5e-10</code> or <code>2#1.0001_0001#e24</code>.</p>
</li>
<li>
<p><a id="character"></a><code>character</code> nodes represent individual characters, like <code>'A'</code>.</p>
</li>
<li>
<p><a id="text"></a><code>text</code> nodes represent text values like <code>"Hello world"</code></p>
</li>
<li>
<p><a id="symbols"></a><code>symbols</code> nodes regroup names like <code>JOHN_DOE</code> and symbols like <code>+=</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Inner nodes contains combinations of other XL nodes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a id="infix"></a><code>infix</code> nodes represent two operands separated by a name or operator,
like <code>A+B</code> or <code>X and Y</code>. Infix nodes with a "new line" name are used
for separate program lines.</p>
</li>
<li>
<p><a id="prefix"></a><code>prefix</code> nodes represent two nodes where the operand follows the
operator, like <code>+A</code> or <code>sin X</code>.</p>
</li>
<li>
<p><a id="postfix"></a><code>postfix</code> nodes represent two nodes where the operator follows the
operand, like <code>3%</code> or <code>45km</code>.</p>
</li>
<li>
<p><a id="block"></a><code>block</code> nodes represent a node surrounded by two delimiters, like
<code>[a]</code>, <code>(a)</code>, <code>{a}</code>. Blocks are also used to represent indentation.
<a href="#indentation">code indentation</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example, let’s consider the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">if X &lt; 0 then
   print "The value of ", X, " is negative"
   X := -X</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming that this program is stored in a file called <code>program.xl</code>, the
XL parse tree for this program can be obtained by using the following
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">% xl -parse program.xl -style debug -show
(infixthen
 (prefix
  if
  (infix&lt;
   X
   0))
 (block indent
  (infix CR
   (prefix
    print
    (infix,
     "The value of "
     (infix,
      X
      " is negative"
     )))
   (infix:=
    X
    (prefix
     -
     X
    )))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>All of XL is built on this very simple <a href="#parse-tree-types">data structure</a>.
Some choices, like having distinct <code>integer</code> and <code>real</code> node, were
guided primarily by considerations beyond syntax, for example the need
to be able to precisely define <a href="#evaluation">program evaluation</a> or
to represent distinct machine types.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The list of node types given above is what the current implementations
of XL offer. Some changes may happen in the future, notably:</p>
</div>
<div id="bits" class="ulist">
<ul>
<li>
<p>Adding a "binary object" node type, which could be used to store
binary data in the program. A possible syntax would be to prefix
<code>bits</code> before a large integer value or file name:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">bits 16#FF_00_FF_00_FF_FF_00_FF_00
bits "image.png"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finding a better representation for empty blocks such as <code>()</code>.
In the current implementation, they are represented as a block with
an "empty symbol" as a child. With this choice, the parse tree has no
"null" node anywhere in the tree. However, this is not very
satisfactory, since the empty symbol cannot exist anywhere else in
the parse tree. Alternatives such as representing blocks as possibly
empty sequences of items have proven even more complicated, since the
representation of <code>[A,B,C]</code> becomes ambiguous (it could be a block
containing three elements, or a block containing two elements, one
of them being an infix, or any other combination), and proved more
difficult to process in a generic way.</p>
</li>
<li>
<p>Finding a more efficient representation for large sequences of items.
Currently, they are represented by an unbalanced tree, i.e. a tree
where one side is disproportionately larger than the other.
So far, attempts at finding a better representation all had at
least one severe drawback that precluded their use.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="leaf-nodes"><a class="anchor" href="#leaf-nodes"></a><a class="link" href="#leaf-nodes">2.2. Leaf nodes</a></h3>
<div class="paragraph">
<p>The leaf nodes in XL each have a uniquely identifable syntax.
For example, simply by looking at the sequence of characters, we can
tell that <code>42</code> is a whole number, <code>3.5</code> is a fractional number, <code>"ABC"</code>
is a text value, <code>'a'</code> is a character value, <code>ABC</code> is a name, and <code>-&gt;</code>
is an operator. This section describes the syntax for leaf nodes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is currently no provision in the compiler to add new kinds
of leaf nodes. This is being considered, and would require a minimal
addition to the syntax file. The primary implementation issue is that
it would require the syntax of the syntax file to diverge from the XL
syntax itself, since numbers or names in the syntax file have to be
"hardcoded" somehow
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="numbers"><a class="anchor" href="#numbers"></a><a class="link" href="#numbers">2.2.1. Numbers</a></h4>
<div class="paragraph">
<p>Numbers in XL begin with a digit, i.e. one of <code>0123456789</code>, possibly
followed by other digits. For example, <code>0</code> and <code>42</code> are valid XL
numbers. XL describes two kinds of numbers: <em>whole numbers</em>, which
have no fractional part, and <em>fractional numbers</em>, which have a
fractional part.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the rest of the document, other terminologies, such as
<em>integer</em> or <em>real</em> numbers may be applied for whole numbers and
fractional numbers respectively. This corresponds to numbers having
been given a <a href="#types">type</a> for evaluation purpose. This is notably
the case whenever a computer font is used, e.g. when we refer to
<code>integer</code> or <code>real</code> values. Except as far as syntax is concerned, this
document will very rarely talk about whole numbers or fractional
numbers.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A single underscore <code>_</code> character can be used to separate
digits, as in <code>1_000_000</code>, in order to increase readability. The
following are not valid XL numbers: <code>_1</code> (leading underscore),
<code>2_</code> (trailing underscore), <code>3__0</code> (two underscores). While this
is not a requirement, it is considered good style to group digits in
equal-sized chunks, for example <code>1_000_000</code> or <code>04_92_98_05_55</code>.</p>
</div>
<div class="paragraph">
<p>By default, numbers are written in base 10. Any other numerical base between 2 and 36 can be used, as well as base 64 using a
special syntax. Based numbers can be written by following the base
with the <code>#</code> sign. For example <code>8#76</code> is an octal representation
of <code>62</code>. For bases between 11 and 36, letters <code>A</code> through <code>Z</code> or <code>a</code> through
<code>z</code> represent digit values larger than 10, so that <code>A</code> is 10, <code>f</code>
is 15, <code>Z</code> is 35. Case does not matter. For example, <code>16#FF</code> and
<code>16#ff</code> are two valid hexadecimal representation of <code>255</code>.
For base 64, <a href="https://en.wikipedia.org/wiki/Base64">Base64</a> encoding is
used, and case matters. This is mostly indended for use in <a href="#bits">binary objects</a>, i.e. after <code>bits</code>. For instance, <code>64#SGVsbG8h</code> is the base-64
encoding for the number with the same binary representation as the
sequence of ASCII characters in <code>Hello!</code>.</p>
</div>
<div class="paragraph">
<p>For fractional numbers, a dot <code>.</code> is used as decimal separator,
and must separate digits. For example, <code>0.2</code> and <code>2.0</code> are valid but,
unlike in C, <code>.2</code> and <code>2.</code> are not numbers but a prefix and
postfix <code>.</code> respectively. This is necessary to avoid ambiguities.
Also, the standard library denotes <a href="#range">ranges</a> using
an infix <code>..</code>, so <code>2..3</code> is an infix <code>..</code> with <code>2</code> and <code>3</code> as
operands, representing the range between 2 and 3.</p>
</div>
<div class="paragraph">
<p>Numbers can contain an exponent, specified by the letter <code>e</code> or
<code>E</code>. If the exponent is negative, then the number is parsed as a
fractional number. Therefore, <code>1e3</code> is integer value 1000, but <code>1e-3</code>
is the same as <code>0.001</code>. The exponent is always given in base 10, and it
indicates an exponentiation in the given base, so that <code>2#1e8</code> is
2<sup>8</sup>, in other words decimal value 256. For based numbers, the
exponent may be preceded by a <code>#</code> sign, which is mandatory if <code>e</code> or
<code>E</code> are valid digits in the base. For example, <code>16#FF#e2</code> is an
hexadecimal representation of decimal value 65280.</p>
</div>
<div class="paragraph">
<p>There is an implementation-dependent limit for the maximum value a
number can have. This limit cannot be less than 2<sup>64</sup>-1 for
whole numbers, and less than <code>9.99e99</code> for floating-point numbers.</p>
</div>
<div class="paragraph">
<p>If a value is preceded by a <code>+</code> or <code>-</code> sign, that sign is parsed as a
prefix operator and not as part of the number. For example, <code>-2</code> is a
prefix <code>-</code> with <code>2</code> as an argument.</p>
</div>
<div class="paragraph">
<p>The various syntactic possibilities for XL numbers are only for
convenience, and are all strictly equivalent as far as program execution
is concerned. In other words, a program may not behave differently if a
constant is spelled as <code>16#FF_FF</code> or as <code>65535</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
One unsatisfactory aspect of XL number syntax is that it does not
offer an obvious path to correctly represent "semantic" version
numbers in the code. For example, a notation like <code>2.3.1</code> will parse as
an infix <code>.</code> between real number <code>2.3</code> and integer <code>1</code>, making it
indistinguishable from <code>2.30.1</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Computers cannot really represent mathematical numbers. For
example, the set of natural numbers is infinite, so there is no such
thing as "the largest natural number". Due to hardware limitations,
there is however such a thing as the largest 64-bit unsigned number.
Similarly, there is no way to accurately represent real numbers in a
computer, but there are at least two widely used representations
called
<a href="https://en.wikipedia.org/wiki/Floating_point">floating-point</a> and
<a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic">fixed-point</a>.</p>
</div>
<div class="paragraph">
<p>From a <a href="#concept-programming">concept programming</a> point of view,
this is a blatant case of <a href="#concept-cast">concept cast</a>. A computer
<code>integer</code> is not a mathematical <em>integer</em>, and a computer <code>real</code> is
only a floating-point or fixed-point approximation of a true <em>real
number</em>. In the rest of this document, we will ignore this
distinction, and refer to a <code>real</code>, knowing full well that there is a
"largest" <code>real</code> value and a limited number of digits.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="symbols-2"><a class="anchor" href="#symbols-2"></a><a class="link" href="#symbols-2">2.2.2. Symbols</a></h4>
<div class="paragraph">
<p>Names in XL begin with an letter, followed by letters or digits. For
example, <code>MyName</code> and <code>A22</code> are valid XL names.  A single underscore
<code>_</code> can be used to separate two valid characters in a name. Therefore,
<code>A_2</code> is a valid XL name, but <code>A__2</code> and <code>_A</code> are not.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The current implementation reads its input in Unicode UTF-8
format, and makes crude attempts at accepting Unicode. This was good
enough for Tao3D to deal with multi-lingual text, including in languages
such as Hebrew or Arabic. However, that implementation is a bit naive
with respect to distinguishing  Unicode letters from non-letter characters.
For example, <code>𝝿_2</code> or <code>étalon</code> are valid XL names, and this is intentional,
but <code>⇒A2</code> is presently a valid XL name, and this is considered a bug.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Case and delimiters are not significant in XL, so that <code>JOE_DALTON</code> and
<code>JoeDalton</code> are treated identically.</p>
</div>
<div class="paragraph">
<p>Operators begin with one of the ASCII punctuation characters:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>! # $ % &amp; ( ) * + , - . / : ; &lt; = &gt; ? @ [ \ ] ^ _ ` { | } ~</pre>
</div>
</div>
<div class="paragraph">
<p>Operators longer than one character must be specified in the XL syntax
file. For example, the XL syntax file defines a <code>&lt;=</code> operator, but no
<code>&lt;=&gt;</code> operator. Consequently, the sequence <code>1 &lt;=&gt; 2</code> will be parsed as
<code>(1 &lt;= (&gt; 2))</code>. In order to add this operator, it is necessary to
<a href="#extending-the-syntax">extend the syntax</a>.</p>
</div>
<div class="paragraph">
<p>Names and operators are treated interchangeably by XL after the parsing
phase, and are collectively called <em>symbols</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="text-2"><a class="anchor" href="#text-2"></a><a class="link" href="#text-2">2.2.3. Text</a></h4>
<div class="paragraph">
<p>Text in XL is delimited with a pair of single
or double quotes. Text can contain any printable character.
For example, <code>"Hello World"</code> or <code>'ABC'</code> are valid text in XL. If the
delimiter is needed in the text, it can be obtained by doubling
it. For example, <code>"He said ""Hello"""</code> is text containing <code>He said
"Hello"</code>.</p>
</div>
<div class="paragraph">
<p>Additionally, the XL <a href="#syntax-file">syntax file</a> can specify
delimiters for "long" text. Long text can include
line-terminating characters, and only terminates when the matching
delimiter is reached. By default, <code>&lt;&lt;</code> and <code>&gt;&gt;</code> are long-text
delimiters, so that the following is valid text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">MyLongText is &lt;&lt;
   This is a multi-line text
   that contains several lines
&gt;&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional delimiters can be configured, and can
be used to define specific types of text. For example, a program that
often has to manipulate HTML data could allow <code>HTML</code> and
<code>END_HTML</code> as delimiters, so that you could write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">MyHTML is HTML
    &lt;p&gt;This is some HTML text here&lt;/p&gt;
END_HTML</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> The reason for a built-in format for text using
single or double quotes is because the <a href="#syntax-file">syntax file</a>
is read using the standard XL parser, and it needs text tokens in some
specific cases that would otherwise parse incorrectly such as block or
comment delimiters.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="inner-nodes"><a class="anchor" href="#inner-nodes"></a><a class="link" href="#inner-nodes">2.3. Inner nodes</a></h3>
<div class="paragraph">
<p>The inner nodes are defined by the <a href="#syntax-file">syntax file</a>,
which specifies their precedence and associativity.</p>
</div>
<div class="sect3">
<h4 id="indentation-and-off-side-rule"><a class="anchor" href="#indentation-and-off-side-rule"></a><a class="link" href="#indentation-and-off-side-rule">2.3.1. <a id="indentation"></a>Indentation and off-side rule</a></h4>
<div class="paragraph">
<p>Indentation in XL is significant. XL follows the
<em>off-side rule</em> to define program blocks. There is no need for
keywords such as <code>begin</code> and <code>end</code>, nor for block delimiters such as
<code>{</code> or <code>}</code>. However, <code>{</code> and <code>}</code> can be used as block
delimiters when needed, for example to create a
block on a single line. The code below shows two equivalent ways to
write the same loop:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">loop { Eat; Pray; Love }
loop
    Eat
    Pray
    Love</code></pre>
</div>
</div>
<div class="paragraph">
<p>The two ways to write the loop above are not just functionally equivalent.
They also share the same parse tree structure, the only difference
being the operators being used. For example, <code>A;B</code> is an infix <code>;</code>
with <code>A</code> on the left and <code>B</code> on the right, whereas individual lines
are operands of an infix <em>new-line</em> operator. Similarly, <code>{A}</code> is a
block containing <code>A</code>, and indentation is represented in the parse tree
by a block delimited by <em>indent</em> and <em>outdent</em> invisible symbols.</p>
</div>
<div class="paragraph">
<p>The structure of the second loop from the previous listing can be
shown by the XL compiler using the <code>-show</code> option, as illustrated
below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">% xl -parse loop.xl -style debug -show
(prefix
 loop
 (block indent
  (infix CR
   Eat
   (infix CR
    Pray
    Love
   ))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Indentation must use the same indentation character within a
single file, either tab or space. In other words, either your
whole file is indented with tabs, or it is indented with spaces, but
it is a syntax error to mix both.</p>
</div>
<div class="paragraph">
<p>Indentation within a block must be consistent. For example, the
following code will cause a syntax error because of the incorrect
indentation of <code>Pray</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">loop
    Eat
   Pray
    Love</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="operator-precedence-and-associativity"><a class="anchor" href="#operator-precedence-and-associativity"></a><a class="link" href="#operator-precedence-and-associativity">2.3.2. <a id="syntax-file"></a>Operator precedence and associativity</a></h4>
<div class="paragraph">
<p>The operators available for XL programmers are defined by the
<a href="http://github.com/c3d/xl/blob/master/src/xl.syntax">syntax file</a>. The same rules apply for all
symbols, i.e. for names or for operators. The table given in this file
uses keywords such as <code>INFIX</code>, <code>PREFIX</code> and <code>POSTFIX</code> to indicate if
an operator is an infix, a prefix, or a postfix respectively.</p>
</div>
<div class="paragraph">
<p>The table also gives operators a precedence. For example, the following
segment in the <code>INFIX</code> portion of the table indicates that <code>*</code> and <code>/</code>
have higher precedence than <code>+</code> and <code>-</code>, so that <code>X+Y*Z</code> will parse as
<code>X+(Y*Z)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">        21      -&gt; is has
        310     + -
        320     * / mod rem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The precedence also indicates associativity for infix operators. Even
precedences indicate left associativity, as for <code>+</code> and <code>*</code> above. This
means that <code>X * Y * Z</code> parses as <code>(X * Y) * Z</code>. Conversely,
right-associativity is indicated by an odd precedence, as is the case
for <code>is</code>. This means that <code>X is Y is Z</code> parses as <code>X is (Y is Z)</code>.</p>
</div>
<div class="paragraph">
<p>Enforcing different precedences for left and right associativity
guarantees that it’s impossible for operators to have the same
precedence, with some being left-associative and some being
right-associative, which would cause parsing ambiguities.</p>
</div>
<div class="paragraph">
<p>The syntax file uses a few special names:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INFIX</code>, <code>PREFIX</code>, <code>POSTFIX</code> and <code>BLOCK</code> introduce sections that
declare the operators of the respective types.</p>
</li>
<li>
<p><code>COMMENT</code> and <code>TEXT</code> specify delimiters for comments and long text
respectively.</p>
</li>
<li>
<p><code>SYNTAX</code> introduces a child syntax. It is followed by the name of a
syntax file, and then by an opening and closing symbol for that syntax.</p>
</li>
<li>
<p><code>BINARY</code> specifies the names that introduce binary data. The default
syntax file uses <code>bits</code>. The syntax for binary data can take one of two
forms: either a very large integer constant in big-endian format, as in
<code>bits 16#000102030405060708090A0B0C0D0E0F</code>, or the name of a file, as in
<code>bits "image.png"</code>.</p>
</li>
<li>
<p><code>NEWLINE</code> is used to represent the infix operators that separates
individual source code lines.</p>
</li>
<li>
<p><code>STATEMENT</code> is the precedence that delimits
<a href="#expression-vs-statement">expressions from statements</a>. Any
operator with a lower precedence belongs to a statement, like <code>if</code> or
<code>loop</code>. Any operator with a higher precedence belongs to an expression,
like <code>+</code> or <code>*</code>.</p>
</li>
<li>
<p><code>DEFAULT</code> is the default precedence for names and symbols. It is not
very important in practice.</p>
</li>
<li>
<p><code>FUNCTION</code> is the precedence for names and symbols used as a prefix
when they are not explicitly listed in the file. If you write <code>sin X</code>
for example, the associated precedence will be that of <code>FUNCTION</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="delimiters"><a class="anchor" href="#delimiters"></a><a class="link" href="#delimiters">2.3.3. Delimiters</a></h4>
<div class="paragraph">
<p>Additional sections of the syntax file define delimiters for comment,
block and text. Comment and text delimiters come in pairs.</p>
</div>
<div class="paragraph">
<p>The default syntax file specifies comments that follow the C/C&#43;&#43;
convention, i.e. comments either start with <code>/*</code> and end with <code>*/</code> or
start with <code>//</code> and end with a new line. The basic text separators
(simple and double quotes) are not specified in the syntax file
because they are used to parse the syntax file itself. The default
syntax file adds <code>&lt;&lt;</code> and <code>&gt;&gt;</code> as separators for multi-line text..</p>
</div>
<div class="paragraph">
<p>Block separators come in pairs and have a priority. The special names
<code>INDENT</code> and <code>UNINDENT</code> are used for the indentation block. The block
priority is used to give the priority of the block in an expression, but
also to determine if the block contains an expression or a statement.</p>
</div>
<div class="paragraph">
<p>In the default syntax file, indentation blocks and blocks delimited by
curly braces <code>{ }</code> contain statements, whereas blocks delimited by
parentheses <code>( )</code> or square brackets <code>[ ]</code> will contain expressions.</p>
</div>
</div>
<div class="sect3">
<h4 id="child-syntax"><a class="anchor" href="#child-syntax"></a><a class="link" href="#child-syntax">2.3.4. Child syntax</a></h4>
<div class="paragraph">
<p>A syntax file can define a child syntax file, which overrides the syntax
when a given symbol is found.</p>
</div>
<div class="paragraph">
<p>The <a href="http://github.com/c3d/xl/blob/master/src/xl.syntax">default syntax file</a> contains a
<a href="http://github.com/c3d/xl/blob/master/src/C.syntax">child syntax</a> named <code>C</code> which is activated between
the <code>extern</code> name and a following semi-colon <code>;</code>. This is used to
approximate C-style parsing for extern declarations, making it easier to
reference C code from XL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">extern real sqrt(real);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The so-called "C syntax" in XL is only a very crude and limited
approximation of the actual C syntax, which is only intended for
relatively simple function declarations.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="extending-the-syntax"><a class="anchor" href="#extending-the-syntax"></a><a class="link" href="#extending-the-syntax">2.3.5. <a id="syntax-statements"></a>Extending the syntax</a></h4>
<div class="paragraph">
<p>In addition the to the default syntax provided by the
<a href="http://github.com/c3d/xl/blob/master/src/xl.syntax">syntax file</a>, modules can also supply a <code>.syntax</code> file
providing the precedence of the operators that this module adds.</p>
</div>
<div class="paragraph">
<p>For example, if you want to add the spaceship operator <code>&lt;=&gt;</code> in your
program, and give the same precedence as <code>&lt;=</code>, namely 290, you could
write a <code>spaceship</code> module with a <code>spaceship.syntax</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">INFIX 290 &lt;=&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="making-the-syntax-easy-for-humans"><a class="anchor" href="#making-the-syntax-easy-for-humans"></a><a class="link" href="#making-the-syntax-easy-for-humans">2.4. Making the syntax easy for humans</a></h3>
<div class="paragraph">
<p>XL contains a couple of tweaks designed specifically to make code easier
to read or write by humans. When the human logic is subtle, so is the XL
compiler parsing…</p>
</div>
<div class="sect3">
<h4 id="expression-vs-statement"><a class="anchor" href="#expression-vs-statement"></a><a class="link" href="#expression-vs-statement">2.4.1. Expression vs. statement</a></h4>
<div class="paragraph">
<p>This first tweak is intended to put in XL an implicit grammatical
grouping that humans apparently do. Consider for example the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">print sin X, cos Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most human beings parse this as <code>print (sin(X),cos(Y))</code>, i.e. we call
<code>print</code> with two values resulting from evaluating <code>sin X</code> and <code>cos Y</code>.</p>
</div>
<div class="paragraph">
<p>This is, however, not entirely logical. If <code>print</code> takes comma-separated
arguments, why wouldn’t <code>sin</code> also take comma-separated arguments? In
other words, why doesn’t this parse as <code>print(sin(X, cos(Y))</code>?</p>
</div>
<div class="paragraph">
<p>This shows that humans have a notion of <em>expressions</em> vs. <em>statements</em>.
Expressions such as <code>sin X</code> have higher priority than commas and require
parentheses if you want multiple arguments. By contrast, statements such
as <code>print</code> have lower priority, and will take comma-separated argument
lists. An indent or <code>{ }</code> block begins a statement, whereas parentheses
<code>()</code> or square brackets <code>[]</code> begin an expression.</p>
</div>
<div class="paragraph">
<p>There are rare cases where the default rule will not achieve the desired
objective, and you will need additional parentheses. One important such
case is what follow <code>is</code> if it is not a block. Consider the following
declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">debug X     is write "X=", X
expm1 X     is exp X - 1
double X    is X; X</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first example parses as intended, as a statement. The second one,
however, is not, despite being syntactically similar. On could want to
see this parse as <code>(exp X) -1</code>, but in reality, it parses as <code>exp (X-1)</code>
for the same reason that the line above parses as <code>write ("X=", X)</code>.
Another issue occurs with the body of <code>double X</code>, because it actually
only contains the first <code>X</code>. The <code>;</code> operator has lower precedence
than <code>is</code>, which is useful for <a href="#scoping">maps</a>, but does not
achieve the expected effect above.</p>
</div>
<div class="paragraph">
<p>The solution to these problems is use a block on the right of <code>is</code> in
all these cases. The correct way to write the above code is therefore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">debug X     is { write "X=", X } <i class="conum" data-value="1"></i><b>(1)</b>
expm1 X     is ( exp X - 1 )  <i class="conum" data-value="2"></i><b>(2)</b>
double X    is { X; X } <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The curly braces indicate that we expect <code>write</code> to be a statement.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The parentheses indicate that we expect <code>exp</code> to be an expression.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The curly braces ensure that we interpret the sequence as the body
of <code>double X</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A quality implementation of XL should probably warn if a prefix
is seen on the right of <code>is</code> and has an infix as an
argument. Expressions such as <code>type X</code> or <code>foo(A,B,C)</code> do not present
a risk, but expressions such as <code>foo A-1</code> do represent present a risk,
and should always be written in a block.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="infix-vs-prefix"><a class="anchor" href="#infix-vs-prefix"></a><a class="link" href="#infix-vs-prefix">2.4.2. infix vs. prefix</a></h4>
<div class="paragraph">
<p>Another special rule is that XL will use the presence of a space on only
one side of an operator to disambiguate between an infix or a prefix.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">write -A    // write (-A)
B - A       // (B - A)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="xl-program-evaluation"><a class="anchor" href="#xl-program-evaluation"></a><a class="link" href="#xl-program-evaluation">3. <a id="evaluation"></a>XL program evaluation</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>XL defines <em>program execution</em> primarily in terms of operations on the
parse tree combined with operations on an implicit <em>context</em> that stores
the program state. The context itself is also described in XL in order
to define the expected result of evaluation.</p>
</div>
<div class="paragraph">
<p>For efficiency, actual implementations are unlikely to store everything
as an actual parse tree, although there is an <em>interpreter</em>
implementation that does exactly that. A compiler is more likely to
<a href="#compiled-representations">optimize representations</a> of both code
and data, as long as that optimized representation ultimately respect
the semantics described using the normal form for the parse tree.</p>
</div>
<div class="sect2">
<h3 id="execution-phases"><a class="anchor" href="#execution-phases"></a><a class="link" href="#execution-phases">3.1. Execution phases</a></h3>
<div class="paragraph">
<p>Executing an XL program is the result of three phases,</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <a href="#parsing-phase">parsing phase</a> where program source text is
converted to a parse tree,</p>
</li>
<li>
<p>A <a href="#declaration-phase">declaration phase</a>, where all declarations
are stored in the context,</p>
</li>
<li>
<p>An <a href="#evaluation-phase">evaluation phase</a>, where statements other
than declarations are processed in order.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The execution phases are designed so that in a very large number of
cases, it is at least conceptually possible to do both the parsing and
declaration phases ahead of time, and to generate machine code that can
perform the evaluation phase using only representations of code and data
<a href="#compiled-representations">optimized</a> for the specific machine
running the program. It should be possible to create an efficient
ahead-of-time compiler for XL. Work is currently in progress to build
one.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Reasonably efficient compilers were produced for earlier
generations of the language, notably as part of the Tao3D project.
However, this earlier iteration of the language had a very weak type
system that made advanced optimizations hard to achieve. This was
actually a feature for Tao3D, which purposely disabled some
optimizations in order to improve compilation speed, notably when the
program structure did not change. The version of XL described in this
document, however, has markedly evolved relative to what was implemented
in Tao3D, with the hope that much better code quality can be achieved.
This part has not been demonstrated yet.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="execution-context"><a class="anchor" href="#execution-context"></a><a class="link" href="#execution-context">3.1.1. Execution context</a></h4>
<div class="paragraph">
<p>The execution of XL programs is defined by describing the evolution of a
particular data structure called the <em>execution context</em>, or simply
<em>context</em>, which stores all values accessible to the program at any
given time.</p>
</div>
<div class="paragraph">
<p>That data structure is only intended to explain the effect of evaluating
the program. It is not intended to be a model of how things are actually
implemented. As a matter of fact, care was taken in the design of XL to
allow standard compilation and optimization techniques to remain
applicable, and to leave a lot of freedom regarding actual evaluation
techniques.</p>
</div>
<div class="paragraph">
<p>In the examples below, <code>CONTEXT0</code>, <code>CONTEXT1</code>, … will denote
pseudo-variables that describe the various currently visible execution
contexts, following the language <a href="#scoping">scoping</a> rules. The most
recent contexts will have higher numbers. In addition, <code>HIDDEN0</code>,
<code>HIDDEN1</code>, … will represent pending execution contexts that are
invisible to the currently executing code. These are also known as
<a href="https://en.wikipedia.org/wiki/Activation_record"><em>activation records</em></a>.
Entries in <code>HIDDEN</code> contexts are
<a href="#lifetime">live</a>, but invisible to the current
code. By convention, <code>CONTEXT0</code> and <code>HIDDEN0</code> are not defined in the
examples and are assumed to be inherited from earlier execution.</p>
</div>
</div>
<div class="sect3">
<h4 id="parsing-phase"><a class="anchor" href="#parsing-phase"></a><a class="link" href="#parsing-phase">3.1.2. Parsing phase</a></h4>
<div class="paragraph">
<p>The parsing phase reads source text and turns it into a parse tree using
operator spelling and precedence information given in the
<a href="http://github.com/c3d/xl/blob/master/src/xl.syntax">syntax file</a>. This results either in a parse-time
error, or in a faithful representation of the source code as a parse
tree data structure that can be used for program evaluation.</p>
</div>
<div class="paragraph">
<p>Since there is almost a complete equivalence between the parse tree and
the source code, the rest of the document will, for convenience,
represent a parse tree using a source code form. In the rare cases where
additional information is necessary for understanding, it will be
provided in the form of XL comments.</p>
</div>
<div class="paragraph">
<p>Beyond the creation of the parse tree, very little actual processing
happens during parsing. There are, however, a few tasks that can only be
performed during parsing:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Filtering out comments: Comments should not have an effect on the
program, so they are simply eliminated during parsing.</p>
</li>
<li>
<p>Processing <code>use</code> statements: Since imported modules can contain
<a href="#extending-the-syntax">syntax extensions</a>, they must at least partially be
processed during parsing. Details about <code>use</code> statements are covered in the
<a href="#modules">chapter about modules</a>.</p>
</li>
<li>
<p>Identifying words that switch to a <a href="#child-syntax">child syntax</a>: symbols
that activate a child syntax are recognized during parsing. This is the case
for example with the <code>extern</code> name in the <a href="http://github.com/c3d/xl/blob/master/src/xl.syntax#L62">default
syntax</a>.</p>
</li>
<li>
<p>Identifying binary data: words such as <code>bits</code> marked as introducing
<code>BINARY</code> data in the syntax file are treated specially during parsing,
to generate parse tree nodes representing binary data.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Binary data is not currently implemented.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The need to process <code>use</code> statements during parsing means that it’s not
possible in XL to have computed <code>use</code> statements. The name of the module
must always be evaluated at compile-time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> An alternative would have been to allow computed <code>use</code>
statement, but disallow syntax extensions in them. However, for convenience,
<code>use</code> names look like <code>XL.CONSOLE.TEXT_IO</code> and not, say,
<code>"xl/console/text_io.xs"</code>, so there is no obvious way to compute them
anyway. If computed <code>use</code> statement ever become necessary, it will be
easy enough to use the syntax <code>use "path"</code> for them.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once parsing completes successfully, the parse tree can be handed to the
declaration and evaluation phases. Parsing occurs for the <em>entire
program</em>, including imported modules, before the other phases begin.</p>
</div>
</div>
<div class="sect3">
<h4 id="sequences"><a class="anchor" href="#sequences"></a><a class="link" href="#sequences">3.1.3. Sequences</a></h4>
<div class="paragraph">
<p>Both declaration and evaluation phases will process <em>sequences</em>, which
are one of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A block, in which case processing the sequence means processing the
block’s child</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">{ print "Hello World" }</code></pre>
</div>
</div>
</li>
<li>
<p>An infix <code>NEWLINE</code> or semi-colon <code>;</code>, in which case the left and right
operands of the infix are processed in that order.  The semi-colon and
new-line are used to separate statements. Processing the infix as a sequence
only happens if <a href="#pattern-matching">pattern matching</a> did not succeed with
the infix form.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">print "One"; print "Two"
print "Three"</code></pre>
</div>
</div>
</li>
<li>
<p>An <code>use</code> statement, which is the only statement that requires
processing in all three executation phases.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">use XL.MATH.COMPLEX</code></pre>
</div>
</div>
</li>
<li>
<p>An infix <code>is</code>, which is called a <em>definition</em>, an infix <code>:</code> or <code>as</code>, which are
called <a href="#type-annotations"><em>type annotations</em></a>, or an infix assignment
operator <code>:=</code> with a <code>:</code> type annotation or a <code>variable</code> prefix on the left,
called a <em>variable initialization</em>. Definitions, type annotations and variable
initializations are collectively called <em>declarations</em>, and are processed
during the <a href="#declaration-phase">declaration phase</a>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">pi is 3.1415                  // Definition of 'pi'
e as real is 2.71828          // Typed definition of 'e'
Count : integer               // Variable declaration of 'Count'
byte_size X as integer        // Function declaration of 'byte_size X'
variable Steps := 100         // Variable initialization of 'Steps'
Remaining : integer := 100    // Typed variable initialization of 'Remaining'</code></pre>
</div>
</div>
</li>
<li>
<p>Anything else, which is called a <em>statement</em> and is processed during
the <a href="#evaluation-phase">evaluation phase</a>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">print "This is a statement"</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, consider the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">pi is 3.14
circumference 5.3
circumference Radius:real is 2 * pi * Radius</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first and last line are representing a definition of <code>pi</code> and
<code>circumference Radius:real</code> respectively. The second line is made of one
statement that computes <code>circumference 5.3</code>. There are two definitions,
one statement and no type annotation in this code.</p>
</div>
<div class="paragraph">
<p>Note that there is a type annotation for <code>Radius</code> in the definition on
the last line, but that annotation is <em>local</em> to the definition, and
consequently not part of the declarations in the top-level sequence.</p>
</div>
<div class="paragraph">
<p>In that specific case, that type annotation is a declaration of a
<em>parameter</em> called <code>Radius</code>, which only accepts <code>real</code> values.
Sometimes, such parameters are called <em>formal parameters</em>. A parameter
will receive its value from an <em>argument</em> during the evaluation. For
example the <code>Radius</code> parameter will be <em>bound</em> to argument <code>5.3</code> while
evaluating the statement on the second line.</p>
</div>
<div class="paragraph">
<p>The <em>result</em> of a sequence is the value of its last statement. In our
example, the result of executing the code will be the value computed by
<code>circumference 5.3</code>. A sequence can be made of multiple statements,
which are <a href="#sequence-evaluation">evaluated in order</a>. Note that XL
statements are expected to evaluate as <code>nil</code>. Unlike C, it is a type
error to have values in a middle of a sequence.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">invalid as integer is (0; 1)            // Type error: 0 is not nil</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="declaration-phase"><a class="anchor" href="#declaration-phase"></a><a class="link" href="#declaration-phase">3.1.4. Declaration phase</a></h4>
<div class="paragraph">
<p>The declaration phase of the program begins as soon as the parsing phase
finishes.</p>
</div>
<div class="paragraph">
<p>During the declaration phase, all declarations are stored in order in
the context, so that they appear before any declaration that was already
in the context. As a result, the new declarations may <em>shadow</em> existing
declarations that match.</p>
</div>
<div class="paragraph">
<p>In the example above, the declaration phase would result in a context
that looks something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT1 is
    pi is 3.14
    circumference Radius:real is 2 * pi * Radius
    CONTEXT0
    HIDDEN0</code></pre>
</div>
</div>
<div class="paragraph">
<p>An actual implementation is likely to store declarations is a more
efficient manner. For example, an interpreter might use some hashing or
some form of balanced tree. Such optimizations must preserve the order
of declarations, since correct behavior during the evaluation phase
depends on it.</p>
</div>
<div class="paragraph">
<p>In the case of a <a href="#compiling-xl">compiled implementation</a>, the
compiler will most likely assign machine locations to each of the
declarations. When the program runs, a constant like <code>pi</code> or the
definition of <code>circumference</code> may end up being represented as a
machine address, and a variable such as <code>Radius</code> may be represented as
a "stack location", i.e. a preallocated offset from the current stack
pointer, the corresponding memory location only containing the value,
i.e. the right-hand side of <code>:=</code>. Most of the
<a href="#types">type analysis</a> can be performed at compile
time, meaning that most type information is unnecessary at program run
time and can be eliminated from the compiled program.</p>
</div>
<div class="paragraph">
<p>Note that since the declaration phase occurs before the execution phase,
all declarations in the program will be visible during the evaluation
phase. In our example, it is possible to use <code>circumference</code> before it
has been declared. Definitions may therefore refer to one another in a
circular way. Some other languages such as C require "forward
declarations" in such cases, XL does not.</p>
</div>
<div class="paragraph">
<p>The parse tree on the left of <code>is</code>, <code>as</code> or <code>:</code> is called the <em>pattern</em>
of the declaration. The pattern will be checked against the <em>form</em> of
parse trees to be evaluated. The right operand of <code>:</code> or <code>as</code> is the
type of the type annotation. The parse tree on the right of <code>is</code> is
called the <em>body</em> of the definition.</p>
</div>
</div>
<div class="sect3">
<h4 id="evaluation-phase"><a class="anchor" href="#evaluation-phase"></a><a class="link" href="#evaluation-phase">3.1.5. Evaluation phase</a></h4>
<div class="paragraph">
<p>The evaluation phase processes each statement in the order they appear
in the program. For each statement, the context is looked up for
matching declarations in order. There is a match if the shape of the
tree being evaluated matches the pattern of the declaration. Precise
pattern matching rules will be <a href="#pattern-matching">detailed below</a>.
In our example, <code>circumference 5.3</code> will not match the declaration of
<code>pi</code>, but it will match the declaration of <code>circumference Radius:real</code>
since the value <code>5.3</code> is indeed a real number.</p>
</div>
<div class="paragraph">
<p>When a match happens, a new context is created with definitions that
<em>bind</em> formal parameters to the corresponding argument. Such
definitions are, unsurprisingly, called <em>bindings</em>.
This new context is called a <em>local context</em> and will be used to
evaluate the body of the definition. For example, the local context
for <code>circumference Radius:real</code> would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT2 is
    Radius:real := 5.3
    CONTEXT1
    HIDDEN1
HIDDEN1 is CONTEXT1</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a reminder, <code>Radius</code> is a <em>formal parameter</em>, or simply <em>parameter</em>
that receives the <em>argument</em> 5.3 as a result of <em>binding</em>. The binding
remains active for the duration of the evaluation of of the body of the
definition. The binding, at least conceptually, contains the type
annotation for the formal parameter, ensuring that all required
<a href="#types">type constraints</a> are known and respected. For
example, the context contains the <code>Redius:real</code> annotation, so that
attempting <code>Radius := "Hello"</code> in the body of <code>circumference</code> would
fail, because the type of <code>"Hello"</code> does not match the <code>real</code> type.</p>
</div>
<div class="paragraph">
<p>Bindings can be marked as <a href="#mutability">mutable</a> or constant. In
this document, bindings made with <code>:=</code> are mutable, while binding made
with <code>is</code> are constant. Since by default, an <code>X : T</code> annotation
creates a mutable binding, the binding for <code>Radius</code> is made with <code>:=</code>.</p>
</div>
<div class="paragraph">
<p>Once the new context has been created, execution of the program
continues with the body of the definition. In that case, that means
evaluating expression <code>2 * pi * Radius</code> in the newly created local
context.</p>
</div>
<div class="paragraph">
<p>After execution of the body completes, the result of that execution
replaces the statement that matched the definition’s pattern. In our
example, <code>circumference 5.3</code> behaves like <code>2 * pi * Radius</code> in a context
containing <code>Radius is 5.3</code>.</p>
</div>
<div class="paragraph">
<p>The process can then resume with the next statement if there is one. In
our example, there isn’t one, so the execution is complete.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expression-evaluation"><a class="anchor" href="#expression-evaluation"></a><a class="link" href="#expression-evaluation">3.2. Expression evaluation</a></h3>
<div class="paragraph">
<p>Executing the body for the definition of <code>circumference Radius:real</code>
involves the evaluation of expression <code>2 * pi * Radius</code>. This follows
almost exactly the same process as for <code>circumference 5.3</code>, but in that
case, that process needs to be repeated multiple times to complete the
evaluation.</p>
</div>
<div class="paragraph">
<p>If we apply the evaluation process with <code>2 * pi * Radius</code>, assuming the
declarations in the <a href="#standard-library">standard library</a>, no
declaration has a larger pattern like <code>X * Y * Z</code> that could match the
whole expression. However, there is a definition for a multiplication
between <code>real</code> numbers, with a pattern that looks like <code>X:real *
Y:real as real</code>, as well as another for <code>integer</code> multiplication, with
a pattern that looks like <code>X:integer * Y:integer</code>.  There may be more,
but we will ignore them for the rest of this discussion. The code
below shows what the relevant declaration might look like (<code>&#8230;&#8203;</code>
indicates irrelevant code):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X:integer * Y:integer   as integer  is ...
X:real * Y:real         as real     is ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>*</code> operator is left-associative, so <code>2 * pi * Radius</code> parses as
<code>(2 * pi) * Radius</code>. Therefore, we will be looking for a match with <code>X</code>
corresponding to <code>2 * pi</code> and <code>Y</code> corresponding to <code>Radius</code>. However,
that information alone is insufficient to determine if either
sub-expression is <code>integer</code> or <code>real</code>. In order to be able to make that
determination, <a href="#immediate-evaluation">immediate evaluation</a> of the
arguments is required. The evaluation process therefore repeats with
sub-expression <code>2 * pi</code>, and like before, it is necessary to evaluate
<code>pi</code>. This in turns gives the result <code>3.14</code> given the current context.
That result replaces <code>pi</code>, so that we now must evaluate <code>2 * 3.14</code>.</p>
</div>
<div class="paragraph">
<p>The <code>2 * 3.14</code> tree does not match <code>X:real * Y:real</code> because <code>2</code> is an
<code>integer</code> and not a <code>real</code>. It does not match <code>X:integer * Y:integer</code>
either because <code>3.14</code> is a <code>real</code> and not an <code>integer</code>. However, the
standard library provides a definition of an <em>implicit conversion</em>
that looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X:integer as real     is builtin "IntegerToReal"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This implicit conversion tells the compiler how to transform an
<code>integer</code> value like <code>2</code> into a <code>real</code>. Implicit conversions are only
considered if there is no exact match, and only one of them can be used
to match a given parameter. In our case, there isn’t an exact match, so
the evaluation will consider the implicit conversion to get a <code>real</code>
from <code>integer</code> value <code>2</code>.</p>
</div>
<div class="paragraph">
<p>The body of the implicit conversion above is therefore evaluated in a
context where <code>X</code> is set to <code>2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT3 is
    X:integer := 2
    CONTEXT2
    HIDDEN2
HIDDEN2 is CONTEXT2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of that implicit conversion is <code>2.0</code>. Evaluation can then
resume with the <code>X:real * Y:real as real</code> definition, this time called
with an argument of the correct <code>real</code> type for <code>X</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT4 is
    X:real := 2.0
    Y:real := 3.14
    CONTEXT2
    HIDDEN2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of the multiplication is a <code>real</code> with value <code>6.28</code>, and
after evaluating <code>Radius</code>, evaluation of the second multiplication will
then happen with the following context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT5 is
    X:real := 6.28 // from 2 * pi
    Y:real :=5.3  // from Radius
    CONTEXT2
    HIDDEN2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of the last multiplication is a <code>real</code> with value <code>33.284</code>.
This is the result of evaluating <code>circumference 5.3</code>, and consequently
the result of executing the entire program.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="#standard-library">standard XL library</a> only provides
implicit conversions that do not cause data loss. On most
implementation, <code>real</code> has a 53-bit mantissa, which means that the
implicit conversion from <code>integer</code> to <code>real</code> actually needs to check
the converted value in a platform-dependent way:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X:integer as real when X &gt;= -2^53 and X &lt; 2^53 is ...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="syntactic-sugar"><a class="anchor" href="#syntactic-sugar"></a><a class="link" href="#syntactic-sugar">3.3. Syntactic sugar</a></h3>
<div class="paragraph">
<p>A number of special forms can be used to make declaration or
definition easier to read, write or validate. This is called
<em>syntactic sugar</em>. The primary intent of syntactic sugar is to
help the programmer understand what the code means. However, syntactic
sugar also gives additional hints to the compiler, and may suggest one
implementation over another. Syntactic sugar is specified by reference
to a functionally equivalent <em>raw</em> version of the same code.</p>
</div>
<div class="paragraph">
<p>A few names are reserved for use as syntactic sugar prefix. These
names have a very low precedence, and as a result do not significantly
impact the syntax of the pattern of the declaration they apply to.
These sugar names are <code>type</code>, <code>class</code>, <code>module</code>, <code>function</code>, <code>method</code>,
<code>procedure</code>, <code>to</code>, <code>operation</code>, <code>data</code>, <code>in</code>, <code>out</code>, <code>in out</code>, <code>io</code>,
<code>constant</code>, <code>variable</code>, <code>macro</code>, <code>generic</code>, <code>polymorphic</code>, <code>fast</code>,
<code>small</code>, <code>global</code>, <code>thread</code> and <code>static</code>. Proper use of these names
also makes textual search of the declarations or definitions easier.</p>
</div>
<div class="paragraph">
<p>The rest of this document will preferably use the sugared form.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The evaluation rules are never changed by using syntactic
sugar. The result of evaluation with or without syntactic sugar should
be identical. Syntactic sugar may guide the implementation in picking
the best implementation to achieve that result. It may also allow the
implementation to emit more precise diagnostics.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="types-sugar"><a class="anchor" href="#types-sugar"></a><a class="link" href="#types-sugar">3.3.1. Types sugar</a></h4>
<div class="paragraph">
<p>The <code>type</code> prefix can be used to announce a type, which implicitly
indicates that the form has the <code>type</code> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type pair[T:type] is matching pair(First:T, Second:T)           // Sugared
pair[T:type] as type is matching pair(First:T, Second:T)        // Raw</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also a syntactic sugar for the common case where the definition
of the type is a <code>matching</code> form. In that case, <code>is matching</code> can be
replaced with <code>matches</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type pair[T:type] matches pair(First:T, Second:T)               // Sugared
pair[T:type] as type is matching pair(First:T, Second:T)        // Raw</code></pre>
</div>
</div>
<div class="paragraph">
<p>This syntactic sugar also applies to the <a href="#interface">interface</a>
of a type, including the definition of its features or of the types it
inherits from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type pair[T:type] with                                          // Sugared
   First  : T
   Second : T
pair[T:type] as type with                                       // Raw
   First  : T
   Second : T

type rectangle like shape                                       // Sugared
type rectangle inherits shape                                   // Sugared
rectangle as type like shape                                    // Raw

type point like shape with (X:coordinate; Y:coordinate)         // Sugared
point as type like shape with (X:coordinate; Y:coordinate)      // Raw</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the word <code>class</code> is a syntactic sugar for <code>type</code>, which can
be used for type hierarchies intended to support
<a href="#object-oriended-programming">object-oriended programming</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">class circle inherits shape with
   X       : coordinate
   Y       : coordinate
   Radius  : length</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using syntactic sugar for types gives the compiler additional hints
that the form is intended to be used as a type in type
annotations. This can be used by the compiler to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Accelerate type lookup in type annotations, by focusing on types</p>
</li>
<li>
<p>Treat the form as a compile-time constant</p>
</li>
<li>
<p>Use the form at compile-time for type analysis</p>
</li>
<li>
<p>Emit more precise diagnostics</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="modules-sugar"><a class="anchor" href="#modules-sugar"></a><a class="link" href="#modules-sugar">3.3.2. Modules sugar</a></h4>
<div class="paragraph">
<p>The syntactic sugar for <a href="#modules">modules</a> is very similar in its
syntax to that of types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">module M with Interface                 // Sugared
M as module with Interface              // Raw

module M is Implementation              // Sugared
M as module is Implementation           // Raw</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>module</code> syntactic sugar gives hints to the compiler that the
declaration is used as a module. The compiler can use that information
to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Accelerate module lookup and build dependencies</p>
</li>
<li>
<p>Validate module version numbers</p>
</li>
<li>
<p>Verify ABI stability and compatibility</p>
</li>
<li>
<p>Optimize the code for use in a shared library</p>
</li>
<li>
<p>Emit better diagnostics</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="parameter-sugar"><a class="anchor" href="#parameter-sugar"></a><a class="link" href="#parameter-sugar">3.3.3. Parameter sugar</a></h4>
<div class="paragraph">
<p>The <code>in</code>, <code>out</code> and <code>in out</code> have a syntactic sugar, where they can be
placed before a type annotation or a pattern, instead of just before
the type in the type annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">to Copy(out Target:value, in From:value)                // Sugared
Copy(Target:out value, From:in value) as ok             // Raw</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sugar can also be used without a type, in which case the type is
assumed to be <code>anything</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">to Debug(in Thing) is print "Debug: ", Thing                    // Sugared
Debug(Thing:in anything) as ok is print "Debug: ", Thing   // Raw</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sugar-for-code-and-data"><a class="anchor" href="#sugar-for-code-and-data"></a><a class="link" href="#sugar-for-code-and-data">3.3.4. Sugar for code and data</a></h4>
<div class="paragraph">
<p>Some syntactic sugar can be used to indicate if a form is a <code>procedure</code>,
a <code>method</code>, a <code>function</code>, an <code>operation</code> or if it represents
<code>data</code>, a <code>property</code> or an <code>attribute</code>. Like other kinds of syntactic
sugar, the primary intent is to make the code easier to read.</p>
</div>
<div class="paragraph">
<p>While these sugared forms are optional, they may make the code more
readable, shorter or more precise. In addition, they convey additional
additional information to the compiler or to a person reading the code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>procedure</code> is typically used for definitions that do not return a
value. If no result type is specified for the pattern, then <code>ok</code> is
implied (that is <code>nil or error</code>), and diagnostics will be emitted
accordingly. A result type can also be explicitly given. In that
case, using <code>procedure</code> is a hint to the compiler that the
implementation is expected to have side effects, as opposed to
<code>function</code>.</p>
<div class="literalblock">
<div class="content">
<pre>procedure Initialization  is { Step1; Step2 }         // Sugared
Initialization as mayfail is { Step1; Step2 }         // Raw</pre>
</div>
</div>
</li>
<li>
<p><code>to</code> is a shorter form of <code>procedure</code> that is normally used for
patterns that look like English verbs. For example, <code>procedure Write</code>
can be written as <code>to Write</code>.</p>
<div class="literalblock">
<div class="content">
<pre>to Write(C:character)                                 // Sugared
Write(C:character) as mayfail                         // Raw</pre>
</div>
</div>
</li>
<li>
<p><code>function</code> indicates that the operation behaves like a pure
mathematical function, i.e. it has no side effects and returns the
same value for identical inputs. This allows the compiler to explore
additional optimizations, and emit additional diagnostics if the
implementation has side effects.</p>
<div class="literalblock">
<div class="content">
<pre>function Sin(X:real) as real                          // Sugared
Sin(X:real) as real                                   // Raw</pre>
</div>
</div>
</li>
<li>
<p><code>method</code> indicates that the pattern applies to an object, its first
formal parameter, and for prefix methods, it provides a dot notation
<code>Object.Method</code> for calling the method.  For example, the <code>Width</code> method
defined above can also be invoked as <code>S.Width</code>.</p>
<div class="literalblock">
<div class="content">
<pre>method Width(S:shape) as real                         // Sugared
Width(S:shape) as real written S.Width                // Raw</pre>
</div>
</div>
</li>
<li>
<p><code>property</code> and <code>attribute</code> are shorthand ways to specify
<a href="#attribute">attribute</a> features in a type, i.e. features that
behave like a field, but can be implemented in a different way. The
language does not make a distinction between attributes and
properties, but a special project may give them different meaning,
for example in a drawing program, that attributes have a
user-visible interface whereas properties are internal values.</p>
<div class="literalblock">
<div class="content">
<pre>property Width(S:shape) as size                       // Sugared
attribute Height(S:shape) as size                     // Sugared
Width(S:shape) as attribute[size] written S.width     // Raw</pre>
</div>
</div>
</li>
<li>
<p><code>operation</code> is a marker when reading the code for special notations.
It is intended to draw the attention of the reader on some special
form that he may not be used to.</p>
<div class="literalblock">
<div class="content">
<pre>operation A:real + B:real as real                     // Sugared
A:real + B:real as real                               // Raw</pre>
</div>
</div>
</li>
<li>
<p><code>data</code> is a marker indicating that the notation is used primarily
for data. For example, the notation <code>data X,Y</code> indicates that there
is no actual operation associated to the <code>,</code> infix operator,
  i.e. that <code>1,3,5,8,4</code> should be representable using only data as
  opposed to code. The implementation of a <code>data</code> normally uses
  <a href="#self"><code>self</code></a>.</p>
<div class="literalblock">
<div class="content">
<pre>data X, Y is self                                     // Sugared
X, Y is self                                          // Raw</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="implementations-hints"><a class="anchor" href="#implementations-hints"></a><a class="link" href="#implementations-hints">3.3.5. Implementations hints</a></h4>
<div class="paragraph">
<p>Prefix names such as <code>constant</code>, <code>variable</code>, <code>macro</code>, <code>generic</code>,
<code>polymorphic</code>, <code>fast</code> and <code>small</code> tell the compiler what is the intended
usage for the definition. They may guide the compiler into favoring
one possible implementation over another.</p>
</div>
<div class="paragraph">
<p>For example, consider a parameter-less name like <code>seconds</code>. This could
be a variable holding a duration in seconds, a constant indicating the
number of seconds in an hour, an operation that returns the seconds in
the current time, or a function that computes the number of seconds
our universe will last, which is a very lengthy computation that
always returns the same value. This would best be indicated by
using different syntactic sugar for the declaration of <code>seconds</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>variable  seconds as natural    // Variable storing a duration in seconds
constant  seconds as natural    // Number of seconds in an hour
operation seconds as natural    // Seconds in the current time
function  seconds as natural    // Estimate number of seconds in the universe</pre>
</div>
</div>
<div class="paragraph">
<p>The meaning of these words is intended as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>constant</code> indicates that the declaration should be implementable as a
compile-time constant that can be stored in a read-only area of memory.</p>
</li>
<li>
<p><code>variable</code> indicates that the declaration should be implementable
so that the result of the operation is mutable, typically an area of memory or
a register.</p>
</li>
<li>
<p><code>macro</code> indicates that the declaration should be implemented using
compile-time manipulations of parse tree arguments, and that the
compiler should not spend too much time trying to analyze the type
of the parameters while processing the definition.</p>
</li>
<li>
<p><code>generic</code> indicates that the declaration is intended to be
parameterized at compile-time, in order to generate multiple
<em>instantiations</em>, and that type analysis on each instantiation
at compile-time will provide valuable information.</p>
</li>
<li>
<p><code>polymorphic</code> indicates that the declaration is intended to be
parameterized at run-time, and that a single implementation should
be generated that can deal with a multiplicity of types using
dynamic dispatch.</p>
</li>
<li>
<p><code>fast</code> indicates that the declaration should be optimized for speed,
even at the expense of compilation time or code size. For example, a
call to that declaration could be inlined.</p>
</li>
<li>
<p><code>small</code> indicates that the declaration should be optimized for size,
even at the expense of execution time. For example, data could be
packed and call inlining could be disabled.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A compiler is free to emit a diagnostic if one of the conditions is not
met. This is only a quality of implementation consideration. In all cases, the
meaning of the declaration remains the same as far as the semantics of the
language is concerned. In other words, an annotation should not change what your
program does, although it may observably change how your program does it.</p>
</div>
<div class="paragraph">
<p>In order to see the effect that these modifiers may have, we can
consider code that simply adds a value to itself, and see what C&#43;&#43;
feature this may be related to:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">XL</th>
<th class="tableblock halign-left valign-top">C&#43;&#43;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>constant twice(X) is X+X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>template&lt;typename T&gt;<br>
constexpr T twice(const T&amp; X)<br>
{<br>
&#160;&#160;&#160;&#160;return X + X;<br>
}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>variable twice(X) is X+X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>template&lt;class T&gt;<br>
T&amp; twice(T&amp; X)<br>
{<br>
&#160;&#160;&#160;&#160;X+=X;<br>
&#160;&#160;&#160;&#160;return X;<br>
}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>macro twice(X) is X+X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>#define twice(X) ({ \<br>
&#160;&#160;&#160;&#160;typeof(X) _X = (X); \<br>
&#160;&#160;&#160;&#160;_X+_X; \<br>
})</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>generic twice(X) is X+X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>template&lt;typename T&gt;<br>
T twice(const T&amp;)<br>
{<br>
&#160;&#160;&#160;&#160;return T + T;<br>
}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>polymorphic twice(X) is X+X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>class Base<br>
{<br>
&#160;&#160;&#160;&#160;virtual Base &amp;twice(Base &amp;X)<br>
&#160;&#160;&#160;&#160;{<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;X += X;<br>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return X;<br>
&#160;&#160;&#160;&#160;}<br>
};<br>
Base &amp;twice(Base &amp;X)<br>
{<br>
&#160;&#160;&#160;&#160;return X.twice(X);<br>
}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fast twice(X) is X+X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>template &lt;typename T&gt;<br>
inline T twice(const T &amp;X)<br>
{<br>
&#160;&#160;&#160;&#160;return X+X;<br>
}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>small twice(X) is X+X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>#pragma GCC optimize("Os")<br>
template&lt;typename T&gt;<br>
constexpr T twice(const T&amp; X)<br>
{<br>
&#160;&#160;&#160;&#160;return X + X;<br>
}</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="storage-hints"><a class="anchor" href="#storage-hints"></a><a class="link" href="#storage-hints">3.3.6. Storage hints</a></h4>
<div class="paragraph">
<p>Three forms of syntactic sugar provide <em>storage hints</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>global</code> indicates that a definition belongs to a shared
<a href="#global-context">global context</a>.</p>
</li>
<li>
<p><code>static</code> indicates that a definition belongs to a
<a href="#static-context">static context</a> that keeps its content between
successive evaluations.</p>
</li>
<li>
<p><code>thread</code> indicates that a definition belongs to a
<a href="#thread-context">thread context</a> that is associated to each
thread of execution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the following example, <code>Counter</code> keeps its value from one
evaluation of <code>EvaluationCounter</code> to the next, but is not visible to
any entity outside of <code>EvaluationCounter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">operation EvaluationCounter as natural is               // Sugared
    static Counter : natural := 0
    Counter++
EvaluationCounter as natural is                         // Raw
    static.{ Counter : natural := 0 }
    static.Counter++</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="alternate-notations"><a class="anchor" href="#alternate-notations"></a><a class="link" href="#alternate-notations">3.3.7. Alternate notations</a></h4>
<div class="paragraph">
<p>In some cases, it may be useful to provide several notations for the
same things. The <code>written</code> infix form can be used to specify
additional patterns for the same implementation. This may increase
readability, or help deal with properties such as commutativity.</p>
</div>
<div class="paragraph">
<p>For example, the following defines an iterative <code>Factorial</code> function,
which gives the operation a name, while also providing the familiar
<code>N!</code> notation for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">function Factorial(N:natural) as natural written N! is
    result := 1
    for I in 1..N loop
        result *= I</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code provides a fused multiply-add operation that is
recognized whether the multiplication is on the left or on the right:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">function FMA(X:number, Y:number, Z:number) as number written X+Y*Z written Y*Z+X</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pattern-matching"><a class="anchor" href="#pattern-matching"></a><a class="link" href="#pattern-matching">3.4. <a id="pattern"></a>Pattern matching</a></h3>
<div class="paragraph">
<p>As we have seen above, the key to execution in XL is <em>pattern matching</em>,
which is the process of finding the declarations patterns that match a
given parse tree. Pattern matching is recursive, the <em>top-level pattern</em>
matching only if all <em>sub-patterns</em> also match.</p>
</div>
<div class="paragraph">
<p>For example, consider the following declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">log X:real when X &gt; 0.0 is ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will match an expression like <code>log 1.25</code> because:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>log 1.25</code> is a prefix with the name <code>log</code> on the left, just like the
prefix in the pattern.</p>
</li>
<li>
<p><code>1.25</code> matches the formal parameter <code>X</code> and has the expected <code>real</code>
type, meaning that <code>1.25</code> matches the sub-pattern <code>X:real</code>.</p>
</li>
<li>
<p>The condition <code>X &gt; 0.0</code> is true with binding <code>X is 1.25</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are several kinds of patterns that will match different kinds of
expressions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#name-definitions">Name definitions</a> match whole names.</p>
</li>
<li>
<p><a href="#wildcards">Wildcards</a> match arbitrary arguments.</p>
</li>
<li>
<p><a href="#type-annotations">Type annotations</a> match arguments based on their type.</p>
</li>
<li>
<p><a href="#function-prefix-definitions">Function (prefix) definitions</a> match prefix forms ("functions").</p>
</li>
<li>
<p><a href="#postfix-definitions">Postfix definitions</a> match postfix forms.</p>
</li>
<li>
<p><a href="#infix-definitions">Infix definitions</a> match infix forms.</p>
</li>
<li>
<p><a href="#argument-splitting">Argument splitting</a> match names bound to infix, prefix or postfix
values to infix, prefix or postfix patterns.</p>
</li>
<li>
<p><a href="#conditional-patterns">Conditional patterns</a> match values based on arbitrary conditions</p>
</li>
<li>
<p><a href="#validated-patterns">Validated patterns</a> validate a pattern using code snippets</p>
</li>
<li>
<p><a href="#literal-constants">Literal constants</a> match constants with the same value.</p>
</li>
<li>
<p><a href="#metabox-values">Metabox values</a> match values computed by the compiler.</p>
</li>
<li>
<p><a href="#blocks">Blocks</a> change the priority of expressions.</p>
</li>
<li>
<p><a href="#scope-pattern-matching">Scope pattern matching</a> allows large lists of paraameters to be
passed as argument ina more readable way.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="name-definitions"><a class="anchor" href="#name-definitions"></a><a class="link" href="#name-definitions">3.4.1. Name definitions</a></h4>
<div class="paragraph">
<p>Top-level name patterns only match the exact same name.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Declaration</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pi is 3.14</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pi</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ip</code>, <code>3.14</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Definitions with a top-level name pattern are called <em>name definitions</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This case only applies to names, not to operators. You cannot
define a <code>+</code> operator that way.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="wildcards"><a class="anchor" href="#wildcards"></a><a class="link" href="#wildcards">3.4.2. Wildcards</a></h4>
<div class="paragraph">
<p>Name patterns that are not at the top-level can match any expression,
and this does not require <a href="#immediate-evaluation">immediate
evaluation</a>. In that case, the expression will be bound to the name in
the argument context, unless it is already bound in the current context.
In that latter case, the value <code>New</code> of the new expression is compared
with the already bound value <code>Old</code> by evaluating the <code>New=Old</code>
expression, and the pattern only matches if that check evaluates to
<code>true</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Declaration</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X+Y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2+"A"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2-3</code>, <code>+3</code>, <code>3+</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>N+N</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3+3</code>, <code>A+B</code> when <code>A=B</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3-3</code>, <code>3+4</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Such name patterns are called <em>wildcard parameters</em> because they can
match any expression, or <em>untyped parameters</em> because no type checking
occurs on the matched argument.</p>
</div>
<div class="paragraph">
<p>Wildcards do not apply to the top level of a pattern, since they would
be interpreted as name definitions there. For example, <code>X is 3</code> will
define name <code>X</code> and not define a pattern that matches anything and
returns <code>3</code>. There are use cases where it is interesting to be able to
do that, for example in <a href="#scoping">maps</a>. In that case, it is
necessary to use the <code>lambda</code> notation:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Declaration</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lambda N</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>\N</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Wildcards only applies to names, not to operators. You cannot
define a parameter named <code>+</code> that way.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="type-annotations"><a class="anchor" href="#type-annotations"></a><a class="link" href="#type-annotations">3.4.3. Type annotations</a></h4>
<div class="paragraph">
<p>When the pattern is an infix <code>:</code> or <code>as</code>, it matches an expression if
the expression matches the pattern on the left of the infix, and if the
<a href="#types">type</a> of the expression matches the type on the
right of the infix.</p>
</div>
<div class="paragraph">
<p>A type annotation as a top-level pattern is a declaration:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Top-level pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X:integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code>, <code>'X'</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>seconds as integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>seconds</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code>, <code>"seconds"</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A type annotation as a sub-pattern declares a parameter:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X:integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>42</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X</code> (unless bound to an <code>integer</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>seconds as integer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>42</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X</code> (unless bound to mutable <code>integer</code>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Such patterns are called <em>type annotations</em>, and are used to perform
type checking. The precedence of <code>as</code> is lower than <code>:</code>, which means
that in a procedure or function, type annotations using <code>:</code> are used to declare
the type of parameters, whereas <code>as</code> is used to declare the type of the
expression being defined, as shown for the pattern on the left of <code>is</code>
in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X:real + Y:real as real is ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>For readability, a type annotation for a name can also be matched by an
<a href="#assignment">assignment</a> or a <a href="#name-definitions">name definition</a>
with the same name as the formal parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">circle (Radius:real, CenterX:real, CenterY:real) as circle
C : circle := circle(Radius := 3.5, CenterX := 6.5, CenterY := 3.3)

type picture is matching picture
    Width  : size
    Height : size
    Buffer : buffer
P : picture is picture
    Width  is 640
    Height is 480
    Buffer is my_buffer</code></pre>
</div>
</div>
<div class="paragraph">
<p>A rule called <a href="#scope-pattern-matching">scope pattern matching</a>
makes it possible to give arguments in a different order in that case.</p>
</div>
</div>
<div class="sect3">
<h4 id="function-prefix-definitions"><a class="anchor" href="#function-prefix-definitions"></a><a class="link" href="#function-prefix-definitions">3.4.4. Function (prefix) definitions</a></h4>
<div class="paragraph">
<p>When the pattern is a prefix, like <code>sin X</code>, the expression will match
only if it is a prefix with the same name, and when the pattern on the
right of the prefix matches the right operand of the expression.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sin X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sin (2.27 + A)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cos 3.27</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+X:real</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+2.27</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>+"A"</code>, <code>-3.1</code>, <code>1+1</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When the prefix is a name, definitions for such patterns are called
<em>function definitions</em>, and the corresponding expressions are usually
called <em>function calls</em>. Otherwise, they are called <em>prefix
definitions</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="postfix-definitions"><a class="anchor" href="#postfix-definitions"></a><a class="link" href="#postfix-definitions">3.4.5. Postfix definitions</a></h4>
<div class="paragraph">
<p>When the pattern is a postfix, like <code>X%</code>, the expression will match only
if it is a postfix with the same name, and when the pattern on the left
of the postfix matches the left operand of the expression.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X%</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.27%</code>, <code>"A"%</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%3</code>, <code>3%2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X km</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.27 km</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>km 3</code>, <code>1 km 3</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Definitions for such patterns are called <em>postfix definitions</em>, and the
corresponding expressions are usually called <em>postfix expressions</em>. The
name or operator is sometimes called the <em>suffix</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="infix-definitions"><a class="anchor" href="#infix-definitions"></a><a class="link" href="#infix-definitions">3.4.6. Infix definitions</a></h4>
<div class="paragraph">
<p>When the pattern is an infix, it matches an infix expression with the
same infix operator when both the left and right operands of the
pattern match the corresponding left and right operands of the
expression.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X:real+Y:real</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.5+2.9</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3+2</code>, <code>3.5-2.9</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X and Y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>N and 3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>N or 3</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Definitions for such patterns are called <em>infix definitions</em>, and the
corresponding expressions are called <em>infix expressions</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="argument-splitting"><a class="anchor" href="#argument-splitting"></a><a class="link" href="#argument-splitting">3.4.7. Argument splitting</a></h4>
<div class="paragraph">
<p>When the pattern is an infix, a prefix or a postfix, it also matches a
name if that name is bound to an infix, prefix or postfix expression
that would match. In that case, the bound value is said to be
<em>split</em> to match the parameters.
</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write X,Y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write Items</code> when <code>Items is "A","B"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write Items</code>
                                                        when
                                                        <code>Items is "A"+"B"</code>,
                                                        <code>wrote 0,1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write X%</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write Items</code> when <code>Items is 2%</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write Items</code>
                                                        when
                                                        <code>Items is 2!</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write -X</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write Items</code> when <code>Items is -2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>write Items</code>
                                                        when
                                                        <code>Items is +2</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A very common idiom is to use comma <code>,</code> infix to separate
multiple parameters, as in the following definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">write Head, Tail is write Head; write Tail</code></pre>
</div>
</div>
<div class="paragraph">
<p>This declaration will match <code>write 1, 2, 3</code> with bindings <code>Head is 1</code>
and <code>Tail is 2,3</code>. In the evaluation of the body with these bindings,
<code>write Tail</code> will then match the same declaration again with <code>Tail</code>
being split, resulting in bindings <code>Head is 2</code> and <code>Tail is 3</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="conditional-patterns"><a class="anchor" href="#conditional-patterns"></a><a class="link" href="#conditional-patterns">3.4.8. Conditional patterns</a></h4>
<div class="paragraph">
<p>When a top-level pattern is an infix like <code>Pattern when Condition</code>, then
the pattern matches an expression if the pattern on the left of the
infix matches the expression, and if the expression on the right
evaluates to <code>true</code> after bindings</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log X when X &gt; 0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log 3.5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>log(-3.5)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Such patterns are called <em>conditional patterns</em>. They do not match if
the expression evaluates to anything but <code>true</code>, notably if it evaluates
to any kind of error. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">log X when X &gt; 0 is ...
log "Logging an error"        // Will not match the definition above</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="validated-patterns"><a class="anchor" href="#validated-patterns"></a><a class="link" href="#validated-patterns">3.4.9. Validated patterns</a></h4>
<div class="paragraph">
<p>When a top-level pattern is an infix like <code>Pattern where Validation</code>, then
the pattern matches an expression if the pattern on the left of the
infix matches the expression, and if the validation on the right
compiles correctly after binding.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">`print X where { write X }</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>print "Hello"</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any value where <code>write X</code> is invalid</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Such patterns are called <em>validated patterns</em>. They do not match if
the evaluation of the validation fails, i.e. returns an error. Like
for conditional patterns, all bindings defined in the pattern are
visible in the body of the validation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Document that you can 'print' something if you can 'write' it
print X where
    write X</code></pre>
</div>
</div>
<div class="paragraph">
<p>The validation is part of the <em>interface</em> of the pattern. This enables
more precise error reporting.</p>
</div>
<div class="paragraph">
<p>The most common use case for validated patterns is to create so-called
<em>validated generic types</em>, which are types
used solely to indicate that a specific operation is available,
facilitating the use of generic code.</p>
</div>
<div class="paragraph">
<p>For example, the <code>ordered</code> type defined by the standard library
requires a comparison between values of the type, and can be defined with
something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type ordered where
     MustHaveLessThan(A:ordered, B:ordered) as boolean is A &lt; B</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can also be used to create advanced type interfaces that would be
difficult to express clearly using the more common pattern syntax. To
facilitate that usage, type annotations in a validation that apply to
parameters bound in the pattern apply as if they were directly in the
pattern.</p>
</div>
<div class="paragraph">
<p>For example, an interface for matrix multiplication can validate the
dimensions and value type as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Left * Right as result_matrix where
    number: type
    N     : integer
    M     : integer
    O     : integer
    Left  : matrix[N,M] of number
    Right : matrix[M,O] of number
    type result_matrix is matrix[N,O] of number</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This second usage is somewhat reminiscent of
<a href="https://doc.rust-lang.org/rust-by-example/generics/where.html">where
clauses</a> in Rust, and it is fortunate that there is some
similarity. However, the use of <code>where</code> for validated generics
<a href="https://github.com/c3d/xl/commit/899a07cf05e9be7c29e1a9cef1cd81326f738e02#diff-7ef85d49d753b59c4ba987b01c6a2b45">predates the Rust usage by several years</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="literal-constants"><a class="anchor" href="#literal-constants"></a><a class="link" href="#literal-constants">3.4.10. Literal constants</a></h4>
<div class="paragraph">
<p>When the pattern is an <code>integer</code> like <code>0</code>, a <code>real</code> like <code>3.5</code>, a <code>text</code>
like <code>"ABC"</code>, it only matches an expression with the same value, as
verified by evaluating the <code>Pattern = Value</code> expression, where <code>Pattern</code>
is the literal constant in the pattern, and <code>Value</code> is the evaluated
value of the expression. Checking that the value matches will therefore
require <a href="#immediate-evaluation">immediate evaluation</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0!</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>N!</code> when <code>N=0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>N!</code> when <code>N&lt;&gt;0</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This case applies to sub-patterns, as was the case for <code>0! is 1</code> in
the <a href="#factorial">definition of factorial</a>. It also applies to
top-level patterns, which is primarily useful in <a href="#scoping">maps</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">digits is
    0 is "Zero"
    1 is "One"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="metabox-values"><a class="anchor" href="#metabox-values"></a><a class="link" href="#metabox-values">3.4.11. Metabox values</a></h4>
<div class="paragraph">
<p>When the pattern is a an expression between two square brackets, like
<code>[[true]]</code>, it is called a <em>metabox</em>, and it only matches a value that
is equal to the value computed by the metabox. This equality is checked
by evaluating <code>Pattern = Value</code>, where <code>Pattern</code> is the expression in
the metabox, and <code>Value</code> is the expression being tested.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[[true]]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code>, <code>not false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"true"</code>, <code>1</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A metabox is used in particular when a name would be interpreted as a
parameter. The two declarations below declare a short-circuit boolean
<code>and</code> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">[[true]]  and X   is X
[[false]] and X   is false</code></pre>
</div>
</div>
<div class="paragraph">
<p>By contrast, the two definitions would not work as intended, since they
would simply declare parameters called <code>true</code> and <code>false</code>, always
causing the first one to be evaluated for any <code>A and B</code> expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">true  and X       is X
false and X       is false</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="blocks"><a class="anchor" href="#blocks"></a><a class="link" href="#blocks">3.4.12. Blocks</a></h4>
<div class="paragraph">
<p>When the pattern is a block, it matches what the block’s child would
match. In other words, blocks in patterns can be used to change the
relative precedence of operators in a complex expression, but play
otherwise no other role in pattern matching.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 24%;">
<col style="width: 38%;">
<col style="width: 38%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Definition</th>
<th class="tableblock halign-left valign-top">Matched by</th>
<th class="tableblock halign-left valign-top">Not matched by</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(X+Y)*(X-Y) is X^2-Y^2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[A+3]*[A-3]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(A+3)*(A-4)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The delimiters of a block cannot be tested that way. In other words, a
pattern with angle brackets can match parentheses or conversely. For
example, <code>[A:integer]</code> will match <code>2</code> or <code>(2)</code> or <code>{2}</code>.</p>
</div>
<div class="paragraph">
<p>It is possible to test the delimiters of a block, but that requires a
conditional pattern. For example the following code will check if its
argument is delimited with parentheses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">has_parentheses B:block when B.opening = "(" and B.closing = ")"  is true
has_parentheses B:block                                           is false</code></pre>
</div>
</div>
<div class="paragraph">
<p>In some cases, checking if an argument matches a pattern requires
evaluation of the corresponding expression or sub-expression. This is
called <a href="#immediate-evaluation">immediate evaluation</a>. Otherwise,
<a href="#lazy-evaluation">evaluation will be lazy</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>STYLE</strong> The rules of pattern matching give a lot of freedom with
respect to coding style. Several conventions are recommended and are
generally followed in this document:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a function takes multiple parameters, they are generally
represented using a comma-separated parameter list, altough in some
cases, other infix operators would do just as well:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">circle CenterX:real, CenterY:real, Radius:real is ...</code></pre>
</div>
</div>
</li>
<li>
<p>When there is such a comma-separated parameter list and when there
is more than one formal parameter, it is customary to surround it with
parentheses when the function is intended to be used in expressions,
because in such an expression context, the parentheses are necessary
at the call site. For example, if <code>circle</code> is intended to create a
<code>circle</code> object rather than to draw a circle, the above definition
might be written as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">circle (CenterX:real, CenterY:real, Radius:real) as circle is ...
C : circle := circle(0.3, 2.6, 4.0)</code></pre>
</div>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="scope-pattern-matching"><a class="anchor" href="#scope-pattern-matching"></a><a class="link" href="#scope-pattern-matching">3.4.13. Scope pattern matching</a></h4>
<div id="argument-scope" class="paragraph">
<p>When a block in a pattern defines a <a href="#sequences">sequence</a> of
declarations or definitions, that block is called a <em>parameter scope</em>,
and it can be matched by any <em>argument scope</em> that provides
matching definitions. In that case, the definitions in the argument
scope may be provided in a different order, provide additional
declarations, and the scope does not need to use the same delimiters
or separators:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">circle(Radius:real, CenterX:real, CenterY:real) as circle <i class="conum" data-value="1"></i><b>(1)</b>
C1 : circle := circle(3.5, 2.6, 3.2) <i class="conum" data-value="2"></i><b>(2)</b>
C2 : circle := circle(CenterX is 0.0; CenterY is 1.5; Radius is 2.4) <i class="conum" data-value="3"></i><b>(3)</b>
C3 : circle := circle <i class="conum" data-value="4"></i><b>(4)</b>
    Scaling is 1.3 <i class="conum" data-value="5"></i><b>(5)</b>
    Radius  is 1.5 * Scaling
    CenterX is 3.5 * Scaling
    CenterY is 2.4 * Scaling</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The formal parameters are a comma-separated sequence of
declarations, meaning that they form a valid scope. A semi-colon
or new-line could interchangeably be used there.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the normal <em>positional form</em> for argument passing.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An argument scope is passed, which contains the necessary
definitions to match the parameter scope. A semi-colon <code>;</code> must be
used to separate the definitions, because the comma <code>,</code> has a
higher precedence than <code>is</code>, and therefore cannot be used to
separate <code>is</code> definitions without parentheses.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The argument scope need not use the same separators as the
parameter scope. Using indentation and line separators removes the
need for parentheses, since all kinds of blocks are equivalent.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The argument scope may contain additional helper declarations or
definitions. It is just a regular scope where the only constraint
is that it must provide bindings that match what is required from
the parameter scope.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This form is often used for data types containing a large number of
parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type person matches person
    first_name : text
    middle_name: text
    last_name  : text
    birthdate  : date
    address    : address
JohnDoe : person := person
    last_name   is "Doe"
    first_name  is "John"
    middle_name is "W"
    birthdate   is date { Month is December; Day is 5; Year is 1968 }
    address     is address
        city    is "New-York"
        street  is "42nd"
        no      is 42
        zip     is 00002</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pattern-matching-scope"><a class="anchor" href="#pattern-matching-scope"></a><a class="link" href="#pattern-matching-scope">3.4.14. Pattern-matching scope</a></h4>
<div id="pattern-scope" class="paragraph">
<p>When matching a pattern, a <a href="#execution-context">local execution context</a>
is created that holds the bindings associated to the patterns being
matched. This <em>pattern-matching scope</em> is used while evaluating
the body of the definition.</p>
</div>
<div class="paragraph">
<p>Consider the following simple example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>foo T:text, A:real is
    print "T=", T, " A=", A
foo "Hello", 2.5</pre>
</div>
</div>
<div class="paragraph">
<p>As <a href="#evaluation-phase">indicated earlier</a>, the body associated to
the <code>foo</code> pattern will evaluate with a pattern-matching scope that
looks like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>CONTEXT1 is
    T : text is "Hello"
    A : real is 2.5</pre>
</div>
</div>
<div class="paragraph">
<p>This is particularly useful for structured data values and
user-defined data types. In XL, <a href="#types">types</a> are defined by the
shape of a parse tree, and that shape is typically defined using a
pattern. The <a href="#scoping">scoping operator</a> can then be used on
values of the type to access the pattern scope.</p>
</div>
<div class="paragraph">
<p>For example, a <code>complex</code> data type and the addition of <code>complex</code>
numbers can be written as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex matches complex(Re:real, Im:real) <i class="conum" data-value="1"></i><b>(1)</b>
Z1:complex + Z2:complex as complex is complex(Z1.Re+Z2.Re, Z1.Im+Z2.Im) <i class="conum" data-value="2"></i><b>(2)</b>
Z:complex := complex(1.3, 4.5) + complex(6.3, 2.5) <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a <a href="#types">type definition</a> based on a pattern.
It indicates that the <code>complex</code> data type corresponds to all the
values that have the parse-tree shape following <code>type</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>Z1.Re</code> notation is a <a href="#scoping">scoping operator</a>, and
evaluates <code>Re</code> in the pattern-matching scope of <code>Z1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Two <a href="#creation">constructors</a> create two <code>complex</code> values, that
are bound to <code>Z1</code> and <code>Z2</code> respectively. In the expression
<code>Z1.Re</code>, the name <code>Re</code> is looked up in pattern-matching scope for
these constructors, so that <code>Z1.Re</code> is <code>1.3</code> and <code>Z2.Im</code> is <code>2.5</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="declaration-selection"><a class="anchor" href="#declaration-selection"></a><a class="link" href="#declaration-selection">3.5. Declaration selection</a></h3>
<div class="paragraph">
<p>An important part in evaluating expressions is to identify which
particular declarations must be used.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#overloading">Overloading</a> is the ability to discriminate
between multiple patterns based on the type or value of the
arguments.</p>
</li>
<li>
<p><a href="#dynamic-dispatch">Dynamic dispatch</a> is the ability to perform
the selection of the right candidate based on run-time values, as
opposed to compile-time checks.</p>
</li>
<li>
<p><a href="immediate-evaluation">Immediate evaluation</a> is any evaluation
that is necessary in order to resolve overloading or dynamic
dispatch.</p>
</li>
<li>
<p>Conversely, <a href="#lazy-evaluation">lazy evaluation</a> is evaluation
that is deferred until the callee needs to evaluate the value.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="overloading"><a class="anchor" href="#overloading"></a><a class="link" href="#overloading">3.5.1. Overloading</a></h4>
<div class="paragraph">
<p>There may be multiple declarations where the pattern matches a given
parse tree. This is called <em>overloading</em>. For example, as we
have seen above, for the multiplication expression <code>X*Y</code> we have at
least <code>integer</code> and <code>real</code> candidates that look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X:integer * Y:integer as integer        is ...
X:real    * Y:real    as real           is ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first declaration above would be used for an expression like <code>2+3</code>
and the second one for an expression like <code>5.5*6.4</code>. It is important for
the evaluation to be able to distinguish them, since they may result in
very different machine-level operations.</p>
</div>
<div class="paragraph">
<p>In XL, the various declarations in the context are considered in order,
and the first declaration that matches is selected. A candidate
declaration matches if it matches the whole shape of the tree.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Historically, the <a href="#bootstrapping-xl">XL2</a>
implementation does not select the first that matches, but the <em>largest
and most specialized</em> match. This is a slightly more complicated
implementation, but not by far, and it has some benefits, notably with
respect to making the code more robust to reorganizations. For this
reason, this remains an open option. However, it is likely to be more
complicated with the more dynamic semantics of XL, notably for
<a href="#dynamic-dispatch">dynamic dispatch</a>, where the runtime cost of
finding the proper candidate might be a bit too high to be practical.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, <code>X+1</code> can match any of the declarations patterns below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X:integer + Y:integer
X:integer + 1
X:integer + Y:integer when Y &gt; 0
X + Y
Infix:infix</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same <code>X+1</code> expression will not match any of the following patterns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">foo X
+1
X * Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Knowing which candidate matches may be possible statically, e.g. at
compile-time, for example if the selection of the declaration can
be done solely based on the type of the arguments and parameters. This
would be the case if matching an <code>integer</code> argument against an
<code>integer</code> parameter, since any value of that argument would match. In
other cases, it may require run-time tests against the values in the
declaration. This would be the case if matching an <code>integer</code> argument
against <code>0</code>, or against <code>N:integer when N mod 2 = 0</code>.</p>
</div>
<div class="paragraph">
<p>For example, a definition of the
<a href="https://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci sequence</a> in XL
is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">fib 0   is 0
fib 1   is 1
fib N   is (fib(N-1) + fib(N-2))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Parentheses are required around the
<a href="#expression-vs-statement">expressions statements</a> in the last
declaration in order to parse this as the addition of <code>fib(N-1)</code> and
<code>fib(N-2)</code> and not as the <code>fib</code> of <code>(N-1)+fib(N-2)</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When evaluating a sub-expression like <code>fib(N-1)</code>, three candidates for
<code>fib</code> are available, and type information is not sufficient to eliminate
any of them. The generated code will therefore have to evaluate <code>N-1</code>.
<a href="#immediate-evaluation">Immediate evaluation</a>
is needed in order to compare the value against the candidates. If the
value is <code>0</code>, the first definition will be selected. If the value is
<code>1</code>, the second definition will be used. Otherwise, the third
definition will be used.</p>
</div>
<div class="paragraph">
<p>A binding may contain a value that may itself need to be
split in order to be tested against the formal
parameters. This is used in the implementation of <code>print</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">print Items             is { write Items; print }
write Head, Rest        is { write Head; write Rest }
write Item:integer      is ...  // Implementation for integer
write Item:real         is ...  // implementation for real</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that case, finding the declaration matching <code>print "Hello", "World"</code>
involves creating a binding like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT1 is
    Items is "Hello", "World"
    CONTEXT0</code></pre>
</div>
</div>
<div class="paragraph">
<p>When evaluating <code>write Items</code>, the various candidates for <code>write</code>
include <code>write Head, Rest</code>, and this will be the one selected after
splitting <code>Items</code>, causing the context to become:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT2 is
    Head is "Hello"
    Rest is "World"
    CONTEXT0
    HIDDEN1 is CONTEXT1</code></pre>
</div>
</div>
<div class="paragraph">
<p>A context may contain multiple identical definitions, in which case
the later ones are not visible. A slightly more useful case is to have
multiple definitions that are identical except for their type. In that
case, a definition that requires no implicit conversion will be
selected over one that does require one. An example of use would be to
provide two representations for the <code>i</code> complex constant:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex            is cartesian or polar
type cartesian          is matching cartesian(Re, Im)
type polar              is matching polar(Mod, Arg)
constant i as cartesian is cartesian(0,1)
constant i as polar     is polar(1, pi/2)</pre>
</div>
</div>
<div class="paragraph">
<p>This provides a form of value-based overloading, where a form is
selected over another based on the return type. This is in particular
used to implement forms that may return a value or not depending on
usage. This is in particular the case for <a href="#assignment">assignment</a>
operators, which can either return the assigned value, or <code>nil</code>. The
<code>nil</code> case is necessary when they are used as statements, because
non-<code>nil</code> values cannot be ignored in XL.</p>
</div>
</div>
<div class="sect3">
<h4 id="dynamic-dispatch"><a class="anchor" href="#dynamic-dispatch"></a><a class="link" href="#dynamic-dispatch">3.5.2. Dynamic dispatch</a></h4>
<div class="paragraph">
<p>As shown above, the declaration that is actually selected to evaluate a
given parse tree may depend on the dynamic value of the arguments. In
the Fibonacci example above, <code>fib(N-1)</code> may select any of the three
declarations of <code>fib</code> depending on the actual value of <code>N</code>. This runtime
selection of declarations based on the value of arguments is called
<em>dynamic dispatch</em>.</p>
</div>
<div class="paragraph">
<p>In the case of <code>fib</code>, the selection of the correct definition is a
function of an <code>integer</code> argument. This is not the only kind of test
that can be made. In particular, dynamic dispatch based on the <em>type</em> of
the argument is an important feature to support well-known techniques
such as <a href="#object-oriented-programming">object-oriented programming</a>.</p>
</div>
<div class="paragraph">
<p>Let’s consider an archetypal example for object-oriented programming,
the <code>shape</code> class, with derived classes such as <code>rectangle</code>, <code>circle</code>,
<code>polygon</code>, and so on. Textbooks typically illustrate dynamic dispatch
using a <code>Draw</code> method that features different implementations depending
on the class. Dynamic dispatch selects the appropriate implementation
based on the class of the <code>shape</code> object.</p>
</div>
<div class="paragraph">
<p>In XL, this can be written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">draw R:rectangle    is ... // Implementation for rectangle
draw C:circle       is ... // Implementation for circle
draw P:polygon      is ... // Implementation for polygon
draw S:shape        is ... // Implementation for shape

draw Something      // Calls the right implementation based on type of Something</code></pre>
</div>
</div>
<div class="paragraph">
<p>A single dynamic dispatch may require multiple tests on different
arguments. For example, the <code>and</code> binary operator can be defined
(somewhat inefficiently) as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">[[false]] and [[false]]     is false
[[false]] and [[true]]      is false
[[true]]  and [[false]]     is false
[[true]]  and [[true]]      is true</code></pre>
</div>
</div>
<div class="paragraph">
<p>When applied to types, this capability is sometimes called
<em>multi-methods</em> in the object-oriented world. This makes the XL version
of dynamic dispatch somewhat harder to optimize, but has interesting use
cases. Consider for example an operator that checks if two shapes
intersect. In XL, this can be written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X:rectangle intersects Y:rectangle  as boolean  is ... // two rectangles
X:circle    intersects Y:circle     as boolean  is ... // two circles
X:circle    intersects Y:rectangle  as boolean  is ... // rectangle &amp; circle
X:polygon   intersects Y:polygon    as boolean  is ... // two polygons
X:shape     intersects Y:shape      as boolean  is ... // general case

if shape1 intersects shape2 then    // selects the right combination
    print "The two shapes touch"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Type-based dynamic dispatch is relatively similar to the notion
of <em>virtual function</em> in C&#43;&#43;, although the XL
implementation is likely to be quite different. The C&#43;&#43;
approach only allows dynamic dispatch along a single axis, based on
the type of the object argument. C&#43;&#43; also features a special
syntax, <code>shape.Draw()</code>, for calls with dynamic dispatch, which differs
from the C-style syntax for function calls, <code>Draw(shape)</code>. The syntax
alone makes the <code>intersects</code> example difficult to write in C&#43;&#43;.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As another illustration of a complex dynamic dispatch not based on
types, <a href="http://tao3d.sourceforge.net">Tao3D</a> uses
<a href="https://github.com/c3d/tao3D/blob/63e2b358691795e612b027b247c99ad31eb3d0ec/modules/themes/white_christmas/white_christmas.xl#L309">theme
functions</a> that depend on the names of the slide theme, master and
element, as in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">theme_font "Christmas", "main",       "title"   is font "Times"
theme_font "Christmas", SlideMaster,  "code"    is font "Menlo"
theme_font "Christmas", SlideMaster,  SlideItem is font "Palatino"
theme_font SlideTheme,  SlideMaster,  SlideItem is font "Arial"</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the example above illustrates, the XL approach to dynamic dispatch
takes advantage of pattern matching to allow complex combinations of
argument tests.</p>
</div>
</div>
<div class="sect3">
<h4 id="immediate-evaluation"><a class="anchor" href="#immediate-evaluation"></a><a class="link" href="#immediate-evaluation">3.5.3. Immediate evaluation</a></h4>
<div class="paragraph">
<p>In the <code>circumference</code> examples, matching <code>2 * pi * Radius</code> against
the possible candidates for <code>X * Y</code> expressions required an evaluation
of <code>2 * pi</code> in order to check whether it was a <code>real</code> or <code>integer</code>
value.  This is called <em>immediate evaluation</em> of arguments, and is
required in XL for statements, but
also in the following cases:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When the formal parameter being checked has a type annotation, like
<code>Radius</code> in our example, and when the annotation type does not match the
type associated to the argument parse tree. Immediate evaluation is
required in such cases in order to check if the argument type is of the
expected type after evaluation. Evaluation is <em>not</em> required if the
argument and the declared type for the formal parameter match, as in the
following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">write X:infix   is  write X.left, " ", X.name, " ", X.right
write A+3</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that case, since <code>A+3</code> is already an <code>infix</code>, it is possible to bind
it to <code>X</code> directly without evaluating it. So we will evaluate the body
with binding <code>X:infix is A+3</code>.</p>
</div>
</li>
<li>
<p>When the part of the pattern being checked is a constant or a
<a href="#metabox">metabox</a>. For example, this is the case in the definition
of the factorial below, where the expression <code>(N-1)</code> must be evaluated
in order to check if it matches the value <code>0</code> in pattern <code>0!</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">0! is 1
N! is N * (N-1)!</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is also the case for the condition in <code>if-then-else</code> statements, to
check if that condition matches either <code>true</code> or <code>false</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">if [[true]]  then TrueBody else FalseBody    is TrueBody
if [[false]] then TrueBody else FalseBody    is FalseBody</code></pre>
</div>
</div>
</li>
<li>
<p>When the same name is used more than once for a formal parameter, as
in the following optimization:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">A - A    is 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Such a definition would require the evaluation of <code>X</code> and <code>2 * Y</code> in
expression <code>X - 2 * Y</code> in order to check if they are equal.</p>
</div>
</li>
<li>
<p>When a conditional clause requires the evaluation of the corresponding
binding, as in the following example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">syracuse N when N mod 2 = 0  is N/2
syracuse N when N mod 2 = 1  is N * 3 + 1
syracuse X+5 // Must evaluate "X+5" for the conditional clause</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Evaluation of sub-expressions is performed in the order required to test
pattern matching, and from left to right, depth first. Patterns are
tested in the order of declarations. Computed values for sub-expressions
are <a href="#memoization">memoized</a>, meaning that they
are computed at most once in a given statement.</p>
</div>
</div>
<div class="sect3">
<h4 id="lazy-evaluation"><a class="anchor" href="#lazy-evaluation"></a><a class="link" href="#lazy-evaluation">3.5.4. Lazy evaluation</a></h4>
<div class="paragraph">
<p>In the cases where immediate evaluation is not required, an argument
will be bound to a formal parameter in such a way that an evaluation of
the formal argument in the body of the declaration will evaluate the
original expression in the original context. This is called <em>lazy evaluation</em>. The original expression will be evaluated every time the
parameter is evaluated.</p>
</div>
<div class="paragraph">
<p>To understand these rules, consider the canonical definition of <code>while</code>
loops:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">while Condition loop Body is
    if Condition then
        Body
        while Condition loop Body</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s use that definition of <code>while</code> in a context where we test the
<a href="https://en.wikipedia.org/wiki/Collatz_conjecture">Syracuse conjecture</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">while N &lt;&gt; 1 loop
    if N mod 2 = 0 then
        N /= 2
    else
        N := N * 3 + 1
    print N</code></pre>
</div>
</div>
<div class="paragraph">
<p>The definition of <code>while</code> given above only works because <code>Condition</code> and
<code>Body</code> are evaluated multiple times. The context when evaluating the
body of the definition is somewhat equivalent to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>CONTEXT1 is
    Condition is N &lt;&gt; 1
    Body is
        if N mod 2 = 0 then
            N /= 2
        else
            N := N * 3 + 1
        print N
    CONTEXT0</pre>
</div>
</div>
<div class="paragraph">
<p>In the body of the <code>while</code> definition, <code>Condition</code> must be evaluated
because it is tested against metabox <code>[[true]]</code> and <code>[[false]]</code> in the
definition of <code>if-then-else</code>. In that same definition for <code>while</code>,
<code>Body</code> must be evaluated because it is a
statement.</p>
</div>
<div class="paragraph">
<p>The value of <code>Body</code> or <code>Condition</code> is not changed by them being
evaluated. In our example, the <code>Body</code> and <code>Condition</code> passed in the
recursive statement at the end of the <code>while Condition loop Body</code> are
the same arguments that were passed to the original invokation. For the
same reason, each test of <code>N &lt;&gt; 1</code> in our example is with the latest
value of <code>N</code>.</p>
</div>
<div class="paragraph">
<p>Lazy evaluation can also be used to implement "short circuit" boolean
operators. The following code for
the <code>and</code> operator will not evaluate <code>Condition</code> if its left operand
is <code>false</code>, making this implementation of <code>and</code> more efficient than
the one given earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">[[true]]  and Condition is Condition
[[false]] and Condition is false</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functional-evaluation"><a class="anchor" href="#functional-evaluation"></a><a class="link" href="#functional-evaluation">3.6. Functional evaluation</a></h3>
<div class="paragraph">
<p>The evaluation of XL expressions borrows a number of ideas that are
somewhat common in functional programming languages, but less common
in imperative programming languages such as Ada, Pascal, C or C++.
These ideas include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#closures">Closures</a> are a way to encapsulate declarations in a
way that makes it safe to pass code fragments as arguments to
functions.</p>
</li>
<li>
<p><a href="#memoziation">Memoization</a> is a way to remember which
expressions have already been evaluated, in order to optimize
evaluation but, more importantly, make it deterministic even in the
presence of non-pure functions (i.e. functions that return different
values for the same input), such as <code>random</code> or <code>current_time</code>.</p>
</li>
<li>
<p><a href="#functions-as-values">First order functions</a> are functions
treated as values. Since XL allows notations that are not obviously
"functional", this may occasionally require an tiny wrapper in XL.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="closures"><a class="anchor" href="#closures"></a><a class="link" href="#closures">3.6.1. Closures</a></h4>
<div class="paragraph">
<p>The bindings given in the <code>while</code> loop definition above for
<code>Condition</code> and <code>Body</code> are somewhat simplistic. Consider what would
happen if you wrote the following <code>while</code> loop:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Condition is N &gt; 1
while Condition loop N -= 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Evaluating this would lead to a "naive" binding that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT2 is
    Condition is Condition
    Body is N -= 1
    CONTEXT0</code></pre>
</div>
</div>
<div class="paragraph">
<p>That would not work well, since evaluating <code>Condition</code> would require
evaluating <code>Condition</code>, and indefinitely so. Something needs to be done
to address this.</p>
</div>
<div class="paragraph">
<p>In reality, the bindings must look more like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT2 is
    Condition is CONTEXT1 { Condition }
    Body is CONTEXT1 { N-= 1 }
    CONTEXT0</code></pre>
</div>
</div>
<div id="closure" class="paragraph">
<p>The notation <code>CONTEXT1 { Condition }</code> means that we evaluate <code>Condition</code>
in context <code>CONTEXT1</code>. This one of the <a href="#scoping">scoping operators</a>,
which is explained in more details below. A prefix with a context on the
left and a block on the right is called a <em>closure</em>.</p>
</div>
<div class="paragraph">
<p>In the above example, we gave an arbitrary name to the closure,
<code>CONTEXT1</code>, which is the same for both <code>Condition</code> and <code>Body</code>. This name
is intended to underline that the <em>same</em> context is used to evaluate
both. In particular, if <code>Body</code> contains a context-modifying operation
like <code>N -= 1</code>, that will modify the same <code>N</code> in the same <code>CONTEXT1</code> that
will later be used to evaluate <code>N &gt; 1</code> while evaluating <code>Condition</code>.</p>
</div>
<div class="paragraph">
<p>A closure may be returned as a result of evaluation, in which case all
or part of a context may need to be captured in the returned value, even
after that context would otherwise normally be discarded.</p>
</div>
<div id="lambda_function" class="paragraph">
<p>For example, consider the following code defining an anonymous function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">adder N is { lambda X is X + N }
add3 is adder 3     // Creates a function that adds 3 to its input
add3 5              // Computes 8</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we evaluate <code>add3</code>, a binding <code>N is 3</code> is created in a new context
that contains declaration <code>N is 3</code>. That context can simply be written
as <code>{ N is 3 }</code>. A context with an additional binding for <code>M is "Hello"</code>
could be written something like <code>{ N is 3; M is "Hello" }</code>.</p>
</div>
<div class="paragraph">
<p>The value returned by <code>adder N</code> is not simply <code>{ lambda X is X + N }</code>,
but something like <code>{ N is 3 } { lambda X is X + N }</code>, i.e. a closure that
captures the bindings necessary for evaluation of the body <code>X + N</code> at a
later time.</p>
</div>
<div class="paragraph">
<p>This closure can correctly be evaluated even in a context where there is
no longer any binding for <code>N</code>, like the global context after the
finishing the evaluation of <code>add3</code>. This ensures that <code>add3 5</code> correctly
evaluates as <code>8</code>, because the value <code>N is 3</code> is <em>captured</em> in the
closure.</p>
</div>
<div class="paragraph">
<p>A closure looks like a prefix <code>CONTEXT EXPR</code>, where <code>CONTEXT</code> and <code>EXPR</code>
are blocks, and where <code>CONTEXT</code> is a sequence of declarations.
Evaluating such a closure is equivalent to evaluating <code>EXPR</code> in the
current context with <code>CONTEXT</code> as a local context, i.e. with the
declarations in <code>CONTEXT</code> possibly shadowing declarations in the current
context.</p>
</div>
<div class="paragraph">
<p>In particular, if argument splitting is required to evaluate the
expression, each of the split arguments shares the same context.
Consider the <code>write</code> and <code>print</code> implementation, with the following
declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">write Head, Tail        is { write Head; write Tail }
print Items             is { write Items; print }</code></pre>
</div>
</div>
<div class="paragraph">
<p>When evaluating <code>{ X is 42 } { print "X=", X }</code>, <code>Items</code> will be bound
with a closure that captures the <code>{ X is 42 }</code> context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT1 is
    Items is { X is 42 } { "X=", X }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In turn, this will lead to the evaluation of <code>write Items</code>, where
<code>Items</code> is evaluated using the <code>{ X is 42 }</code> context. As a result, the
bindings while evaluating <code>write</code> will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT2 is
    Head is CONTEXT1 { "X=" }
    Tail is CONTEXT1 { X }
    CONTEXT1 is { X is 42 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The whole processus ensures that, when <code>write</code> evaluates <code>write Tail</code>,
it computes <code>X</code> in a context where the correct value of <code>X</code> is
available, and <code>write Tail</code> will correctly write <code>42</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="memoization"><a class="anchor" href="#memoization"></a><a class="link" href="#memoization">3.6.2. Memoization</a></h4>
<div class="paragraph">
<p>A sub-expression will only be computed once irrespective of the number
of overload candidates considered or of the number of tests performed on
the value. Once a sub-expression has been computed, the computed value
is always used for testing or binding that specific sub-expression, and
only that sub-expression. This is called <em>memoization</em>.</p>
</div>
<div class="paragraph">
<p>For example, consider the following declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X + 0               is Case1(X)
X + Y when Y &gt; 25   is Case2(X, Y)
X + Y * Z           is Case3(X,Y,Z)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you evaluate an expression like <code>A + foo B</code>, then <code>foo B</code> will be
evaluated in order to test the first candidate, and the result will be
compared against <code>0</code>. The test <code>Y &gt; 25</code> will then be performed with the
result of that evaluation, because the test concerns a sub-expression,
<code>foo B</code>, which has already been evaluated.</p>
</div>
<div class="paragraph">
<p>On the other hand, if you evaluate <code>A + B * foo C</code>, then <code>B * foo C</code>
will be evaluated to match against <code>0</code>. Like previously, the evaluated
result will also be used to test <code>Y &gt; 25</code>. If that test fails, the third
declaration remains a candidate, because having evaluated <code>B * foo C</code>
does not preclude the consideration of different sub-expressions such as
<code>B</code> and <code>foo C</code>. However, if the evaluation of <code>B * foo C</code> required the
evaluation of <code>foo C</code>, then that evaluated version will be used as a
binding for <code>Z</code>.</p>
</div>
<div class="paragraph">
<p>Another important effect of memoization is that it limits the number
of evaluation of top-level constants. In other words, a single
evaluation will not "chase constants". Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">do_not_chase is
    0 is 1
    1 is 2
    2 is 3
do_not_chase 0          // Returns 1, not 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>The evaluation of sub-expression <code>0</code> happens only once, and therefore,
<code>1</code> is not itself evaluated again for the same sub-expression. This is
quite important to get sensible results for <a href="#scoping">maps</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> These rules are not just optimizations. They are necessary
to preserve the semantics of the language during dynamic dispatch for
expressions that are not constant. For example, consider a call like
<code>fib(random(3..10))</code>, which evaluates the <code>fib</code> function with a random
value between <code>3</code> and <code>10</code>. Every time <code>random</code> is evaluated, it returns
a different, pseudo-random value. The rules above guarantee that the
<em>same</em> value will be used when testing against <code>0</code>, <code>1</code> or as a binding
with <code>N</code>. Witout these rules, it would be possible for the body of the
general case to be called with a value that is <code>0</code> or <code>1</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="functions-as-values"><a class="anchor" href="#functions-as-values"></a><a class="link" href="#functions-as-values">3.6.3. Functions as values</a></h4>
<div class="paragraph">
<p>Unlike in several functional languages, when you declare a "function",
you do not automatically declare a named entity or value with the
function’s name.</p>
</div>
<div class="paragraph">
<p>For example, the first definition in the following code does not create
any declaration for <code>my_function</code> in the context, which means that the
last statement in that code will cause an error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">my_function X is X + 1
apply Function, Value is Function(Value)
apply my_function, 1        // Error: Nothing called 'my_function'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> One reason for that choice is that
<a href="#overloading">overloading</a> means a multiplicity of declarations
often need to be considered for a single expression. Another reason is
that declarations can have arbitrarily complex patterns. It is not
obvious what name should be given to a declaration of a pattern like
<code>A in B..C</code>: a "name" like <code>in..</code> does not even "work"
syntactically.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is not clear how such a name would be called as a function either,
since some of the arguments may themselves contain arbitrary parse
trees, as we have seen for the definition of <code>print</code>, where the single
<code>Items</code> parameter may actually be a comma-separated list of arguments
that will be split when calling <code>write Items</code> and matching it to
<code>write Head, Tail</code>.</p>
</div>
<div class="paragraph">
<p>If you need to perform the operation above, it is however quite easy to
create a map that performs the operation. That map may be given a name
or be anonymous. The following code example shows two correct ways to
write such an <code>apply</code> call for a factorial definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">0!                      is 1
N!                      is N * (N-1)!
apply Function, Value   is Function(Value)

// Using an anonymous map to compute 3!
apply { lambda N is N! }, 3

// Using a named map to compute 5!
factorial   is { lamdba N is N! }
apply factorial, 5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Passing definitions like this might be seen as related to what other
languages call <em>anonymous functions</em>, or sometimes <em>lambda function</em> in
reference to Church’s lambda calculus. The way this works, however, is
markedly different internally, and is detailed in the section on
<a href="#scoping">scoping</a> above.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="special-evaluation-rules"><a class="anchor" href="#special-evaluation-rules"></a><a class="link" href="#special-evaluation-rules">3.7. Special evaluation rules</a></h3>
<div class="paragraph">
<p>A few cases require special evaluation rules</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#sequence-evaluation">Evaluating sequences</a> forces
<a href="#immediate-evaluation">immediate evaluation</a> of
all the terms in the sequence in order. All the terms but the last
one must evaluate as <code>nil</code> or an <code>error</code>.</p>
</li>
<li>
<p><a href="#self">Self</a> is a way to stop the evaluation of a form</p>
</li>
<li>
<p>The <a href="#implicit-result-variable">implicit <code>result</code> variable</a> can be used to
set the value returned by a declaration.</p>
</li>
<li>
<p>The <a href="#returned-value">returned value</a> for a declaration follows rules that
take into account the <code>result</code> variable, <code>return</code> statements and <code>error</code>
values.</p>
</li>
<li>
<p><a href="#assignment">Assignment</a> operations are somewhat special insofar as they
are used for <a href="#transfers">transfers</a> of values during parameter passing
while evaluating all other operations.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="sequence-evaluation"><a class="anchor" href="#sequence-evaluation"></a><a class="link" href="#sequence-evaluation">3.7.1. Sequence evaluation</a></h4>
<div class="paragraph">
<p>A sequence, i.e. an <code>infix</code> with a <code>;</code> or new-line as a separator,
requires <a href="#immediate-evaluation">immediate evaluation</a> of its left
term, and evaluates as its right term, which may be
<a href="lazy-evaluation">evaluated lazily</a>.</p>
</div>
<div class="paragraph">
<p>The left term is expected to evaluate to <code>nil</code>. However, if it
evaluates as <a href="#error-handling">an <code>error</code> value</a>, then
the sequence as a whole evaluates as that <code>error</code> value.</p>
</div>
<div class="paragraph">
<p>Any other return value results in a type error.</p>
</div>
</div>
<div class="sect3">
<h4 id="self"><a class="anchor" href="#self"></a><a class="link" href="#self">3.7.2. Self</a></h4>
<div class="paragraph">
<p>In a definition body, <code>self</code> refers to the input parse tree. A
special idiom is a definition where the body is <code>self</code>, called a
<em>self definition</em>.  Such definitions indicates that the item being
defined needs no further evaluation. For example, <code>true</code> and <code>false</code>
can be defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">true    is self
false   is self</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that evaluating <code>true</code> will return <code>true</code>, and evaluating
<code>false</code> will return <code>false</code>, without any further
evaluation. Note that you cannot write for
example <code>true is true</code>, as <code>true</code> in the body is a statement, which
would require further evaluation, hence an infinite recursion.</p>
</div>
<div class="paragraph">
<p>It is possible to use <code>self</code> for data structures. For example, in
order to ensure that elements of a comma-separated <code>list</code> are not
evaluated, you can write :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">list (X, Y)             is self</code></pre>
</div>
</div>
<div class="paragraph">
<p>A sugar form using <code>data</code> is usually in that case to draw attention to
this situation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">data list(X, Y)         is self</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the following values also evaluate as themselves:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>integer</code>, <code>real</code> or <code>text</code> constants, unless an explicit declaration
in the current context matches.</p>
</li>
<li>
<p>Sequences of declarations, like <code>{ Zero is 0; One is 1 }</code>, in
particular the contexts captured for
<a href="#closures">closures</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="implicit-result-variable"><a class="anchor" href="#implicit-result-variable"></a><a class="link" href="#implicit-result-variable">3.7.3. Implicit result variable</a></h4>
<div class="paragraph">
<p>Within the body of a definition, an implicit variable called <code>result</code>
holds the value that will be given to the caller. For example, an
iterative version of the factorial function can be written as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>factorial N:natural as natural is
    result := 1
    for I in 2..N loop
        result *= I</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="returned-value"><a class="anchor" href="#returned-value"></a><a class="link" href="#returned-value">3.7.4. Returned value</a></h4>
<div class="paragraph">
<p>The value returned by the body of a definition is, in order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the value of a <code>return</code> statement if there is one. A <code>return</code>
statement immediately stops evaluation.</p>
</li>
<li>
<p>the value of any statement that <a href="#error-handling">returns an <code>error</code></a>.</p>
</li>
<li>
<p>the last value assigned to the <code>result</code> variable</p>
</li>
<li>
<p>if <code>result</code> was never assigned to in the body, the value of the last
statement evaluated in the body.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example, in addition to the definition given in the previous
section, a factorial can be written as follows using a <code>return</code>
statement, although it is not quite idiomatic:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>factorial_return N:natural as natural is
    if N = 0 then
        return 1
    return N * factorial_return(N-1)</pre>
</div>
</div>
<div class="paragraph">
<p>An alternate form would use the last returned value:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>factorial_last N:natural as natural is
    if N = 0 then
        1
    else
        N * factorial_last(N-1)</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scoping"><a class="anchor" href="#scoping"></a><a class="link" href="#scoping">3.8. Scoping</a></h3>
<div class="paragraph">
<p>The term <em>scoping</em> refers to the set of rules that describe the
hierarchical relationship between declarations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#nested-declarations">Nested declarations</a> are declarations
within declarations or blocks, and are not visible outside of the
enclosing declaration or block.</p>
</li>
<li>
<p><a href="#scopes-and-maps">Scopes</a> describe the set of declarations that
are visible at any given point. Users can explicitly define scopes
using <em>maps</em>, which are blocks containing only declarations.</p>
</li>
<li>
<p>The <a href="#context"><code>context</code></a> variable refers to the current context,
which makes it possible to easily pass a context around.</p>
</li>
<li>
<p>The <a href="#enclosing-context"><code>super</code></a> variable refers to the
immediately enclosing context.</p>
</li>
<li>
<p>The <a href="#static-context"><code>static</code></a> variables refers to a static
context which keeps its value from one evaluation of the context to
the next.</p>
</li>
<li>
<p>The <a href="#global-context"><code>global</code></a> variable refers to a global
context that is shared by all entities in the program.</p>
</li>
<li>
<p>The <a href="#thread-context"><code>thread</code></a> variable refers to a per-thread
context that can be used to optimize operations on multiprocessor systems.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="nested-declarations"><a class="anchor" href="#nested-declarations"></a><a class="link" href="#nested-declarations">3.8.1. Nested declarations</a></h4>
<div class="paragraph">
<p>A definition body, or any block for that matter, may itself contain
declarations, which are called <em>nested declarations</em>.</p>
</div>
<div class="paragraph">
<p>When the body is evaluated, a <em>local declaration
phase</em> will run, followed by a <em>local evaluation phase</em>. The local
<a href="#declaratiion-phase">declaration phase</a> will add the local
declarations at the beginning of a new context, which will be
destroyed when the body evaluation terminates. The local declarations
therefore shadow declarations from the enclosing context.</p>
</div>
<div class="paragraph">
<p>For example, a function that returns the number of vowels in some text
can be written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">count_vowels InputText is
    is_vowel C is
        Item in Head, Tail  is Item in Head or Item in Tail
        Item in RefItem     is Item = RefItem
        C in 'a', 'e', 'i', 'o', 'u', 'y', 'A', 'E', 'I', 'O', 'U', 'Y'

    Count : integer := 0
    for C in InputText loop
        if is_vowel C then
            Count += 1
    Count
count_vowels "Hello World" // Returns 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code example defines a local helper <code>is_vowel C</code> that checks if <code>C</code>
is a vowel by comparing it against a list of vowels. That local helper
is not visible to the outer scopes, in other words, to the rest of the
program. You cannot use <code>is_vowel X</code> elsewhere in the program, since it is
not present in the outer context. It is, however, visible while
evaluating the body of <code>count_vowels T</code>.</p>
</div>
<div class="paragraph">
<p>Similarly, the local helper itself defines an even more local helper
infix <code>in</code> in order ot evaluate the following expression:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>C in 'a', 'e', 'i', 'o', 'u', 'y', 'A', 'E', 'I', 'O', 'U', 'Y'</pre>
</div>
</div>
<div class="paragraph">
<p>While evaluating <code>count_vowels "Hello World"</code>, the context will look
something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT1 is
    is_vowel C is ...
    Count:integer := 0
    InputText is "Hello World"
    CONTEXT0</code></pre>
</div>
</div>
<div class="paragraph">
<p>In turn, while evaluating <code>is_vowel Char</code>, the context will look
something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">CONTEXT2 is
    Item in Head, Tail is ...
    Item in RefItem is ...
    C is 'l'
    CONTEXT1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The context is sorted so that the innermost definitions are visible
first, possibly shadowing outer
declarations. Also, outer declarations are
visible from the body of inner ones.  In the example above, the body
of <code>is_vowel Char</code> could validly refer to <code>Count</code> or to <code>InputText</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This example is designed for illustration purpose only. It is not
idiomatic XL, since the standard library provides useful tools. A better
way to write it would be:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>count_vowels InputText is count C in InputText where C in "aeiouyAEIOUY"</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="scopes-and-maps"><a class="anchor" href="#scopes-and-maps"></a><a class="link" href="#scopes-and-maps">3.8.2. Scopes and maps</a></h4>
<div class="paragraph">
<p>A list of declarations, similar to the kind that is used in
<a href="#closures">closures</a>, is called a <em>map</em> and evaluates as itself. One
of the primary uses for maps is to create a common <em>scopes</em> for
the declarations that it contains. Since the
<a href="#declaration-phase">declaration phase</a> operates on entire blocks,
all declarations within a scope are visible at the same time.</p>
</div>
<div class="paragraph">
<p>There are two primary operations that apply to a map:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Applying</em> a map as a prefix to an operand, as
we saw with closures, evaluates the operand in the context defined by
overlaying the map definitions on top of the current context.</p>
</li>
<li>
<p><em>Scoping</em> an expression within a map uses the infix <code>.</code> operator,
where the expression on the right is evaluated in a context that
consists <em>exclusively</em> of the declarations in the map on the left.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Evaluating a closure is a prime example of map application. The
context is captured by the closure in a map, and
the closure itself is a prefix that corresponds to the map
application. Such an expression can also be created explicitly. For
example, <code>{ X is 40; Y is 2 } { X + Y }</code> will evaluate as <code>42</code>, taking
<code>X</code> and <code>Y</code> from the map, and taking the declaration used to evaluate
<code>X + Y</code> from the current context.</p>
</div>
<div class="paragraph">
<p>Another common usage for maps is to store declarations where the
patterns are constant values. For example, you
can use a map called <code>digit_spelling</code> to convert a digit to its
English spelling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">digit_spelling is
    0 is "zero"
    1 is "one"
    2 is "two"
    3 is "three"
    4 is "four"
    5 is "five"
    6 is "six"
    7 is "seven"
    8 is "eight"
    9 is "nine"</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this declaration, the expression <code>digit_spelling 3</code> evaluates to
<code>"three"</code>. This kind of map application is called <em>indexing</em>. A
suggested style choice is to make the intent more explicit using square brackets, i.e. <code>digit_spelling[4]</code>, as a nod to the syntax of
programming languages such as C or C&#43;&#43;.</p>
</div>
<div class="paragraph">
<p>When the index is an expression, for example <code>digit_spelling[A+3]</code> in a
context where <code>A is 2</code>, we must evaluate <code>A+3</code> in the current context
augmented with the declarations in <code>digit_spelling</code>. In other words,
the relevant context for evaluation will look something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{ X:integer+Y:integer as integer is ... }
  { A is 2 }
    { 0 is "zero"; 1 is "one"; ... }
      [A+3]</pre>
</div>
</div>
<div class="paragraph">
<p>The first candidate for evaluation has pattern <code>0</code>. This requires
<a href="#immediate-evaluation">immediate evaluation</a> of expression <code>A+3</code> to
check if it matches the value. Naively, one might think that
evaluating it requires matching once more against <code>0</code>, and that the
evaluation would neve terminate. However,
<a href="#memoization">memoization</a> of sub-expression <code>A+3</code> means that it
can no longer be evaluated in the inner context.</p>
</div>
<div class="paragraph">
<p>It can still, however, be evaluted in the outer context. In that outer
context, the pattern matches the <code>X:integer+Y:integer</code> pattern, from
which it computes value <code>2+3</code>, and then returns <code>5</code> for comparison in
the inner context, in order to compare it against <code>0</code>. Since <code>0=5</code>
fails, it then considers the next candidate, but again because of
memoization, there is no need to re-evaluate the value of
sub-expression <code>A+3</code>. Instead, the computed value <code>5</code> will be compared
successively against <code>1</code>, <code>2</code>, and so on, until it matches <code>5</code>. The
returned value for the inner expression is therefore <code>"five"</code>.</p>
</div>
<div class="paragraph">
<p>A map is not restricted to constant patterns. For example, the following
map performs a more complete spelling conversion for numbers below 1000
(the notation <code>\N</code> being a shortcut for <code>lambda N</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">number_spelling is
    \N when N&lt;10    is digit_spelling[N]
    11              is "eleven"
    12              is "twelve"
    13              is "thirteen"
    14              is "fourteen"
    15              is "fifteen"
    16              is "sixteen"
    17              is "seventeen"
    18              is "eighteen"
    19              is "nineteen"
    20              is "twenty"
    30              is "thirty"
    40              is "forty"
    50              is "fifty"
    60              is "sixty"
    70              is "seventy"
    80              is "eighty"
    90              is "ninety"
    ten N           is N&lt;100  and N mod 10 = 0
    hun N           is N&lt;1000 and N mod 100 = 0
    \N when ten N   is (number_spelling[N/10*10])
    \N when N&lt;100   is (number_spelling[N/10*10] &amp; " " &amp;
                        digit_spelling[N mod 10])
    \N when hun N   is (digit_spelling[N/100] &amp; "hundred")
    \N when N&lt;1000  is (digit_spelling[N/100] &amp; " hundred and " &amp;
                        number_spelling[N mod 100])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another common idiom is to use a named map to group related
declarations. This is the basis for the XL module system. For example,
consider the following declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">byte_magic_constants is
    num_bits    is 8
    min_value   is 0
    max_value   is 255</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that declaration, <code>byte_magic_constants.num_bits</code> evaluates to <code>8</code>.
A declaration like this can of course be more than a simple name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">magic_constants(Bits) is
    num_bits    is Bits
    min_value   is 0
    max_value   is 2^Bits - 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that case, <code>magic_constants(4).max_values</code> will evaluate to <code>15</code>.</p>
</div>
<div class="paragraph">
<p>This is also exactly what happens when you <code>use</code> a module. For example,
with <code>use IO = XL.CONSOLE.TEXT_IO</code>, a local name <code>IO</code> is created in the
current context that contains the declarations in the module. As a
result, <code>IO.write</code> will refer to the declaration in the module.</p>
</div>
</div>
<div class="sect3">
<h4 id="current-context"><a class="anchor" href="#current-context"></a><a class="link" href="#current-context">3.8.3. Current context</a></h4>
<div class="paragraph">
<p>The <code>context</code> variable can be used to access the current scope at any
point of the program. This can be used in particular to pass the
current context to some other declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X : integer := 42

foo Ctx, Value is
    Ctx.X := Value
    Ctx &amp;=
        Y is "Hello"

foo context, 33

print "X=", X, " Y=", Y   // Prints 33 Hello</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The ability to inject something in a context as indicated above
has some interesting use cases. For example, an object-oriented
package could inject a "virtual functions table" field in the types
that are passed to it. Whether this can be implemented in a sane and
safe way without making any kind of optimization impossible remains to
be validated. Also, the syntax may change, as it&#8217;s unclear that the
proposed syntax is not ambiguous or unintuitive.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="enclosing-context"><a class="anchor" href="#enclosing-context"></a><a class="link" href="#enclosing-context">3.8.4. Enclosing context</a></h4>
<div class="paragraph">
<p>In a given context, <code>super</code> is a way to refer to the enclosing scope.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X is 42
foo X:integer is X + super X    // super X refers to X above
foo 3                           // Returns 45</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this specific use-case, the notation <code>super.X</code> would find the
declaration for <code>X</code>, because it is in the immediately enclosing
scope. In general, however, it is more advisable to use <code>super X</code>, so
that <code>X</code> is found even if it&#8217;s in some further enclosing scope.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="static-context"><a class="anchor" href="#static-context"></a><a class="link" href="#static-context">3.8.5. Static context</a></h4>
<div class="paragraph">
<p>The <code>static</code> name can be used to refer to a context that is specific
to the current scope, but remains from one evaluation of that scope to
the next.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">foo is
   static.{ Counter : natural := 0 }
   static.Counter := static.Counter + 1
   X + static.Counter

for I in 1..5 loop
    print "foo = ", foo    // Prints 1, 2, 3, 4, 5</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>static</code> sugar for declarations creates types that store their
values in the static context. The above code can be written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">foo is
   static Counter : natural := 0
   Counter := Counter + 1
   X + Counter

for I in 1..5 loop
    print "foo = ", foo    // Prints 1, 2, 3, 4, 5</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="global-context"><a class="anchor" href="#global-context"></a><a class="link" href="#global-context">3.8.6. Global context</a></h4>
<div class="paragraph">
<p>The <code>global</code> name can be used to refer to the global context, which is
a special static context shared by all modules and all scopes in the
system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Access the C errno variable
global.{ errno as integer is C.errno }

if some_C_function() &lt; 0 then
    print "Function failed with errno=", global.errno</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>global</code> context is <em>not</em> visible by default unlike in
languages such as C or C++. One reason for this choice is that global
state is often a source of problems, so XL does not make it overly
easy to create global variables.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="thread-context"><a class="anchor" href="#thread-context"></a><a class="link" href="#thread-context">3.8.7. Thread context</a></h4>
<div class="paragraph">
<p>The <code>thread</code> name can be used to refer to a per-thread global
context. Like the <code>static</code> context, the <code>thread</code> context is local to
the current scope.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Process next-item
thread.{ work_items as list of tasks }
global.{ work_items as list of tasks }
next_work_item as [work_item or nil] is
    if not thread.work_items.empty then
        pop thread.work_items
    else
        single_threaded
           if not global.work_items.empty then
               pop global.work_items
           else
               nil</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s unclear if there is a real need for a per-thread global
scope. If so, it could be called <code>thread.global</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="error-handling"><a class="anchor" href="#error-handling"></a><a class="link" href="#error-handling">3.9. Error handling</a></h3>
<div class="paragraph">
<p>Code that fails will generally report it by returning an <code>error</code> value.
Error values have the <a href="#errors"><code>error</code> type</a>. For
example, consider the <code>sqrt</code> (square root) function. That function is
only defined for positive values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">sqrt X:real as real     when X &gt;= 0     is ...
print "Square root of 2 is ", sqrt 2        // OK
print "Square root of -1 is ", sqrt(-1)     // Error</code></pre>
</div>
</div>
<div class="paragraph">
<p>This program will print something similar to the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="console" class="language-console hljs">Square root of 2 is 1.41421356237
Square root of -1 is Error: No form matching sqrt(-1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This message is not very informative. For that reason, it is customary
to add specific error messages for well-identified conditions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">sqrt X:real as real     when X &gt;= 0     is ...
sqrt X:real as error    when X &lt;  0     is error "Square root of negative real ", X</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that case, the output will change to something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="console" class="language-console hljs">Square root of 2 is 1.41421356237
Square root of -1 is Error: Square root of negative real -1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are multiple ways to handle errors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#taking-error-parameters">Taking error parameters</a> lets you
explicitly deal with errors, for example to show an error message.</p>
</li>
<li>
<p><a href="#fallible-types">Fallible types</a> deal with cases where you expect
a value or an error.</p>
</li>
<li>
<p><a href="#try-catch">Try-Catch</a> will let you special-case error conditions.</p>
</li>
<li>
<p><a href="#error-statements">Error statements</a> automatically propagate
errors without cluttering your code with error checking conditions.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="taking-error-parameters"><a class="anchor" href="#taking-error-parameters"></a><a class="link" href="#taking-error-parameters">3.9.1. Taking error parameters</a></h4>
<div class="paragraph">
<p>The simplest way to handle errors is to have a variant of the function
that takes an <code>error</code> as an argument. For example, you could extend your
square root function as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">sqrt X:real as real     when X &gt;= 0     is ...
sqrt X:real as error    when X &lt;  0     is error "Square root of negative real ", X
sqrt E:error as error                   is error "Square root of error: ", E</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you attempt to take the square root of an error, you will get a
different output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">print "Double error is ", sqrt(sqrt(-1))
Double error is Error: Square root of error: Square root of negative real -1.0</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As the code above illustrates, <code>print</code> and <code>write</code> are examples
of functions that take an <code>error</code> parameter. In that case, these
functions will print the associated error message.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="fallible-types"><a class="anchor" href="#fallible-types"></a><a class="link" href="#fallible-types">3.9.2. Fallible types</a></h4>
<div class="paragraph">
<p>Another way to handle errors is to use so-called <em>fallible types</em>, which
use the <code>T?</code> notation, a shortcut for <code>T or error</code>. The <code>ok</code> type is the same as
<code>nil?</code>, and is normally used for functions that are not expected to return a
value, but can return an error.</p>
</div>
<div class="paragraph">
<p><code>T?</code> contains four accessible features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>value</code> is a <code>T</code> value, and can only be accessed when there was no
error (otherwise, it returns… the <code>error</code>, there is no escaping it)</p>
</li>
<li>
<p><code>error</code> is an <code>error</code> value that should only be accessed when there
was an error. Otherwise, it returns <code>nil</code>.</p>
</li>
<li>
<p><code>good</code> is <code>true</code> if there was no error, and <code>false</code> otherwise.</p>
</li>
<li>
<p><code>bad</code> is equivalent to <code>not good</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following code shows how to use a <code>real?</code> type to return
<code>0.0</code> for the <code>sqrt</code> of a negative value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">sanitized_sqrt X:real as real is
    R : real? := sqrt X
    if R.bad then
        print "Got an error in sqrt: ", R.error
        R := 0.0
    return R.value</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="try-catch"><a class="anchor" href="#try-catch"></a><a class="link" href="#try-catch">3.9.3. Try-Catch</a></h4>
<div class="paragraph">
<p>A third way to handle errors is to use a <code>try Body catch Handler</code> form,
which evaluates <code>Body</code>, and if <code>Body</code> returns an <code>error</code>, evaluates
<code>Handler</code> instead. The error that was caught by <code>catch</code> is called
<code>caught</code>.</p>
</div>
<div class="paragraph">
<p>With this construct, the <code>sanitized_sqrt</code> above can be written in a much
shorter and more idiomatic way as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">sanitized_sqrt X:real as real is
    try
        sqrt X
    catch
        print "Got an error in sqrt: ", caught
        0.0</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This may look like exception handling, and intentionally so.
However, <code>error</code> values are not exceptions in that they don’t
automatically propagate across functions like C&#43;&#43; exceptions do. If an
error happens at some level, you must deal with it at that level, if
only to explicitly pass it along. This is done
<a href="#error-statements">automatically</a> in many cases, so that the end
result may feel a little like exceptions, but conceptually, this is
always an <code>error</code> value being returned, not an exception being thrown.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="error-statements"><a class="anchor" href="#error-statements"></a><a class="link" href="#error-statements">3.9.4. Error statements</a></h4>
<div class="paragraph">
<p>If a statement, assignment or declaration returns an <code>error</code>, then as a
special evaluation rule, any <code>error</code> value is immediately returned by
the enclosing function. It is a type error if the interface of the
enclosing function does not allow an <code>error</code> return value.</p>
</div>
<div class="paragraph">
<p>For example, in C, it is frequent to have code that looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="c" class="language-c hljs">Thing *read_thing_from_file(const char *filename)
{
    FILE *file = fopen(filename, "r");
    if (file == NULL)
        return NULL;
    Thing *thing = malloc(sizeof(Thing))
    if (thing == NULL)
    {
        fclose(file);
        return NULL;
    }
    thing-&gt;header = malloc(sizeof(ThingHeader));
    if (thing-&gt;header == NULL)
    {
        free(thing);
        fclose(file);
        return NULL;
    }
    size_t header_read = fread(&amp;thing-&gt;header, 1, sizeof(ThingHeader), file);
    if (header_read != sizeof(ThingHeader))
    {
        free (thing-&gt;header);
        free (thing);
        fclose(file);
        return NULL;
    }
    if (thing-&gt;header.size &lt; MIN_SIZE)
    {
        log_error("Header size is too small: %u", thing-&gt;header.size);
        free(thing-&gt;header);
        free(thing);
        fclose(file);
        return NULL;
    }
    // ... possibly more of the same
    fclose(file);
    return thing;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In XL, handling <code>error</code> values is implicit, so that code similar to the
above can be written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">read_thing_from_file FileName:text as own thing? is
    F:file := file(FileName)            // May error out <i class="conum" data-value="1"></i><b>(1)</b>
    H:own thing_header := read(F)       // May error out (and close F) <i class="conum" data-value="2"></i><b>(2)</b>
    if H.size &lt; MIN_SIZE then
        // Explicitly error out with custom message
        error "Header size %1 is too small", H.size <i class="conum" data-value="3"></i><b>(3)</b>
    T:own thing := thing(H)             // May error out, dispose H, close F <i class="conum" data-value="4"></i><b>(4)</b>
    // ... possibly more of the same
    T</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This may error out if you cannot open the file, for example
because it does not exist. This would typically return a
<code>file_error</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This may error out because of an I/O error, but also because of a
storage error if there isn&#8217;t enough heap space to allocate the
<code>thing_header</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is a case where you explicit error out. Since <code>error</code> builds
an <code>error</code> value, it also implicitly returns from the function.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This might error out if making a <code>thing</code> out of <code>H</code> fails, but
also if a <code>storage_error</code> is raised trying to find some heap space
for a <code>thing</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The notation <code>own T</code> above is an <a href="#ownership">owning type</a> that
dynamically allocates an object from the heap.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="interface-and-implementation"><a class="anchor" href="#interface-and-implementation"></a><a class="link" href="#interface-and-implementation">3.10. <a id="interface"></a><a id="implementation"></a>Interface and implementation</a></h3>
<div class="paragraph">
<p>XL provides strong <em>encapsulation</em> by allowing a programmer to hide
irrelevant details of an implementation. This is fundamental to provide
a robust <a href="#modules">module system</a>.</p>
</div>
<div class="paragraph">
<p>All values in XL expose an <em>interface</em>, which define <em>what</em> can be done
with the value, and also have an <em>implementation</em> of their interface to
tell the program <em>how</em> operations actually happen. The interface needs
to be visible for the program to be correct, but various mechanisms may
allow to hide the implementation.</p>
</div>
<div class="paragraph">
<p>For example, a variable <code>integer</code> value named <code>X</code> has the following
interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X : integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is all that is really needed in order to recognize the validity and
meaning of operations such as <code>X+X</code>, <code>2*X+1</code>, <code>X&lt;0</code> or <code>X:=18</code>. The
actual value of <code>X</code> does not matter. In other words, it is sufficient to
have the interface above to use <code>X</code>, an implementation like the one
shown below can be hidden to the users of <code>X</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X : integer := 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same is true for functions. For example, a function checking if a
value is even could expose the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">is_odd N:integer as boolean</code></pre>
</div>
</div>
<div class="paragraph">
<p>Based on this interface alone, I know that I can write code that checks
if a value is even or odd:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">for I in 1..100 loop
    if is_odd I then
        print I, " is odd"
    else
        print I, " is even"</code></pre>
</div>
</div>
<div class="paragraph">
<p>It does not matter if <code>is_odd</code> is actually implemented as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">is_odd N:integer as boolean is N mod 2 &lt;&gt; 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>or maybe as folows using the bitwise <code>and</code> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">is_odd N:integer as boolean is N and 1 = 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="#declaration-phase">declarations</a> must specify the interface of
the values being used, but they need not specify the implementation. A
definitions of the value must be provided at some point that matches the
declaration and specifies an implementation, but that definition may be
<a href="#modules">in a different source file</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> In languages such as C&#43;&#43;, some members of a
class can be made <em>private</em> or <em>protected</em>. This restricts their
usage, but the compiler (and the programmer) still have knowledge of
internal details of the implementation. This facilitates some
low-level compiler optimizations (most of which are obsolete or
irrelevant today when link-time optimizations are widely available),
but also results in a number of long-term maintenance issues. Exposing
implementation details in the interface worsens the
<a href="https://en.wikipedia.org/wiki/Fragile_base_class">fragile base class</a>
problem, since some aspects of the implementation are public enough
that they cannot be modified. In XL, the implementation can be truly
hidden, and an implementation must be able to generate code that does
not depend on the implementation when the situation requires it, for
example if the implementation may be in a different shared library
than the code using the interface.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="types"><a class="anchor" href="#types"></a><a class="link" href="#types">4. Types</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>XL types are a way to organize values by restricting which operations
can be selected during evaluation. For example, knowing that <code>A</code> is a
<code>real</code> allows expression <code>A+A</code> to match declaration pattern
<code>X:real+Y:real</code>, but prevents it from matching pattern
<code>X:integer+Y:integer</code>.</p>
</div>
<div class="paragraph">
<p>In XL, types are based on the <em>shape</em> of <a href="#the-xl-parse-tree">parse trees</a>.
A type identifies the tree patterns that belong to the type. The
expression <code>matching Pattern</code> returns a type that matches the given type
declaration pattern.  For example, the type for all additions where
the first value is a <code>real</code> is <code>matching(A:real+B)</code>.</p>
</div>
<div class="paragraph">
<p>This approach to typing means in particular that a same value can
belong to <em>multiple</em> types. For example, the expression <code>2+3*5</code>
belongs to <code>matching(A+B*C)</code>, but also to <code>matching(A:integer+B:integer)</code>,
or to <code>infix</code>.  Therefore, for XL, you shouldn’t talk about <em>the</em> type
of a value, but rather about <em>a</em> type. However, in the presence of a
type annotation, it is customary to talk about <em>the type</em> to denote
the single type indicated by the annotation. For example, for
<code>X:integer</code>, we will ordinarily refer to the type of <code>X</code> as being
<code>integer</code>, although the value of <code>X</code>, for example <code>2</code>, may also belong
to other types such as <code>even_integer</code> or <code>positive_integer</code> or
<code>matching(2)</code>, a type that only contains the value <code>2</code>.</p>
</div>
<div class="sect2">
<h3 id="type-annotations-2"><a class="anchor" href="#type-annotations-2"></a><a class="link" href="#type-annotations-2">4.1. Type annotations</a></h3>
<div class="paragraph">
<p>A type can be associated to a name or expression using a
<em>type annotation</em>. For example, a type annotation such as
<code>X:integer</code> indicates that the values that can be bound to the name
<code>X</code> must belong to the <code>integer</code> type.</p>
</div>
<div class="paragraph">
<p>Two infix operators can be used for type annotations, <code>X:T</code> and
<code>X as T</code>. Both are annotations indicating that <code>X</code> belongs to type <code>T</code>.
Typical usage for these two kinds of annotations is illustrated below,
indicating that the <code>&lt;</code> operator between two <code>integer</code> values has the
<code>boolean</code> type:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>X:integer &lt; Y:integer as boolean</pre>
</div>
</div>
<div class="paragraph">
<p>The first difference between the two kinds of type annotations is
parsing precedence. The infix <code>:</code> has precedence higher than most
operators, whereas infix <code>as</code> has a very low precedence. In most
declarations, an infix <code>:</code> is used to give a type to formal parameters,
whereas an infix <code>as</code> is used to give a type to the whole expression.
This is illustrated in the example above, where <code>X:integer</code> and
<code>Y:integer</code> define the types of the two formal parameters <code>X</code> and <code>Y</code> in
the pattern <code>X &lt; Y</code>, and the <code>as boolean</code> part indicates that the result
of an operation like <code>3 &lt; 5</code> has the <code>boolean</code> type.</p>
</div>
<div class="paragraph">
<p>Another difference is <a href="#mutability">mutability</a>. If type <code>T</code> is not
explicitly marked as <code>constant</code> or <code>variable</code>, <code>X:T</code> indicates that <code>X</code>
is mutable, whereas <code>X as T</code> indicates that <code>X</code> is not mutable. For
example, <code>seconds : integer</code> declares a <em>variable</em> named seconds,
where you can store your own seconds values, whereas <code>seconds as
integer</code> declares a <em>function</em> named seconds, possibly returning
the number of seconds in the current time from some real-time clock.</p>
</div>
</div>
<div class="sect2">
<h3 id="type-conversions"><a class="anchor" href="#type-conversions"></a><a class="link" href="#type-conversions">4.2. Type conversions</a></h3>
<div class="paragraph">
<p>In some cases, a value from one type needs to be converted to some
other type. This is called a <em>type conversion</em>. There are thre
kinds of type conversion:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#conversion-using-constructor">using constructors</a> to create a type value
explicitly using its <a href="#creation">constructor</a> pattern,</p>
</li>
<li>
<p><a href="#explicit-conversion">explicit conversions</a> use the type name as a prefix
to create functions dedicated to value conversion. This is mostly useful when
writing generic code,</p>
</li>
<li>
<p><a href="#implicit-conversion">implicit conversions</a> are special forms allowing one
type to transparently convert to another one when needed.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="conversion-using-constructors"><a class="anchor" href="#conversion-using-constructors"></a><a class="link" href="#conversion-using-constructors">4.2.1. Conversion using constructors</a></h4>
<div class="paragraph">
<p>
The simplest way to convert a type to another is to embed the original type in a
constructor for the second type. This only works if the original type is
compatible with the pattern for the second type.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>distance is matching distance(D:real)
X:distance + Y:distance as distance     is distance(X.D+Y.D) <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This can be interpreted as a "conversion" of the <code>real</code> value <code>X.D+Y.D</code> to a
<code>distance</code> type using the constructor.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the above example, <code>distance</code> is both the name of the type and a prefix used
as a constructor for the type. This is only coincidental, if frequent. The above
example could be written using a postfix form as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>distance is matching D:real m
X:distance + Y:distance as distance is distance(X.D + Y.D) // Error <i class="conum" data-value="1"></i><b>(1)</b>
X:distance + Y:distance as distance is (X.D + Y.D) m       // OK <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is an error because there is no prefix <code>distance D</code> form that matches
expressions <code>distance(X.D+Y.D)</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This works because the value of the type is really something like <code>2.3 m</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Rewrite the code as seen above demonstrates that what really matters is the
constructor pattern, not the name of the type, which is nothing special.</p>
</div>
</div>
<div class="sect3">
<h4 id="explicit-conversion"><a class="anchor" href="#explicit-conversion"></a><a class="link" href="#explicit-conversion">4.2.2. Explicit conversion</a></h4>
<div class="paragraph">
<p>
Having to use a type-specific constructor pattern is not practical when writing
generic code. Consider for example that you want to create a <code>long_distance</code>
subtype that corresponds to distances greater than <code>1000 m</code></p>
</div>
<div class="literalblock">
<div class="content">
<pre>distance      is matching distance(D:real)
long_distance is matching distance(D:real when D &gt;= 1000.0)
km : long_distance := distance 1000.0                   // OK <i class="conum" data-value="1"></i><b>(1)</b>
Mm : long_distance := long_distance 1_000_000.0         // Error <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This works because the prefix being used corresponds to the constructor
pattern.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>There is no <code>long_distance</code> prefix pattern for the type</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In such cases, it is possible to create an <em>explicit conversion</em> form that
takes the target type as a prefix, using a <a href="#metabox">metabox</a> to make it
clear that the <em>type</em>, not its <em>name</em>, is what you use as a prefix:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>distance is matching distance(D:real)
[[distance]] D:real as distance is distance D

long_distance is matching (D:distance when D.D &gt;= 1000.0)
[[long_distance]] D:real when D &gt;= 1000.0 as long_distance is distance D</pre>
</div>
</div>
<div class="paragraph">
<p>Invoking such an explicit conversion function requires you to evaluate the type
separately, not as part of a prefix form. This can be done by putting the type
expression in a block:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>km : long_distance := (distance) 1000.0                 // OK <i class="conum" data-value="1"></i><b>(1)</b>
Mm : long_distance := (long_distance) 1_000_000.0       // OK <i class="conum" data-value="2"></i><b>(2)</b>
Gm : long_distance := long_distance 1.0e9               // OK <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This now calls the form <code><a id="distance"></a> D:real</code>, and type checks that the
<code>D &gt;= 1000.0</code> is valid in order to assign to a <code>long_distance</code> value. If the
type check fails, e.g. if you replace value <code>1000.0</code> with <code>100.0</code>, then it
is reported on the assignment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This now calls the form <code><a id="long_distance"></a> D:real</code>. As a result, this
validates that the value obeys the condition <code>D &gt;= 1000.0</code> earlier, in the
right-hand side expression. If the value given fails the validation, it will
be reported in the expression itself.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This now works and calls the explicit conversion <em>if</em> there is no form such
as <code>long_distance D:real</code> that would match the form first.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is only coincidental, if quite fortunate, that this explicit type
conversion  notation happens to match the syntax for type casting in C and C++.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The rules of overloading are such that, in general, the parentheses are not
necessary to invoke an explicit conversion. Programmers should use the
parenthese form if they intend to make it clear that this is an explicit
conversion, and if they want to avoid calling any prefix form with a matching
name. This is also the only possible syntax if the type results form an
expression. Conversely, If they want to pick up the prefix form first if it
exists, then they should use the prefix form.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// C-style low-level pointer cast: must use parentheses for type expression
P : pointer to integer := (pointer to integer) malloc(integer.ByteSize)

// Numerical conversion: might prefer more precise prefix form if it exists
Circumference is natural(2 * pi * 1000)</pre>
</div>
</div>
<div class="paragraph">
<p>There are explicit conversion functions for most numerical types
, which in
general allows you to get the closest numerical value in the target form.</p>
</div>
<div class="paragraph">
<p>Many types also have an explicit conversion to
<code>text</code>, which must produce a
human-readable version of the value. Some types can also feature an explicit
conversion from <code>text</code>, which can be used to parse a value given in
human-readable form.</p>
</div>
</div>
<div class="sect3">
<h4 id="implicit-conversion"><a class="anchor" href="#implicit-conversion"></a><a class="link" href="#implicit-conversion">4.2.3. Implicit conversion</a></h4>
<div class="paragraph">
<p>
Implicit type conversions are definitions that have a single typed parameter and
return a different type. For example, if you want to be able to implicitly
convert between polar and cartesian form for a complex number, you would need:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Z:polar as cartesian
Z:cartesian as polar</pre>
</div>
</div>
<div class="paragraph">
<p>A single implicit type conversion can apply to a single binding, and
is only applied if there is no direct match with the original type.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>foo X:complex as complex
X:real as complex
foo 1.0                 // OK, implicit conversion from real to complex
foo 1                   // Error: two implicit conversions required</pre>
</div>
</div>
<div class="paragraph">
<p>In a case like the one that causes an error, you can use a <em>type hint</em>,
which is simply a sequence of explicit conversions indicating how to
get from one type to another.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>foo X:complex as complex
X:real as complex
foo 1.0                 // OK, implicit conversion from real to complex
foo real 1              // OK: first convert to real, then implicit complex</pre>
</div>
</div>
<div class="paragraph">
<p>Implicit type conversions can also be used on return values or when evaluating
statements, in order to adjust a value to what is expected in that context.</p>
</div>
</div>
<div class="sect3">
<h4 id="ignorable-type"><a class="anchor" href="#ignorable-type"></a><a class="link" href="#ignorable-type">4.2.4. Ignorable type</a></h4>
<div class="paragraph">
<p>A particular usage of implicit conversions to adjust to the context is
<em>ignorable types</em>. the <code>ignorable T</code> generic type
provided by the standard library can implicitly convert to either <code>T</code> or <code>nil</code>
so that itcan be either returned from a function or used in a statement. Its
definition is roughly as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>with
    T : type
type ignorable[T]               is matching ignore(Value:T)
V:ignorable[T]          as T    is V.Value
V:ignorable[T]          as nil  is nil</pre>
</div>
</div>
<div class="paragraph">
<p>An ignorable type can be used for the return value of any operation that is
useful, but may safely be ignored. The most common use case for this are
<a href="#assignment">assignments</a>, which are used primarily for the side effect of
assigning to the target, but can also return the value of the target.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// Ignore the return value by implicitly converting it to 'nil'
X := 3

// Use the return value of the assignment to compare with ' '
while (NextChar := ReadNextCharacterFrom(File)) &gt; ' ' loop
    print "We got ", NextChar</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="type-definitions"><a class="anchor" href="#type-definitions"></a><a class="link" href="#type-definitions">4.3. Type definitions</a></h3>
<div class="paragraph">
<p>In XL, types are values like any other value, which simply match the
<code>type</code> type. In particular, types can be declared or
<a href="#definition">defined</a> like any other value.</p>
</div>
<div class="paragraph">
<p>The simplest case of <em>type definition</em> simply gives a new name to
an existing type. The following code will create a type named <code>int</code>
that is just another name for <code>integer</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>int is integer</pre>
</div>
</div>
<div id="implicit-inheritance" class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In reality, the above is really equivalent to deriving <code>int</code> from
<code>integer</code>. in other words, the definition above is equivalent to the
following pattern-based definition:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>int is matching(base:integer)</pre>
</div>
</div>
<div class="paragraph">
<p>One reason this is important is to maintain some guarantees during
<a href="#field-destruction">destruction</a>, specifically make sure that
destruction of the new type does not bypass the destruction of the
original type.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>More interesting types can be defined using the <code>matching</code> function, which
takes a pattern as an argument, and returns a type that
<a href="#pattern-matching">matches that pattern</a>. The expression <code>matching(42)</code>
returns a type that only matches the value <code>42</code>.</p>
</div>
<div class="paragraph">
<p>The <code>matching</code> function can obviously be used to create much more
interesting types. In order to create a <code>positive</code> type that only
matches positive values, one only needs the following code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>positive is matching(X when X &gt; 0)</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you come from another language, it is important to realize
that <code>positive</code> as defined above is a type that accepts both <code>integer</code>
values such as <code>27</code> and <code>real</code> values such as <code>3.14</code>, since the
expression <code>X &gt; 0</code> is valid in both cases. As a matter of fact, it
applies to any type where the expression <code>X &gt; 0</code> is valid. Types like
this are often used in type expressions such as <code>ordered and positive</code>.
Using such types makes it possible to write <em>constrained generic code</em>,
i.e. code that applies on a large class of cases, while being properly
constrained.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A common usage is to use a named prefix to create types that are
easier to identify. This kind of notation is called a
<a href="#creation">constructor</a>, and plays for XL the role that <code>struct</code>
plays for C or <code>record</code> for Pascal. A <code>complex</code> data type can be
created and used as shown in the following code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex matches complex(Re:real, Im:real)
Z:complex := complex(4.3, 2.1)</pre>
</div>
</div>
<div class="paragraph">
<p>This definition of <code>complex</code> states that a value matches the type
<code>complex</code> if and only if it matches the pattern <code>complex(Re:real, Im:real)</code>.
In particular, it matches the value <code>complex(4.3, 2.1)</code>, which makes
the assignment on the second line of code possible.</p>
</div>
<div class="paragraph">
<p>Since they are quite frequent, there is a
<a href="#syntactic-sugar">syntactic sugar</a> for this kind of declarations:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex matches complex(Re:real, Im:real)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="type-expressions"><a class="anchor" href="#type-expressions"></a><a class="link" href="#type-expressions">4.4. Type expressions</a></h3>
<div class="paragraph">
<p>Type definitions are not restricted to names. XL offers extensive
support for <em>type expressions</em>, i.e. expressions that return a type.
For example, the <code>complex</code> type might take the <code>real</code> type as an
argument, instead of assuming the standard <code>real</code> type:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex[real:type] is matching complex(Re:real, Im:real)
type complex is complex[real]
Z:complex := complex(4.3, 2.1)
K:complex[real32] := complex(1.2, 3.4)</pre>
</div>
</div>
<div class="paragraph">
<p>Type expressions can be used to create what is called a <em>generic type</em> in languages like Ada, or a <em>template</em> in languages like
C&#43;&#43;. However, as far as syntax is concerned, it is
indistinguishable from a function taking a type argument and returning
a type. This extends the range of capabilities for the feature,
meaning that the implementation may sometime have fo fall-back to more
dynamically typed ways to evaluate the code.</p>
</div>
<div class="paragraph">
<p><strong>STYLE</strong> A stylistic convention is to use square brackets in type
expressions and parentheses in regular expressions. Thus, this
documentation will typically write <code>complex[real]</code> for the type
expression, and <code>complex(1.2,3.4)</code> for the numerical expression,
although it would be perfectly legal to write <code>complex real</code> and
<code>complex[1.2,3.4]</code> respectively, since XL does not differentiate
blocks except for precedence.</p>
</div>
<div class="paragraph">
<p>In practice, type expression are extremely frequent, notably being
used to define a plethora of generic types using operator-like
notations, like <code>pointer to T</code>.
In addition, a large number of <a href="#standard-types">standard types</a>,
including <a href="#genneric-containers">generic container types</a>,
can be used to quickly build useful data types.</p>
</div>
<div class="paragraph">
<p>Standard type expressions include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>T1 or T2</code> is a type that contains values belonging to <code>T1</code> or <code>T2</code>.
It is similar to what other languages call union types, and is used
in particular for error reporting through types like <code>real or error</code>.</p>
</li>
<li>
<p><code>T1 and T2</code> is a type that contains values belonging both to <code>T1</code>
and <code>T2</code>. It is primarily  used to constrain types in generic code,
for example <code>ordered and positive</code>.</p>
</li>
<li>
<p><code>not T</code> is a type that contains values that do not belong to <code>T</code>. It
can be used to exclude specific types from a definition.</p>
</li>
<li>
<p><code>T?</code> is a shortcut for <code>T or error</code> and is used when a
function may fail.</p>
</li>
<li>
<p><code>one_of Patterns</code> is a type that accept one of the following
patterns. It can be used to implement enumerations, such as
<code>one_of(RED,GREEN,BLUE)</code>, but also more complex variant types with
more complex patterns, like for the definition of <code>color</code> below
which describes various ways to describe a color:</p>
<div class="literalblock">
<div class="content">
<pre>component is real range 0.0..1.0 bits 16
angle     is real range 0.0..360.0 bits 16
color is one_of
    rgb   Red:component, Green:component, Blue:component
    rgba  Red:component, Green:component, Blue:component, Alpha:component
    hsv   Hue:angle, Saturation:component, Value:component
    hsva  Hue:angle, Saturation:component, Value:component, Alpha:component
    cymk  Cyan:component, Yellow:component, Magenta:component, Black:component
    named Name:text
    named Name:text, Alpha:component
Red        : color := { rgb 100%, 0%, 0% }
Background : color := { named "black" }</pre>
</div>
</div>
</li>
<li>
<p><code>any_of Patterns</code> is a type that accept any combination of the
following patterns. It can be used to implement flags, like the
representation of Unix-style permissions as <code>any_of(READ,WRITE,EXECUTE)</code>,
but also more complex variant types that may combine multiple
patterns, as in the <code>text_style</code> type defined below, where a text
style can contain at most a family, a weight, a slant, a fill color
and a line color:</p>
<div class="literalblock">
<div class="content">
<pre>type permissions is any_of(READ, WRITE, EXECUTE)
normal_access : permissions := { READ; WRITE }

type text_style is any_of
    family F:font_family
    weigth W:font_weight
    slant S:font_slant
    fill_color C:color
    line_color C:color
default_style : text_style := { family "Arial"; weight 100% }</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>one_of</code> and <code>any_of</code> can be implemented using a tagged
union, where the first <em>tag</em> field is an enumeration in the case of <code>one_of</code>
and a bit flag in the case of <code>any_of</code>, and the memory layout of the
following fields depends on the value of the tag.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below is code for a <code>complex</code> type that uses some of these features,
and is somewhat closer to the actual implementation in
<code>XL.MATH.COMPLEX</code> than what we have shown so far:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex[real:type]         is real or polar[real] or cartesian[real]
type cartesian[real:type]       matches cartesian(Re:real, Im:real)
type polar[real:type]           matches polar(Mod:real, Arg:real)

with
    real : some number
    C1   : cartesian[real]
    C2   : cartesian[real]
    P1   : polar[real]
    P2   : polar[real]

C1 + C2         is cartesian(C1.Re + C2.Re, C1.Im + C2.Im)
C1 - C2         is cartesian(C1.Re - C2.Re, C1.Im - C2.Im)
P1 * P2         is polar(P1.Mod * P2.Mod, P1.Arg + P2.Arg)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="variable-sized-types"><a class="anchor" href="#variable-sized-types"></a><a class="link" href="#variable-sized-types">4.5. Variable sized types</a></h3>
<div class="paragraph">
<p>Type expressions evaluate following the regular rules of evaluation
for XL. This makes it possible to build types that would be impossible
to build in many mainstream languages, like <em>variable sized types</em>.
For example, it is frequent, notably in networking, to have a
<code>packet</code> that has a <em>header</em> followed by a <em>payload</em>, the
payload having a size that depends on information in the header. In
XL, you can describe a type like this as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type header is matching header (byte_count:size)
type payload[byte_count:size] is array[byte_count] of byte
type packet is matching packet
    header  : header
    payload : payload[header.byte_count]</pre>
</div>
</div>
<div class="paragraph">
<p>The XL type system provides very strong guarantees even for data types
as complicated as this one.  For example, the following code will fail
type system checks:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>to Resize (P:in out packet, S:size) is
    P.header.byte_count := S <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a type error on the <code>packet</code> type, because the existing
<code>payload</code> field no longer has the correct size, therefore the
result does not belong to the <code>packet</code> type, unless <code>S</code> is the
existing size.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The correct way to write the code above will hightlight the need to
possibly reallocate memory for the new packet, and deal with three
distinct cases for resizing:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>to Resize (P:in out packet, S:size) when S = P.header.byte_count is nil
to Resize (P:in out packet, S:size) when S &lt; P.header.byte_count is
    new_header  : header := header(S)
    new_payload : payload(S) := P.payload[0..S-1]
    P := packet(new_header, new_payload)
to Resize (P:in out packet, S:size) when S &gt; P.header.byte_count is
    new_header  : header := header(S)
    new_payload : payload(S) := array
        lambda I when I &lt; P.byte_count   is P.payload[I]
        lambda I                         is byte(0)
    P := packet(new_header, new_payload)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="shared-type-annotations"><a class="anchor" href="#shared-type-annotations"></a><a class="link" href="#shared-type-annotations">4.6. Shared type annotations</a></h3>
<div class="paragraph">
<p>In some cases, notably for <a href="#modules">modules</a>, a number of very
similar declarations will have to be written again and again. For
example, consider that you are writing code for implementing complex
arithmetic. This might look something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex is matching complex(Re:real, Im:real)
Z1:complex + Z2:complex as complex is ...
Z1:complex - Z2:complex as complex is ...
Z1:complex * Z2:complex as complex is ...
Z1:complex / Z2:complex as complex is ...</pre>
</div>
</div>
<div class="paragraph">
<p>In this code, <code>Z1</code> and <code>Z2</code> are always <code>complex</code> values. It seems
unnecessary to have to repeat the time over and over again. XL offers
a feature, called <em>shared type annotations</em>, where a <code>with</code>
prefix, followed by a block of declarations, can be used to give local
type annotations that will be valid in the entire scope where they are
being used. The above examples could then be written as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex is matching complex(Re:real, Im:real)
with
    Z1 : complex
    Z2 : complex
Z1 + Z2 as complex is ...
Z1 - Z2 as complex is ...
Z1 * Z2 as complex is ...
Z1 / Z2 as complex is ...</pre>
</div>
</div>
<div class="paragraph">
<p>A shared type annotation may contain more complicated type
information. In particular, you can declare the type for expressions.
For example, if you define a factorial expression, you might ensure
that all variants of the definition have a consistent type as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>with
    N  :  natural
    N! as natural
0! is 1
N! is N * (N-1)!</pre>
</div>
</div>
<div class="paragraph">
<p>The first declaration within the <code>with</code> block indicates that any
variable named <code>N</code> will have type <code>natural</code>. This is in particular
true for the declaration on the next line. In other words, the second
line in the <code>with</code> block is equivalent to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>N:natural! as natural</pre>
</div>
</div>
<div class="paragraph">
<p>The pattern <code>0!</code> matches <code>N:natural!</code>, and the same is true for the
next declaration. Therefore, the two definitions for the factorial are
equivalent to the code below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>0:natural! as natural is 1
N:natural! as natural is N * (N-1)!</pre>
</div>
</div>
<div class="paragraph">
<p>A shared type annotation can take another form, <code>with Types in Body</code>,
which makes it possible to restrict the type annotations to a specific
subset of declarations. The declatations in <code>Body</code> really belong to
the scope containing the <code>with Types in Body</code> form.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>with
    Z1 : complex
    Z2 : complex
in
    Z1 + Z2 as complex is ...
    Z1 - Z2 as complex is ...
    Z1 * Z2 as complex is ...
    Z1 / Z2 as complex is ...</pre>
</div>
</div>
<div class="paragraph">
<p>This is particularly useful to provide complex type parameters in
generic declarations. The following example illustrates this syntax to
declare a notation <code>find Item in List</code> where the <code>Item</code> must have the
type of the elements of the <code>List</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>with
    T:type
    L:type list of T
in
    find Item:T in List:L as T?</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="standard-types"><a class="anchor" href="#standard-types"></a><a class="link" href="#standard-types">4.7. Standard types</a></h3>
<div class="paragraph">
<p>The XL library provides a number of standard types representing
fundamental data types common in most programming languages, as well
as more advanced and more idiomatic data types, such as the types used
as building blocks for a parse tree. This section will only give an
quick overview of many of the available types, with the intent to list
them more than to describe them. A more complete description of the
available types will be given in a later section about the
<a href="#standard-library">standard XL library</a>.</p>
</div>
<div class="sect3">
<h4 id="basic-types"><a class="anchor" href="#basic-types"></a><a class="link" href="#basic-types">4.7.1. Basic types</a></h4>
<div class="paragraph">
<p>Some fundamental data types are available on all implementations, and
do not require any <code>use</code> statement. These fundamental types are called
<em>basic types</em>, and include the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code> is the type used for types&#8230;&#8203;</p>
</li>
<li>
<p><code>nil</code> is a type that contains only the value <code>nil</code>. It is generally
used to represent an absence of value.</p>
</li>
<li>
<p><code>integer</code> is an approximation of integer numbers with a limited
range, typically between -2<sup>63</sup> and 2<sup>63</sup>-1, which are accessible as
<code>integer.min</code> and <code>integer.max</code> respectively. That range cannot be
less than -2<sup>31</sup> and 2<sup>31</sup>-1. Overflowing while performing
operations on <code>integer</code> operations behaves like the underlying
hardware of the target machine, typically wrapping values
around on all modern hardware. <code>integer</code> is a type that matches
literal values below <code>integer.min</code>, such as <code>12</code>, or the result of
the prefix negation operator on literal values, such as <code>-3</code>.</p>
</li>
<li>
<p><code>natural</code> is an approximation of natural numbers, with a limited
range, typically between 0 and 2<sup>64</sup>-1. Like <code>integer</code>, it behaves
like the underlying hardware in case of overflow. <code>natural</code> matches
whole number literal values such as <code>0</code>, <code>16#FF</code> or <code>42</code>.</p>
</li>
<li>
<p><code>size</code> is a type similar to <code>natural</code>, but specifically intended to
represent a size. In some cases, it may have a different range than
<code>natural</code>.</p>
</li>
<li>
<p><code>count</code> is a type similar to <code>natural</code>, but specifically intended to
represent a count. It should be at least as large as <code>size</code> and
<code>natural</code>.</p>
</li>
<li>
<p><code>offset</code> is a type that plays for <code>integer</code> the role that <code>size</code>
plays for <code>natural</code>, i.e. it is intended to indicate offsets that
can be either positive or negative, for example while indexing an
array.</p>
</li>
<li>
<p><code>byte</code> is the smallest unsigned type that is naturally represented
on the machine. On most modern machine, it is an 8-bit value. It is
the same type as <code>XL.MEMORY.byte</code>.</p>
</li>
<li>
<p><code>character</code> is a representation of the native character set on the
target machine. On modern machines, it should generally follow the
<a href="https://en.wikipedia.org/wiki/Unicode">Unicode</a> standard for encoding
characters. The <code>character</code> type matches single-quote
single-character literal text constants like <code>'A'</code>.</p>
</li>
<li>
<p><code>text</code> is a representation for sequences of characters. On modern
machines, it should generally use a compact representation such as
<a href="https://en.wikipedia.org/wiki/UTF-8">UTF-8</a>, and have an
<a href="#interface">interface</a> that is compatible with the
<a href="#string"><code>string of character</code></a> type. The <code>text</code> type matches
literal text constants that contain any number of characters, for
example <code>"Hello World"</code>.</p>
</li>
<li>
<p><code>boolean</code> is a type containing two values, <code>true</code> or <code>false</code>, and
intended to represent truth values, for example conditions in tests.
Unlike languages like C, the <code>boolean</code> type is not a numerical type.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sized-data-types"><a class="anchor" href="#sized-data-types"></a><a class="link" href="#sized-data-types">4.7.2. Sized data types</a></h4>
<div class="paragraph">
<p>Basic data types are not very precisely sized, in order to leave the
implementation free to pick up a size that is maximally efficient on
the target machine. For example, <code>integer</code> should hold 32-bit values on
a 32-bit machine, and 64-bit values on a 64-bit machine.</p>
</div>
<div class="paragraph">
<p>This may adversely affect portability, and for that reason, XL also
offers <em>sized types</em>, with a precise number of bits specified in the
name. The size is appended to the type name. For example, <code>i64</code>
is an <code>integer</code> type that is guaranteed to be exactly 64-bit.</p>
</div>
<div class="paragraph">
<p>Such sized data types exist for the following base types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>i</code> for at least 8, 16, 32 and 64 bits, are signed integer values,</p>
</li>
<li>
<p><code>u</code> for at least 8, 16, 32 and 64 bits, are unsigned integer values,</p>
</li>
<li>
<p><code>real</code> for at least 32 and 64 bits,</p>
</li>
<li>
<p><code>character</code> for at least 8, 16 and 32 bits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional sizes may be provided if they are native to the target
machine. For example, some DSPs feature 24-bit operations, and
compilers for such machines should provide types like <code>u24</code> to
match.</p>
</div>
<div class="paragraph">
<p>The sized types are guaranteed to wrap around at the boundary for the
given number of bits. For example, <code>u8</code> holds values between
<code>0</code> and <code>255</code>, and will wrap around so that the next value after <code>255</code>
is <code>0</code>, and the value preceding <code>0</code> is <code>255</code>.</p>
</div>
<div class="paragraph">
<p>When the standard sizes are not sufficient, it is easy to use
integer <a href="#subtypes">subtypes</a> to identify precise
<a href="#range-subtypes">ranges</a> of values, as in <code>integer range 1..5</code>,
which only accepts values between <code>1</code> and <code>5</code>, or precise
<a href="#size-subtypes">number of bits</a>, such as <code>integer bits 24</code>, which
wraps around like a 24-bit <code>integer</code> value.</p>
</div>
</div>
<div class="sect3">
<h4 id="category-types"><a class="anchor" href="#category-types"></a><a class="link" href="#category-types">4.7.3. Category types</a></h4>
<div class="paragraph">
<p>Some types are intended primarily as an easy way to categorize
values along generally useful boundaries, and are naturally called
<em>category types</em>. Examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>anything</code> is the <em>most general type</em>, which accepts any
value. It is typically used to create
<a href="#true-generic-types">true generic types</a>.</p>
</li>
<li>
<p><code>number</code>, a type that matches numerical data types such as
<code>integer</code>, <code>real</code> or <code>complex</code>.</p>
</li>
<li>
<p><code>positive</code>, a type that accepts only positive values.</p>
</li>
<li>
<p><code>ordered</code>, a type that only matches values that can be compared
 using <code>&lt;</code>. A variant, <code>totally_ordered</code>, ensures that the type is
totally ordered. This is unfortunately not the case of common types
such as <code>real</code>.</p>
</li>
<li>
<p><code>discrete</code>, a type that only matches discrete types, such as
<code>integer</code> or <code>character</code>. Discrete types feature an <code>index</code> function
that returns the index of the value in the type.</p>
</li>
<li>
<p><code>access</code>, a type that accepts only values used to access other types,
such as pointers or references.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Category types are often used to implement <em>generic algorithms</em>
and <em>generic types</em> without overly burdening the code. For
example, the <code>vector</code> type represents a mathematical vector, and that
requires a <code>number</code> type for the values in the vector. Similarly, the
<code>sort</code> algorithm only works on <code>ordered</code> values.</p>
</div>
</div>
<div class="sect3">
<h4 id="generic-containers"><a class="anchor" href="#generic-containers"></a><a class="link" href="#generic-containers">4.7.4. Generic containers</a></h4>
<div class="paragraph">
<p>In some cases, a general structure is shared by a number of data types.
For example, all array types share an internal organization and provide
similar features. XL features <em>generic types</em> to address this kind
of need. Most often, generic types are declared with formal parameters,
and are <em>instantiated</em> by supplying arguments for
the required parameters.</p>
</div>
<div class="paragraph">
<p>This is particularly useful for <em>container types</em>, i.e. types that
are primarily designed to store a possibly large number of values from
some other type.</p>
</div>
<div class="paragraph">
<p>Container types include in particular the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>array</code> store a fixed number of consecutive elements. They exist
in multiple flavors:</p>
<div class="ulist">
<ul>
<li>
<p>Zero-based arrays such as <code>array[5] of integer</code>.</p>
</li>
<li>
<p>Range-indexed arrays, such as <code>array['A'..'Z'] of boolean</code>, which
are indexed with a <code>discrete</code> range of values.</p>
</li>
<li>
<p>Multi-dimensional arrays such as <code>array['A'..'H', 1..8] of chess_piece</code>
are simply a convenient shortcut for arrays of arrays.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>string</code> store a variable number of consecutive elements. They also
exist in multiple flavors:</p>
<div class="ulist">
<ul>
<li>
<p>Unbounded, zero-based strings, such as <code>string of integer</code>.
The <code>text</code> type exposes a <code>string of character</code> interface.</p>
</li>
<li>
<p>Bounded, zero-based strings, such as <code>string[1000] of integer</code>,
which can hold up to <code>1000</code> values of the <code>integer</code> type.</p>
</li>
<li>
<p>Bounded, range-indexed strings, such as <code>string[1..10] of real</code>,
which can hold up to <code>10</code> values, indexed starting at <code>1</code>.</p>
</li>
<li>
<p>Multi-dimensional strings, such as <code>string[25,80] of character</code>,
which is a storage-efficient way to store possibly blank text screens.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>list</code> to store a variable number of linked elements. Unlike arrays
or strings, elements in lists are individually allocated in memory
rather than as a large contiguous chunk. Lists exist in several
flavors:</p>
<div class="ulist">
<ul>
<li>
<p>Single-linked lists such as <code>list of integer</code>.</p>
</li>
<li>
<p>Doubly-linked, double-ended queues, such as <code>queue of integer</code>.</p>
</li>
<li>
<p>Xor-linked lists such as <code>xor_list of integer</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>stack</code> to expose <code>push</code> and <code>pop</code> operations, and the type is matched
by several container type such as <code>string</code>, <code>list</code> or <code>queue</code>. In
other words, you can treat a <code>list of T</code> as a <code>stack of T</code>.</p>
</li>
<li>
<p><code>map</code> to efficiently map source values to a stored value. For
example, <code>map[text] of real</code> creates a map between <code>text</code> index
values and <code>real</code> stored values:</p>
</li>
<li>
<p><code>set</code> to efficiently store a set of value, and make it easy to know
if a value is in the set or not. A <code>set of character</code> holds an
arbitrary number of <code>character</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="true-generic-types"><a class="anchor" href="#true-generic-types"></a><a class="link" href="#true-generic-types">4.7.5. True generic types</a></h4>
<div class="paragraph">
<p>Often, an algorithm will apply to all variants of a generic type. For
example, consider the operation that sums all the elements in an
array. Its body can be written so as to not really depend on the type
or number of elements.</p>
</div>
<div class="paragraph">
<p>In order to make it easier to write such generic code, XL programmers
can take advantage of a feature called <em>true generic type</em>, which
is a way to define a type that will accept any variant of some
underlying generic type. It is customary to use a name that easily
relates to the generic type. For example, one can define a true
generic type named <code>array</code> that covers all array types as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type array is matching (array[index:array_index] of value:type)</pre>
</div>
</div>
<div class="paragraph">
<p>This makes it possible to write true generic code that takes an
<code>array</code> argument, as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>function sum(A:array) as A.value is
    result := 0 <i class="conum" data-value="1"></i><b>(1)</b>
    for I in A loop
        result += I</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This assignment may require an implicit conversion of the value
<code>0</code> to the <code>A.value</code> type. There is a requirement for the <code>number</code>
type that values <code>0</code> and <code>1</code> can be implicitly converted to it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Such generic types can be equipped with attributes or functions like any other
entity in XL. For example, to get the <code>length</code> of an array type, assuming we
know how to compute the length of its index, we could write:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>function Length(type A like array) written A.length is
    length(A.array_index)</pre>
</div>
</div>
<div class="paragraph">
<p>Wihin a same definition, a given name only matches a single type, even if the
type is generic and could represent different values. For example, if we define
a function that performs the sum of two arrays, the array types have to match:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>function AddArray(A:array, B:array) as array written A+B is
    for I in array.index loop
        result[I] := A[I] + B[I]

A : array[1..5] of integer
B : array[1..5] of integer
C : array[2..7] of real

A := A + B      // OK, same type
C := A + B      // Not OK, conflicting value for `array`</pre>
</div>
</div>
<div class="paragraph">
<p>If you want to have multiple distinct types in the same declaration, you need to
name them indiviudally. For example, to example a <code>Find</code> functions that checks
if a smaller array is contained in a larger one with the same value type, you can
write the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>with
    type haystack  is array
    type needle    is array when
        needle.length &lt;= haystack.length and
        needle.value = haystack.value

function Find(What : needle, Where : haystack) as want(haystack.index) is
    for H in haystack.index loop
        let S := H
        for N in needle.index loop
            if What[N] &lt;&gt; Where[S] then
                next H
            S++
        return S
    return nil</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="constrained-generic-types"><a class="anchor" href="#constrained-generic-types"></a><a class="link" href="#constrained-generic-types">4.7.6. Constrained generic types</a></h4>
<div class="paragraph">
<p>It is possible for the pattern of the true generic type to be somewhat
more restrictive. For example, for a <code>complex</code> type, one might want to
create a type that only accepts numbers for the <code>real</code> type. The type
<code>some T</code> describes all types that derive from <code>T</code>, so that the true
generic type for <code>complex</code> can be defined with something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex matches complex[real:some number]</pre>
</div>
</div>
<div class="paragraph">
<p>A true generic type with constraints like in the above example is
called a <em>constrained generic type</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>RATIONALE</strong> In languages such as C&#43;&#43;, the lack of this feature
often leads to code that largely repeats the same <code>template</code> arguments
for each individual declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="c++" class="language-c++ hljs">template &lt;typename T&gt;
T sum(const vector&lt;T&gt; &amp;v)
{
    T s = 0;
    for (auto i : v)
        s += i;
    return s;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The recent standards for C&#43;&#43; have introduced the notion of
<a href="https://en.wikipedia.org/wiki/Concepts_(C%2B%2B)">concepts</a> to
address the need to constrain generic types.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="other-generic-types"><a class="anchor" href="#other-generic-types"></a><a class="link" href="#other-generic-types">4.7.7. Other generic types</a></h4>
<div class="paragraph">
<p>Many generic types are not intended as containers.
They include the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>want T</code> is <code>nil or T</code></p>
</li>
<li>
<p>'T?` is <code>T or error</code></p>
</li>
<li>
<p><code>range of T</code> holds ranges of values of type <code>T</code>. For example, the
type <code>range of integer</code> can hold a value such as <code>1..5</code>, which is
the range between values <code>1</code> and <code>5</code> inclusive. This can be used for
simple iteration, but it is also a
<a href="#mathematical-type">mathematical type</a> with range arithmetic.</p>
</li>
<li>
<p><code>own T</code> holds a dynamically allocated value of type <code>T</code> that is
<a href="#ownership">owned</a> by the <code>own</code> value, i.e. it is disposed of
when the <code>own</code> value is <a href="#destruction">destroyed</a>.</p>
</li>
<li>
<p><code>ref T</code> holds a reference to a value of type <code>T</code>. Its
<a href="#lifetime">lifetime</a> must be less than the value being
referenced.</p>
</li>
<li>
<p><code>in T</code> can be used to pass input arguments of type <code>T</code>, i.e. values
that are <a href="#creation">created</a> and owned by the caller.</p>
</li>
<li>
<p><code>out T</code> can be used for output arguments of type <code>T</code>, i.e. values
that are created by the callee.</p>
</li>
<li>
<p><code>in out T</code> can be used for input-output arguments of type <code>T</code>,
i.e. values that can be modified by the callee but are created and
owned by the caller.</p>
</li>
<li>
<p><code>any T</code> can hold a value of type <code>T</code> or any
<a href="#inheritance">derived type</a>, preserving the original type
information, so that dynamic dispatch will happen based on the
actual type.</p>
</li>
<li>
<p><code>slice of T</code> holds a slice of contiguous containers such as <code>array</code>
or <code>string</code>, and makes it possible to manipulate subsets of the
container. This is also useful with <code>text</code>.</p>
</li>
<li>
<p><code>access T</code> matches any type that can be used to access values of
type <code>T</code>, such as <code>own T</code>, <code>ref T</code> or <code>slice of T</code>.</p>
</li>
<li>
<p><code>attribute T</code> is an <a href="#attribute">attribute</a> with type <code>T</code>, i.e. a
value that can be read or written to in a controlled fashion.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mathematical-types"><a class="anchor" href="#mathematical-types"></a><a class="link" href="#mathematical-types">4.7.8. Mathematical types</a></h4>
<div class="paragraph">
<p>Computers are often used to perform mathematical operations. XL
features several mathematical types designed for that purpose:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>number</code> represent all kinds of numbers and is intended to be used
in generic code. All <code>number</code> types must accept the values <code>0</code> and
<code>1</code> through implicit conversion, although they may represent for
example a null vector or an identity matrix respectively.</p>
</li>
<li>
<p><code>natural</code> represent natural numbers, i.e. non-negative whole numbers.</p>
</li>
<li>
<p><code>integer</code> represent integer numbers, i.e. signed whole numbers.</p>
</li>
<li>
<p><code>rational</code> represent rational numbers, i.e. a signed ratio of two whole
numbers. They can be used to perform accurate computations on ratios.</p>
</li>
<li>
<p><code>real</code> is the base floating-point type, but it also provides
fixed-point <a href="#real-subtypes">subtypes</a>.</p>
</li>
<li>
<p><code>range of T</code> is a type that represents a range of numbers, and
features range arithmetic, which makes it possible to estimate
the effect of rounding errors in complicated calculations involving
floating-point types.</p>
</li>
<li>
<p><code>complex[T]</code> is a generic representation for complex numbers using
<code>T</code> as the representation for real numbers. Without an argument,
<code>complex</code> denotes <code>complex[real]</code>. Values with the <code>complex</code> type
have a <code>polar</code> and <code>cartesian</code> representation, and the compiler will
select the representation based on usage.</p>
</li>
<li>
<p><code>quaternion[T]</code> is a generic representation for mathematical
<a href="https://en.wikipedia.org/wiki/Quaternion">quaternions</a>, and are
particularly useful in the field of 3D graphics. Without an
argument, <code>quaternion</code> is the same as <code>quaternion[real]</code>.</p>
</li>
<li>
<p><code>vector</code> is a generic representation of mathematical
<a href="https://en.wikipedia.org/wiki/Vector_(mathematics_and_physics)">vectors</a>,
which takes a size and a number type, so that <code>vector[3] of real32</code>
represents a 3-dimensional vector of <code>real32</code> values, and
<code>vector[4]</code> is a 4-dimensional <code>real</code> vector. The <code>vector</code>
type exposes an <code>array</code> interface, but also provides additional
capabilities such as vector arithmetic. Operations on the <code>vector</code>
type typically take advantage of
<a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a> or "multimedia"
operations on the processor if available.</p>
</li>
<li>
<p><code>matrix</code> is a generic representation of mathematical
<a href="https://en.wikipedia.org/wiki/Matrix_(mathematics)">matrices</a>,
with two underlying representations, <code>sparse</code> and <code>dense</code>. The
<code>matrix</code> type exposes an interface for a two-dimensional <code>array</code>
type. It features matrix algebra and matrix-specific operations,
as well as operations combining <code>matrix</code> and <code>vector</code> for the same
underlying numerical type. Operations on the <code>matrix</code> type are often
highly parallelizable.  The <code>matrix[4,3] of i32</code> will create a 4x3
matrix with <code>i32</code> as the underlying numerical type, whereas
<code>matrix[2,2]</code> will create a 2x2 matrix of <code>real</code> values.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="parse-tree-types"><a class="anchor" href="#parse-tree-types"></a><a class="link" href="#parse-tree-types">4.7.9. Parse tree types</a></h4>
<div class="paragraph">
<p>The <code>XL.PARSER</code> module offers a number of types intended to represent
or match elements in the parse tree:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tree</code> matches any parse tree.</p>
</li>
<li>
<p><code>integer</code> matches <a href="#numbers">whole number</a> literals such as <code>42</code>.</p>
</li>
<li>
<p><code>real</code> matches <a href="#numbers">fractional number</a> literals such as <code>3.14</code>.</p>
</li>
<li>
<p><code>text</code> matches <a href="#text">text</a> literals such as <code>"ABC"</code>.</p>
</li>
<li>
<p><code>character</code> matches <a href="#text">character</a> literals such as <code>'A'</code>.</p>
</li>
<li>
<p><code>name</code> matches names such as <code>A</code>.</p>
</li>
<li>
<p><code>operator</code> matches operators such as <code>+</code>.</p>
</li>
<li>
<p><code>symbol</code> matches either name or operators, as well as an empty
symbol used in empty blocks, e.g. <code>()</code>.</p>
</li>
<li>
<p><code>infix</code> matches infix expressions such as <code>A+B</code>.</p>
</li>
<li>
<p><code>prefix</code> matches prefix expressions such as <code>+3</code>.</p>
</li>
<li>
<p><code>postfix</code> matches postfix expressions such as <code>4%</code>.</p>
</li>
<li>
<p><code>block</code> matches block expressions such as <code>(A)</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="program-related-types"><a class="anchor" href="#program-related-types"></a><a class="link" href="#program-related-types">4.7.10. Program-related types</a></h4>
<div class="paragraph">
<p>A few other types are related to program evaluation, notably:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>lifetime</code> represents the <a href="#lifetime">lifetime</a> of values.</p>
</li>
<li>
<p><code>parser</code> represents an XL parser.</p>
</li>
<li>
<p><code>evaluator</code> represents an XL program evaluator.</p>
</li>
<li>
<p><code>task</code> represent a running task.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="other-common-types"><a class="anchor" href="#other-common-types"></a><a class="link" href="#other-common-types">4.7.11. Other common types</a></h4>
<div class="paragraph">
<p>A number of modules provide various generally useful, if more
specialized types. Here are some examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In module <code>XL.MEMORY</code></p>
<div class="ulist">
<ul>
<li>
<p><code>byte</code> is a type representing the smallest addressable unit of
memory, typically 8-bit on most modern implementations.</p>
</li>
<li>
<p><code>address</code> is a type representing addresses for the target machine,
i.e. values that can be used to index individual <code>byte</code> elements in
memory.</p>
</li>
</ul>
</div>
</li>
<li>
<p>In module <code>XL.FILE</code></p>
<div class="ulist">
<ul>
<li>
<p><code>file</code> is a representation for a file on the file system, allowing
operations such as reading or writing.</p>
</li>
<li>
<p><code>name</code> is a representation for file names that can be converted to
and from <code>text</code>.</p>
</li>
<li>
<p><code>path</code> is a representation for hierarchical access paths made of
individual <code>name</code> instances</p>
</li>
<li>
<p><code>directory</code> is a representation for directories, allowing to get a
list of files in a directory, to find the parent directory, and so on.</p>
</li>
<li>
<p><code>attributes</code> describe file-related attributes, such as creation and
modification date or access rights.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many more, documented in the section about the
<a href="#standard-library">standard library</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="type-related-concepts"><a class="anchor" href="#type-related-concepts"></a><a class="link" href="#type-related-concepts">4.8. Type-related concepts</a></h3>
<div class="paragraph">
<p>A number of essential concepts are related to the type system, and will
be explained more in details below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <a href="#lifetime">lifetime</a> of a value is the amount of time during
which the value exists in the program. Lifetime is, among other things,
determined by <a href="#scoping">scoping</a>.</p>
</li>
<li>
<p><a href="#creation">creation</a> and <a href="#destruction">destruction</a> defines
how values of a given type are initialized and destroyed.</p>
</li>
<li>
<p><a href="#errors">errors</a> are special types used to indicate failure.</p>
</li>
<li>
<p><a href="#mutability">mutability</a> is the ability for an entity to change
value over its lifetime.</p>
</li>
<li>
<p><a href="#compactness">compactness</a> is the property of some types to have
their values represented in the machine in a compact way, i.e. a
fixed-size sequence of consecutive memory storage units (most generally
bytes).</p>
</li>
<li>
<p><a href="#ownership">ownership</a> is a properties of some types to control
the lifetime of the associated values or possibly some other resource
such as a network connection. Non-owning types can be used to
<a href="#access-types">access</a> values of an associated owning type.</p>
</li>
<li>
<p><a href="#inheritance">inheritance</a> is the ability for a type to inherit
all operations from another type, so that its values can safely be
implicitly converted to values of that other type. Conversely,
<a href="#subtypes">subtypes</a> are types that add constraints to a type.</p>
</li>
<li>
<p>the <a href="#type-interface">interface</a> of a type is an optional scope that
exposes <em>features</em> of the type, i.e. individually accessible values. The
<em>implementation</em> of the type must provide all interfaces exposed in the
type’s interface.</p>
</li>
<li>
<p><a href="#transfers">transfers</a> are the ways values can be exchanged
between different parts of the program, and include
<a href="#copy">copy</a>, <a href="#move">move</a> and <a href="#binding">binding</a>.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="lifetime"><a class="anchor" href="#lifetime"></a><a class="link" href="#lifetime">4.8.1. Lifetime</a></h4>
<div class="paragraph">
<p>The lifetime of a value is the amount of time during which the value
exists in the program, in other words the time between its
<a href="#creation">creation</a> and its <a href="#destruction">destruction</a>.</p>
</div>
<div class="paragraph">
<p>An entity is said to be <em>live</em> if it was created but
not yet destroyed.  It is said to be <em>dead</em> otherwise.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some entities may be live but not accessible from within the
current context because they are not visible. This is the case for
variables declared in the caller’s context.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The lifetime information known by the compiler about entity <code>X</code> is
represented as compile-time constant <code>lifetime X</code>. The lifetime values
are equipped with a partial order <code>&lt;</code>, such that the expression
<code>lifetime X &lt; lifetime Y</code> being <code>true</code> is a compiler guarantee that <code>Y</code>
will always be live while <code>X</code> is live. It is possible for neither
<code>lifetime X &lt; lifetime Y</code> nor <code>lifetime X &gt; lifetime Y</code> to be true. This
<code>lifetime</code> feature is used to implement
<a href="https://doc.rust-lang.org/1.8.0/book/ownership.html">Rust-like</a>
<a href="#lifetime">restrictions on access types</a>,
i.e. a way to achieve memory safety at zero runtime cost.</p>
</div>
<div class="paragraph">
<p>The lifetime of XL values fall in one of the following categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>global values</em> become live during the
<a href="#declaration-phase">declaration phase</a> of the program, just
before its <a href="#evaluation-phase">evaluation phase</a>, and they remain
live until the end of that evaluation phase. Global values are
typically preallocated statically in a reserved area of memory,
before any program evaluation, by a program called a linker.</p>
</li>
<li>
<p><em>local values</em> become live during the
<a href="#nested-declarations">local declaration phase</a> of the bodies of
the declarations corresponding to patterns
<a href="#pattern-matching">being matched</a> during the evaluation phase.
Local values are typically allocated dynamically on a
<a href="https://en.wikipedia.org/wiki/Call_stack">call stack</a>
allocated for each thread of execuion. That stack has a limited
"depth", which may limit the depth of recursion allowed for a
program.</p>
</li>
<li>
<p><a id="dynamic_value"></a><em>dynamic values</em> are dynamically allocated
using a "heap", and remain live as long as some other value
<a href="#ownership">owns them</a>.  That owning value may itself be a
global, local or dynamic value.  The heap is typically the largest
available memory space for the program. XL offers a number of
facilities to help you manage how this dynamic allocation happens,
including facilities to build <a href="#garbage-collection">garbage
collectors</a> if and when this is an efficient management strategy.</p>
</li>
<li>
<p><em>temporary values</em> are  created during evaluation of
expressions, and can be discarded as soon as they have been
consumed. For example, assuming a definition for <code>x+y</code>, the
expression <code>a+b+c+d</code> will be processed as <code>((a+b)+c)+d</code>, and the
result of evaluating <code>a+b</code> can be destroyed as soon as <code>(a+b)+c</code> has
been evaluated. Temporary values are typically also allocated on
the stack.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, consider the following piece of code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>use XL.CONSOLE.TEXT_IO <i class="conum" data-value="1"></i><b>(1)</b>
use XL.TEXT.FORMAT

print "Starting printing Fibonacci sequences" <i class="conum" data-value="2"></i><b>(2)</b>

fib 0 is 1 <i class="conum" data-value="3"></i><b>(3)</b>
fib 1 is 1
fib N is (fib(N-1) + fib(N-2)) <i class="conum" data-value="4"></i><b>(4)</b>

for I in 1..5 loop <i class="conum" data-value="5"></i><b>(5)</b>
    F is fib I <i class="conum" data-value="6"></i><b>(6)</b>
    print format("Fib(%1) is %2", I, F) <i class="conum" data-value="7"></i><b>(7)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>use</code> statements import global values defined in other
files. Here, the <code>XL</code> module, its sub-module <code>XL.CONSOLE</code>, and a
third-level sub-module <code>XL.CONSOLE.TEXT_IO</code> are all imported by
the first statement, and similarly, <code>XL.TEXT</code> and <code>XL.TEXT.FORMAT</code>
are added by the second statement (<code>XL</code> being already imported)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The declaration of <code>print</code> is a global value <a href="#print">defined</a>
in <code>XL.CONSOLE.TEXT_IO</code>. This <code>print</code> statement is the first thing
to be executed during program evaluated. Its evaluation will call
code for an implementation of <code>print</code>, thereby adding a new
context on the call stack. As we indicated
<a href="#print_instances">earlier</a>, this may involve further calls
making the call stack deeper.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The three definitions with <code>fib</code> as a prefix are three distinct
global values, even if, thanks to dynamic dispatch, they may be
considered as implementing a single entity. Evaluating <code>fib N</code> or
<code>fib I</code> may require considering all three global values as
candidates.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The evaluation of the expression <code>(fib(N-1)+fib(N-2))</code> will need
to create a number of temporaries, for example to compute <code>N-1</code> or
<code>N-2</code>. Temporaries may be <a href="#destruction">destroyed</a> as soon as
they are no longer needed. For example, the code to evaluate the
expression could be someting similar to the following code, where
<code>tmp1</code>, <code>tmp2</code>, <code>tmp3</code>, <code>tmp4</code> and <code>tmp5</code> are the required
temporaries:
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">tmp1 is N-1
tmp2 is fib(tmp1)
delete tmp1
tmp3 is N-2
tmp4 is fib(tmp3)
delete tmp3
tmp5 is tmp2+tmp4
delete tmp2
delete tmp4
tmp5</code></pre>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>for</code> loop creates a local variable named <code>I</code> that will
successively take values <code>1</code>, <code>2</code>, <code>3</code>, <code>4</code>, <code>5</code>. The value for
<code>I</code> will only be live within one iteration of the loop. In other
words, the execution will be identical to the following
(using a <a href="#closure">closure</a> for the different values of <code>I</code>):
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">tmpBody is
    F is fib I
    print format("Fib(%1) is %2", I, F)
{ I is 1 } ( tmpBody )
{ I is 2 } ( tmpBody )
{ I is 3 } ( tmpBody )
{ I is 4 } ( tmpBody )
{ I is 5 } ( tmpBody )</code></pre>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The value defined by <code>F is fib I</code> is a local value that will be
live for the duration of the evaluation of the enclosing block. It
will be destroyed the end of each block. In other words, a more
accurate description for <code>tmpBody</code> in the example above would have
a <code>delete F</code> statement at the end, as follows:
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">tmpBody is
    F is fib I
    print format("Fib(%1) is %2", I, F)
    delete F</code></pre>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>It may come as a suprise to people coming from C or C++ that XL
does not <em>require</em> the call to <code>fib I</code> to be done before this
point. The definition <code>F is fib I</code> can be read as either a
constant initialized with <code>fib I</code>, or as a function returning <code>fib I</code>.
If the compiler can determine that the result of calling
evaluating <code>F</code> will always be identical, it is allowed to
implement memoization, i.e. to store the value computed for <code>F</code>
the first time, for example in an expression like <code>F+F</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Typically, a good compiler also makes use of machine
<em>registers</em>, very fast storage in the processor itself, as a cache for
values that are logically part of the call stack. In general, we will
only talk about the stack, with the understanding that this includes
registers where applicable.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="creation"><a class="anchor" href="#creation"></a><a class="link" href="#creation">4.8.2. Creation</a></h4>
<div class="paragraph">
<p><em>Creation</em> is the process of preparing a value for use.
The XL language rules guarantee that values are never undefined while
the value is live, by calling programmer-supplied code at the
appropriate times.</p>
</div>
<div class="paragraph">
<p>The lifetime of a value <code>V</code> begins by implicitly evaluating
a <em>creation</em> statement <code>create V</code>. This happens in particular
if you create a local variable without initializing it.</p>
</div>
<div class="paragraph">
<p>For example, consider the following code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Add Z:complex is
   T:complex
   Z+T</pre>
</div>
</div>
<div class="paragraph">
<p>The code above is really equivalent to the following, where the
implicitly-generated code has been put between parentheses:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Add Z:complex is
   T:complex
   (create T)
   Z+T</pre>
</div>
</div>
<div class="paragraph">
<p>Values in <a href="#generic-containers">containers</a> receive well-defined
values through creation. For example, if you create an <code>array[1..5] of complex</code>,
the 5 <code>complex</code> values are created before you can access them.</p>
</div>
<div id="field-creation" class="paragraph">
<p>A <code>create</code> operation must take a single <code>out</code> argument. All the values
in this <code>out</code> argument are themselves created before the body of the
definition begins. For example, consider the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>create Z:out complex is
    print "Creator called"</pre>
</div>
</div>
<div class="paragraph">
<p>This code does not lead to uninitialized values, because it is really
equivalent to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>create Z:out complex is
   (create Z.Re)        // Implicit creation of complex fields
   (create Z.Im)
   print "Creator called"</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>create</code> operator for <a href="#basic-types">basic types</a> is said to
<em>zero initialize</em> them as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>type</code> and <code>nil</code> values receive <code>nil</code>.</p>
</li>
<li>
<p>All integer types receive value <code>0</code></p>
</li>
<li>
<p>All real types receive value <code>0.0</code></p>
</li>
<li>
<p>All character types receive <code>character 0</code>.</p>
</li>
<li>
<p><code>text</code> receive <code>""</code>.</p>
</li>
<li>
<p><code>boolean</code> receive <code>false</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>create</code> operation can be called by the programmer, and therefore
must behave correctly if it is called multiple times. This is true by
default because of the rule that <code>out</code> parameters are
<a href="#destruction">destroyed</a> before a call.</p>
</div>
<div class="paragraph">
<p>For example, if you explicitly call <code>create</code> as in the following code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Z:complex
create Z</pre>
</div>
</div>
<div class="paragraph">
<p>this is really equivalent to the following, where implicit statements
are between parentheses:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Z:complex
(create Z)      // because of the declaration above
(delete Z)      // because Z is passed as out argument to 'create'
create Z</pre>
</div>
</div>
<div class="paragraph">
<p>The compiler may be able to elide some of these calls in such cases.
Another important case where a compiler should elide creation calls is
called <em>construction</em>, and is based on the shape defined for types.
When you define a type, you need to specify the associate shape. For
example, we defined a <code>complex</code> type as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type complex is matching complex(Re:real, Im:real)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that a shape like <code>complex(2.3, 5.6)</code> is a <code>complex</code>. This
also means that the <em>only</em> elementary way to build an arbitrary
<code>complex</code> value is by creating such a shape. It is therefore not
possible to have an uninitialized element in a <code>complex</code>, since for
example <code>complex(X, Y)</code> would not match the shape unless both <code>X</code> and
<code>Y</code> were valid <code>real</code> values.</p>
</div>
<div class="paragraph">
<p>However, there are contexts where it is desirable to <em>default
initialize</em> a complex value, for example when creating a container,
and this is where the <code>create</code> operation is necessary.</p>
</div>
<div class="paragraph">
<p>Using the shape explicitly given for the type is called the
<em>constructor</em> for the type, and can be used in definitions or in
variable declarations with an initial value. A constructor can never
fail nor build a partial object. If an argument returns an
<a href="#errors">error</a> during evaluation, then that <code>error</code> value will
not match the expected argument, except naturally if the constructor
is written to accept <code>error</code> values.</p>
</div>
<div class="paragraph">
<p>Often, developers will offer alternate ways to create values of a given
type. These alternate helpers are nothing else than regular definitions
that return a value of the type.</p>
</div>
<div class="paragraph">
<p>For example, for the <code>complex</code> type, you may create an imaginary unit,
<code>i</code>, but you need a constructor to define it. You can also recognize
common expressions such as <code>2+3i</code> and turn them into constructors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">i   is complex(0.0, 1.0)

syntax { POSTFIX 190 i }
Re:real + Im:real i                 is complex(Re, Im)      // Case 1
Re:real + Im:real * [[i]]           is complex(Re, Im)      // Case 2
Re:real + [[i]] * Im:real           is complex(Re, Im)      // Case 3
Re:real as complex                  is complex(Re, 0.0)     // Case 4
X:complex + Y:complex as complex    is ...

2 + 3i              // Calls case 1 (with explicit concersions to real)
2 + 3 * i           // Calls case 2 (with explicit conversions to real)
2 + i * 3           // Calls case 3
2 + 3i + 5.2        // Calls case 4 to convert 5.2 to complex(5.2, 0.0)
2 + 3i + 5          // Error: Two implicit conversions (exercise: fix it)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The fact that the only elementary way to create a type is through the
constructor is illustrated by the following code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type large is matching (N when N &gt; 42)
A:large := 44   // OK
B:large := 99.1 // OK
C:large         // Error
to create V:out large is
    print "Creator called"</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>A:large</code> and <code>B:large</code> initializations are acceptable, because it
is possible to validate that the initial values match the <code>large</code>
pattern. The <code>C:large</code> definition, however, is not acceptable, despite
the presence of a <code>create</code> operation. The reason is that there is no
way to <code>create V.N</code>, first because the type to use cannot be deduced,
second because if we picked a type like <code>integer</code>, the default initial
value <code>0</code> would not match the pattern.</p>
</div>
<div class="paragraph">
<p>The code above can be fixed, however, by using a constructor for the
<code>large</code> type inside the creator, which means supplying a value that
matches the type&#8217;s pattern. The following is an almost acceptable
version of the <code>create</code> function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type large is matching (N when N &gt; 42)
C:large         // OK
to create V:out large is
    print "Creator called"
    V := 44     // Creator for a large value</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The above is only <em>almost</em> acceptable because it calls <code>print</code>,
which may fail. Returning an <code>error</code> from a <code>create</code> is not recommended,
since it means that simply declaring a value of the type may cause
an error.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A type implementation may be <em>hidden</em> in a
<a href="#modules">module interface</a>, in which case the module
interface should also provide some functions to create elements of the
type. The following example illustrates this for a <code>file</code> interface
based on Unix-style file descriptors:</p>
</div>
<div id="my_file" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">module MY_FILE with
    type file
    to open(Name:text) as file
    to close F:in out file

module MY_FILE is
    type file matches file(fd:integer)
    to open(Name:text) as file is
        fd:integer := libc.open(Name, libc.O_RDONLY)
        file(fd)
    to close F:in out file is
        if fd &gt;= 0 then
            libc.close(F.fd)
            F.fd := -2
    to delete F:in out file is close F    // Destruction, see below</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the interface provides a <code>create</code> operation, it must be ready to
accept default-created values as input in all other functions of the
module. In the module above, however, the only way to get a value of
the <code>file</code> type is by using the <code>open</code> function. This also means that
you cannot create a variable of type <code>file</code> without initializing it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> This mechanism is similar to <em>elaboration</em> in Ada or to
<em>constructors</em> in C&#43;&#43;. It makes it possible for programmers to provide
strong guarantees about the internal state of values before they can be
used. This is a fundamental brick of programming techniques such as
encapsulation, programming contracts or
<a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RAII</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="destruction"><a class="anchor" href="#destruction"></a><a class="link" href="#destruction">4.8.3. Destruction</a></h4>
<div class="paragraph">
<p>
When the lifetime of a value <code>V</code> terminates, the statement <code>delete V</code>
automatically evaluates. Declared entites are destroyed in the reverse
order of their declaration. A <code>delete X:T</code> definition is called a
<em>destructor</em> for type <code>T</code>. It often has an <a href="#binding">in out</a> parameter
for the value to destroy, in order to be able to modify its argument,
i.e. a destructor often has a signature like <code>delete X:in out T</code>.</p>
</div>
<div class="paragraph">
<p>Symmetrical to <a href="#field-creation">creation</a>, the body of a <code>delete V</code>
automatically invokes <code>delete V.X</code> for any field <code>X</code> in <code>V</code> at exit of
the body of the definition.</p>
</div>
<div class="paragraph">
<p>For example, consider the definition below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>to delete Z:in out complex is
    print "Deleting complex ", Z</pre>
</div>
</div>
<div class="paragraph">
<p>That definition is actually equivalent to the definition below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>to delete Z:in out complex is
    print "Deleting complex ", Z
    (delete Z.Im)
    (delete Z.Re)</pre>
</div>
</div>
<div class="paragraph">
<p>There is a built-in default definition of that statement that has no
effect and matches any value, and which only deletes the fields:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>to delete Anything is nil</pre>
</div>
</div>
<div class="paragraph">
<p>There may be multiple destructors that match a given expression. When
this happens, normal lookup rules happen. This means that, unlike
languages like C&#43;&#43;, a programmer can deliberately override the
destruction of an object, and remains in control of the destruction
process. More importantly, this means that the destruction process
respects the global type semantics.</p>
</div>
<div class="paragraph">
<p>Consider for example the deletion of the <code>file</code> type defined in the
<code>MY_FILE</code> module above. Since there is a special case for negative
values, that might be reflected in the implementation as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>to delete F:in out file when F.fd &lt; 0  is ... // Invalid flie
to delete F:in out file                is ... // Valid file</pre>
</div>
</div>
<div class="paragraph">
<p>However, this also means that the programmer could create a
<code>valid_file</code> type corresponding to the case where <code>F.fd&lt;0</code> is false.
If you have a <code>valid_file</code> value to <code>delete</code>, normal type system and
lookup rules ensure that the second case will be selected.</p>
</div>
<div id="field-destruction" class="paragraph">
<p>Consider another interesting example, where you have the following
declarations:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type positive is matching (N when N &gt; 0)
integers is string of integer
N:integers &gt; 0 as boolean is
    for I in N loop
        if not (I &gt; 0) then
            return false
    return true

delete N:in out positive is
    print "Deleting positive: ", N

delete N:integer is
    print "Deleting integer: ", N

delete N:integers is
    print "Deleting integers with size: ", size N

example is
   print "Beginning example"
   A:integers := string(1,8,4)
   B:integers := string(-1,0,5)
   print "End of example"</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we create an <code>integers</code> type based on <code>string of integers</code>,
for which we implement the <code>N&gt;0</code> operator to mean that all elements
in the <code>string</code> are positive. This in turn means that some values that
have type <code>integers</code> also have type <code>positive</code>. In the body of
<code>example</code>, <code>A</code> is <code>positive</code>, but <code>B</code> is not.</p>
</div>
<div class="paragraph">
<p>If one consider <a href="#implicit-inheritance">implicit inheritance</a> and
the implicitly inserted field destruction, the code for the <code>integers</code>
type and <code>delete</code> operations above is really equivalent to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type integers is matching(base:string of integer)

delete P:in out positive is
    print "Deleting positive: ", P
    (delete P.N)        // Delete the N bound in 'positive'

delete N:integer is
    print "Deleting integer: ", N
    (delete N.base)     // For 'integer', this is a no-op

delete S:integers is
    print "Deleting integers with size: ", size S
    (delete S.base)     // Delete the underlying 'string of integer'</pre>
</div>
</div>
<div class="paragraph">
<p>As a result, the output of this program should be something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Beginning example
End of example
Deleting integers with size 3 <i class="conum" data-value="1"></i><b>(1)</b>
Deleting positive: 5 <i class="conum" data-value="2"></i><b>(2)</b>
Deleting integer: 5 <i class="conum" data-value="3"></i><b>(3)</b>
Deleting integer: 0 <i class="conum" data-value="4"></i><b>(4)</b>
Deleting integer: -1
Deleting positive: string(1,8,4) <i class="conum" data-value="5"></i><b>(5)</b>
Deleting integers with size 3 <i class="conum" data-value="6"></i><b>(6)</b>
Deleting positive: 4
Deleting integer: 4
Deleting positive: 8
Deleting integer: 8
Deleting positive: 1
Deleting integer: 1</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is deleting local variable <code>B</code> using type <code>integers</code>, knowing
that it failed to pass the test for <code>positive</code> because of value <code>-1</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is deleting values in the <code>string of integer</code> container in
local variable <code>B</code>, starting with the last one. Containers can
destroy their values in any order, but for <code>string</code>, an efficient
algorithm may start with the end of the container in order to be
able to truncate before each element being removed simply by
changing a "number of items" in the <code>string</code>. The local <code>delete</code>
definitions are visible to the instantiation of <code>delete</code> for the
type <code>string of integer</code> that is made for the call at the end of
<code>example</code>. The first matching definition for value <code>5</code> is for the
<code>positive</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is implicitly deleting the <code>integer</code> value called <code>P.N</code> in
the code above.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>For value <code>0</code> in the <code>string of integer</code> value held in <code>B</code>, the
<code>positive</code> test failed, so that the first destructor that works is
for <code>integer</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This is deleting local variable <code>A</code>. Since <code>A</code> is positive, the
destructor for positive is called.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Unlike what happened for <code>B</code>, the destructor for <code>integers</code> is not
called directly for <code>B</code> but implicitly for <code>P.N</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to create local destructor definitions. When such a local
definition exists, it is possible for it to override a more general
definition. The general definition can be accessed using
link:#enclosing context[<code>super</code> lookup], and generally, it should in order to
preserve the language semantics.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">show_destructors is
    delete Something is
        print "Deleted", Something
        super.delete Something
    X is 42
    Y is 57.2
    X + Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should output something similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Deleted 42.0
Deleted 57.2
Deleted 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first value being output is the temporary value created by the
necessary implicit conversion of <code>X</code> from <code>integer</code> to <code>real</code>. Note that
additional temporary values may appear depending on the optimizations
performed by the compiler. The value returned by the function should not
be destroyed, since it’s passed to the caller.</p>
</div>
<div class="paragraph">
<p>Any destruction code must be able to be called multiple times with the
same value, if only because you cannot prevent a programmer from
writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">delete Value</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that case, <code>Value</code> will be destroyed twice, once by the explicit
<code>delete</code>, and a second time when <code>Value</code> goes out of scope. There is
obviously no limit on the number of destructions that an object may go
through.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>for I in 1..LARGE_NUMBER loop
    delete Value</pre>
</div>
</div>
<div class="paragraph">
<p>Also, remember that passing a value as an <code>out</code> argument implicitly
destroys it. This is in particular the case for the target of an
assignment.</p>
</div>
</div>
<div class="sect3">
<h4 id="errors"><a class="anchor" href="#errors"></a><a class="link" href="#errors">4.8.4. Errors</a></h4>
<div class="paragraph">
<p>Errors in XL are represented by values with the <code>error</code>
type, or any type that <a href="#inheritance">inherits</a> from
error. The error type has a constructor that takes a simple error
message, or a simple message and a payload.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type error is one_of
    error Message:text
    error Message:text, Payload</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message is typically a localizable format text taking elements in
the payload as numbered argument in a way similar to the
<a href="#text-format"><code>format</code> function</a>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>log X:real as error when X &lt;= 0 is
    error "Logarithm of negative value %1", X</pre>
</div>
</div>
<div class="paragraph">
<p>A function that may fail will often have a <code>T or error</code> return value.
There is a specific shortcut for that, <code>T?</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">(T:type)? as type is T or error</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, a logarithm returns an error for non-positive values, so
that the signature of the <code>log</code> functions is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">log X:real as real?     is ... // May return real or error</code></pre>
</div>
</div>
<div class="paragraph">
<p>If possible, error detection should be pushed to the interface of the
function. For the <code>log</code> function, it is known to fail only for negative
or null values, so that a better interface would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">log X:real as real  when X &gt; 0.0    is ... // Always return a real
log X:real as error                 is ... // Always return an error</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the definitions above, the type of <code>log X</code> will be <code>real</code> if it
is known that <code>X &gt; 0.0</code>, <code>error</code> if it is known that the condition is
false, and <code>real or error</code>, i.e. <code>real?</code>, in the more general case.
A benefit of writing code this way is that the compiler can more easily
figure out that the following code is correct and does not require any
kind of error handling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">if X &gt; 0.0 then
    print format("Log(%1) is %2", X, log X)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> By returning an <code>error</code> for failure conditions,
XL forces the programmer to deal with errors simply to satisfy the
type system. They cannot simply be ignored like C return values or
C&#43;&#43; exceptions can be. Errors that may possibly return from a
function are a fundamental part of its type, and error handling is not
optional.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A number of types <a href="#inheritance">derive</a> from the base <code>error</code> type
to feature additional properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>range_error</code> indicates that a given value is out
of range. The default message provided is supplemented with
information comparing the value with the expected range.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">T:text[I:offset] as character or range_error is
    if I &gt;= length T then
        range_error "Text index %2 is out of bounds for text %2", I, T
    else
        P : memory_address[character] := memory_address(T.first)
        P += I
        *P</code></pre>
</div>
</div>
</li>
<li>
<p>A <code>logic_error</code> indicates an unexpected condition
in the program, and can be returned by contract checks like <code>assert</code>,
<code>require</code> and <code>ensure</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">if X &gt; 0 then
    print "X is positive"
else if X &lt; 0 then
    print "X is negative"
else
    logic_error "Some programmer forgot to consider this case"</code></pre>
</div>
</div>
</li>
<li>
<p><a id="storage_error"></a>A <code>storage_error</code> is returned whenever a
<a href="#dynamic_value">dynamic value</a> is created, notably each time an
<code>own T</code> object is created, but also when additional storage is
needed for containers.</p>
<div class="literalblock">
<div class="content">
<pre>S : string of integer           // The string requires storage
loop
    V : own integer := 3        // This allocates an integer, freed each loop
    S &amp;= V                      // Accumulate integers in an unbounded way</pre>
</div>
</div>
</li>
<li>
<p>A <code>file_error</code> reports when there is an error
opening a file, for example because a file does not exist.</p>
</li>
<li>
<p>A <code>permission_error</code> reports when a resource
access is denied, whether it&#8217;s a file or any other resource.</p>
</li>
<li>
<p>A <code>compile_error</code> helps the compiler emit better
diagnostic for situations which would lead to an invalid program. All
errors can be emitted at compile-time if the compiler can detect that
they will occur unconditionally, but <code>compile_error</code> makes it clearer
that this is intended to detect an error at compile-time. A variant,
<code>compile_warning</code>, emits a message but lets the compilation proceed.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">// Emit a specific compile-time error if assigning text to an integer
X:integer := Y:text is
    compile_error "Cannot assign text %1 to integer %2", Y, X

// Emit a specific warning when writing a real into an integer
X:integer := Y:real is
    compile_warning "Assigning real to integer may lose data"
    T is integer Y
    if real T = Y then
        X := T
    else
        range_error "Assigned real value %1 is out of range for integer", Y</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mutability"><a class="anchor" href="#mutability"></a><a class="link" href="#mutability">4.8.5. Mutability</a></h4>
<div class="paragraph">
<p>A value is said to be <em>mutable</em> if it can change during its lifetime. A
value that is not mutable is said to be <em>constant</em>.</p>
</div>
<div class="paragraph">
<p>You create a mutable entity with the notation: <code>Name:Type := Init</code>, where <code>Name</code>
is the name you give to the entity, <code>Type</code> is the type it must have over its
lifetime, and <code>Init</code> is its initial value.</p>
</div>
<div class="paragraph">
<p>A mutable value can be referenced at most in one place at a time in the
program. That place is called the <em>owner</em> of the mutable value.
A <em>mutable binding</em> is a binding that transfers a mutable value. While the
mutable binding is active, the mutable value is owned by the mutable binding.
A mutable binding is marked by the <code>out</code> or <code>inout</code> marker.</p>
</div>
<div class="paragraph">
<p>Consider for example a <code>Swap</code> function that swaps its parameters. Since it needs
to modify both parameters, both are marked as <code>inout</code>, meaning that they are
both mutable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">to Swap(inout A, inout B) is
    Tmp is A
    A := B
    B := Tmp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code shows an example of valid use of <code>Swap</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X : integer := 35
Y : integer := 42
Swap X, Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the statement <code>Swap X, X</code> is not valid, because <code>X</code> is passed to two
distinct mutable bindings.</p>
</div>
<div class="paragraph">
<p>Consider the following more subtle example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X : array[1..5] of real
Y : array[2..7] of real
Swap X[2], Y[3]         // OK
Swap X[2], X[3]         // Not OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second example is not valid, because for <code>A[I]</code> to be mutable, <code>A</code> needs to
be mutable itself, so for <code>X[2], X[3]</code>, we need to hold two mutable bindings
to <code>X</code> at the same time.</p>
</div>
<div class="paragraph">
<p>Note that you can implement <code>Swap</code> for an array by swapping its elements,
because if <code>Swap</code> receives two mutable bindings, they are necesary to two
different mutable arrays.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">to Swap(inout X:array, inout Y:array) is
    for I in array.index loop
        Swap X[I], Y[I]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>X:T</code> type annotations indicates that <code>X</code> is a mutable value of type
<code>T</code>, unless type <code>T</code> is explicitly marked as constant. When <code>X</code> is a
name, the annotation declares that <code>X</code> is a variable. The <code>X as T</code> type
annotation indicates that <code>X</code> is a constant value of type <code>T</code>, unless
type <code>T</code> is explicitly marked as variable. When <code>X</code> is a name, this may
declare either a named constant or a function without parameters,
depending on the shape of the body.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">StartupMessage : text := "Hello World"  // Variable
Answer as integer is 42                 // Named constant</code></pre>
</div>
</div>
<div class="paragraph">
<p>A mutable value can be initialized or modified using the <code>:=</code> operator,
which is called an
<a href="#assignment"><em>assignment</em></a>.
There are a number of derived operators, such as <code>+=</code>, that combine a
frequent arithmetic operation and an assignment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">X : integer := 42       // Initialize with value 42
X := X or 1             // Binary or, X is now 43
X -= 1                  // Subtract 1 from X, now 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some entities may give <a href="#access-types">access</a> to individual inner values.
For example, a <code>text</code> value is conceptually made of a number of
individual <code>character</code> values that can be accessed individually. This is
true irrespective of how <code>text</code> is represented. In addition, a <code>slice</code> of
a <code>text</code> value is itself a <code>text</code> value. The mutability of a <code>text</code>
value obviously has an effect on the mutability of accessed elements in
the <code>text</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows how <code>text</code> values can be mutated directly
(1), using a computed assignment (2), by changing a slice (3) or by
changing an individual element (4).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Greeting : text := "Hello"              // Variable text
Person as text is "John"                // Constant text
Greeting := Greeting &amp; " " &amp; Person     // (1) Greeting now "Hello John"
Greeting &amp;= "!"                         // (2) Greeting now "Hello John!"
Greeting[0..4] := "Good m0rning"        // (3) Greeting now "Good m0rning John!"
Greeting[6] := 'o'                      // (4) Greeting now "Good morning John!"</code></pre>
</div>
</div>
<div class="paragraph">
<p>None of these operations would be valid on a constant text such as
<code>Person</code> in the code above. For example, <code>Person[3]:='a'</code> is invalid,
since <code>Person</code> is a constant value.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the case (3) above, modifying a <code>text</code> value through an access
type can change its length. This is possible because <code>Greeting[0..4]</code> is
not an independent value, but an access type, specifically a <code>slice</code>,
which keeps track of both the <code>text</code> (<code>Greeting</code> here) and the index
range (<code>0..4</code> in that case), with a <code>:=</code> operator that modifies the
accessed <code>text</code> value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A constant value does not change over its lifetime, but it may change
over the lifetime of the program. More precisely, the lifetime of a
constant is at most as long as the lifetime of the values it is computed
from. For example, in the following code, the constant <code>K</code> has a
different value for every interation of the loop, but the constant <code>L</code>
has the same value for all iterations of <code>I</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">for J in 1..5 loop
    for I in 1..5 loop
        K is 2*I + 1
        L is 2*J + 1
        print "I=", I, " K=", K, " L=", L</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> There is no syntactic difference between a constant and a
function without parameters. An implementation should be free to
implement a constant as a function if this is more effective, or to use
smarter strategies when appropriate.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="compactness"><a class="anchor" href="#compactness"></a><a class="link" href="#compactness">4.8.6. Compactness</a></h4>
<div class="paragraph">
<p>Some data types can be represented by a fixed number of contiguous
memory locations. This is the case for example of <code>integer</code> or <code>real</code>:
all <code>integer</code> values take the same number of bytes. Such data types are
called <em>compact</em>.</p>
</div>
<div class="paragraph">
<p>On the other hand, a <code>text</code> value can be of any length, and may
therefore require a variable number of bytes to represent values such as
<code>"Hi"</code> and
<code>"There once was a time where text was represented in languages such as Pascal by fixed-size character array with a byte representing the length. This meant that you could not process text that was longer than, say, 255 characters. More modern languages have lifted this restriction."</code>.
These values are said to be <em>scattered</em>.</p>
</div>
<div class="paragraph">
<p>Scattered types are always built by <em>interpreting</em> compact types. For
example, a representation for text could be made of two values, the
memory address of the first character, and the size of the text. This is
not the only possible representation, of course, but any representation
require interpreting fixed-size memory locations and giving them a
logical structure.</p>
</div>
<div class="paragraph">
<p>Although this is not always the case, the assignment for compact types
generally does a <a href="#copy">copy</a>, while the assignment for scattered
types typically does a <a href="#move">move</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="ownership"><a class="anchor" href="#ownership"></a><a class="link" href="#ownership">4.8.7. Ownership</a></h4>
<div class="paragraph">
<p>Computers offer a number of <em>resources</em>: memory, files, locks,
network connexions, devices, sensors, actuators, and so on. A common
problem with such resources is to control their <em>ownership</em>. In
other words, who is responsible for a given resource at any given
time.</p>
</div>
<div class="paragraph">
<p>In XL, like in languages like Rust or C&#43;&#43;, ownership is largely
determined by the type system, and relies heavily on the guarantees it
provides, in particular with respect to <a href="#creation">creation</a> and
<a href="#destruction">destruction</a>. In C&#43;&#43;, the mechanism is called
<a href="https://en.wikipedia.org/wiki/RAII">RAII</a>, which stands for <em>Resource Acquisition is Initialization</em>. The central idea is that ownership of a
resource is an invariant during the lifetime of a value. In other words,
the value gets ownership of the resource during construction, and
releases this ownership during destruction. This was illustrated in the
<code>file</code> type of the module <code>MY_FILE</code> <a href="#my_file">given earlier</a>.</p>
</div>
<div class="paragraph">
<p>Types designed to own the associated value are called <em>owner types</em>.
There is normally at most one live owner at any given time for each
controlled resource, that acquired the resource at construction time,
and will release it at destruction time. It may be possible to release
the owned resource early using <code>delete Value</code>.</p>
</div>
<div class="paragraph">
<p>The <a href="#standard-library">standard library</a> provides a
number of types intended to own common classes of resources, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>own</code> value owns a single item allocated in dynamic storage.
Note that the value <code>nil</code> is not a valid <code>own</code> value (except for
<code>own nil</code>). If you need <code>nil</code> as a value, you must use <code>own T or nil</code>.</p>
</li>
<li>
<p>An <code>array</code>, a <code>buffer</code> and a <code>string</code> all own a contiguous sequence of
items of the same type.</p>
<div class="ulist">
<ul>
<li>
<p>An <code>array</code> has a fixed size during its lifetime and allocates items
directly, e.g. on the execution stack.</p>
</li>
<li>
<p>A <code>buffer</code> has a fixed size during its lifetime, and allocates items
dynamically, typically from a heap.</p>
</li>
<li>
<p>A <code>string</code> has a variable size during its lifetime, and consequently
may move items around in memory as a result of specific operations.</p>
</li>
</ul>
</div>
</li>
<li>
<p>A <code>text</code> owns a variable number of <code>character</code> items, and inherits
from the <code>string of character</code> type.</p>
</li>
<li>
<p>A <code>file</code> owns an open file.</p>
</li>
<li>
<p>A <code>mutex</code> owns execution by a single thread while it’s live.</p>
</li>
<li>
<p>A <code>timer</code> owns a resource that can be used to measure time and
schedule execution.</p>
</li>
<li>
<p>A <code>thread</code> owns an execution thread and the associated call stack.</p>
</li>
<li>
<p>A <code>task</code> owns an operation to perform that can be dispatched to one of
the available threads of execution.</p>
</li>
<li>
<p>A <code>process</code> owns an operating system process, including its threads
and address space.</p>
</li>
<li>
<p>A <code>context</code> captures an execution context.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="access-types"><a class="anchor" href="#access-types"></a><a class="link" href="#access-types">4.8.8. Access types</a></h4>
<div class="paragraph">
<p>Not all types are intended to be owner types. Many types delegate
ownership to another type. Such types are called <em>access types</em>.
When an access type is destroyed, the resources that it accesses are
<em>not</em> disposed of, since the access type does not own the value. A
value of the acces type merely provides <em>access</em> to a particular value
of the associated owner type.</p>
</div>
<div class="paragraph">
<p>For example, if <code>T</code> is a <code>text</code> value and if <code>A</code> and <code>B</code> are <code>integer</code>
values, then <code>T[A..B]</code> is a particular kind of access value called a
<em>slice</em>, which denotes the fragment of text between <code>0</code>-based positions
<code>A</code> and <code>B</code>. By construction, slice <code>T[A..B]</code> can only access <code>T</code>, not
any other <code>text</code> value. Similarly, it is easy to implement bound checks
on <code>A</code> and <code>B</code> to make sure that no operation ever accesses any
<code>character</code> value outside of <code>T</code>. As a result, this access value is
perfectly safe to use.</p>
</div>
<div class="paragraph">
<p>Access types generalize <em>pointers</em> or <em>references</em> found in
other languages, because they can describe a much wider class of
access patterns. A pointer can only access a single element, whereas
access types have no such restriction, as the <code>T[A..B]</code> example
demonstrates.  Access types can also enforce much stricter ownership
rules than mere pointers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The C language worked around the limitation that pointers access
a single element by abusing so-called "pointer arithmetic", in
particular to implement arrays. In C, <code>A[I]</code> is merely a shortcut for
<code>*(A+I)</code>. This means that <code>3[buffer]</code> is a valid way in C to access the
third element of <code>buffer</code>, and that there are scenarios where <code>ptr[-1]</code>
also makes sense as a way to access the element that precedes <code>ptr</code>.
Unfortunately, this hack, which may have been cute when machines had 32K
of memory, is now the root cause of a whole class of programming errors
known as <em>buffer overflows</em>, which contribute in no small part to the
well-deserved reputation of C as being a language that offers no memory safety whatsoever.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="#standard-library">standard library</a> provides a
number of types intended to access common owner types, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>ref</code> is a reference to a live <code>own</code> value.</p>
</li>
<li>
<p>A <code>slice</code> can be used to access range of items in contiguous
sequences, including <code>array</code>, <code>buffer</code> or <code>string</code> (and therefore
<code>text</code> considered as a <code>string of character</code>).</p>
</li>
<li>
<p>A <code>reader</code> or a <code>writer</code> can be used to access a <code>file</code> either for
reading or writing.</p>
</li>
<li>
<p>A <code>lock</code> takes a <code>mutex</code> to prevent multiple threads from executing a
given piece of code.</p>
</li>
<li>
<p>Several types such as <code>timing</code>, <code>dispatch</code>, <code>timeout</code> or <code>rendezvous</code>
will combine <code>timer</code>, <code>thread</code>, <code>task</code> and <code>context</code> values.</p>
</li>
<li>
<p>The <code>in</code>, <code>out</code> and <code>in out</code> type expressions can sometimes be
equivalent to an access types if that is the most efficient way to pass
an argument around. However, this is mostly invisible to the programmer.</p>
</li>
<li>
<p>An <code>XL.SYSTEM.MEMORY.address</code> references a specific address in
memory, and is the closest there is in XL to a raw C pointer. It is
purposely verbose and cumbersome to use, so as to discourage its use
when not absolutely necessary.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="inheritance"><a class="anchor" href="#inheritance"></a><a class="link" href="#inheritance">4.8.9. Inheritance</a></h4>
<div class="paragraph">
<p>A type is said to <em>inherit</em> another type, called its
<em>base type</em>, if it can use all its operations. The type is then
said to <em>derive</em> from the base type. In XL, this is
achieved simply by providing an <em>implicit conversion</em> between the
derived type and the base type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Derived:derived as base is ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a consequence of this approach, a type can derive from any number of
other types, a feature sometimes called <em>multiple inheritance</em>. There is
also no need for the base and derived type to share
any specific data representation, although this is
<a href="#data-inheritance">often done in practice</a>. For example, there is
an implicit conversion from <code>i16</code> to <code>i32</code>, altough the
machine representation is different, so in XL, one can say that
<code>i16</code> derives from <code>i32</code>.</p>
</div>
<div class="paragraph">
<p>Sometimes, it is necessary to denote a type that inherits from a
specific type. For example, if you want to create a constrained generic type for <code>complex</code>, you might want it to accept only <code>number</code>
for its type argument. The following code is an incorrect way to do
it, since it creates a type that only accept <code>number</code> <em>values</em> as an
argument, i.e. it would accept <code>complex[3.5]</code> but not <code>complex[real]</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex is matching complex[real:number] // WRONG</pre>
</div>
</div>
<div class="paragraph">
<p>To denote a type that derives from a base type, one can use the
<code>derived like base</code> notation. The correct way to implement the above
restriction is as follows, which indicates that the argument is a
type, not a value, and that the type must derive from <code>number</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex is matching complex[real:type like number]</pre>
</div>
</div>
<div class="paragraph">
<p>The precedence of <code>like</code> is lower than that of <code>:</code>, so that the above
really parses as <code>(real:type) like number</code>. The <code>like</code> operator can be
applied to specify inheritance at any place in a declaration, and
notably in scopes. An alternate spelling for <code>like</code> is <code>inherits</code>,
which is generally more readable in global scope. For example, you can
indicate that the <code>complex</code> type itself inherits from <code>arithmetic</code>
(providing arithmetic operations) as well as from <code>compact</code> (using a
contiguous memory range) as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type complex inherits arithmetic
type complex inherits compact</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="subtypes"><a class="anchor" href="#subtypes"></a><a class="link" href="#subtypes">4.9. Subtypes</a></h3>
<div class="paragraph">
<p>A type can be given additional constraints,
which define a <em>subtype</em>. A subtype can always be converted to the
type it was derived from, and therefore derives from that type in the
<a href="#inheritance">inheritance</a> sense. A subtype machine representation
may differ from the type it derives from.</p>
</div>
<div class="paragraph">
<p>For example, from the <code>integer</code> type, one can construct a <code>month</code> type
that matches only <code>integer</code> values between <code>1</code> and <code>12</code> using a regular
<a href="#when">conditional pattern</a> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type month is matching(M:integer when M &gt;= 1 and M &lt;= 12)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The language defines a number of standard subtypes. All these subtypes
can be implemented using regular language features.</p>
</div>
<div class="sect3">
<h4 id="range-subtypes"><a class="anchor" href="#range-subtypes"></a><a class="link" href="#range-subtypes">4.9.1. Range subtypes</a></h4>
<div class="paragraph">
<p>Subtyping to select a range is common enough that there is a shortcut
for it. For any type with an order, subtypes can be created with the
<code>range</code> infix operator, creating a <em>range subtype</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">T:type range Low:T..High:T      is matching(X:T when X in Low..High)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this definition, the <code>month</code> type can be defines simply as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type month is integer range 1..12</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="size-subtypes"><a class="anchor" href="#size-subtypes"></a><a class="link" href="#size-subtypes">4.9.2. Size subtypes</a></h4>
<div class="paragraph">
<p>The infix <code>bits</code> operator creates a <em>size subtype</em> with the
specified number of bits. It applies to <code>real</code>, <code>integer</code> and
<code>character</code> types.</p>
</div>
<div class="paragraph">
<p>For example, the <code>i8</code> type can be defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type i8 is integer bits 8</code></pre>
</div>
</div>
<div class="paragraph">
<p>This implicitly implies a <code>range</code> that depends on the type being
subtyped. For example, for <code>integer</code> and <code>natural</code>, the range would be
defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">[[integer]] bits N:natural      is integer range -2^(N-1)..2^(N-1)-1
[[natural]] bits N:natural      is natural range  0..2^N-1</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>bits</code> subtypes are intended to specify the bit size of the
machine representation. The requested size may be rounded up to a more
convenient or more efficient machine representation. For example, on a
32-bit machine, <code>integer bits 22</code> might be more efficiently represented
as a 32-bit value in registers and as 3 bytes, i.e. 24 bits, in memory.
Irrespective of the representation, these subtypes will wrap around
exactly as if the type had the given number of bits.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="real-subtypes"><a class="anchor" href="#real-subtypes"></a><a class="link" href="#real-subtypes">4.9.3. Real subtypes</a></h4>
<div class="paragraph">
<p>The <code>real</code> type can be subtyped with a <code>range</code> and a <code>bits</code> size, as
well as with additional constraints more specific to the <code>real</code> type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <code>digits</code> count specifies the number of accurate decimal digits,
For example, <code>real digits 3</code> is represents values with at least 3
significant digits.</p>
</li>
<li>
<p>a <code>quantum</code> followed by a literal real value specifies a
representation that should be representable exactly. For example,
<code>real quantum 0.25</code> that value <code>0.25</code> must be represented exactly.</p>
</li>
<li>
<p>an <code>exponent</code> specifies the maximum decimal exponent. For example,
<code>real exponent 100</code> will ensure that values up to <code>1.0e100</code> can be
represented.</p>
</li>
<li>
<p>a <code>base</code> specifies the base for the internal representation. Only
bases <code>2</code>, <code>10</code> and <code>16</code> are allowed. Base <code>2</code> requires a binary floating-point representation. Base <code>10</code> requires a decimal floating-point representation. Base <code>16</code> requires an hexadecimal floating-point representation on historical platforms that support it.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In some cases, the types created using one of these operators may not
be subtypes of <code>real</code>. For example, on any machine using the most
common floating-point representation available in hardware,
<a href="https://en.wikipedia.org/wiki/IEEE-754">IEEE-754</a>, the value <code>0.01</code> cannot be
<a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic#Representable_numbers,_conversion_and_rounding">represented accurately</a>.
This means that an implicit conversion from <code>real quantum 0.01</code> to
<code>real</code> would implicitly destroy accuracy. As a result, <code>real quantum 0.01</code>
must be converted to <code>real</code> <em>explicitly</em>.
In some other cases, implementation limitations may cause errors. For
example, an implementation is not required to accept <code>real digits
100</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>real</code> subtype should be represented using
<a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic"><em>fixed-point arithmetic</em></a> if one of the following conditions is true:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>exponent</code> is specified as <code>0</code>.</p>
</li>
<li>
<p>The <code>range</code> is small enough to be representable entirely with the same
exponent and the available number of bits.</p>
</li>
<li>
<p>A <code>quantum</code> is specified and no <code>exponent</code> is specified.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the <code>hundredth</code> type defined below could be represented
internally by an <code>natural</code> values between <code>0</code> and <code>100</code>, and converted to
<code>real</code> by multiplying this value by the given <code>quantum</code> value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type hundredth is real range 0.0..1.0 quantum 0.01</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="saturating-subtypes"><a class="anchor" href="#saturating-subtypes"></a><a class="link" href="#saturating-subtypes">4.9.4. Saturating subtypes</a></h4>
<div class="paragraph">
<p>The <code>saturating</code> prefix operator can be used on <code>integer</code> and <code>real</code>
types (primarily intended for use with fixed-point subtypes) to select
<a href="https://en.wikipedia.org/wiki/Saturation_arithmetic"><em>saturation arithmetic</em></a>
in case of overflow.</p>
</div>
<div class="paragraph">
<p>For example, a <code>color_component</code> type that has values between <code>0.0</code>
and <code>1.0</code> and saturates can be defined as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type color_component is saturating real range 0.0..1.0 bits 16
Red : color_component := 0.5
Red += 0.75             // Red is now 1.0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="character-subtypes"><a class="anchor" href="#character-subtypes"></a><a class="link" href="#character-subtypes">4.9.5. Character subtypes</a></h4>
<div class="paragraph">
<p>The <code>character</code> types can be subtyped with the <code>range</code> and <code>bits</code>
operators:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type letter is character range 'A'..'Z'
type ASCII  is character bits 7</pre>
</div>
</div>
<div class="paragraph">
<p>In addition, character types can be subtyped with the following infix
operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>encoding</code> operator specifies the encoding used for the text, for
example <code>character encoding "ASCII"</code>.</p>
</li>
<li>
<p>The <code>locale</code> operator specifies the locale for the text, for example
<code>character locale "fr_FR"</code> will select a French locale.</p>
</li>
<li>
<p>The <code>collation</code> operator specifies collating order. For example, to
have <code>character</code> values that sort following German rules, you would use
<code>character collation "de_DE"</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Encoding, collation and locale can be implemented by adding
fields to the base type that record these attributes, and by having
additional runtime operations that take these attributes into account.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="text-subtypes"><a class="anchor" href="#text-subtypes"></a><a class="link" href="#text-subtypes">4.9.6. Text subtypes</a></h4>
<div class="paragraph">
<p>The <code>text</code> type can be subtyped with the <code>encoding</code>, <code>locale</code> and
<code>collation</code> operators, with the same meaning as for <code>character</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="memory-access-subtypes"><a class="anchor" href="#memory-access-subtypes"></a><a class="link" href="#memory-access-subtypes">4.9.7. Memory access subtypes</a></h4>
<div id="atomic" class="paragraph">
<p>Many recent machines provide several ways to access memory, for
example to deal with synchronization between multiple CPUs or between
CPUs and memory-mapped devices. XL presents this kind of features as
subtypes.</p>
</div>
<div class="paragraph">
<p>The following standard subtypes implement memory-related semantics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>atomic T</code> is a type derived from <code>T</code> that offers
<a href="https://en.cppreference.com/w/c/language/atomic">atomic operations</a>.
This may come at the expense of performance.</p>
</li>
<li>
<p><code>unaligned T</code> is a type derived from <code>T</code> that may not respect normal
alignment rules, and may require slower mis-aligned accesses.</p>
</li>
<li>
<p><code>T aligned N</code> guarantees that values of type <code>T</code> use memory
aligned on <code>N</code> bytes boundaries.</p>
</li>
<li>
<p><code>volatile T</code> is a type derived from <code>T</code> where the compiler cannot
assume that the value does not change externally due to causes
external to the current code.</p>
</li>
<li>
<p><code>uncached T</code> is a type derived from <code>T</code> where the compiler should
ensure that data accesses are consistent with external memory, even
if this is significantly more expensive.</p>
</li>
<li>
<p><code>packed T</code> is a type derived from <code>T</code> where data is packed as
tightly as possible, even to the detriment of performance.</p>
</li>
<li>
<p><code>little_endian T</code>, <code>big_endian T</code> and <code>native_endian T</code> are types
derived from <code>T</code> where the in-memory representation is either
little-endian, big-endian respectively or the native endianness of
the host. Depending on the platform, using such type may severely
impact performance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional subtypes may be available to match the features of the
machine the code runs on.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="type-interface"><a class="anchor" href="#type-interface"></a><a class="link" href="#type-interface">4.10. Type interface</a></h3>
<div class="paragraph">
<p><a id="field"></a><a id="method"></a>
The <a href="#interface-and-implementation">interface</a> of a type specifies
how the type can be used, and what operations can be performed with
it. Specifically, the interface defines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>features</em> of the type, which are elements that are visible in
the <a href="#pattern-matching-scope">scope</a> defined by a value of the type.
<a href="#mutability">Mutable</a> features are sometimes called <em>fields</em>,
whereas constant features are sometimes called <em>methods</em>.</p>
</li>
<li>
<p><em>inheritance</em> of the type, which indicates what type, if any,
the type <a href="#inheritance">derives from</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A feature is said to be <em>advertised</em> if it is
explicitly and intentionally part of the interface. A feature is said
to be <em>exposed</em> if it is made visible as an
unintentional or even undesirable side effect of the implementation.
For example, if an implementation requires dynamic values, this may
force the interface to expose the <code>storage_error</code> values that might be
generated as a result of out-of-memory conditions.</p>
</div>
<div class="paragraph">
<p>The code below defines a <code>picture</code> type that advertises <code>width</code>, <code>height</code>
and <code>pixels</code> fields, as well as an <code>area</code> method that is used to compute
the total number of pixels and is the size for the <code>pixels</code> buffer. In
this interface, one might argue that the fact that <code>pixels</code> is a
<code>buffer</code> falls more in the "exposed" category than "advertised".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type picture with
    width  : size
    height : size
    pixels : buffer[area] of byte
    area as size</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code below indicates that the type <code>text</code> derives from <code>string of
character</code> with additional features:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type text like [string of character] with
    byte_count as size                  // Number of bytes used by characters
    as_number[T:some number] as T       // Numerical conversion</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <em>abstract type</em> is a type for which features or inheritance are not
provided. The only thing known about such a type is its name. In the
earlier <code>MY_FILE</code> <a href="#my_file">example</a>, <code>file</code> was an abstract type defined
as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>file as type</pre>
</div>
</div>
<div class="paragraph">
<p>A type for which only the interface is known is called a <em>tag type</em>.
Since nothing is known about the parse tree shape associated with the
type, a tag type can only match values that were <em>tagged</em> with the
same type using some explicit type annotation.</p>
</div>
<div class="paragraph">
<p>In particular, knowing only the interface of a type does not allow
values of the type to be <a href="#creation">created</a>. It is sometimes
useful or desirable to preclude the creation of values of the type,
for example when creating <a href="#true-generic-types">true generic types</a>.
For most concrete types, however, the interface of a function creating
values of the type should generally also be provided. In the rest of
the discussion for the <code>picture</code> type, we will assume that there is a
<code>picture</code> function returning a <code>picture</code> value with the following
function interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">picture(width:size, height:size) as picture</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="information-hiding"><a class="anchor" href="#information-hiding"></a><a class="link" href="#information-hiding">4.10.1. Information hiding</a></h4>
<div class="paragraph">
<p>The interface of a type does not reveal any information on the actual
implementation of the type, e.g. on the shape of the parse tree
associated with it. This is called <em>information hiding</em> and
is the primary way in XL to achieve
<a href="https://en.wikipedia.org/wiki/Encapsulation_(computer_programming)"><em>encapsulation</em></a>.</p>
</div>
<div class="paragraph">
<p>While the type interface for <code>picture</code> above does not give us any clue
about how the type is actually implemented, it still provides very
useful information. It remains sufficient to validate code that uses
values of the type, like the following definition of <code>is_square</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">is_square P:picture is P.width = P.height</code></pre>
</div>
</div>
<div class="paragraph">
<p>In that code, <code>P</code> is properly tagged as having the <code>picture</code> type, and
even if we have no idea how that type is implemented, we can still use
<code>P.width</code> and deduce that it’s an <code>integer</code> value based on the type
interface alone.</p>
</div>
<div class="paragraph">
<p>Information hiding is specially useful in the context of
<a href="#modules">modules</a>, where the interface and implementation
typically reside in different source files.</p>
</div>
</div>
<div class="sect3">
<h4 id="direct-implementation"><a class="anchor" href="#direct-implementation"></a><a class="link" href="#direct-implementation">4.10.2. Direct implementation</a></h4>
<div class="paragraph">
<p>The simplest way to implement any feature of a type is to ensure that
the implementation of the type has a matching feature. This is called
a <em>direct implementation</em> of the feature.</p>
</div>
<div class="paragraph">
<p>A feature is directly implemented by providing a definition for it.
For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type point with { X:real; Y:real }
type point is point(X:real, Y:real)</pre>
</div>
</div>
<div class="paragraph">
<p>In that case, type <code>point</code> type implementation creates a scope that
contains definitions for <code>X</code> and <code>Y</code>. In other words, if <code>P</code> is a
<code>point</code>, then <code>P.X</code> is defined by the implementation, and therefore
the interface requirement for <code>P.X</code> is satisfied as well.</p>
</div>
<div class="paragraph">
<p>This is a particular case of the
a <a href="#pattern-matching-scope">pattern matching scope</a> rule applied to
the type implementation.</p>
</div>
<div class="paragraph">
<p>A direct implementation for the type <code>picture</code> interface might look like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type picture is matching picture
    pixels : buffer[area] of u8
    width  : size
    height : size</pre>
</div>
</div>
<div class="paragraph">
<p>In a context where only the interface is visible, an expression like
<code>P.width</code> is known to be valid because we can look it up in the
interface for the <code>picture</code> type. However, in order to identify the
implementation for <code>P.width</code>, we must look this expression up in a
context where the implementation of <code>picture</code> is known. Finding an
implementation definition that matches the interface definition is the
mechanism underlying direct implementation of the feature.</p>
</div>
</div>
<div class="sect3">
<h4 id="data-inheritance"><a class="anchor" href="#data-inheritance"></a><a class="link" href="#data-inheritance">4.10.3. Data inheritance</a></h4>
<div class="paragraph">
<p>To implement inheritance, a direct implementation is to simply reuse
the existing data in the original type, possibly adding more to
it. This is called <em>data inheritance</em>, and is implemented by using
the <code>T with Fields</code> notation.</p>
</div>
<div class="paragraph">
<p>For example, using data inheritance to implement a <code>colored_text</code> that
derives from the <code>text</code> type and adds a color, the interface might be:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type colored_text like text with
    foreground : color
    background : color</pre>
</div>
</div>
<div class="paragraph">
<p>An implementation using data inheritance would look like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type colored_text is text with
   background : color
   foreground : color</pre>
</div>
</div>
<div class="paragraph">
<p>As shown in the example, the fields need not be in the same order in
the implementation as in the interface. In the resulting
implementation type, a field named <code>base</code> refers to the base type on
the left of <code>with</code>. For values of that derived type, the field <code>base</code>
refers to the base value. Using data inheritance lets the translator
automatically generate implicit conversion code that takes a derived
value and returns its base. In our case, that implicit conversion
would look like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>derived:colored_text as text is derived.base</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="indirect-implementation"><a class="anchor" href="#indirect-implementation"></a><a class="link" href="#indirect-implementation">4.10.4. Indirect implementation</a></h4>
<div class="paragraph">
<p>However, the implementation may be entirely different from the
interface, as long as any expression that is valid knowing the
interface is valid in a context where the implementation is known.
An implementation that provides an advertised feature of the interface
withtout using a similar definition is called an <em>indirect implementation</em>
of that feature.</p>
</div>
<div class="paragraph">
<p>A simple case of indirect implementation for inheritance is to provide
an implicit conversion function. For example, the implementation of
<code>text</code> may simply be defined in a scope that also features the
following function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>T:text as string of character is convert_to_string(T)</pre>
</div>
</div>
<div class="paragraph">
<p>While it is reasonable to infer from the interface that <code>text</code> and
<code>string of character</code> might share a common internal representation,
this is only an efficient way to provide inheritance, but it is not a
constraint on the implementation.</p>
</div>
<div class="paragraph">
<p>A type may also provide entirely different implementations of its
features, while still allowing individual features to be accessed
almost as if they were provided by a direct implementation. We will
see a number of examples in the next sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="delegation"><a class="anchor" href="#delegation"></a><a class="link" href="#delegation">4.10.5. Delegation</a></h4>
<div class="paragraph">
<p>An interesting case is when the type <em>delegates</em> most
of its implementation to some other type. For example, the <code>picture</code>
type might actually be using a <code>bitmap</code> type as its internal
representation:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>type bitmap with
    width  : u16
    height : u16
    buf    : array[width, height] of u8
type picture is matching picture
    bits:bitmap</pre>
</div>
</div>
<div class="paragraph">
<p>Such an implementation of the <code>picture</code> type must perform some serious
adjustments in order to delegate the work to the underlying <code>bitmap</code>
value while providing the expected interface. Dealing with the <code>width</code>
and <code>height</code> fields seems relatively straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type picture is matching picture
    bits:bitmap

    width  is bits.width
    height is bits.height</code></pre>
</div>
</div>
<div class="paragraph">
<p>This, however, will not work as is, because we have only provided a
way to <em>read</em> <code>width</code> and <code>height</code>, not to write it. This does not
match the interface. A simple solution would be to modify the
<code>picture</code> interface, for example so that it reads <code>width as size</code>.
With this interface change, the code above will correctly allow us to
find an implementation for expressions such as <code>P.width</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="attributes-implementation"><a class="anchor" href="#attributes-implementation"></a><a class="link" href="#attributes-implementation">4.10.6. Attributes implementation</a></h4>
<div class="paragraph">
<p>If, however, we still want to be able to <em>write</em> into <code>width</code> and
<code>height</code>, the implementation must provide a way to assign to the field.
The first problem here is with the notation that properly identifies
this operation. The following for example does not work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type picture is matching picture
    bits:bitmap

    width  is bits.width
    height is bits.height

    width  := W is bits.width := W
    height := H is bits.width := H</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason it does not work is that <code>width</code> in the <code>width := W</code>
pattern is a formal parameter. The <a href="#metabox">metabox</a> solution
does not work in that context, since writing <code>[[width]] := W</code> would
match the <em>value</em> of <code>width</code>, not its shape, and unless <code>width</code> is
defined as <code>self</code> like <code>true</code> or <code>false</code> can be, attempting to
evaluate <code>width</code> will not achieve the desired effect.</p>
</div>
<div class="paragraph">
<p>It is possible to resort to a more convoluted solution that intercepts
assignments to <code>width</code> and height by using <code>type(width)</code> as a way to
only match <code>width</code>, which leads to somewhat inelegant and unreadable
code like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type picture is matching picture
    bits:bitmap

    width  is bits.width
    height is bits.height

    width:type(width)   := W    is      bits.width := W
    height:type(height) := H    is      bits.width := H</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid this issue, XL provides a helper generic type called
<code>attribute T</code>, which helps implementing an
<a href="#attributes"><em>attribute</em></a> of the desired type. An <code>attribute T</code>
behaves like a <code>T</code> that provides <code>get</code> and <code>set</code> features, as well as
support for assignments. The implementation for the <code>picture</code> type
type can be correctly written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type picture is matching picture
    bits:bitmap

    width as attribute[size] is attribute
        get     is bits.width
        set W   is bits.width := W
    height as attribute[size] is attribute
        get     is bits.height
        set H   is bits.height := H</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>P</code> is a <code>picture</code>, then the <code>width</code> value can be read using
<code>P.width</code> or <code>P.width.get</code>, and written to using <code>P.width := W</code>,
<code>P.width.set W</code> or <code>P.width W</code>. The best method will depend on the use
case. In any case, an <code>attribute T</code> can be used to implement a field
of type <code>T</code> declared in the interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="generic-implementations"><a class="anchor" href="#generic-implementations"></a><a class="link" href="#generic-implementations">4.10.7. Generic implementations</a></h4>
<div class="paragraph">
<p>By providing as little type information as possible, the code as
written above remains as generic as possible. This enables better
optimizations. For instance, writing <code>width 320</code> might generate only
code for <code>u16</code> without any need for any <code>size</code> value to be
ever created.</p>
</div>
<div class="paragraph">
<p>Unfortunately, that code will only be accepted by the compiler until
you try to use it with values that do not fit within an <code>u16</code>.
It is accepted because it is not typed, therefore generic, so that
some errors cannot be detected until you instantiate it.
Furthermore, no error will be generated if the values being passed all
fit within an <code>u16</code>.</p>
</div>
<div class="paragraph">
<p>If <code>P</code> is a <code>picture</code>, then <code>P.width 320</code> will work, but <code>P.width
1_000_000</code> will not, since that value is out of range for
<code>u16</code>. This is problematic because it is quite likely that the
attribute will receive some unknown <code>size</code> value. After all, the
interface was designed for an <code>sie</code>, not an <code>u16</code>, so it
makes sense to invoke it with values of this type. There will be an
error in that case, because nothing in our code accepts a <code>size</code>
value that does not fit in the <code>u16</code> subtype.</p>
</div>
</div>
<div class="sect3">
<h4 id="attribute-error-checking"><a class="anchor" href="#attribute-error-checking"></a><a class="link" href="#attribute-error-checking">4.10.8. Attribute error checking</a></h4>
<div class="paragraph">
<p>This can also be fixed, but if we want to do it correctly, we need to
range-check the input. One cheap and lazy way to do it is to ignore
bad input and just print some run-time error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type picture is matching picture
    bits:bitmap

    width as attribute[size] is
        get             is bits.width
        set W:u16       is bits.width := W
        set W           is
             print error("Invalid picture width %1", W
             bits.width
    height as attribute[size] is
        get             is bits.height
        set H:u16       is bits.height := H
        set H           is
            print error("Invalid picture height %1", H)
            bits.height</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we instead want to return the error, then we need to expose the
error in the interface, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type picture with
    width  : size?
    height : size?
    pixels : buffer[area] of byte
    area as size</code></pre>
</div>
</div>
<div class="paragraph">
<p>That, however, suggests that <code>width</code> might accept <code>error</code> values as
input. A better interface would be to expose the attribute nature of
<code>width</code> and <code>height</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">type picture with
    width  as attribute size
    height as attribute size
    pixels : buffer[area] of byte
    area as size</code></pre>
</div>
</div>
<div class="paragraph">
<p>But if we are going that way, we may as well expose the simpler
interface that does not lie about the underlying values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">tyep picture with
    width  : u16
    height : u16
    pixels : buffer[area] of byte
    area as size is width * height</code></pre>
</div>
</div>
<div class="paragraph">
<p>These various examples show that XL provides powerful tools that makes
it possible to evolve software significantly without having to change
the interface, preserving compatibility for client code. However,
information hiding can never be perfect. The XL type system will catch
a large number of errors and force you to deal with them, giving you
several ways to safely evolve the code.</p>
</div>
</div>
<div class="sect3">
<h4 id="exposed-details"><a class="anchor" href="#exposed-details"></a><a class="link" href="#exposed-details">4.10.9. Exposed details</a></h4>
<div class="paragraph">
<p>A similar, if slightly more complicated problem arises with the
proposed interface for <code>pixels</code> in the <code>picture</code> type, because
<code>buffer</code> is a type that may require dynamic allocation, and therefore
some operations may have to return a <code>storage_error</code>. This is already
present in the interface for the <code>buffer</code> type, so one might feel a
bit safer than for the mismatch between <code>size</code> and <code>u16</code>.</p>
</div>
<div class="paragraph">
<p>However, since there is no actual <code>buffer</code> present in <code>bitmap</code>, a
buffer may need to be created or at least given storage in the
implementation of <code>P.pixels</code> for <code>picture</code> values.
This may involve the <em>creation</em> of a buffer while simply
reading a field. In other words, a <code>storage_error</code> may now result from
apparently <em>reading</em> <code>P.pixels</code>, something that would not
happen with a direct implementation of <code>P.pixels</code> as a field.</p>
</div>
<div class="paragraph">
<p>In other words, in an ideal world, <code>P.pixels</code> might be implemented as
an actual buffer or as a function computing a buffer and returning
it. In the real world, however, the XL type system will force you to
distinguish between the two cases, because the place where dynamic
allocations may fail is different depending on the chosen implementation.</p>
</div>
<div class="paragraph">
<p>In that case too, the interface may need to be changed to expose an
implementation detail regarding when the buffer is actually created.
It might seem like an inability of XL to offer sufficient information
hiding capabilities, but in reality, it&#8217;s a testament to the power of
the XL type system that it should catch such subtle errors, even if it
is at the cost of convenience. XL will accept to hide details as long
as these details are not critical for safe evaluation. The details
that will not be hidden in that case are what might cause your program
to crash or your rocket to explode.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transfers"><a class="anchor" href="#transfers"></a><a class="link" href="#transfers">4.11. Transfers</a></h3>
<div class="paragraph">
<p>One of the most important operation that can happen to values of any
type is to <em>transfer</em> them around in the program. These operations
are so crucial to the behavior of the program that XL provides a
robust framework for defining and optimizing them.</p>
</div>
<div class="paragraph">
<p>In particular, transfers interact with the <a href="#ownership">ownership</a>
guarantees that the language may provide, in combination with the rules
about <a href="#binding">binding</a>, <a href="#lifetime">lifetime</a>, <a href="#creation">creation</a>
and <a href="#destruction">destruction</a>. Additionally, transfers are so frequent that
it is necessary to consider performance of transfers, which is one reason why
there are two primary flavors, <a href="#copy">copy</a> and <a href="#move">move</a>.</p>
</div>
<div class="sect3">
<h4 id="assignment"><a class="anchor" href="#assignment"></a><a class="link" href="#assignment">4.11.1. Assignment</a></h4>
<div class="paragraph">
<p>An <em>assignment</em> is the primary way for a programmer to explicitly transfer
values from one context to another. The <code>:=</code> operator is used in XL to represent
assignments.  For example, the following code implements the core computation of
a <a href="https://en.wikipedia.org/wiki/Julia_set">Julia set</a>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>JuliaDepth(Z:complex, Mu:complex, Bound:real, Max:count) as count is
    while result &lt; Max and Z.Re^2 + Z.Im^2 &lt; Bound ^2 loop
        result := result + 1
        Z := Z^2 - Mu</pre>
</div>
</div>
<div class="paragraph">
<p>The example code above contains two assignments, one to <code>result</code>, the
<a href="#implicit-result-variable">implicit variable</a> holding the return
value, and one to <code>Z</code>. The assignment <code>result := result + 1</code> updates
the variable <code>result</code> with the next <code>count</code> value. This kind of
assignment combined with a simple operation is so frequent that there
are <a href="#computing-assignment">shortcut notations</a> for it, and you
can write <code>result += 1</code> to achieve the same effect.</p>
</div>
<div class="paragraph">
<p>An assignment is a shortcut for either a <a href="#copy">copy</a> of the
value, which is the case in the code above, or a <a href="#move">move</a> when
a copy would be unreasonably expensive.</p>
</div>
<div class="paragraph">
<p>In general, using the <code>:=</code> assignment operator is the safe choice, since it will
automatically select the most efficient operation for you based on the type.
However, in order to give programmers additional control, XL offers two
additional operators, the <code>:+</code> <em>copy</em> operator and the <code>:&lt;</code> <em>move</em> operator,
which is also sometimes <em>cut</em> operator because of its shape that evokes
scissors. The <code>:+</code> operator guarantees that all data is being copied, and that
the new object is an independent copy of the original (hence the <code>+</code> character
in it). The <code>:&lt;</code> operator guarantees that the value is moved and
<a href="#destruction">destroys</a> the right side of the operator, which may no longer
be used.</p>
</div>
<div class="paragraph">
<p>When you create a new type, you get to choose if the assignment
operator for that type performs a copy or a move. For example,
for <code>complex</code> we may want a copy, and for <code>picture</code> we may want a move
because there is a lot of data. This would be implemented as follows</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Target:out complex := Source:complex    is Target :+ Source     // Copy
Target:out picture := Source:picture    is Target :&lt; Source     // Move</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>RATIONALE</strong> For simple types such as arithmetic types, an assignment
performs a copy, which is a relatively inexpensive memory copy between
fixed-size locations. For more complicated data types, such as
<code>spreadsheet</code>, <code>graph</code> or <code>picture</code>, a copy involves copying possibly
megabytes of data, or complex webs of interconnected objects, which can
be very expensive, and often leaves an unused copy behind. For such data
types, moving data is the frequently desirable operations, for example
to pass objects around as arguments, and copying data is the less
frequent case. In any case, the programmer remains in charge, always
having the possibility to explicitly request a copy or a move.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assignments return their destination as an <a href="#ignorable-type">ignorable type</a>,
which means that an assignment can be used either as a statement or in an
expression.</p>
</div>
</div>
<div class="sect3">
<h4 id="copy"><a class="anchor" href="#copy"></a><a class="link" href="#copy">4.11.2. Copy</a></h4>
<div class="paragraph">
<p>A <em>copy</em> is a kind of transfer which creates a new, "identical",
yet completely independent value. The new value can then be modified
without impacting the original, and it may have a completely different
lifetime.</p>
</div>
<div class="paragraph">
<p>The copy operation has the following mandatory interface for any type <code>T</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Target:out[T] :+ Source:in[T] as ignorable[T]?</pre>
</div>
</div>
<div class="paragraph">
<p>The copy returns the <code>Target</code> after it has been copied into, or an
<code>error</code> value if there was some failure. When it returns a failure,
any value that may have been created as part of the copy must
have been <a href="#destruction">deleted</a> by the copy operation.</p>
</div>
<div class="paragraph">
<p>The returned value is marked as <code>ignorable</code> in order to ensure that a copy, like
an assignment, can be used in statements as well as expressions.</p>
</div>
<div class="paragraph">
<p>The new copied value is <a href="#creation">created</a> by the operator, and
should be identical in its behavior to the source. It needs not be
identical in its internal representation. For example, if you copy a
<code>picture</code> type, the content of the <code>pixels</code> buffer, i.e. the values
that it contains, should be identical to the original, but the binary
representation for the <code>pixels</code> field itself will be different, since
it will refer to a new buffer in memory.</p>
</div>
<div class="paragraph">
<p>Some types may have a complex hierarchical structure, with several
layers of values referencing one another. For example, a <code>tree</code>
structure may have some arbitrarily nested branches. In such a case,
the copy operator should perform what is known as a <em>deep copy</em>,
in other words make sure that the new value has ownership of all the
elements it refers to, independently from the source value.</p>
</div>
<div class="paragraph">
<p>The <code>copy</code> function returns a copy for all types, and is defined as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>copy Source is result :+ Source</pre>
</div>
</div>
<div class="paragraph">
<p>There may be variants of <code>copy</code> for some types that limit the amount of copy
happening. For example, for a recursive structure, you could limit the depth of
the copy:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>copy(Source:hierarchy, Depth:natural) as hierarchy</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="move"><a class="anchor" href="#move"></a><a class="link" href="#move">4.11.3. Move</a></h4>
<div class="paragraph">
<p>A <em>move</em> is a kind of destructive transfer which gives a value to
a new location, and <a href="#destruction">destroys</a> the original value.
The intent is that a move is generally cheaper to perform than a copy.
XL uses the prefix <code>move</code> function or the infix <code>Target :&lt; Source</code> as
a notation for the move, where the <code>:&lt;</code> is designed to look like a
scissor and is pronounced as <em>cuts</em>.</p>
</div>
<div class="paragraph">
<p>The performance benefit of using a move rather than a copy can be
significant. For example, even for a complex, deep data structure, a
move may involve simply copying a pointer to some new location and
making sure that the original pointer is no longer used, whereas a
copy may require a number of memory allocations and memory copies.
The downside, obviously, is that the source of the move may no longer
be used after the move.</p>
</div>
<div class="paragraph">
<p>The move operation has the following mandatory interface for all types:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Target:out[T] :&lt; Source:in out[T] as ignorable T?</pre>
</div>
</div>
<div class="paragraph">
<p>The move returns the <code>Target</code> after it has been moved into, or an
<code>error</code> value if there was some failure. When there is a failure,
the move should essentially have had no effect, i.e. it should not
cause partially moved, partially created or partially destroyed values.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The use of a move in an expression is generally less useful than the use
of a copy, since the source is destroyed by the move. For example, while
possible, it makes little sense to write <code>X :&lt; Y :&lt; Z</code> because the value in Y
would be destroyed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The new moved value is <a href="#creation">created</a> by the operator, and
should be identical in its behavior to the source. Like for copy, it
needs not be identical in its internal representation. For example, if
you move a value with internal pointers, the move operation may need to adjust
the internal pointers. Such cases should be infrequent, and are undesirable
since the main reason for <code>move</code> to exist is performance.</p>
</div>
<div class="paragraph">
<p>The source of a move may no longer be used after a move operation, and
should be in the same state as right after a <code>delete</code> operation. The
compiler should normally issue a diagnostic when an attempt is made to
use a value that was moved or deleted.</p>
</div>
<div class="paragraph">
<p>The <code>move</code> function moves the value into the result:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>move Source is result :&lt; Source</pre>
</div>
</div>
<div class="paragraph">
<p>Like <code>copy</code>, variants of the <code>move</code> function can take additional parameters.
For example, some objects may contain internal caches that consume resources
such as memory. Such caches would not exist if you created a new object from
scratch. So in a <code>move</code> operation, it may be useful to have a choice top
preserve cached data or not.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>move(Source:database, Caches:one_of(ClearCaches,PreserveCaches) as database</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="computing-assignment"><a class="anchor" href="#computing-assignment"></a><a class="link" href="#computing-assignment">4.11.4. Computing assignment</a></h4>
<div class="paragraph">
<p>Seven combined operators are defined independently of the type as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">Target += Source      is      Target := Target + Source
Target -= Source      is      Target := Target - Source
Target *= Source      is      Target := Target * Source
Target /= Source      is      Target := Target / Source
Target &amp;= Source      is      Target := Target &amp; Source
Target |= Source      is      Target := Target | Source
Target ^= Source      is      Target := Target ^ Source</code></pre>
</div>
</div>
<div class="paragraph">
<p>These variants are equivalent to performing the corresponding operation and
assigning to the result.</p>
</div>
</div>
<div class="sect3">
<h4 id="binding"><a class="anchor" href="#binding"></a><a class="link" href="#binding">4.11.5. Binding</a></h4>
<div class="paragraph">
<p>The transfer of an argument to a formal parameter during a call is
called a <em>binding</em>, and like an assignment, it may involve either
copying or moving the value. Argument binding uses the assignment
operator to assign the argument to the formal paramerer, ensuring that
the same copy or move semantics applies to assignment and to binding.</p>
</div>
<div class="paragraph">
<p>However, the precise transfer operations associated to binding
may be modified depending on the direction of the transfer between the
caller and the callee. This is achieved by using
<em>argument-passing types</em> with an assignment
designed to optimize the passing of arguents.</p>
</div>
<div class="paragraph">
<p>The following types are provided to indicate this direction and optimize
argument passing accordingly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>in T</code> indicates that the corresponding value is passed from the
caller to the callee. An <code>in T</code> value is read-only in the callee,
since it is possible that it may be passed by reference. In other
words, <code>in T</code> derives from <code>constant T</code>. A parameter with the <code>in</code>
type modifier is called an <em>input parameter</em> and the
corresponding argument is called an <em>input argument</em>. The
<a href="#lifetime">lifetime</a> of an input argument must be larger than
that of the call, and ownership remains in the caller.
An input parameter is typically either copied on entry, or passed by
reference.</p>
</li>
<li>
<p><code>out T</code> indicates that the corresponding value is passed from the
callee to the caller. In that case, the value is created in the
callee, and moved to the caller on exit, destroying the previous
value that may have existed for that argument in the caller.
An <code>out T</code> inherits from <code>T</code>. A parameter with the <code>out</code> type
modifier is called an <em>output parameter</em> and the corresponding
argument is called an <em>output argument</em>.
An output parameter is typically either moved on exit, or passed by reference.</p>
</li>
<li>
<p><code>in out T</code> indicates that the corresponding value is tranferred to the
callee for the duration of the call, and then transferred back to the caller.
Its lifetime is interrupted in the caller for the duration of the call,
and ownership is temporarily transferred to the callee.  The <code>in out
T</code> type also inherits from <code>T</code>. A parameter with the <code>in out</code>
modifier is called a <em>bidirectional parameter</em> and the
corresponding argument is called a <em>bidirectional argument</em>.
An input/output parameter is typically either moved on entry and exit, or
passed by reference.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the type of a parameter is specified, but without <code>in</code>, <code>out</code> or <code>in out</code>,
then the parameter is treated like an input parameter. If no type is given, then
the type is treated like an by-reference input/output parameter:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// Here, Times is `in integer` and Body is passed by reference
repeat(Times:integer, Body) as integer is
    for I in 1..Times loop
        Body</pre>
</div>
</div>
<div class="paragraph">
<p>The argument-passing types are intended to provide access to a value of type <code>T</code>
within the caller in a way that is possibly less expensive than directly using
the assignment for <code>T</code>. Common optimization strategies include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Passing a pointer to large values rather than copying them, a
technique often called passing the value <em>by reference</em>.</p>
</li>
<li>
<p>Copying or moving the value only in the required direction.</p>
</li>
<li>
<p>Passing a smart reference that precisely tracks ownership.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An interesting example that illustrates the use of these type
modifiers is the <code>text</code> type. This is an example of owning type, since
it owns the <code>character</code> values in it. Since there is a possibly large
number of characters, it may be quite expensive to copy.</p>
</div>
<div class="paragraph">
<p>It would be inconvenient to have pure move semantics for <code>text</code>, since
it would mean that an assignment would destroy the source value.
Consider the following code to see how this would be uncomfortable:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>window_name  : text := "Untitled"
if file_name &lt;&gt; "" then
    window_name := file_name
path_is_absolute : boolean := file_name.begins_with("/")</pre>
</div>
</div>
<div class="paragraph">
<p>Under a pure move semantics, in the above code, the second use of
<code>file_name</code> to compute <code>path_is_absolute</code> would be incorrect, since
the value in <code>file_name</code> might have been moved to <code>window_name</code> in
just the previous line. That would make using <code>text</code> quite complicated.
Indeed, Rust developers have to pay attention to this kind of
considerations with many types such as <code>vector</code>.</p>
</div>
<div class="paragraph">
<p>Instead, assignment for <code>text</code>, and therefore passing <code>text</code> values as
an argument, performs a copy of the <code>text</code> value. The binding
modifiers for <code>text</code>, however, use not <code>text</code> but <code>slice of text</code>, an
<a href="#access-types">access type</a> that is cheap to copy around, and that
references the original text. This organization provides the
convenience of copy semantics for local variables and the speed of
move semantics for calls.</p>
</div>
<div class="paragraph">
<p>Argument-passing types can be used in other contexts than arguments.
For example, code that creates a closure or a callback may store
argument-passing types in an intermediate structure in order to pass it to the
closure or callback.</p>
</div>
</div>
<div class="sect3">
<h4 id="name-parameters"><a class="anchor" href="#name-parameters"></a><a class="link" href="#name-parameters">4.11.6. Name parameters</a></h4>
<div class="paragraph">
<p>In some cases, it is interesting for a form to create new variables
based on a name given as an argument. The corresponding parameter is
called a <em>name parameter</em>. An archetypcal example for this
is the <code>for</code> loop.</p>
</div>
<div class="paragraph">
<p>Consider the following simple example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>for I in 1..5 loop
    print "I=", I</pre>
</div>
</div>
<div class="paragraph">
<p>The variable <code>I</code> in this example does not exist outside of the <code>for</code>
loop. This is accomplished by taking a <code>name</code> as a parameter.
The <a href="#metabox">metabox</a> notation can then be used to refer to the
actual name.</p>
</div>
<div class="paragraph">
<p>For example, a <code>for</code> loop on a range of discrete values can be written
as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>for N:name in R:[range of discrete] loop Body is <i class="conum" data-value="1"></i><b>(1)</b>
    loop_context is <i class="conum" data-value="2"></i><b>(2)</b>
        [[N]] : R.type := R.first <i class="conum" data-value="3"></i><b>(3)</b>
    LoopVar is loop_context.[[N]] <i class="conum" data-value="4"></i><b>(4)</b>
    while LoopVar &lt;= R.last loop
        (loop_context) (Body) <i class="conum" data-value="5"></i><b>(5)</b>
        ++LoopVar <i class="conum" data-value="6"></i><b>(6)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>N</code> is declared as a <code>name</code>. This type is defined in <code>XL.PARSER</code>.
The programmer can control what kind of input is acceptable to a
new programming construct like the <code>for</code> loop defined here. The
fact that the XL type system is based on the shape of parse trees
gives a powerful way to achieve that objective.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We need to create a <code>loop_context</code> scope that holds the variable
 created from the input argument to make sure that it does not pollute
the current context of the function. For example, if the argument for
<code>N</code> was <code>R</code>, we would not want to hide the <code>R</code> formal parameter with a
local definition that has the same name.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="#metabox">metabox</a> evaluates <code>N</code>, which gives us access to
the name referenced by <code>N</code>. In the declaration, simply writing <code>N</code>
would create a local variable named <code>N</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>LoopVar</code> declaration is a shortcut to facilitate access to
<code><a id="N"></a></code> within <code>loop_context</code>. The reference to <code>N</code> also needs to
go through a metabox in order to lookup what <code>N</code> contains, and not
the variable <code>N</code> within <code>loop_context</code>, does not exist except in
cases where parameter <code>N</code> receives name <code>N</code> as an argument.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The parentheses are not strictly necessary, but a good reminder
that what we are doing here is evaluate <code>Body</code> after
<a href="#scoping">injecting</a> the <code>loop_context</code> context. This is what
makes the variable name referenced by <code><a id="N"></a></code> visible in
<code>Body</code>. This approach lets the programmer precisely control what
is being injected while evaluating <code>Body</code>. In particular, all the
local variables in the implementation of the <code>for</code> loop, like <code>N</code>,
<code>R</code>, <code>Body</code>, <code>LoopVar</code> or <code>loop_context</code> are not visible while
evaluating <code>Body</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>++LoopVar</code> notation is a generic way to increment any
<code>discrete</code> value. In that case, <code>LoopVar += 1</code> would not work if
<code>R</code> was for example a <code>range of character</code> like <code>'A'..'Z'</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="attributes"><a class="anchor" href="#attributes"></a><a class="link" href="#attributes">4.11.7. Attributes</a></h4>
<div class="paragraph">
<p>Attributes are a types that behave like a value of a given type, but
with controlled access when reading or writing values. Attributes also
offer the convention that they can be written to by using them as a
prefix.</p>
</div>
<div class="paragraph">
<p>For example, a <code>background</code> feature with the <code>color</code> type can be
implemented as an attribute, which can then be used in any of the
following ways:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>background : attribute[color]
if background = blue then
    background := red           // Assigment style
if background = green then
    background blue             // Attribute style</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is considered bad taste in XL to use explicitly getters or setters
as is common usage in languages such as Java. For example, the
following code is a very poor alternative to attributes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>get_background as color
set_background C:color as color
if get_background = blue then
   set_background red</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="programming-paradigms"><a class="anchor" href="#programming-paradigms"></a><a class="link" href="#programming-paradigms">5. Programming paradigms</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The XL language features make it quite easy to follow and even enforce
the rules necessary to apply various common and less common
<em>programming paradigms</em>.</p>
</div>
<div class="paragraph">
<p>In the following sections, we will consider the following major paradigms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#object-oriented-programming">Object-oriented programming</a></p>
</li>
<li>
<p><a href="#functional-programming">Functional programming</a></p>
</li>
<li>
<p><a href="#generic-programming">Generic programming</a></p>
</li>
<li>
<p><a href="#design-by-contract">Design by contract</a></p>
</li>
<li>
<p><a href="#distributed-programming">Distributed programming</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will also take a look at a few less common, if highly esteemed,
programming paradigms, which all carved a niche through
somewhat special-purpose programming languages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#aspect-oriented-programming">Aspect-oriented programming</a></p>
</li>
<li>
<p><a href="#logic-programming">Logic programming</a></p>
</li>
<li>
<p><a href="#declarative-programming">Declarative programming</a></p>
</li>
<li>
<p><a href="#reactive-programming">Reactive programming</a></p>
</li>
<li>
<p><a href="#synchronous-programming">Synchronous programming</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The fact that XL seamlessly supports so many different programming
paradigms <em>together</em> is a testimony to the extensible nature of the
language.</p>
</div>
<div class="sect2">
<h3 id="object-oriented-programming"><a class="anchor" href="#object-oriented-programming"></a><a class="link" href="#object-oriented-programming">5.1. Object-oriented programming</a></h3>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Object-oriented_programming">Object-oriented programming</a>
is a programming paradigm based on the concept of <em>objects</em>,
which are self-contained units acting as black boxes, providing a
controlled interface to their internal <em>data</em> through
<em>methods</em>. This provides a form of <em>information hiding</em> that
helps with the long-term maintenance of the software by enforcing
rules about how to access the object.
Object-oriented programming relies on a number of features such as
<a href="https://en.wikipedia.org/wiki/Encapsulation_(computer_programming)"><em>encapsulation</em></a>
<a href="https://en.wikipedia.org/wiki/Dynamic_dispatch"><em>dynamic dispatch</em></a>,
(sometimes called <em>message passing</em>),
<a href="https://en.wikipedia.org/wiki/Inheritance_(object-oriented_programming)"><em>inheritance</em></a>,
and <a href="https://en.wikipedia.org/wiki/Polymorphism_(computer_science)"><em>polymorphism</em></a>.</p>
</div>
<div class="paragraph">
<p>A common way to introduce object-oriented programming is with a
program that deals with various shapes. This is a good way to
illustrate the use of the fundamental object-oriented techniques. In
the following example, we will write such a program, which will both
illustrate the similarities of XL with a language like C++, as well as
the differences and how they can matter even on such a simple example.</p>
</div>
<div class="sect3">
<h4 id="type-interface-2"><a class="anchor" href="#type-interface-2"></a><a class="link" href="#type-interface-2">5.1.1. Type interface</a></h4>
<div class="paragraph">
<p>The first part of the program is to define the interface for the type
<code>shape</code>, which will act as the
<a href="https://en.wikipedia.org/wiki/Inheritance_(object-oriented_programming)"><em>base class</em></a>
of our class hierarchy, and for the derived types that we will use in
our code. We will assume that we have an existing <code>coordinate</code> type
for shape coordinates, <code>dimension</code> for shape dimensions, and <code>color</code> for
shape colors.</p>
</div>
<div class="paragraph">
<p>A first attempt at building a type interface for <code>shape</code> and a couple
of derived types using the syntax for types we already saw would be:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// Base class
type shape with
    draw         as ok                          // Draw the shape
    fill_color   as attribute color             // Color of the fill
    stroke_color as attribute color             // Color of the stroke
    stroke_width as attribute dimension         // Width of the stroke
    top          as attribute coordinate        // Top coordinate
    left         as attribute coordinate        // Left coordinate
    bottom       as attribute coordinate        // Bottom coordinate
    right        as attribute coordinate        // Right coordinate
    x            as attribute coordinate        // Center horizontal coordinate
    y            as attribute coordinate        // Center vertical coordinate
    width        as attribute dimension         // Width of the shape
    height       as attribute dimension         // Height of the shape

// A few derived classes
rectangle as some shape

square as some rectangle with
    side        as attribute dimension

ellipse as some shape

circle as some shape with
    radius      as attribute dimension
    diameter    as attribute dimension</pre>
</div>
</div>
<div class="paragraph">
<p>This style of code is called a <em>type interface</em>. It already shows
interesting properties that XL brings to the table. From the
interface, we see that we have multiple ways to access the same data,
namely the dimensions and position of the shape, which are obviously
related. The width of the shape is related to the left and right
coordinates, for example. However, the interface does not tell us how
the implementation choses to store the data. This provides stronger
information hiding than languages like C&#43;&#43;, where some
"private" data fields for the class would probably be exposed.</p>
</div>
<div class="paragraph">
<p>This means that client code can access all these features in a very
consistent and flexible manner, without bothering about how the data
is stored internally:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>S : shape
S.top := 42                     // Assignment form
S.bottom 640                    // Attribute setting form
if S.height &lt;&gt; 598 then         // Reading the value
    logic_error "Somethign is wrong with your implementation, height is %1", S.height</pre>
</div>
</div>
<div class="paragraph">
<p>As part of information hiding, the interface also purposefully does
not expose how <code>draw</code> is actually implemented. The <code>draw</code> method,
obviously, needs a different implementation for a <code>rectangle</code> and a
<code>circle</code>, but the interface does not expose that information, only the
fact that there is a <code>draw</code> method in <code>shape</code> and all derived types.</p>
</div>
</div>
<div class="sect3">
<h4 id="class-interface"><a class="anchor" href="#class-interface"></a><a class="link" href="#class-interface">5.1.2. Class interface</a></h4>
<div class="paragraph">
<p>However, our first interface remains somewhat verbose and cumbersome to
write. In order to support object-oriented programming better, there
is a <code>class</code> declaration helper that will generate the above code based on the
following input, transforming all fields into attributes and keeping
methods as is. This coding style is called a <em>class interface</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class shape with
    draw        as ok
    fill_color   : color
    stroke_color : color
    stroke_width : dimension
    top          : coordinate
    left         : coordinate
    bottom       : coordinate
    right        : coordinate
    x            : coordinate
    y            : coordinate
    width        : dimension
    height       : dimension

class rectangle like shape

class square like rectangle with
    side         : dimension

class ellipse like shape

class circle like shape with
    radius       : dimension
    diameter     : dimension</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="class-implementation"><a class="anchor" href="#class-implementation"></a><a class="link" href="#class-implementation">5.1.3. Class implementation</a></h4>
<div class="paragraph">
<p>In XL, the implementation of a type can be
<a href="#direct-implementation">directly related</a> to the interface, but
every field may also be implemented
<a href="#indirect-implementation">indirectly</a> using
<a href="#attributes">attributes</a>.</p>
</div>
<div class="paragraph">
<p>For the shape class, let&#8217;s make the choice that we will store the
center of the shape, its width and its height, and compute the
rest. We need a convention on what happens when we set <code>top</code>, for
example. A convention will be that it moves the whole shape without
changing its size, but we could also decide to not move the bottom for
example. We will also assume that <code>y</code> increases towards the top.
This particular choice leads to a class implementation that looks like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class shape is
    draw is logic_error "Drawing a base shape"
    fill_color   : color
    stroke_color : color
    stroke_width : dimension
    x            : coordinate
    y            : coordinate
    width        : dimension
    height       : dimension

    left as attribute coordinate is
        get     is x - width / 2
        set L   is x += L - left
    right as attribute coordinate is
        get     is x + width / 2
        set R   is x += R - right
    top as attribute coordinate is
        get     is y + height / 2
        set T   is y += T - top
    bottom as attribute coordinate is
        get     is y - height / 2
        set B   is y += B - bottom</pre>
</div>
</div>
<div class="paragraph">
<p>This kind implementations demonstrates how much freedom there is in
implementing a class interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="direct-derivation"><a class="anchor" href="#direct-derivation"></a><a class="link" href="#direct-derivation">5.1.4. Direct derivation</a></h4>
<div class="paragraph">
<p>A derived class like <code>rectangle</code> can leverage the base class using
<a href="#data-inheritance">data inheritance</a>, and then add a <code>draw</code>
method. This kind of derivation is called <em>direct derivation</em>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class rectangle is shape with
    draw is
        draw_polygon fill_color, stroke_color, stroke_width,
            move_to top, left
            line_to top, right
            line_to bottom, right
            line_to bottom, left
            line_to top, left</pre>
</div>
</div>
<div class="paragraph">
<p>Since the purpose of this document is not to focus on shape drawing
algorithms, but on object-oriented programming, we simply assumed that
there is some general <code>draw_polygon</code> utility that we can use.</p>
</div>
<div class="paragraph">
<p>Unlike languages like C&#43;&#43;, XL does not require the
interface of a derived class like <code>rectangle</code> to indicate that it will
override the <code>draw</code> feature from the base class.</p>
</div>
</div>
<div class="sect3">
<h4 id="indirect-derivation"><a class="anchor" href="#indirect-derivation"></a><a class="link" href="#indirect-derivation">5.1.5. Indirect derivation</a></h4>
<div class="paragraph">
<p>Implementing the <code>square</code> type allows us to demonstrate an interesting
possibility of XL that does not exist in C++, which is to make a
derived class that does not inherit its data members from its base
class. A square does not need a separate width and height, so we could
make the data storage requirements for a <code>square</code> smaller by only
having it store a single <code>side</code> data value. The implementation of <code>square</code> can
however still inherit a lot of the implementation from <code>rectangle</code>,
but needs to rewrite <code>width</code> and <code>height</code> as attributes related to <code>side</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class square is
    draw is rectangle.draw
    fill_color   : color
    stroke_color : color
    stroke_width : dimension
    x            : coordinate
    y            : coordinate
    side         : dimension

    width as attribute dimension is
        get     is side
        set W   is side := W
    height as attribute dimension is
        get     is side
        set H   is side := H

    left        is rectangle.left
    right       is rectangle.right
    top         is rectangle.top
    bottom      is rectangle.left</pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, the savings in the case of something as simple as a
<code>square</code> are quite limited. There are cases where this approach may
lead to much more significant improvements.</p>
</div>
<div class="paragraph">
<p>More importantly, this approach makes it possible to enforce stricter
rules for the derived types. In particular, this implementation of
<code>square</code> makes it absolutely impossible to end up with a <code>square</code> that
has a different value for <code>width</code> and <code>height</code>, even by mistake.</p>
</div>
<div class="paragraph">
<p>This is not a purely theoretical concern. In C&#43;&#43;, if the base
<code>Rectangle</code> class has different fields for <code>width</code> and <code>height</code>, the
derived <code>Square</code> class might initially enforce the rules, and be later
broken for example when the base <code>Shape</code> class adds a <code>scale</code> method
that scales width and height differently. Unless the <code>Square</code> class
itself is modified to implement its own version of <code>scale</code>, it will be
broken by a change in the base class. This category of issue is known
as the <a href="https://en.wikipedia.org/wiki/Fragile_base_class">fragile base class</a>
problem.</p>
</div>
<div class="paragraph">
<p>We can also take advantage of this feature to have a different
hierarchy for data inheritance than for the interface. For example, we
can implement the <code>ellipse</code> and <code>circle</code> classes as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class ellipse is rectangle with
    draw is
        draw_ellipse fill_color, stroke_color, stroke_width, x, y, width, height

class circle is square with
    draw is ellipse.draw</pre>
</div>
</div>
<div class="paragraph">
<p>This flexibility gives the maximum potential for code reuse.</p>
</div>
</div>
<div class="sect3">
<h4 id="dynamic-dispatch-2"><a class="anchor" href="#dynamic-dispatch-2"></a><a class="link" href="#dynamic-dispatch-2">5.1.6. Dynamic dispatch</a></h4>
<div class="paragraph">
<p>If we want to add a <code>group</code> shape, we need to be able to draw each
shape individually, according to its class.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class group like shape with
    children : string of shape</pre>
</div>
</div>
<div class="paragraph">
<p>There is a problem with this interface, however. Each time you add a
<code>shape</code> to <code>children</code>, you really add a value that has the <code>shape</code>
type, not the <code>rectangle</code> or <code>circle</code> type. In order to preserve the
original type information, we need to use the <code>any shape</code> notation.
The correct class interface for <code>group</code> is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class group like shape with
    children : string of any shape</pre>
</div>
</div>
<div class="paragraph">
<p>The implementation can then invoke <code>draw</code> for each shape in
<code>children</code>, and since <code>any shape</code> retains the type of the associated
shape, this will call the appropriate <code>draw</code> feature for each of the
individual shapes. This technique is called <em>dynamic dispatch</em>.</p>
</div>
<div class="paragraph">
<p>The implementation of class <code>group</code> does not need the <code>shape</code> fields,
since it can compute features from the shapes in <code>children</code>. The
example below only shows the case of <code>draw</code>, <code>fill_color</code>, <code>top</code> and
<code>width</code>, but other features can be implemented in a similar way. The
<code>fill_color</code> attribute uses a local variable to hold the color value
for the whole group. These three examples show the respective benefits
of the various ways to set an attribute.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>class group is
    // Draw a group by drawing all shapes in it
    draw is
        for S in children loop
            S.draw

    // The fill color is the last one set for the group
    fill_color as attribute color is
        value : color := black
        get   is value
        set C is
            value := C
            for S in children loop
                S.fill_color C

    // The top is the maximum of the top of all shapes
    top as attribute coordinate is
        get is
            result := coordinate.min
            for S in children loop
                if result &lt; S.top then
                   result := S.top
        set T is
            delta is T - top
            for S in children loop
                S.top += delta

    // The width is still right - left, and adjusted by scaling
    width as attribute coordinate is
        get   is right - left
        set W is
            old is width
            for S in children loop
                S.width := S.width * W / old</pre>
</div>
</div>
<div class="paragraph">
<p>In this code, all references to <code>S</code> have the type <code>any shape</code>, and
therefore, <code>S.width</code> or <code>S.draw</code> will be dynamically dispatched. This
plays the role to <em>virtual functions</em> in C&#43;&#43;.</p>
</div>
</div>
<div class="sect3">
<h4 id="multiple-dispatch"><a class="anchor" href="#multiple-dispatch"></a><a class="link" href="#multiple-dispatch">5.1.7. Multiple dispatch</a></h4>
<div class="paragraph">
<p>An operation like <code>draw</code> really depends on a single <code>shape</code> value.
Many operations, however, require more than one value to operate. A
simple example would be an operation to intersect two shapes, which we
could write as <code>S1 and S2</code>, or merge two shapes, which we could write
as <code>A or B</code>. There are various special cases, followed by a more
general case:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>A:rectangle and B:rectangle as rectangle
A:ellipse   and B:ellipse   as ellipse or path
A:rectangle and B:ellipse   as rectangle or ellipse or path
A:ellipse   and B:rectangle as rectangle or ellipse or path
A:group     and B:group     as group
A:any shape and B:any shape as any shape</pre>
</div>
</div>
<div class="paragraph">
<p>The implementation for groups, for example, could look someting like
the following code, which intersects all pairs of shapes and adds the
result when it is not empty:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>A:group and B:group as group is
    for SA in A.children loop
        for SB in B.children loop
            child is SA and SB
            if child.width &gt; 0 and child.height &gt; 0 then
                result.children &amp;= child</pre>
</div>
</div>
<div class="paragraph">
<p>The operation that computes <code>child</code> in the code above is <code>SA and
SB</code>. Since both <code>SA</code> and <code>SB</code> are dynamically typed, that operation
must perform a dynamic dispatch on both <code>SA</code> and <code>SB</code>. A feature like
tihs is sometimes called <em>multiple dispatch</em> or
<em>multi-methods</em> in <a href="https://en.wikipedia.org/wiki/Multiple_dispatch">other languages</a>.
For example, if both shapes have the <code>rectangle</code> type, then the first
declaration would be called; if both shapes have the <code>ellipse</code> type,
then the second one would be invoked; and so on.</p>
</div>
<div class="paragraph">
<p>With code like this, it is possible to write a function that performs
clipping within a rectangle, where dynamic dispatch will occur only
for the second argument, and where the returned value will itself be
dynamically typed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>clip(Bounds:rectangle, Shape:any shape) as any shape is
    result := Bounds and Shape</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="functional-programming"><a class="anchor" href="#functional-programming"></a><a class="link" href="#functional-programming">5.2. Functional programming</a></h3>
<div class="paragraph">
<p>This section will soon cover techniques that are familiar to
programmers using languages derived from Lisp and similar languages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Functions as first-order values</p>
</li>
<li>
<p>Anonymous functions, already quickly <a href="#lambda_function">covered earlier</a></p>
</li>
<li>
<p>Currying</p>
</li>
<li>
<p>Purely-functional code</p>
</li>
<li>
<p>Immutable values</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="generic-programming"><a class="anchor" href="#generic-programming"></a><a class="link" href="#generic-programming">5.3. Generic programming</a></h3>
<div class="paragraph">
<p>This section will soon cover techniques that are familar primarily to
C&#43;&#43; programmers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generic containers</p>
</li>
<li>
<p>Generic algorithms</p>
</li>
<li>
<p>Traits</p>
</li>
<li>
<p>Concepts</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="design-by-contract"><a class="anchor" href="#design-by-contract"></a><a class="link" href="#design-by-contract">5.4. Design by contract</a></h3>
<div class="paragraph">
<p>This section will soon cover techniques that are familiar primarily to
Eiffel developers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Invariants</p>
</li>
<li>
<p>Preconditions</p>
</li>
<li>
<p>Postconditions</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="distributed-programming"><a class="anchor" href="#distributed-programming"></a><a class="link" href="#distributed-programming">5.5. Distributed programming</a></h3>
<div class="paragraph">
<p>This section will cover techniques used for distributed programming,
that come from a variety of sources, and includes some innovations
that I believe are specific to the XL family of languages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Processes</p>
</li>
<li>
<p>Threads</p>
</li>
<li>
<p>Tasks</p>
</li>
<li>
<p>Thread pools</p>
</li>
<li>
<p>Erlang-style message passing</p>
</li>
<li>
<p>Ada-style rendez-vous</p>
</li>
<li>
<p>ELFE-style distributed programs</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="aspect-oriented-programming"><a class="anchor" href="#aspect-oriented-programming"></a><a class="link" href="#aspect-oriented-programming">5.6. Aspect-oriented programming</a></h3>
<div class="paragraph">
<p>This section will cover techniques to address cross-cutting concerns
that were studied in languages such as AspectJ, as well as other
aspects that were explored in XL2:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AspectJ-style code injection</p>
</li>
<li>
<p>Automated trace / logging injection</p>
</li>
<li>
<p>Translation statemnts in XL2</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="logic-programming"><a class="anchor" href="#logic-programming"></a><a class="link" href="#logic-programming">5.7. Logic programming</a></h3>
<div class="paragraph">
<p>This section will cover techniques developed in particular by the
Prolog programming language.</p>
</div>
</div>
<div class="sect2">
<h3 id="declarative-programming"><a class="anchor" href="#declarative-programming"></a><a class="link" href="#declarative-programming">5.8. Declarative programming</a></h3>
<div class="paragraph">
<p>This section will cover techniques that make programs look or behave more
declarative in a declarative than imperative way. It will in
particular cover more extensively some declarative aspects of Tao3D,
and how to use XL as a document description language.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Non-imperative evaluation</p>
</li>
<li>
<p>Documentation generation</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="reactive-programming"><a class="anchor" href="#reactive-programming"></a><a class="link" href="#reactive-programming">5.9. Reactive programming</a></h3>
<div class="paragraph">
<p>This section will cover techniques that were in particular developed
for Tao3D:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Partial re-evaluation</p>
</li>
<li>
<p>Value dependency tracking</p>
</li>
<li>
<p>Data flow programming</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="synchronous-programming"><a class="anchor" href="#synchronous-programming"></a><a class="link" href="#synchronous-programming">5.10. Synchronous programming</a></h3>
<div class="paragraph">
<p>This section will cover concepts and techniques that were particular
notably by the Esterel family of languages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Signals</p>
</li>
<li>
<p>Model of time</p>
</li>
<li>
<p>Determinism</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compiling-xl"><a class="anchor" href="#compiling-xl"></a><a class="link" href="#compiling-xl">6. Compiling XL</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The XL language is quite different from a language like C. Some of the
language constructs described in this document may seem a little bit
mysterious to programmers coming from such languages. This section
will explain how some of the features described previously can be
implemented, by showing examples using C code.</p>
</div>
<div class="paragraph">
<p>In the C code, the notation <code>`expr`</code> will denote a magical macro
creating a unique name attributed to the XL expression <code>expr</code>, and
<code>&#8230;&#8203;</code> will indicate that what is presented is only a partial
representation, with the expectation that whas surrounds <code>&#8230;&#8203;</code> allows
the reader to infer what can be there.</p>
</div>
<div class="paragraph">
<p>In addition, the example code will borrow two features from C&#43;&#43;,
inheritance and overloading, so that we may write something like the
following in the examples:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>struct Derived : Base { ... };
void foo(int);
void foo(double);</pre>
</div>
</div>
<div class="sect2">
<h3 id="normal-representation"><a class="anchor" href="#normal-representation"></a><a class="link" href="#normal-representation">6.1. Normal representation</a></h3>
<div class="paragraph">
<p>All XL source code and data can be represented using a homoiconic
representation that looks something like the following code, where <code>P</code>
is a shortcut for <code>XL.PARSER</code>.</p>
</div>
<div class="paragraph">
<p>First, there is a tag that can be used at run-time to discriminate
between the possible values, and a struct that holds the common
fields, notably a <code>position</code> field that can be used to identify a
precise source code position while printing error messages:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>enum kind { NATURAL, REAL, CHARACTER, ... };
struct `P.tree`                       { enum kind kind; position_t position; ... };</pre>
</div>
</div>
<div class="paragraph">
<p>The leaf nodes simply contain one of the basic values types that can be
found in the source code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>struct `P.natural`    : `P.tree`    { `natural` value; };
struct `P.real`       : `P.tree`    { `real` value; }
struct `P.character`  : `P.tree`    { `character` value; };
struct `P.text`       : `P.tree`    { `text` value; }
struct `P.bits`       : `P.tree`    { size_t size; void *data; }
struct `P.symbol`     : `P.tree`    { `text` value; }
struct `P.name`       : `P.symbol`  { };
struct `P.operator`   : `P.symbol`  { };</pre>
</div>
</div>
<div class="paragraph">
<p>The inner nodes contain pointers to other nodes. These pointers are
never <code>NULL</code>, and the structure is a tree that is easily allocated or
deallocated. The previous XL implementations have pools for each type,
allowing faster fixed-size allocation without memory fragmentation.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>struct `P.prefix`     : `P.tree`    { `P.tree` *left, *right; };
struct `P.postfix`    : `P.tree`    { `P.tree` *left, *right; };
struct `P.infix`      : `P.tree`    { `P.tree` *left, *right; `text` name; }
struct `P.block`      : `P.tree`    { `P.tree` *child; `text` opening, closing; }</pre>
</div>
</div>
<div class="paragraph">
<p>This representation is called the <em>normal representation</em> or
<em>normal form</em> of the parse tree, and it corresponds almost
directly to the XL declarations <a href="#parser">given in module</a>
<code>XL.PARSER</code>. This is in particular the input to the <code>XL.TRANSLATOR</code>
module, and it can be evaluated directly.</p>
</div>
</div>
<div class="sect2">
<h3 id="machine-representation"><a class="anchor" href="#machine-representation"></a><a class="link" href="#machine-representation">6.2. Machine representation</a></h3>
<div class="paragraph">
<p>The normal form is not very efficient, and generated machine code will
normally only use a <em>machine representation</em> or  <em>machine form</em>
for both data and code.</p>
</div>
<div class="paragraph">
<p>When this is useful for proper evaluation, a normal form can be
<em>boxed</em> into its equivalent machine representation, and
conversely, that machine representation can be
<em>unboxed</em>. This process is called <em>autoboxing</em>, and
should be entirely transparent to the developer.</p>
</div>
<div class="paragraph">
<p>The machine representation for data is normally a <code>struct</code> that
contains the definitions in the
<a href="#pattern-matching-scope">pattern matching scope</a> for the type
being considered. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// type complex is matching complex(Re:real, Im:real)
typedef struct `complex` { `real` Re; `real` Im; } complex_t;

// Z : complex := complex(1.2, 3.4)
complex_t Z = { 1.2, 3.4 };

// Z1:complex + Z2.complex is complex(Z1.Re+Z2.Re, Z1.Im+Z2.Im)
#define complex_add  `Z1:complex + Z2.complex`
complex_t complex_add(complex_t Z1, complex_t Z2)
{
    complex_t result;
    result.Re = Z1.Re + Z2.Re;
    result.Im = Z1.Im + Z2.Im;
    return result;
}</pre>
</div>
</div>
<div class="paragraph">
<p>In the special case of types that contain only a single value, that
machine type itsef is used, since the XL compiler takes care of the
type checking aspects. In other words, there is no additional cost in
using this kind of type.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// type distance is matching distance(meters:real)
typedef `real` distance_t;    // Probably a double

// D1:distance + D2:distance is distance(D1.meters + D2.meters)
#define distance_add `D1:distance + D2:distance`
inline distance_t distance_add(distance_t D1, distance_t D2)
{
    return D1 + D2;
}</pre>
</div>
</div>
<div class="paragraph">
<p>At lower levels of optimization, as was the case in Tao3D, the machine
representation for types with open-ended or unconstrained values will
typically contain the normal form, knowing that the passed normal form
will generally be the normal form for <a href="#closures">closures</a>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// type if_statement is matching { if Condition then TrueClause else FalseClause }
struct `if_statement`
{
    `P.tree` *Condition;
    `P.tree` *TrueClause;
    `P.tree` *FalseClause;
};</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="closures-representation"><a class="anchor" href="#closures-representation"></a><a class="link" href="#closures-representation">6.3. Closures representation</a></h3>
<div class="paragraph">
<p>Executable code and closures also have machine forms.
The machine form for a closure may look something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>typedef `type of expression` expression_type;
struct `expression`
{
    expression_type (*code) (struct `expression` *closure, args...);
    `P.tree` *self; // If needed
    ... // additional data fields for captured data used by 'code'
};</pre>
</div>
</div>
<div class="paragraph">
<p>For example, consider the <code>adder</code> example <a href="#cosures">given as an
example</a> for closures earlier, assuming we know that <code>N</code> and <code>X</code> are
<code>integer</code> values.</p>
</div>
<div class="paragraph">
<p>A first structure represents a function that takes a single <code>X</code>
argument, again assuming that argument is an <code>int</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// adder N is { lambda X is X + N }
typedef struct `lambda X`
{
    int (*code) (struct `lambda X` *closure, int X);
} lambda;</pre>
</div>
</div>
<div class="paragraph">
<p>However, if the code uses a variable like <code>N</code>, that variable is said
to be <em>captured</em>. In order to be able to
preserve the value of that variable outside of the scope that created
it, another structure inheriting from <code>lambda</code> is needed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>typedef struct `lambda X capturing N` : lambda
{
    int N;
} lambda_N;</pre>
</div>
</div>
<div class="paragraph">
<p>Using this data structure, it is now possible to generate the code for
the body of the anonymous function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#define anonymous_function `X + N`
int anonymous_function(lambda_N *closure, int X)
{
    return X + closure-&gt;N;
}</pre>
</div>
</div>
<div class="paragraph">
<p>That body can then be used to generate the code for the <code>adder</code>
function itself:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#define adder_name      `adder N`
lambda_N adder_name(int N)
{
    lambda_N result;
    result.code = anonymous_function;
    result.N = N;
    return result;
}</pre>
</div>
</div>
<div class="paragraph">
<p>That code can be used to create values that represent the adder, along
with the data that it needs:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// add3 is adder 3
#define add3    `add3`
lambda_N add3 = adder_name(3)</pre>
</div>
</div>
<div class="paragraph">
<p>Invoking that code is straightfordward:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// add3 5
add3.code(&amp;add3, 5);</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="type-representation"><a class="anchor" href="#type-representation"></a><a class="link" href="#type-representation">6.4. Type representation</a></h3>
<div class="paragraph">
<p>The <code>type</code> type is a standard data type, which exposes a number of
features used by the XL runtime to manipulate values of the type:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>struct `type`
{
    size_t (*size)    (void *value);    // Compute size of a value
    void   (*create)  (void *value);    // Create value of the type
    void   (*delete)  (void *value);    // Delete value of the type
    bool   (*contains)(void *value);    // Check if a value belong
    ...
};</pre>
</div>
</div>
<div class="paragraph">
<p>When a type interface is provided, the actual type implementation may
be implemented as a structure that derives from <code>struct `type`</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// type shape_t with
//    draw         as ok
//    width        : coordinate

struct `shape_t`_interface : `type`
{
    `ok`                (*`draw`) (struct `shape` *shape);
    `coordinate`        (*`width`)(struct `shape` *shape);
    `coordinate`        (*`width`)(struct `shape` *shape, `coordinate` width);
}</pre>
</div>
</div>
<div class="paragraph">
<p>The type interface can then be used by generated code in a way that is
largely independant of the actual layout for the object. The type
interface therefore gives a standard way to refer to the features of
the type. Since all the features are represented by pointer, derived
types may populate them by alternate values. This mechanism is overall
very similar to so-called <em>vtables</em> in C&#43;&#43;, except that
interface calls for getters and setters are automatically generated.</p>
</div>
<div class="paragraph">
<p>For a direct implementation, wrappers to access the fields are
generated automatically, which can be removed by global optimization
if the implementation is known to be in the same load module as the
code using it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// type shape_t is matching shape
//    draw is logic_error "Drawing a base shape"
//    width : coordinate
struct `shape`
{
    `coordinate` width;
};

static `ok` `draw`(`shape` *shape)
{
     `ok` result;
     result.kind = `error`
     result.error = `logic_error`("Drawing a base shape");
     return result;
}

static `coordinate` `width`_get(struct `shape` *shape)
{
    return shape-&gt;width;
}

static `coordinate` `width`_set(struct `shape` *shape, `coordinate` width)
{
    return shape-&gt;width = width;
}</pre>
</div>
</div>
<div class="paragraph">
<p>It also needs to define the standard functions for a type:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>static size_t size(`shape` *value)
{
    return sizeof(shape);
}

static void create(`shape` *shape)
{
    shape-&gt;width = 0;
}

static void delete(`shape` *shape)
{
}

static bool contains(`shape` *shape)
{
    return true; // No conditions on 'width'
}</pre>
</div>
</div>
<div class="paragraph">
<p>With all these, the actual value for the type implementation can be
built simply by populating its various fields:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>`shape_t`_interface `shape_t` =
{
    size,
    create,
    delete,
    contains,
    `draw`,
    `width`_get,
    `width`_set
}</pre>
</div>
</div>
<div class="paragraph">
<p>All the code that views the implementation of <code>shape</code> can directly
access it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// S.width := 387
S.width = 387;</pre>
</div>
</div>
<div class="paragraph">
<p>This extends to code that is known by the compiler to be in the same
load module. In other words, the compiler is allowed to do global
optimizations across multiple files. If the actual type implementation
is not known, in particular because it resides in a different load
module (e.g. a shared library) that may change at runtime, then the
type structure is used instead:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// S.width := 387
`shape_t`.`width`_set(&amp;S, 387);</pre>
</div>
</div>
<div class="paragraph">
<p>Obviously, if we have an <code>attribute</code> instead, the <code>get</code> and <code>set</code>
functions are replaced with code generated from the attribute&#8217;s <code>get</code>
and <code>set</code>, and the fields in the attribute are inserted in the type in
place of the attribute:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// type shape_t is matching shape
//    width as attribute coordinate is
//        attribute_width : some_other_integer
//        get   is attribute_width / 2
//        set W is attribute_width := W * 2
struct `shape`
{
    `some_other_integer` attribute_width;
};

static `coordinate` `width`_get(struct `shape` *shape)
{
    return shape-&gt;attribute_width / 2
}

static `coordinate` `width`_set(struct `shape` *shape, `coordinate` W)
{
    return shape-&gt;attribute_width = W * 2;
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="discriminated-types"><a class="anchor" href="#discriminated-types"></a><a class="link" href="#discriminated-types">6.5. Discriminated types</a></h3>
<div class="paragraph">
<p>For a type expression like <code>A or B</code>, a memory space can be occupied
by either a <code>A</code> or a <code>B</code>. In that case, the compiler needs to add a
field that helps identify which type is being represented. Such a
field is called a <em>discriminant</em>.</p>
</div>
<div class="paragraph">
<p>When there is a limited number of possible types, then the compiler
should generate an enumeration, since this makes it relatively easy to
crate dispatch tables. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// my_type is integer or real
// triple X:my_type as my_type is X + X + X
struct `my_type`
{
    enum { `integer`_case, `real`_case } kind;
    union
    {
        `integer` a;
        `real` b;
    }
};

static `my_type` `triple`_a(`my_type` X)
{
    `my_type` result = { `integer`_case, a: X.a + X.a + X.a }
    return result;
}

static `my_type` `triple`_b(`my_type` X)
{
    `my_type` result = { `real`_case, b: X.b + X.b + X.b }
    return result;
}

`my_type` `triple`(`my_type` X)
{
    typedef `my_type`(*impl)(`my_type` X);
    static impl impls[] = { `triple`_a, `triple`_b };
    return impls[X.kind](X);
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>any T</code> type can accept a much larger and open-ended set of
types. In that case, the discriminant must be a type.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// S : any shape_t
struct `any shape_t`
{
    struct `shape_t`_interface *type;
    struct `shape_t` *value;
} S;

// S := rectangle(1,2,3,4)
`rectangle` tmp_r = { 1, 2, 3, 4};
S.type = `rectangle`;
S.value = &amp;tmp_r;

// S := circle(0, 0, 100)
`circle` tmp_c = { 0, 0, 100 };
S.type =`circle`;
S.value = &amp;tmp_c;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="compiling-variable-sized-types"><a class="anchor" href="#compiling-variable-sized-types"></a><a class="link" href="#compiling-variable-sized-types">6.6. Compiling variable-sized types</a></h3>
<div class="paragraph">
<p>The <code>size</code> field in types takes a value of the type. This is intended
to allow the implementation to work with
<a href="#variable-sized-types">variable-sized types</a>.</p>
</div>
<div class="paragraph">
<p>For example, the <code>size</code> for <code>packet</code> type can be implemented by adding
the size of the <code>header</code> and <code>payload</code> parts, the payload itself
having a variable size.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// type header is matching header (byte_count:size)
typedef size_t `header`;
size_t `size` (`header` *value) { return sizeof(`header`); }

// payload[byte_count:size] is array[byte_count] of byte
typedef
{
     size_t byte_count;
     struct `array` array;
} `payload`;

size_t `size`(`payload` *value)
{
    return sizeof(value-&gt;byte_count)
         + `array`.size(&amp;value-&gt;array)
         + value-&gt;byte_count * sizeof(byte);
}</pre>
</div>
</div>
<div class="paragraph">
<p>This also means that all access to individual features may need
several steps of computation.</p>
</div>
</div>
<div class="sect2">
<h3 id="constrained-types"><a class="anchor" href="#constrained-types"></a><a class="link" href="#constrained-types">6.7. Constrained types</a></h3>

</div>
<div class="sect2">
<h3 id="dynamic-dispatch-3"><a class="anchor" href="#dynamic-dispatch-3"></a><a class="link" href="#dynamic-dispatch-3">6.8. Dynamic dispatch</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="basic-operations"><a class="anchor" href="#basic-operations"></a><a class="link" href="#basic-operations">7. Basic operations</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="modules"><a class="anchor" href="#modules"></a><a class="link" href="#modules">8. <a id="module"></a>Modules</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="standard-library"><a class="anchor" href="#standard-library"></a><a class="link" href="#standard-library">9. Standard Library</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The standard library provides the vast majority of the features
available to the XL developer.</p>
</div>
<div class="sect2">
<h3 id="garbage-collection"><a class="anchor" href="#garbage-collection"></a><a class="link" href="#garbage-collection">9.1. Garbage collection</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="history-of-xl"><a class="anchor" href="#history-of-xl"></a><a class="link" href="#history-of-xl">10. History of XL</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The status of the current XL compiler is <a href="http://github.com/c3d/xl/blob/master/#compiler-status">a bit
messy</a>. There is a rationale to this madness. I attempt to give it here.</p>
</div>
<div class="paragraph">
<p>There is also a
<a href="https://grenouillebouillie.wordpress.com/2017/12/10/from-ada-to-xl-in-25-years/">blog
version</a> if you prefer reading on the web (but it’s not exactly
identical). In both cases, the article is a bit long, but it’s worth
understanding how XL evolved, and why the XL compiler is still work in
progress.</p>
</div>
<div class="sect2">
<h3 id="it-started-as-an-experimental-language"><a class="anchor" href="#it-started-as-an-experimental-language"></a><a class="link" href="#it-started-as-an-experimental-language">10.1. It started as an experimental language</a></h3>
<div class="paragraph">
<p>Initially, XL was called LX, "Langage experimental" in French, or as
you guessed it, an experimental language. Well, the very first codename
for it was "WASHB" (What Ada Should Have Been). But that did not sound
very nice. I started working on it in the early 1990s, after a training
period working on the Alsys Ada compiler.</p>
</div>
<div class="paragraph">
<p>What did I dislike about Ada? I never liked magic in a language. To me,
keywords demonstrate a weakness in the language, since they indicated
something that you could not build in the library using the language
itself. Ada had plenty of keywords and magic constructs. Modern XL has
no keyword whatsoever, and it’s a Good Thing &#8482;.</p>
</div>
<div class="paragraph">
<p>Let me elaborate a bit on some specific frustrations with Ada:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tasks in Ada were built-in language constructs. This was inflexible.
Developers were already hitting limits of the Ada-83 tasking model. My
desire was to put any tasking facility in a library, while retaining an
Ada-style syntax and semantics.</p>
</li>
<li>
<p>Similarly, arrays were defined by the language. I wanted to build them
(or, at least, describe their interface) using standard language
features such as generics. Remember that this was years before the STL
made it to C&#43;&#43;, but I was thinking along similar lines. Use cases I had
in mind included:</p>
<div class="ulist">
<ul>
<li>
<p>interfacing with languages that had different array layouts such as
Fortran and C,</p>
</li>
<li>
<p>using an array-style interface to access on-disk records. Back then,
<code>mmap</code> was unavailable on most platforms,</p>
</li>
<li>
<p>smart pointers that would also work with on-disk data structures,</p>
</li>
<li>
<p>text handling data structures (often called "strings") that did not
expose the underlying implementation (e.g. "pointer to char" or
"character array"), …</p>
</li>
</ul>
</div>
</li>
<li>
<p>Ada text I/O facilities were uncomfortable. But at that time, there
was no good choice. You had to pick your poison:</p>
<div class="ulist">
<ul>
<li>
<p>In Pascal, <code>WriteLn</code> could take as many arguments as you needed and
was type safe, but it was a magic procedure, that you could not write
yourself using the standard language features, nor extend or modify to
suit your needs.</p>
</li>
<li>
<p>Ada I/O functions only took one argument at a time, which made
writing the simplest I/O statement quite tedious relative to C or
Pascal.</p>
</li>
<li>
<p>C’s <code>printf</code> statement had multiple arguments, but was neither type
safe nor extensible, and the formatting string was horrid.</p>
</li>
</ul>
</div>
</li>
<li>
<p>I also did not like Ada pragmas, which I found too ad-hoc, with a
verbose syntax. I saw pragmas as indicative that some kind of generic
"language extension" facility was needed, although it took me a while
to turn that idea into a reality.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I don’t have much left of that era, but that first compiler was
relatively classical, generating 68K assembly language. I reached the
point where the compiler could correctly compile a "Hello World" style
program using an I/O library written in the language. I was doing that
work at home on Atari-ST class machines, but also gave demos to my HP
colleagues running XL code on VME 68030 boards.</p>
</div>
<div class="paragraph">
<p>From memory, some of the objectives of the language at the time
included:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Giving up on superfluous syntactic markers such as terminating
semi-colon.</p>
</li>
<li>
<p>Using generics to write standard library component such as arrays or
I/O facilities.</p>
</li>
<li>
<p>Making the compiler an integral part of the language, which led to…</p>
</li>
<li>
<p>Having a normalised abstract syntax tree, and…</p>
</li>
<li>
<p>Considering "pragmas" as a way to invoke compiler extensions.
Pragmas in XL were written using the <code>{pragma}</code> notation, which would
indirectly invoke some arbitrary code through a table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thus, via pragmas, the language became extensible. That led me to…</p>
</div>
</div>
<div class="sect2">
<h3 id="lx-an-extensible-language"><a class="anchor" href="#lx-an-extensible-language"></a><a class="link" href="#lx-an-extensible-language">10.2. LX, an extensible language</a></h3>
<div class="paragraph">
<p>I wanted to have a relatively simple way to extend the language. Hence,
circa 1992, the project was renamed from "experimental" to
"extensible", and it has kept that name since then.</p>
</div>
<div class="paragraph">
<p>One example of thing I wanted to be able to do was to put tasking in a
library in a way that would "feel" similar to Ada tasking, with the
declaration of task objects, rendez-vous points that looked like
procedures with parameter passing, and so on.</p>
</div>
<div class="paragraph">
<p>I figured that my <code>{annotations}</code> would be a neat way to do this, if
only I made the parse tree public, in the sense that it would become a
public API. The idea was that putting <code>{annotation}</code> before a piece of
code would cause the compiler to pass the parse tree to whatever
function was associated with <code>annotation</code> in a table of annotation
processors. That table, when pointing to procedures written in XL, would
make writing new language extensions really easy. Or so I thought.</p>
</div>
<div class="paragraph">
<p>Ultimately, I would make it work. If you are curious, you can see the
<a href="http://github.com/c3d/xl/blob/master/xl2/native/xl.semantics.instructions.xl#L629">grand-child of that
idea</a> in the <code>translation</code> statements under <code>xl2/</code>. But that was way
beyond what I had initially envisionned, and the approach in the first
XL compiler did not quite work. I will explain why soon below.</p>
</div>
<div class="paragraph">
<p>The first experiment I ran with this, which became a staple of XL since
then, was the <code>{derivation}</code> annotation. It should have been
<code>{differentiation}</code>, but at that time, my English was quite crappy, and
in French, the word for "differentiation" is "derivation". The idea
is that if you prefixed some code, like a function, with a
<code>{derivation}</code> annotation, the parse tree for that function would be
passed to the <code>derivation</code> pragma handler, and that would replace
expressions that looked like differential expressions with their
expanded value. For example, <code>{derivation} d(X+sin(X))/dX</code> would
generate code that looked like <code>1 + cos(X)</code>.</p>
</div>
<div class="paragraph">
<p>If you are curious what this may look like, there are still
<a href="http://github.com/c3d/xl/blob/master/xl2/native/TESTS/07.Plugins">tests in the XL2 test suite</a> using a
very similar feature and syntax.</p>
</div>
</div>
<div class="sect2">
<h3 id="lx-meet-xroma"><a class="anchor" href="#lx-meet-xroma"></a><a class="link" href="#lx-meet-xroma">10.3. LX, meet Xroma</a></h3>
<div class="paragraph">
<p>That initial development period for LX lasted between 1990, the year of
my training period at Alsys, and 1998, when I jointed the HP California
Language Lab in Cupertino (CLL). I moved to the United States to work on
the HP C&#43;&#43; compiler and, I expected, my own programming language. That
nice plan did not happen exactly as planned, though…</p>
</div>
<div class="paragraph">
<p>One of the very first things I did after arriving in the US was to
translate the language name to English. So LX turned into XL. This was a
massive rename in my source code, but everything else remained the same.</p>
</div>
<div class="paragraph">
<p>As soon as I joined the CLL, I started talking about my language and the
ideas within. One CLL engineer who immediately "got it" is Daveed
Vandevoorde. Daveed immediately understood what I was doing, in large
part because he was thinkering along the same lines. He pointed out that
my approach had a name: meta-programming, i.e. programs that deal with
programs. I was doing meta-programming without knowing about the word,
and I felt really stupid at the time, convinced that everybody in the
compilers community knew about that technique but me.</p>
</div>
<div class="paragraph">
<p>Daveed was very excited about my work, because he was himself working on
his own pet language named Xroma (pronounced like Chroma). At the time,
Xroma was, I believe, not as far along as XL, since Daveed had not
really worked on a compiler. However, it had annotations similar to my
pragmas, and some kind of public representation for the abstract syntax
tree as well.</p>
</div>
<div class="paragraph">
<p>Also, the Xroma name was quite Xool, along with all the puns we could
build using a capital-X pronounced as "K" (Xolor, Xameleon, Xode, …)
or not (Xform, Xelerate, …) As a side note, I later called
"Xmogrification" the VM context switch in
<a href="https://en.wikipedia.org/wiki/HP_Integrity_Virtual_Machines">HPVM</a>,
probably in part as a residual effect of the Xroma naming conventions.</p>
</div>
<div class="paragraph">
<p>In any case, Daveed and I joined forces. The combined effort was named
Xroma. I came up with the early version of the lightbulb logo still
currently used for XL, using FrameMaker drawing tools, of all things.
Daveed later did a nice 3D rendering of the same using the Persistence
of Vision ray tracer. I don’t recall when the current logo was
redesigned.</p>
</div>
</div>
<div class="sect2">
<h3 id="xl-moves-to-the-off-side-rule"><a class="anchor" href="#xl-moves-to-the-off-side-rule"></a><a class="link" href="#xl-moves-to-the-off-side-rule">10.4. XL moves to the off-side rule</a></h3>
<div class="paragraph">
<p>Another major visual change that happened around that time was switching
to the off-side rule, i.e. using indentation to mark the syntax. Python,
which made this approach popular, was at the time a really young
language (release 1.0 was in early 1994).</p>
</div>
<div class="paragraph">
<p>Alain Miniussi, who made a brief stint at the CLL, convinced me to give
up the Ada-style <code>begin</code> and <code>end</code> keywords, using an solid
argumentation that was more or less along the lines of "I like your
language, but there’s no way I will use a language with <code>begin</code> and
<code>end</code> ever again". Those were the times where many had lived the
transition of Pascal to C, some still wondering how C won.</p>
</div>
<div class="paragraph">
<p>I was initially quite skeptical, and reluctantly tried an
indentation-based syntax on a fragment of the XL standard library. As
soon as I tried it, however, the benefits immediately became apparent.
It was totally consistent with a core tenet of concept programming that
I was in the process of developing (see below), namely that the code
should look like your concepts. Enforcing indentation made sure that the
code did look like what it meant.</p>
</div>
<div class="paragraph">
<p>It took some effort to convert existing code, but I’ve never looked back
since then. Based on the time when Alain Miniussi was at the CLL, I
believe this happened around 1999.</p>
</div>
</div>
<div class="sect2">
<h3 id="concept-programming"><a class="anchor" href="#concept-programming"></a><a class="link" href="#concept-programming">10.5. Concept programming</a></h3>
<div class="paragraph">
<p>The discussions around our respective languages, including the
meta-programming egg-face moment, led me to solidify the theoretical
underpinning of what I was doing with XL. My ideas actually did go quite
a bit beyond mere meta-programming, which was really only a technique
being used, but not the end goal. I called my approach <em>Concept
Programming</em>. I tried to explain what it is about in
<a href="http://xlr.sourceforge.net/Concept%20Programming%20Presentation.pdf">this
presentation</a>. Concept programming is the theoretical foundation for XL.</p>
</div>
<div class="paragraph">
<p>Concept programming deals with the way we transform concepts that reside
in our brain into code that resides in the computer. That conversion is
lossy, and concept programming explores various techniques to limit the
losses. It introduces pseudo-metrics inspired by signal processing such
as syntactic noise, semantic noise, bandwidth and
signal/noise ratio.
These tools, as simple as they were, powerfully demonstrated limitations
of existing languages and techniques.</p>
</div>
<div class="paragraph">
<p>Since then, Concept Programming has consistently guided what I am doing
with XL. Note that Concept Programming in the XL sense has little do do
with C&#43;&#43; concepts (although there may be a connection, see blog
referenced above for details).</p>
</div>
</div>
<div class="sect2">
<h3 id="mozart-and-moka-adding-java-support-to-xl"><a class="anchor" href="#mozart-and-moka-adding-java-support-to-xl"></a><a class="link" href="#mozart-and-moka-adding-java-support-to-xl">10.6. Mozart and Moka: Adding Java support to XL</a></h3>
<div class="paragraph">
<p>At the time, Java was all the rage, and dealing with multiple languages
within a compiler was seen as a good idea. GCC being renamed from "GNU
C Compiler" to the "GNU Compiler Collection" is an example of this
trend.</p>
</div>
<div class="paragraph">
<p>So with Daveed, we had started working on what we called a "universal
program database", which was basically a way to store and access
program data independently of the language being used. In other words,
we were trying to create an API that would make it possible to
manipulate programs in a portable way, whether the program was written
in C, C&#43;&#43; or Java. That proved somewhat complicated in practice.</p>
</div>
<div class="paragraph">
<p>Worse, Daveed Vandevoord left the HP CLL to join the Edison Design
Group, where he’s still working to this date. Xroma instantly lost quite
a bit of traction within the CLL. Also, Daveed wanted to keep the Xroma
name for his own experiments. So we agreed to rename "my" side of the
project as "Mozart". For various reasons, including a debate regarding
ownership of the XL code under California law, the project was
open-sourced. The <a href="http://mozart-dev.sourceforge.net">web site</a> still
exists to this day, but is not quite functional since CVS support was
de-commissioned from SourceForge.</p>
</div>
<div class="paragraph">
<p>Part of the work was to define a complete description of the source code
that could be used for different language. Like for Xroma, we stayed on
bad puns and convoluted ideas for naming. In Mozart that representation
was called <code>Coda</code>. It included individual source elements called <code>Notes</code>
and the serialized representation was called a <code>Tune</code>. Transformation on
Notes, i.e. the operations of compiler plug-ins, were done by
<code>Performer</code> instances. A couple of years later, I would realize that
this made the code totally obfuscated for the non-initiated, and I vowed
to never make that mistake again.</p>
</div>
<div class="paragraph">
<p>Mozart included <a href="http://mozart-dev.sourceforge.net/moka.html">Moka</a>, a
Java to Java compiler using Mozart as its intermediate representation. I
published an <a href="http://www.drdobbs.com/jvm/what-is-moka/184404696">article
in Dr Dobb’s journal</a>, a popular developers journal at the time.</p>
</div>
<div class="paragraph">
<p>But my heart was never with Java anymore than with C&#43;&#43;, as evidenced by
the much more extensive documentation about XL on the Mozart web site.
As a language, Java had very little interest for me. My management at HP
had no interest in supporting my pet language, and that was one of the
many reasons for me to leave the CLL to start working on virtualization
and initiate what would become HPVM.</p>
</div>
</div>
<div class="sect2">
<h3 id="innovations-in-2000-vintage-xl"><a class="anchor" href="#innovations-in-2000-vintage-xl"></a><a class="link" href="#innovations-in-2000-vintage-xl">10.7. Innovations in 2000-vintage XL</a></h3>
<div class="paragraph">
<p>By that time, XL was already quite far away from the original Ada, even
if it was still a statically typed, ahead-of-time language. Here are
some of the key features that went quite a bit beyond Ada:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The syntax was quite clean, with very few unnecessary characters.
There were no semi-colons at the end of statement, and parentheses were
not necessary in function or procedure calls, for example. The off-side
rule I talked about earlier allowed me to get rid of any <code>begin</code> or
<code>end</code> keyword, without resorting to C-style curly braces to delimit
blocks.</p>
</li>
<li>
<p>Pragmas extended the language by invoking
<a href="http://mozart-dev.sourceforge.net/tools.html#pragma">arbitrary compiler
plug-ins</a>. I suspect that attributes in C&#43;&#43;11 are distant (and less
powerful) descendants of this kind of annotation, if only because their
syntax matches my recollection of the annotation syntax in Xroma, and
because Daveed has been a regular and innovative contributor to the C&#43;&#43;
standard for two decades…</p>
</li>
<li>
<p><a href="http://mozart-dev.sourceforge.net/xl_style.html#expred">Expression
reduction</a> was a generalisation of operator overloading that works with
expressions of any complexity, and could be used to name types. To this
day, expression reduction still has no real equivalent in any other
language that I know of, although expression templates can be used in
C&#43;&#43; to achieve similar effect in a very convoluted and less powerful
way. Expression templates will not allow you to add operators, for
example. In other words, you can redefine what <code>X+Y*Z</code> means, but you
cannot create <code>X in Y..Z</code> in C&#43;&#43;.</p>
</li>
<li>
<p><a href="http://mozart-dev.sourceforge.net/xl_style.html#truegen">True generic
types</a> were a way to make generic programming much easier by declaring
generic types that behaved like regular types. Validated generic types
extended the idea by adding a validation to the type, and they also have
no real equivalent in other languages that I am aware of, although C&#43;&#43;
concepts bring a similar kind of validation to C&#43;&#43; templates.</p>
</li>
<li>
<p><a href="http://mozart-dev.sourceforge.net/xl_style.html#vararg">Type-safe
variable argument lists</a> made it possible to write type-safe variadic
functions. They solved the <code>WriteLn</code> problem I referred to earlier,
i.e. they made it possible to write a function in a library that behaved
exactly like the Pascal <code>WriteLn</code>. I see them as a distant ancestor of
variadic templates in C&#43;&#43;11, although like for concepts, it is hard to
tell if variadic templates are a later reinvention of the idea, or if
something of my e-mails influenced members of the C&#43;&#43; committee.</p>
</li>
<li>
<p>A powerful standard library was in the making. Not quite there yet,
but the key foundations were there, and I felt it was mostly a matter of
spending the time writing it.
<a href="http://github.com/c3d/xl/blob/master/xl2/native/library/xl.math.complex.xl">My implementation of
complex numbers</a>, for example, was
<a href="http://mozart-dev.sourceforge.net/news.html#complex">70% faster than C&#43;&#43;
on</a> simple examples, because it allowed everything to be in registers
instead of memory. There were a few things that I believe also date from
that era, like getting rid of any trace of a main function, top-level
statements being executed as in most scripting languages.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="xl0-and-xl2-reinventing-the-parse-tree"><a class="anchor" href="#xl0-and-xl2-reinventing-the-parse-tree"></a><a class="link" href="#xl0-and-xl2-reinventing-the-parse-tree">10.8. XL0 and XL2: Reinventing the parse tree</a></h3>
<div class="paragraph">
<p>One thing did not work well with Mozart, however, and it was the parse
tree representation. That representation, called <code>Notes</code>, was quite
complicated. It was some kind of object-oriented representation with
many classes. For example, there was a class for <code>IfThenElse</code>
statements, a <code>Declaration</code> class, and so on.</p>
</div>
<div class="paragraph">
<p>This was all very complicated and fragile, and made it extremely
difficult to write thin tools (i.e. compiler plug-ins acting on small
sections of code), in particular thin tools that respected subtle
semantic differences between languages. By 2003, I was really hitting a
wall with XL development, and that was mostly because I was also trying
to support the Java language which I did not like much.</p>
</div>
<div class="paragraph">
<p>One of the final nails in the Mozart coffin was a meeting with Alan Kay,
of Smalltalk fame, during an HP technical conference. Kay was an HP
Fellow at the time. I tried to show him how my language was solving some
of the issues he had talked about during his presentation. He did not
even bother looking. He simply asked: “<em>Does your language
self-compile?</em>“. When I answered that the compiler was written in C&#43;&#43;,
Alan Kay replied that he was not interested.</p>
</div>
<div class="paragraph">
<p>That gave me a desire to consider a true bootstrap of XL. That meant
rewriting the compiler from scratch. But at that time, I had already
decided that the internal parse tree representation needed to be
changed. So that became my topic of interest.</p>
</div>
<div class="paragraph">
<p>The new implementation was called XL2, not just as a version number, but
because I was seeing things as a three-layer construction:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>XL0</code> was just a very simple parse tree format with only eight node
types. I sometimes refer to that level of XL as "<em>XML without the
M</em>", i.e. an extensble language without markup.</p>
</li>
<li>
<p><code>XL1</code> was the core language evaluation rules, not taking any library
into account.</p>
</li>
<li>
<p><code>XL2</code> was the full language, including its standard library. At the
time, the goal was to reconstruct a language that would be as close as
possible at the version of XL written using the Mozart framework.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This language is still available today, and while it’s not been
maintained in quite a while, it seems to still pass most of its test
suite. More importantly, the <code>XL0</code> format has remained essentially
unchanged since then.</p>
</div>
<div class="paragraph">
<p>The XL0 parse tree format is something that I believe makes XL
absolutely unique among high-level programming languages. It is designed
so that code that can look and feel like an Ada derivative can be
represented and manipulated in a very simple way, much like Lisp lists
are used to represent all Lisp programs. XL0, however, is not some minor
addition on top of S-expressions, but rather the definition of an
alternative of S-expressions designed to match the way humans parse
code.</p>
</div>
<div class="paragraph">
<p>The parse tree format consists of only eight node types, four leaf node
types (integer, real, text and symbol), four inner node types (infix,
prefix, postfix and block).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Integer</code> represents integer numbers, like <code>123</code> or <code>16#FFFF_FFFF</code>. As
the latter example shows, the XL syntax includes support for based
numbers and digit grouping.</p>
</li>
<li>
<p><code>Real</code> represents floating-point numbers, like <code>123.456</code> or
<code>2#1.001_001#e-3</code>. Like for <code>Integer</code>, XL supports based floating-point
numbers and digit grouping.</p>
</li>
<li>
<p><code>Text</code> represents textual constants like <code>"Hello"</code> or <code>'A'</code>.</p>
</li>
<li>
<p><code>Name</code> represents names like <code>ABC</code> or symbols like <code>&lt;=</code>.</p>
</li>
<li>
<p><code>Infix</code> represents operations where a name is between two operands,
like <code>A+B</code> or <code>A and B</code>.</p>
</li>
<li>
<p><code>Prefix</code> represents operations where an operator precedes its operand,
like <code>sin X</code> or <code>-4</code>.</p>
</li>
<li>
<p><code>Postfix</code> represents operations where an operator follows its operand,
like <code>3 km</code> or <code>5%</code>.</p>
</li>
<li>
<p><code>Block</code> represents operations where an operand is surrounded by two
names, like <code>[A]</code>, <code>(3)</code> or <code>{write}</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Individual program lines are seen as the leaves of an infix "newline"
operator. There are no keywords at all, the precedence of all operators
being given dynamically by a syntax file.</p>
</div>
</div>
<div class="sect2">
<h3 id="bootstrapping-xl"><a class="anchor" href="#bootstrapping-xl"></a><a class="link" href="#bootstrapping-xl">10.9. Bootstrapping XL</a></h3>
<div class="paragraph">
<p>The initial translator converts a simplified form of XL into C&#43;&#43; using a
very basic transcoding that involves practically no semantic analysis.
The limited XL2 acceptable as input for this translation phase is only
used in the bootstrap compiler. It already looks a bit like the final
XL2, but error checking and syntax analysis are practically nonexistent.</p>
</div>
<div class="paragraph">
<p>The bootstrap compiler can then be used to translate the native XL
compiler. The native compiler performs much more extended semantic
checks, for example to deal with generics or to implement a true module
system. It emits code using a configurable "byte-code" that is
converted to a variety of runtime languages. For example, the C bytecode
file will generate a C program, turning the native compiler into a
transcoder from XL to C.</p>
</div>
<div class="paragraph">
<p>That native compiler can translate itself, which leads to a true
bootstrap where the actual compiler is written in XL, even if a C
compiler is still used for the final machine code generation. Using a
Java or Ada runtime, it would theoretically be possible to use a Java or
Ada compiler for final code generation.</p>
</div>
<div class="paragraph">
<p>The XL2 compiler advanced to the point where it could pass a fairly
large number of complex tests, including practically all the things that
I wanted to address in Ada:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pragmas implemented as <a href="http://github.com/c3d/xl/blob/master/xl2/native/TESTS/07.Plugins">compiler
plug-ins</a>.</p>
</li>
<li>
<p>Expression reduction
<a href="http://github.com/c3d/xl/blob/master/xl2/native/TESTS/05.Expressions/multi-reduction.xl">generalising
operator overloading</a>.</p>
</li>
<li>
<p>An I/O library that was
<a href="xl2/native/TESTS/12.Library/hello_world.xl">as usable as in Pascal</a>,
but <a href="http://github.com/c3d/xl/blob/master/xl2/native/library/xl.text_io.xl">written in the language</a>
and
<a href="http://github.com/c3d/xl/blob/master/xl2/native/TESTS/12.Library/instantiation_of_complex.xl#L8">user-extensible</a>.</p>
</li>
<li>
<p>A language powerful enough to define its own
<a href="http://github.com/c3d/xl/blob/master/xl2/native/library/xl.array.xs">arrays</a> or
<a href="http://github.com/c3d/xl/blob/master/xl2/native/library/xl.pointer.address.xs">pointers</a>, while
keeping them exactly
<a href="http://github.com/c3d/xl/blob/master/xl2/native/TESTS/08.Aggregates/basic-array.xl">as usable as
built-in types</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="xl2-compiler-plugins"><a class="anchor" href="#xl2-compiler-plugins"></a><a class="link" href="#xl2-compiler-plugins">10.10. XL2 compiler plugins</a></h3>
<div class="paragraph">
<p>XL2 has <a href="http://github.com/c3d/xl/blob/master/xl2/native/TESTS/07.Plugins">full support for compiler
plug-ins</a>, in a way similar to what had been done with Mozart. However,
plug-ins were much simpler to develop and maintain, since they had to
deal with a very simple parse tree structure.</p>
</div>
<div class="paragraph">
<p>For example, the
<a href="http://github.com/c3d/xl/blob/master/xl2/native/xl.plugin.differentiation.xl">differentiation plugin</a>
implements symbolic differentiation for common functions. It is tested
<a href="http://github.com/c3d/xl/blob/master/xl2/native/TESTS/07.Plugins/differentiation.xl#L33">here</a>. The
generated code after applying the plugin would
<a href="http://github.com/c3d/xl/blob/master/xl2/native/TESTS/07.Plugins/differentiation_cmd_line.ref">look
like this</a>. The plugin itself is quite simple. It simply applies basic
mathematical rules on parse trees. For example, to perform symbolic
differentiation on multiplications, the code looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">function Differentiate (expr : PT.tree; dv : text) return PT.tree is
    translate expr
        when ('X' * 'Y') then
            dX : PT.tree := Differentiate(X, dv)
            dY : PT.tree := Differentiate(Y, dv)
            return parse_tree('dX' * 'Y' + 'X' * 'dY')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Meta-programming became almost entirely transparent here. The
<code>translate</code> statement, itself provided by a compiler plug-in (see
below), matches the input tree against a number of shapes. When the tree
looks like <code>X*Y</code>, the code behind the matching <code>then</code> is evaluated. That
code reconstructs a new parse tree using the <code>parse_tree</code> function.</p>
</div>
<div class="paragraph">
<p>Also notice the symmetric use of quotes in the <code>when</code> clause and in the
<code>parse_tree</code> function, in both cases to represent variables as opposed
to names in the parse tree. Writing <code>parse_tree(X)</code> generates a parse
tree with the name <code>X</code> in it, whereas <code>parse_tree('X')</code> generates a
parse tree from the <code>X</code> variable in the source code (which must be a
parse tree itself).</p>
</div>
</div>
<div class="sect2">
<h3 id="xl2-internal-use-of-plugins-the-translation-extension"><a class="anchor" href="#xl2-internal-use-of-plugins-the-translation-extension"></a><a class="link" href="#xl2-internal-use-of-plugins-the-translation-extension">10.11. XL2 internal use of plugins: the <code>translation</code> extension</a></h3>
<div class="paragraph">
<p>The compiler uses this plug-in mechanism quite extensively internally. A
particularly important compiler extension provides the <code>translation</code> and
<code>translate</code> instructions. Both were used extensively to rewrite XL0
parse trees easily.</p>
</div>
<div class="paragraph">
<p>We saw above an example of <code>translate</code>, which translated a specific tree
given as input. It simply acted as a way to compare a parse tree against
a number of forms, evaluating the code corresponding to the first match.</p>
</div>
<div class="paragraph">
<p>The <code>translation</code> declaration is even more interesting, in that it is a
non-local function declaration. All the <code>translation X</code> from all modules
are accumulated in a single <code>X</code> function. Functions corresponding to
<code>translation X</code> and <code>translation Y</code> will be used to represent distinct
phases in the compiler, and can be used a regular functions taking a
tree as input and returning the modified tree.</p>
</div>
<div class="paragraph">
<p>This approach made it possible to distribute <code>translation XLDeclaration</code>
statements <a href="http://github.com/c3d/xl/blob/master/xl2/native/xl.semantics.functions.xl#L371">throughout
the compiler</a>, dealing with declaration of various entities, with
matching <code>translation XLSemantics</code> took care of
<a href="http://github.com/c3d/xl/blob/master/xl2/native/xl.semantics.functions.xl#L557">the later semantics
analysis phase</a>.</p>
</div>
<div class="paragraph">
<p>Writing code this way made it quite easy to maintain the compiler over
time. It also showed how concept programming addressed what is sometimes
called
<a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming">aspect-oriented
programming</a>. This was yet another proof of the "extensible" nature of
the language.</p>
</div>
</div>
<div class="sect2">
<h3 id="switching-to-dynamic-code-generation"><a class="anchor" href="#switching-to-dynamic-code-generation"></a><a class="link" href="#switching-to-dynamic-code-generation">10.12. Switching to dynamic code generation</a></h3>
<div class="paragraph">
<p>One issue I had with the original XL2 approach is that it was strictly a
static compiler. The bytecode files made it possible to generate
practically any language as output. I considered generating LLVM
bitcode, but thought that it would be more interesting to use an XL0
input instead. One reason to do that was to be able to pass XL0 trees
around in memory without having to re-parse them. Hence XLR, the XL
runtime, was born. This happened around 2009.</p>
</div>
<div class="paragraph">
<p>For various reasons, I wanted XLR to be dynamic, and I wanted it to be
purely functional. My motivations were:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a long-time interest in functional languages.</p>
</li>
<li>
<p>a desire to check that the XL0 representation could also comfortably
represent a functional languages, as a proof of how general XL0 was.</p>
</li>
<li>
<p>an intuition that sophisticated
<a href="https://en.wikipedia.org/wiki/Type_inference">type inference</a>,
Haskell-style, could make programs both shorter and more solid than the
declarative type systems of Ada.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While exploring functional languages, I came across
<a href="https://en.wikipedia.org/wiki/Pure_(programming_language)">Pure</a>, and
that was the second big inspiration for XL. Pure prompted me to use LLVM
as a final code generator, and to keep XLR extremely simple.</p>
</div>
</div>
<div class="sect2">
<h3 id="translating-using-only-tree-rewrites"><a class="anchor" href="#translating-using-only-tree-rewrites"></a><a class="link" href="#translating-using-only-tree-rewrites">10.13. Translating using only tree rewrites</a></h3>
<div class="paragraph">
<p>I sometimes describe XLR as a language with a single operator, <code>is</code>,
which reads as <em>transforms into</em>. Thus, <code>X is 0</code> declares that <code>X</code> has
value <code>0</code>.</p>
</div>
<div class="paragraph">
<p>Until very recently, that operator was spelled using an arrow, as <code>-&gt;</code>,
which I thought expressed the <em>transforms into</em> quite well. Around 2018,
I decided that this was unreadable for the novice, and switched to using
<code>is</code> as this <em>definition operator</em>. This <code>-&gt;</code> operator is still what you
will find for example on the <a href="http://tao3d.sourceforge.net">Tao3D web
site</a>.</p>
</div>
<div class="paragraph">
<p>This notation can be used to declare basic operators:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">x:integer - y:integer as integer    is opcode Sub</code></pre>
</div>
</div>
<div class="paragraph">
<p>It makes a declaration of <code>writeln</code> even shorter than it was in XL2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">write x:text as boolean             is C xl_write_text
write x:integer as boolean          is C xl_write_integer
write x:real as boolean             is C xl_write_real
write x:character as boolean        is C xl_write_character
write A, B                          is write A; write B
writeln as boolean                  is C xl_write_cr
writeln X as boolean                is write X; writeln</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The precedence of <code>;</code> was changed over time. It is now lower
than <code>is</code>, but was higher at the time to make it possible to write the
code above without curly braces. See the rationale in
<a href="#expression-vs-statemnt">expression vs. statement</a> for an
explanation of why this was changed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>More interestingly, even if-then-else can be described that way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">if true  then TrueBody else FalseBody   is TrueBody
if false then TrueBody else FalseBody   is FalseBody
if true  then TrueBody                  is TrueBody
if false then TrueBody                  is false</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The above code now requires a <a href="#metabox">metabox</a> for <code>true</code> in
the version of XL described in this document, i.e. <code>true</code> must be
replaced with <code>[[true]]</code> in order to avoid being interpreted as a
formal parameter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similarly for basic loops, provided your translation mechanism
implements tail recursion properly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">while Condition loop Body is
    if Condition then
        Body
    while Condition loop Body

until Condition loop Body is while not Condition loop Body

loop Body is { Body; loop Body }

for Var in Low..High loop Body is
    Var := Low
    while Var &lt; High loop
        Body
        Var := Var + 1</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The fact that such structures can be implemented in the library
does not mean that they have to. It is simply a proof that basic
amenities can be constructed that way, and to provide a reference
definition of the expected behaviour.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="tao3d-interactive-3d-graphics-with-xl"><a class="anchor" href="#tao3d-interactive-3d-graphics-with-xl"></a><a class="link" href="#tao3d-interactive-3d-graphics-with-xl">10.14. Tao3D, interactive 3D graphics with XL</a></h3>
<div class="paragraph">
<p>When I decided to leave HP, I thought that XLR was flexible enough to be
used as a dynamic document language. I quickly whipped together a
prototype using XLR to drive an OpenGL 3D rendering engine. That proved
quite interesting.</p>
</div>
<div class="paragraph">
<p>Over time, that prototype morphed into <a href="http://tao3d.sf.net">Tao3D</a>. As
far as the XLR language itself is concerned, there wasn’t as much
evolution as previously. A few significant changes related to usability
popped up after actively using the language:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicit conversions of integer to real were not in the original XLR,
but it was quite annoying in practice when providing object coordinates.</p>
</li>
<li>
<p>The XL version in Tao3D also became sensitive to spacing around
operators, so as to distinguish <code>Write -A</code> from <code>X - Y</code>. Earlier
versions forced you to use parentheses in the first case, as in
<code>Write (-A)</code>, which was quite against the ideas of concept programming
that your code must match your ideas.</p>
</li>
<li>
<p>The more important change was the integration in the language of
reactivity to transparently deal with events such as mouse, keyboard or
time. Thus, the Tao3D language a fully functional-reactive language,
without changing the core translation technology at all.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Precisely because the changes were so minor, Tao3D largely proved the
point that XL was really extensible. For example, a <code>slide</code> function
(that takes code as its second argument) makes it easy to describe a
great-looking bullet points slide:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">import WhiteChristmasTheme
theme "WhiteChristmas"

slide "An example slide",
    * "Functional reactive programming is great"
    color_hsv mouse_x, 100%, 100%
    * "This text color changes with the mouse"
    color_hsv time * 20, 100%, 100%
    * "This text color changes with time"</code></pre>
</div>
</div>
<div class="paragraph">
<p>and get an animated slide that looks like this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/tao3dtheme1.png" alt="Tao3D slide"></span></p>
</div>
<div class="paragraph">
<p>The same technique goes well beyond mere bullet points:</p>
</div>
<div class="videoblock">
<div class="title">Christmas Card in Tao3D</div>
<div class="content">
<iframe width="800" height="600" src="https://www.youtube.com/embed/4wTQcKvhReo?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>Tao3D developed a relatively large set of specialised modules, dealing
with things such as stereoscopy or lens flares. As a product, however,
it was never very successful, and Taodyne shut down in 2015, even if the
open-source version lives on.</p>
</div>
<div class="paragraph">
<p>Unfortunately, Tao3D was built on a relatively weak implementation of
XL, where the type system in particular was not well thought out (it was
really a hack that only supported parse tree types). This made a few
things really awkward. Notably, all values are passed by reference,
which was mostly an implementation hack to enable the user-interface to
"retrofit" values into the code when you move shapes on the screen.
Unfortunately, this made the language brittle, and forced many modules
to rely on poor hacks when updating values. To make a long story short,
<code>X := Y</code> in Tao3D is a joke, and I’m rightfully ashamed of it.</p>
</div>
</div>
<div class="sect2">
<h3 id="elfe-distributed-programming-with-xl"><a class="anchor" href="#elfe-distributed-programming-with-xl"></a><a class="link" href="#elfe-distributed-programming-with-xl">10.15. ELFE, distributed programming with XL</a></h3>
<div class="paragraph">
<p><a href="https://github.com/c3d/elfe">ELFE</a> was another experiment with XL, that
took advantage of XL’s extensibility to explore yet another application
domain, namely distributed software, with an eye on the Internet of
Things. The idea was to take advantage of the existence of the XL0
standard parse tree to communicate programs and data across machines.</p>
</div>
<div class="paragraph">
<p>An ELFE program looks as as if it was running on a single machine, but
actively exchanges program segments and their associated data between
distant nodes (in modern XL, <code>-&gt;</code> below would read <code>is</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">invoke "pi2.local",
   every 1.1s,
        rasp1_temp -&gt;
            ask "pi.local",
                temperature
        send_temps rasp1_temp, temperature

   send_temps T1:real, T2:real -&gt;
       if abs(T1-T2) &gt; 2.0 then
           reply
               show_temps T1, T2

show_temps T1:real, T2:real -&gt;
    write "Temperature on pi is ", T1, " and on pi2 ", T2, ". "
    if T1&gt;T2 then
        writeln "Pi is hotter by ", T1-T2, " degrees"
    else
        writeln "Pi2 is hotter by ", T2-T1, " degrees"</code></pre>
</div>
</div>
<div class="paragraph">
<p>ELFE only adds a very small number of features to the standard XL, which
are simply regular XL functions implemented in C&#43;&#43;:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>ask</code> statement sends a program, and returns the result of
evaluating that program as if it has been evaluated locally. It works
like a remote function call.</p>
</li>
<li>
<p>An <code>invoke</code> statement sends a program to a remote node. It’s a "fire
and forget" operation, but leaves a reply channel open while it’s
executing.</p>
</li>
<li>
<p>Finally, the <code>reply</code> statement allows a remote node to respond to
whoever <code>invoke</code>‘d it, by evaluating one of the available functions in
the caller’s context.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A few very simple <a href="http://github.com/c3d/xl/blob/master/demo">ELFE demos</a> illustrate these
remote-control capabilities. For example, it’s easy to
<a href="http://github.com/c3d/xl/blob/master/demo/7-two-hops.xl">monitor temperature</a> on two remote sensor
nodes, and to ask them to report if their temperatures differ by more
than some specified amount. The code is very short and looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">invoke "pi2.local",
   every 1.1s,
        rasp1_temp -&gt;
            ask "pi.local",
                temperature
        send_temps rasp1_temp, temperature

   send_temps T1:real, T2:real -&gt;
       if abs(T1-T2) &gt; 2.0 then
           reply
               show_temps T1, T2

show_temps T1:real, T2:real -&gt;
    write "Temperature on pi is ", T1, " and on pi2 ", T2, ". "
    if T1&gt;T2 then
        writeln "Pi is hotter by ", T1-T2, " degrees"
    else
        writeln "Pi2 is hotter by ", T2-T1, " degrees"</code></pre>
</div>
</div>
<div class="paragraph">
<p>ELFE was designed to run with a small memory footprint, so it provides a
complete interpreter that does not require any LLVM. As the names in the
example above suggest, it was tested on Raspberry Pi. On the other hand,
the LLVM support in that "branch" of the XL family tree fell into a
bad state of disrepair.</p>
</div>
</div>
<div class="sect2">
<h3 id="xl-gets-a-type-system"><a class="anchor" href="#xl-gets-a-type-system"></a><a class="link" href="#xl-gets-a-type-system">10.16. XL gets a type system</a></h3>
<div class="paragraph">
<p>Until that point, XL lacked a real type system. What was there was
mostly quick-and-dirty solutions for the most basic type checks. Over a
Christmas vacation, I spent quite a bit of time thinking about what a
good type system would be for XL. I was notably stumped by what the type
of <code>if-then-else</code> statements should be.</p>
</div>
<div class="paragraph">
<p>The illumination came when I realized that I was blocked in my thinking
by the false constraint that each value had to have a single type.
Instead, the type system that seems natural in XL is that a type
indicates the shape of a parse tree. For example, <code>integer</code> is the type
of integer constants in the code, <code>real</code> the type of real constants, and
<code>type(X+Y)</code> would be the type of all additions.</p>
</div>
<div class="paragraph">
<p>Obviously, that means that in XL, a value can belong to multiple types.
<code>2+3*5</code> belongs to <code>type(X+Y)</code>, to <code>type(X:integer+Y:integer)</code> or to
<code>infix</code>. This makes the XL type system extremely powerful. For example.
a type for even numbers is <code>type(X:integer when X mod 2 = 0)</code>. I later
changed <code>type(X)</code> into <code>matching(X)</code> for two reasons. First, the
<code>type(X)</code> operation was more expected to be the type of value <code>X</code>, not
the type derived from its shape. Second, you need to learn that the XL
type system is based on pattern matching, and <code>matching</code> makes
somewhat obvious what happens.</p>
</div>
<div class="paragraph">
<p>ELFE also gave me a chance to implement a relatively crude version of
this idea and validate that it’s basically sane. Bringing that idea to
the optimizing compiler was an entirely different affair, though, and is
still ongoing.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-llvm-catastrophy"><a class="anchor" href="#the-llvm-catastrophy"></a><a class="link" href="#the-llvm-catastrophy">10.17. The LLVM catastrophy</a></h3>
<div class="paragraph">
<p>For a while, there were multiple subtly distinct variants of XL which
all shared the same XL0, but had very different run-time constraints.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tao3D had the most advanced library, and a lot of code written for it.
But that code often depends on undesirable behaviours in the language,
such as implicit by reference argument passing.</p>
</li>
<li>
<p>ELFE had the most advanced type system of all XLR variants, being able
to perform overloading based on the shape of parse trees, and having a
rather complete set of control structures implemented in the library. It
also has an interesting modular structure, and a rather full-featured
interpreter.</p>
</li>
<li>
<p>XLR has the most advanced type inference system, allowing it to
produce machine-level instructions for simple cases to get performance
that was on a par with C. Unfortunately, due to lack of time, it fell
behind with respect to LLVM support, LLVM not being particularly careful
about release-to-release source compatibility. And the type inference
was never solid enough to retrofit it in Tao3D, which still uses a much
simpler code generation.</p>
</li>
<li>
<p>XL2 was the only self-compiling variant of XL ever written, and still
had by far the most sophisticated handling of generics and most advanced
library. But it has been left aside for a few years. As an imperative
language, it is more verbose and feels heavier to program. Yet it is not
obsolete, as the discussion above demonstrates. Its type system, with
its support for generics or validation, is much more robust than
whatever was ever implemented in all XLR variants. It would need quite a
bit of love to make it really usable, for example improving the standard
library and actually connect XLR as a bytecode back-end as initially
envisioned.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to this divergence, another problem arose externally to the
XL project. The LLVM library, while immensely useful, proved a nightmare
to use, because they purposely don’t care about source cdoe
compatibility between releases. XLR was initially coded against LLVM
2.5, and the majority of Tao3D development occured in the LLVM 2.7 time
frame.</p>
</div>
<div class="paragraph">
<p>Around release 3.5, LLVM started switching to a completely different
code generation model. Being able to support that new model proved
extremely challenging, in particular for something as complex as Tao3D.
The problem is not unique to Tao3D: the LLVM pipe in the Mesa project
has similar issues. But in Tao3D, it was made much worse precisely
because Tao3D uses both OpenGL and XL, and the Mesa implementation of
OpenGL commonly used on Linux also uses LLVM. If the variants of LLVM
used by the XL runtime and by OpenGL don’t match, mysterious crashes are
almost guaranteed.</p>
</div>
<div class="paragraph">
<p>From 2015 to 2018, all development of XL and Tao3D was practically stuck
on this problem. It did not help that my job during that time was
especially challenging time-wise. In practice, the development of Tao3D
and XLR was put on hold for a while.</p>
</div>
</div>
<div class="sect2">
<h3 id="repairing-and-reconverging"><a class="anchor" href="#repairing-and-reconverging"></a><a class="link" href="#repairing-and-reconverging">10.18. Repairing and reconverging</a></h3>
<div class="paragraph">
<p>A project that lasted several months, called <code>bigmerge</code> allowed me to
repair a lot of the issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The XL2 compiler was brought back into the main tree</p>
</li>
<li>
<p>The ELFE interpreter was merged with the main tree, and its modular
approach (designed to allow the use of XL as an extension language) was
incorporated in XL. As a result, ELFE is dead, but it lives on in the
main XL tree. XL was also turned into a library, with a very small
front-end calling that library to evaluate the code.</p>
</li>
<li>
<p>The switch from <code>-&gt;</code> to <code>is</code> as the definition operator was
implemented.</p>
</li>
<li>
<p>The LLVM "Compatibility Restoration Adaptive Protocol" (LLVM-CRAP)
component of XL was completely redesigned, giving up pre-3.5 versions of
LLVM, but supporting all the recent ones (from 3.7 to 9.0).</p>
</li>
<li>
<p>The Tao3D branch of the compiler was forward-ported to this updated
compiler, under the name <code>FastCompiler</code>. That work is not complete,
howver, because some of the changes required by the two previous steps
are incompatible with the way Tao3D was interfacing with XL.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the current state of the XL tree you are looking at. Not pretty,
but still much better than two years ago.</p>
</div>
</div>
<div class="sect2">
<h3 id="language-redefinition"><a class="anchor" href="#language-redefinition"></a><a class="link" href="#language-redefinition">10.19. Language redefinition</a></h3>
<div class="paragraph">
<p>During all that time, the language definition had been a very vaguely
defined <a href="XL_Reference_Manual.pdf">TeXMacs document</a>. This document
had fallen somewhat behind with respect to the actual language
implementation or design. Notably, the type system was quickly
retrofitted in the document. Also, the TexMacs document was monolithic,
and not easy to convert to a web format.</p>
</div>
<div class="paragraph">
<p>So after a while, I decided to <a href="#introduction-to-xl">rewrite the
documentation in markdown</a>. This led me to crystalize decisions about a
few things that have annoyed me in the previous definition, in
particular:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ambiguity about formal parameters in patterns, exhibited by the
definition of <code>if-then-else</code>. The XL language had long defined
<code>if-then-else</code> as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">if true  then TrueClause      is TrueClause
if false then TrueClause      is false</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is an obvious problem in that definition. Why should <code>true</code> be
treated like a constant while <code>TrueClause</code> a formal parameter?</p>
</div>
<div class="paragraph">
<p>The solution proposed so far so far was that if a name already existed
in the context, then we were talking about this name. In other words,
<code>true</code> was supposed to be defined elsewhere and not <code>TrueClause</code>.</p>
</div>
<div class="paragraph">
<p>This also dealt with patterns such as <code>A - A is 0</code>. However, the cost
was very high. In particular, a formal parameter name could not be any
name used in the enclosing context, which was a true nuisance in
practice.</p>
</div>
<div class="paragraph">
<p>More recently, I came across another problem, which was how to properly
insert a computed value like the square root of two in a pattern? I came
up with an idea inspired parameters in <code>translate</code> statements in XL2,
which I called a "metabox". The notation <code>[[X]]</code> in a pattern will
evaluate <code>X</code>. To match the square root of 2, you would insert the
metabox <code>[[sqrt 2]]</code>. To match <code>true</code> instead of defining a name <code>true</code>,
you would insert <code>[[true]]</code> instead of <code>true</code>.</p>
</div>
<div class="paragraph">
<p>Downside: fix all the places in the documentation that had it backwards.</p>
</div>
</li>
<li>
<p>The addition of opaque binary data in parse trees, for example to put
an image from a PNG file in an XL program. I had long been thinking
about a syntax like <code>binary "image.png"</code> It should also be possible to
declare arbitrary binary data inline, as in
<code>binary 16#FFFF_0000_FFFF_0000_FF00_00FF_FF00_00FF</code>.</p>
</li>
<li>
<p>Adding a <code>lambda</code> syntax for anonymous functions. Earlier versions of
XL would use a catch-all pattern like <code>(X is X + 1)</code> to define a lambda
function, so that <code>(X is X + 1) 3</code> would be <code>4</code>. That pattern was only
recognized in some specific contexts, and in other contexts, this would
be a definition of a variable named <code>X</code>. It is now mandatory to add
<code>lambda</code> for a catch-all pattern, as in <code>lambda X is X + 1</code>, but then
this works in any context.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="future-work"><a class="anchor" href="#future-work"></a><a class="link" href="#future-work">10.20. Future work</a></h3>
<div class="paragraph">
<p>The work that remains to make XL usable again (in the sense of being as
stable as it was for Tao3D in the 2010-2015 period) includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Complete the work on an Haskell-style type inference system, in order
to make the "O3" compiler work well.</p>
</li>
<li>
<p>Repair the Tao3D interface in order to be able to run Tao3D again with
modern LLVM and OpenGL variants.</p>
</li>
<li>
<p>Re-connect the XL2 front-end for those who prefer an imperative
programming style, ideally connecting it to XLR as a runtime.</p>
</li>
<li>
<p>Sufficient library-level support to make the language usable for real
projects.</p>
</li>
<li>
<p>Bootstrapping XLR as a native compiler, to validate that the XLR-level
language is good enough for a compiler. Some of the preparatory work for
this is happening in the <code>native</code> directory.</p>
</li>
<li>
<p>Implement a Rust-style borrow checker, ideally entirely from the
library, and see if it makes it possible to get rid of the garbage
collector. That would be especially nice for Tao3D, where GC pause,
while generally quite small, are annoying.</p>
</li>
<li>
<p>Some reworking of XL0, notably to make it easier to add terminal node
types. An example of use case is version numbers like <code>1.0.1</code>, which
are hard to deal with currently. The distinction between <code>Integer</code> and
<code>Real</code> is indispensable for evaluation, but it may not be indispensable
at parse time.</p>
</li>
<li>
<p>Replace blocks with arrays. Currently, blocks without a content, such
as <code>( )</code> or <code>{ }</code>, have a blank name inside, which I find ugly. It would
make more sense to consider them as arrays with zero length.
Furthermore, blocks are often used to hold sequences, for example
sequences of instructions. It would be easier to deal with a block
containing a sequence of instructions than with the current block
containing an instruction or a chain of infix nodes.</p>
</li>
<li>
<p>Adding a "binary object" node type, which could be used to either
describe data or load it from files. I have been considering a syntax
like:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="xl" class="language-xl hljs">binary 16#0001_0002_0003_0004_0005_0006_0007_0008_0009
binary "image.jpg"</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is unclear if I will be able to do that while at the same time
working on my job at Red Hat and on various other little projects such
as <code>make-it-quick</code> or <code>recorder</code> (which are themselves off-shoots of XL
development).</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-12-10 13:15:19 +0100
</div>
</div>
<link rel="stylesheet" href="highlight/styles/github.min.css">
<script src="highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>